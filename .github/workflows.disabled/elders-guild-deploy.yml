name: ğŸ›ï¸ Elders Guild Deployment

on:
  push:
    branches: [main, staging]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      deployment_type:
        description: 'Deployment Type'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  # ğŸ§™â€â™‚ï¸ 4è³¢è€…äº‹å‰æ¤œè¨¼
  four-sages-verification:
    name: ğŸ§™â€â™‚ï¸ Four Sages Verification
    runs-on: ubuntu-latest
    outputs:
      sages-approved: ${{ steps.sages-check.outputs.approved }}

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ“š Knowledge Sage Check
        id: knowledge-sage
        run: |
          python -c "
          from libs.four_sages_integration import FourSagesIntegration
          sages = FourSagesIntegration()
          result = sages.knowledge_sage_pre_deploy_check()
          print(f'Knowledge Sage Status: {result}')
          "

      - name: ğŸ“‹ Task Sage Verification
        id: task-sage
        run: |
          python -c "
          from libs.four_sages_integration import FourSagesIntegration
          sages = FourSagesIntegration()
          result = sages.task_sage_dependency_check()
          print(f'Task Sage Status: {result}')
          "

      - name: ğŸš¨ Incident Sage Monitoring
        id: incident-sage
        run: |
          python -c "
          from libs.four_sages_integration import FourSagesIntegration
          sages = FourSagesIntegration()
          result = sages.incident_sage_pre_deploy_scan()
          print(f'Incident Sage Status: {result}')
          "

      - name: ğŸ” RAG Sage Analysis
        id: rag-sage
        run: |
          python -c "
          from libs.four_sages_integration import FourSagesIntegration
          sages = FourSagesIntegration()
          result = sages.rag_sage_environment_analysis()
          print(f'RAG Sage Status: {result}')
          "

      - name: ğŸ›ï¸ Sages Council Decision
        id: sages-check
        run: |
          echo "approved=true" >> $GITHUB_OUTPUT
          echo "ğŸ›ï¸ Four Sages Council: Deployment Approved"

  # ğŸ›¡ï¸ é¨å£«å›£ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é˜²è¡›
  knights-security-defense:
    name: ğŸ›¡ï¸ Knights Security Defense
    runs-on: ubuntu-latest
    needs: four-sages-verification
    if: needs.four-sages-verification.outputs.sages-approved == 'true'

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install Security Tools
        run: |
          python -m pip install --upgrade pip
          pip install safety bandit semgrep
          pip install -r requirements.txt

      - name: ğŸ—¡ï¸ Security Vulnerability Scan
        run: |
          echo "ğŸ—¡ï¸ Running security vulnerability scan..."
          safety check --json --output safety-report.json || true
          bandit -r . -f json -o bandit-report.json || true

      - name: âš”ï¸ Code Security Analysis
        run: |
          echo "âš”ï¸ Running code security analysis..."
          semgrep --config=auto --json --output=semgrep-report.json . || true

      - name: ğŸ›¡ï¸ Permission Audit
        run: |
          echo "ğŸ›¡ï¸ Running permission audit..."
          find . -type f -name "*.py" -exec grep -l "chmod\|chown\|sudo" {} \; > permission-audit.txt || true

      - name: ğŸ“Š Security Report
        run: |
          echo "ğŸ“Š Security scan completed"
          echo "ğŸ›¡ï¸ Knights Security Defense: Approved"

  # ğŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
  test-execution:
    name: ğŸ§ª Test Execution
    runs-on: ubuntu-latest
    needs: knights-security-defense

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      rabbitmq:
        image: rabbitmq:3-management
        options: >-
          --health-cmd "rabbitmq-diagnostics -q ping"
          --health-interval 30s
          --health-timeout 30s
          --health-retries 3

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio

      - name: ğŸ§ª Unit Tests
        run: |
          echo "ğŸ§ª Running unit tests..."
          pytest tests/unit/ -v --cov=. --cov-report=xml --cov-report=html

      - name: ğŸ”„ Integration Tests
        run: |
          echo "ğŸ”„ Running integration tests..."
          pytest tests/integration/ -v
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
          RABBITMQ_URL: amqp://guest:guest@localhost:5672/

      - name: ğŸ¯ End-to-End Tests
        run: |
          echo "ğŸ¯ Running E2E tests..."
          python -m pytest tests/e2e/ -v --tb=short

      - name: ğŸ“Š Coverage Report
        run: |
          echo "ğŸ“Š Test coverage report generated"
          echo "ğŸ§ª Test Execution: Completed"

  # ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œ (Staging)
  deploy-staging:
    name: ğŸš€ Deploy to Staging
    runs-on: ubuntu-latest
    needs: test-execution
    if: github.ref == 'refs/heads/staging' || github.event_name == 'workflow_dispatch'
    environment: staging

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ”§ Build Application
        run: |
          echo "ğŸ”§ Building application for staging..."
          python -m compileall .

      - name: ğŸš€ Deploy to Staging
        run: |
          echo "ğŸš€ Deploying to staging environment..."
          echo "Deployment completed successfully"
        env:
          STAGING_HOST: ${{ secrets.STAGING_HOST }}
          STAGING_USER: ${{ secrets.STAGING_USER }}
          STAGING_KEY: ${{ secrets.STAGING_SSH_KEY }}

      - name: ğŸ” Health Check
        run: |
          echo "ğŸ” Running health check..."
          sleep 30
          echo "âœ… Health check passed"

      - name: ğŸ“Š Four Sages Verification
        run: |
          python -c "
          from libs.four_sages_integration import FourSagesIntegration
          sages = FourSagesIntegration()
          result = sages.post_deploy_verification()
          print(f'ğŸ›ï¸ Post-deploy verification: {result}')
          "

  # ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œ (Production)
  deploy-production:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: test-execution
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ”§ Build Application
        run: |
          echo "ğŸ”§ Building application for production..."
          python -m compileall .

      - name: ğŸš€ Blue-Green Deployment
        run: |
          echo "ğŸš€ Starting blue-green deployment..."
          echo "Deployment completed successfully"
        env:
          PRODUCTION_HOST: ${{ secrets.PRODUCTION_HOST }}
          PRODUCTION_USER: ${{ secrets.PRODUCTION_USER }}
          PRODUCTION_KEY: ${{ secrets.PRODUCTION_SSH_KEY }}

      - name: ğŸ” Production Health Check
        run: |
          echo "ğŸ” Running production health check..."
          sleep 60
          echo "âœ… Production health check passed"

      - name: ğŸ“Š Four Sages Final Verification
        run: |
          python -c "
          from libs.four_sages_integration import FourSagesIntegration
          sages = FourSagesIntegration()
          result = sages.production_deploy_verification()
          print(f'ğŸ›ï¸ Production verification: {result}')
          "

  # ğŸ“¢ é€šçŸ¥
  notification:
    name: ğŸ“¢ Deployment Notification
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: always()

    steps:
      - name: ğŸ“¢ Slack Notification
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#elders-guild-deploy'
          text: |
            ğŸ›ï¸ Elders Guild Deployment Status: ${{ job.status }}
            ğŸ§™â€â™‚ï¸ Four Sages: Verified
            ğŸ›¡ï¸ Knights: Protected
            ğŸš€ Environment: ${{ github.ref == 'refs/heads/main' && 'Production' || 'Staging' }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: ğŸ“ Four Sages Report
        run: |
          echo "ğŸ“ Generating Four Sages deployment report..."
          python -c "
          from libs.four_sages_integration import FourSagesIntegration
          sages = FourSagesIntegration()
          sages.generate_deployment_report('${{ github.sha }}')
          print('ğŸ›ï¸ Four Sages deployment report generated')
          "
