name: Issueè‡ªå‹•ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 

on:
  issues:
    types: [opened, edited, labeled, unlabeled]
  pull_request:
    types: [opened, closed]
  workflow_dispatch:
    inputs:
      command:
        description: 'Command to execute'
        required: true
        type: choice
        options:
          - sync
          - report
          - create-subs
      issue_number:
        description: 'Issue number (optional)'
        required: false

permissions:
  issues: write
  pull-requests: write
  contents: read

jobs:
  auto_manage:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install PyGithub
          pip install -r requirements.txt || true

      - name: ğŸ¤– Issueè‡ªå‹•ç®¡ç†
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [[ "${{ github.event_name }}" == "issues" ]]; then
            # æ–°è¦Issueä½œæˆæ™‚
            if [[ "${{ github.event.action }}" == "opened" ]]; then
              echo "ğŸ†• æ–°è¦Issueæ¤œå‡º: #${{ github.event.issue.number }}"

              # è‡ªå‹•ãƒ©ãƒ™ãƒªãƒ³ã‚°
              python3 -c "
import os
from github import Github
g = Github(os.environ['GITHUB_TOKEN'])
repo = g.get_repo('${{ github.repository }}')
issue = repo.get_issue(${{ github.event.issue.number }})

# ã‚¿ã‚¤ãƒˆãƒ«ã¨æœ¬æ–‡ã‹ã‚‰è‡ªå‹•ãƒ©ãƒ™ãƒªãƒ³ã‚°
title = issue.title.lower()
body = (issue.body or '').lower()

labels = []
if 'bug' in title or 'error' in title or 'fix' in title:
    labels.append('bug')
elif 'feature' in title or 'æ©Ÿèƒ½' in title:
    labels.append('enhancement')
elif 'research' in title or 'èª¿æŸ»' in title:
    labels.append('research')

if 'urgent' in title or 'critical' in title or 'ç·Šæ€¥' in title:
    labels.append('priority:high')

if labels:
    issue.add_to_labels(*labels)
    print(f'Added labels: {labels}')
              "

              # EpicIssueã®å ´åˆã€Sub Issueä½œæˆã‚’ææ¡ˆ
              if [[ "${{ contains(github.event.issue.labels.*.name, 'epic') }}" == "true" ]]; then
                python3 libs/integrations/github/elders_issue_manager.py create-subs \
                  --repo "${{ github.repository }}" \
                  --issue ${{ github.event.issue.number }}
              fi
            fi

            # ãƒ©ãƒ™ãƒ«å¤‰æ›´æ™‚
            if [[ "${{ github.event.action }}" == "labeled" ]]; then
              # ã‚¨ãƒ«ãƒ€ãƒ¼ã‚µãƒ¼ãƒãƒ³ãƒˆã¸ã®è‡ªå‹•ã‚¢ã‚µã‚¤ãƒ³
              python3 libs/integrations/github/elders_issue_manager.py auto-assign \
                --repo "${{ github.repository }}" \
                --issue ${{ github.event.issue.number }}
            fi
          fi

          # PRå‡¦ç†
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            if [[ "${{ github.event.action }}" == "closed" ]] && [[ "${{ github.event.pull_request.merged }}" == "true" ]]; then
              echo "ğŸ”€ PR ãƒãƒ¼ã‚¸æ¤œå‡º: #${{ github.event.pull_request.number }}"

              # é–¢é€£Issueã®è‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚º
              python3 -c "
import os
import re
from github import Github

g = Github(os.environ['GITHUB_TOKEN'])
repo = g.get_repo('${{ github.repository }}')
pr = repo.get_pull(${{ github.event.pull_request.number }})

# PRæœ¬æ–‡ã‹ã‚‰é–¢é€£Issueã‚’æŠ½å‡º
body = pr.body or ''
pattern = r'(?:closes?|fix(?:es)?|resolv(?:es)?)\s*#(\d+)'
matches = re.findall(pattern, body, re.IGNORECASE)

for issue_num in matches:
    try:
        issue = repo.get_issue(int(issue_num))
        issue.edit(state='closed')
        issue.create_comment(f'âœ… Closed by PR #{pr.number}')
        print(f'Closed issue #{issue_num}')
    except:
        pass
              "
            fi
          fi

          # æ‰‹å‹•å®Ÿè¡Œ
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            python3 libs/integrations/github/elders_issue_manager.py ${{ inputs.command }} \
              --repo "${{ github.repository }}" \
              ${{ inputs.issue_number && format('--issue {0}', inputs.issue_number) || '' }}
          fi

      - name: ğŸ“Š 4è³¢è€…ã‚·ã‚¹ãƒ†ãƒ åŒæœŸ
        if: github.event_name == 'issues'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 libs/integrations/github/elders_issue_manager.py sync \
            --repo "${{ github.repository }}" \
            --issue ${{ github.event.issue.number }}

      - name: ğŸ“ˆ æ—¥æ¬¡ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
        if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && inputs.command == 'report')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 libs/integrations/github/elders_issue_manager.py report \
            --repo "${{ github.repository }}" > daily_report.json

          # ãƒ¬ãƒãƒ¼ãƒˆã‚’Issueã¨ã—ã¦æŠ•ç¨¿
          python3 -c "
import os
import json
from datetime import datetime
from github import Github

with open('daily_report.json', 'r') as f:
    report = json.load(f)

g = Github(os.environ['GITHUB_TOKEN'])
repo = g.get_repo('${{ github.repository }}')

title = f'ğŸ“Š Daily Issue Report - {datetime.now().strftime(\"%Y-%m-%d\")}'
body = f'''
# ğŸ“Š Daily Issue Management Report

## ğŸ“ˆ Summary
- **Opened Issues**: {report['summary']['opened_issues']}
- **Closed Issues**: {report['summary']['closed_issues']}
- **Active Issues**: {report['summary']['active_issues']}
- **Completion Rate**: {report['metrics']['completion_rate']:.1f}%

## ğŸ§™â€â™‚ï¸ 4è³¢è€…ã®æ´å¯Ÿ
{json.dumps(report.get('sage_insights', {}), indent=2, ensure_ascii=False)}

---
ğŸ¤– Generated by Elders Guild Issue Management System
'''

repo.create_issue(title=title, body=body, labels=['report', 'automated'])
          "
EOF
