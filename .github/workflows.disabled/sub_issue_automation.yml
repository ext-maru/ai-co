name: Sub Issueè‡ªå‹•ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 

on:
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  issues:
    types: [closed, opened, edited, labeled, unlabeled]
  issue_comment:
    types: [created, edited]
  pull_request:
    types: [closed, merged]
  schedule:
    - cron: '0 */6 * * *'  # 6æ™‚é–“æ¯ã®å®šæœŸãƒã‚§ãƒƒã‚¯

permissions:
  issues: write
  pull-requests: write
  contents: read

jobs:
  auto_progress_update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: ğŸ§™â€â™‚ï¸ 4è³¢è€…ã‚·ã‚¹ãƒ†ãƒ çµ±åˆ
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = context.payload.issue;
            const comment = context.payload.comment;
            const pr = context.payload.pull_request;

            // Sub Issueå®Œäº†æ™‚ã®è‡ªå‹•å‡¦ç†
            if (context.eventName === 'issues' && context.payload.action === 'closed') {
              // 4è³¢è€…ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ©ãƒ™ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯
              const sageLabels = ['knowledge-sage', 'task-sage', 'incident-sage', 'rag-sage'];
              const hasSageLabel = issue.labels.some(label =>
                sageLabels.includes(label.name.toLowerCase())
              );

              if (hasSageLabel) {
                console.log(`ğŸ‰ ${issue.title} å®Œäº† - Master Issueé€²æ—æ›´æ–°ä¸­...`);

                // Master Issueã‚’æ¤œç´¢ï¼ˆParent Issueï¼‰
                const issues = await github.rest.issues.listForRepo({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  state: 'open',
                  labels: 'epic'
                });

                // Master Issueã«é€²æ—æ›´æ–°ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
                for (const masterIssue of issues.data) {
                  if (masterIssue.body.includes('ã‚¨ãƒ«ãƒ€ãƒ¼ã‚ºã‚®ãƒ«ãƒ‰çµ±åˆè¨ˆç”»')) {
                    await github.rest.issues.createComment({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      issue_number: masterIssue.number,
                      body: `ğŸ‰ **Sub Issueå®Œäº†é€šçŸ¥**

                      âœ… #${issue.number} - ${issue.title}

                      ## ğŸ“Š è‡ªå‹•é€²æ—æ›´æ–°
                      Sub Issueå®Œäº†ã«ã‚ˆã‚Šå…¨ä½“é€²æ—ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸã€‚

                      ğŸ¤– Automated by Elder Flow GitHub Actions`
                    });
                  }
                }
              }
            }

            // é€²æ—ã‚³ãƒ¡ãƒ³ãƒˆè‡ªå‹•åˆ†æ
            if (context.eventName === 'issue_comment' && context.payload.action === 'created') {
              const commentBody = comment.body;

              // é€²æ—ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¤œå‡º
              const progressKeywords = ['å®Œäº†', 'é€²è¡Œä¸­', 'é–‹å§‹', 'å®Œäº†ç‡', '%', 'done', 'progress', 'complete'];
              const hasProgress = progressKeywords.some(keyword =>
                commentBody.toLowerCase().includes(keyword.toLowerCase())
              );

              if (hasProgress) {
                console.log(`ğŸ“ˆ é€²æ—æ›´æ–°æ¤œçŸ¥: Issue #${issue.number}`);

                // é€²æ—ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡ºã—ã¦ãƒ©ãƒ™ãƒ«æ›´æ–°
                if (commentBody.includes('å®Œäº†')) {
                  await github.rest.issues.addLabels({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue.number,
                    labels: ['status:completed']
                  });
                } else if (commentBody.includes('é€²è¡Œä¸­')) {
                  await github.rest.issues.addLabels({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue.number,
                    labels: ['status:in-progress']
                  });
                }
              }
            }

            // PR ãƒãƒ¼ã‚¸æ™‚ã®é–¢é€£Issueè‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚º
            if (context.eventName === 'pull_request' && pr.merged) {
              const prBody = pr.body || '';

              // Issueå‚ç…§ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œå‡º (closes #123, fixes #456, resolves #789)
              const issuePattern = /(closes?|fix(?:es)?|resolv(?:es)?)\s*#(\d+)/gi;
              const matches = [...prBody.matchAll(issuePattern)];

              for (const match of matches) {
                const issueNumber = parseInt(match[2]);
                console.log(`ğŸ”§ PR #${pr.number} ãƒãƒ¼ã‚¸ã«ã‚ˆã‚ŠIssue #${issueNumber} ã‚’è‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚º`);

                try {
                  // Issueã‚’ã‚¯ãƒ­ãƒ¼ã‚º
                  await github.rest.issues.update({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issueNumber,
                    state: 'closed',
                    state_reason: 'completed'
                  });

                  // å®Œäº†ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ 
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issueNumber,
                    body: `âœ… **è‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚º**\n\nPR #${pr.number} ã®ãƒãƒ¼ã‚¸ã«ã‚ˆã‚Šã€ã“ã®Issueã¯è‡ªå‹•çš„ã«ã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚Œã¾ã—ãŸã€‚\n\nğŸ¤– Automated by Elders Guild Issue Management System`
                  });
                } catch (error) {
                  console.error(`Issue #${issueNumber} ã®ã‚¯ãƒ­ãƒ¼ã‚ºã«å¤±æ•—: ${error.message}`);
                }
              }
            }

            // å®šæœŸå®Ÿè¡Œæ™‚ã®é€²æ—ãƒã‚§ãƒƒã‚¯
            if (context.eventName === 'schedule') {
              console.log('ğŸ“Š å®šæœŸé€²æ—ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­...');

              // å…¨ã¦ã®ã‚ªãƒ¼ãƒ—ãƒ³Issueã‚’å–å¾—
              const openIssues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                per_page: 100
              });

              for (const issue of openIssues.data) {
                // Sub Issueã®ã‚ã‚‹ãƒã‚¹ã‚¿ãƒ¼issueã‚’æ¤œå‡º
                if (issue.body && issue.body.includes('- [ ]')) {
                  const checklistPattern = /- \[([ x])\]/g;
                  const matches = [...issue.body.matchAll(checklistPattern)];
                  const completed = matches.filter(m => m[1] === 'x').length;
                  const total = matches.length;

                  if (total > 0) {
                    const progress = Math.round((completed / total) * 100);

                    // é€²æ—ãƒ©ãƒ™ãƒ«ã‚’æ›´æ–°
                    const progressLabel = `progress:${progress}%`;

                    // æ—¢å­˜ã®é€²æ—ãƒ©ãƒ™ãƒ«ã‚’å‰Šé™¤
                    const currentLabels = issue.labels.filter(l => !l.name.startsWith('progress:'));

                    // æ–°ã—ã„é€²æ—ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
                    await github.rest.issues.setLabels({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      issue_number: issue.number,
                      labels: [...currentLabels.map(l => l.name), progressLabel]
                    });

                    console.log(`Issue #${issue.number}: é€²æ— ${progress}% æ›´æ–°å®Œäº†`);
                  }
                }
              }
            }

      - name: ğŸ” Elder Flowé€£æº
        run: |
          echo "ğŸŒŠ Elder Flowè‡ªå‹•åŒ–ã‚·ã‚¹ãƒ†ãƒ ã¨é€£æºä¸­..."
          # Elder Flowã‚·ã‚¹ãƒ†ãƒ ã«é€²æ—é€šçŸ¥
          if [ -f "libs/elder_system/flow/github_integration.py" ]; then
            python3 libs/elder_system/flow/github_integration.py \
              --issue-number="${{ github.event.issue.number }}" \
              --action="${{ github.event.action }}"
          fi
