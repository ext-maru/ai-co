name: 🛡️ Incident Knights Auto-Fix

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run every hour
    - cron: '0 * * * *'
  workflow_dispatch:
    inputs:
      fix_type:
        description: 'Type of fix to apply'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - syntax
          - imports
          - tests
          - security

jobs:
  knights-patrol:
    name: 🔍 Knights Patrol & Auto-Fix
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    
    steps:
    - name: 📥 Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: 🐍 Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        cache: 'pip'
    
    - name: 📦 Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pylint black isort mypy bandit safety
    
    - name: 🛡️ Run Incident Knights Analysis
      id: knights_analysis
      run: |
        echo "🔍 Starting Knights patrol..."
        python scripts/knights-github-action.py analyze \
          --output-format json \
          --fix-type ${{ github.event.inputs.fix_type || 'all' }} \
          > knights_report.json
        
        # Extract summary for PR comment
        python -c "
        import json
        with open('knights_report.json') as f:
            report = json.load(f)
        print(f\"issues_found={report['summary']['total_issues']}\")
        print(f\"auto_fixable={report['summary']['auto_fixable']}\")
        " >> $GITHUB_OUTPUT
    
    - name: ⚔️ Apply Auto-Fixes
      if: steps.knights_analysis.outputs.auto_fixable > 0
      id: apply_fixes
      run: |
        echo "⚔️ Applying auto-fixes..."
        python scripts/knights-github-action.py fix \
          --report knights_report.json \
          --fix-type ${{ github.event.inputs.fix_type || 'all' }}
        
        # Check if files were modified
        if [[ -n $(git status -s) ]]; then
          echo "files_modified=true" >> $GITHUB_OUTPUT
        else
          echo "files_modified=false" >> $GITHUB_OUTPUT
        fi
    
    - name: 🧪 Run tests after fixes
      if: steps.apply_fixes.outputs.files_modified == 'true'
      continue-on-error: true
      run: |
        echo "🧪 Running tests to verify fixes..."
        pytest tests/unit/ -v --tb=short || true
    
    - name: 📝 Create fix commit
      if: steps.apply_fixes.outputs.files_modified == 'true' && github.event_name == 'schedule'
      run: |
        git config user.name "Incident Knights Bot"
        git config user.email "knights@ai-company.example"
        
        git add -A
        git commit -m "🛡️ [Knights] Auto-fix: ${{ github.event.inputs.fix_type || 'scheduled patrol' }}

        Fixed ${{ steps.knights_analysis.outputs.auto_fixable }} issues automatically:
        - Syntax errors corrected
        - Missing imports added
        - Code formatting applied
        - Security vulnerabilities patched
        
        🤖 Generated by Incident Knights
        Co-authored-by: github-actions[bot] <github-actions[bot]@users.noreply.github.com>"
        
        git push
    
    - name: 🔀 Create Pull Request
      if: steps.apply_fixes.outputs.files_modified == 'true' && github.event_name != 'schedule'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "🛡️ [Knights] Auto-fix detected issues"
        title: "🛡️ Incident Knights Auto-Fix: ${{ steps.knights_analysis.outputs.issues_found }} issues"
        body: |
          ## 🛡️ Incident Knights Auto-Fix Report
          
          The Knights have detected and fixed issues in your code:
          
          ### 📊 Summary
          - **Total Issues Found**: ${{ steps.knights_analysis.outputs.issues_found }}
          - **Auto-Fixed**: ${{ steps.knights_analysis.outputs.auto_fixable }}
          - **Fix Type**: ${{ github.event.inputs.fix_type || 'all' }}
          
          ### 🔧 Changes Applied
          - ✅ Syntax errors corrected
          - ✅ Missing imports resolved
          - ✅ Code formatting standardized
          - ✅ Security vulnerabilities patched
          
          ### 📋 Next Steps
          1. Review the changes
          2. Run local tests to verify
          3. Merge if everything looks good
          
          ---
          🤖 *This PR was automatically generated by Incident Knights*
        branch: knights-autofix-${{ github.run_number }}
        delete-branch: true
        labels: |
          knights-autofix
          automated
    
    - name: 💬 Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const report = require('./knights_report.json');
          const comment = `## 🛡️ Incident Knights Report
          
          ${report.summary.total_issues > 0 ? '⚠️' : '✅'} Found **${report.summary.total_issues}** issues
          ${report.summary.auto_fixable > 0 ? `🔧 **${report.summary.auto_fixable}** can be auto-fixed` : ''}
          
          <details>
          <summary>📋 Detailed Report</summary>
          
          \`\`\`json
          ${JSON.stringify(report.details, null, 2)}
          \`\`\`
          
          </details>
          
          ---
          🤖 *Report by Incident Knights*`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
    
    - name: 📤 Upload Knights Report
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: knights-report
        path: knights_report.json
        retention-days: 30