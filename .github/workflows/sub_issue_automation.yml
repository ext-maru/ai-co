name: Sub Issueè‡ªå‹•ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 

on:
  issues:
    types: [closed, opened, edited]
  issue_comment:
    types: [created, edited]

jobs:
  auto_progress_update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ§™â€â™‚ï¸ 4è³¢è€…ã‚·ã‚¹ãƒ†ãƒ çµ±åˆ
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const comment = context.payload.comment;
            
            // Sub Issueå®Œäº†æ™‚ã®è‡ªå‹•å‡¦ç†
            if (context.eventName === 'issues' && context.payload.action === 'closed') {
              // 4è³¢è€…ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ©ãƒ™ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯
              const sageLabels = ['knowledge-sage', 'task-sage', 'incident-sage', 'rag-sage'];
              const hasSageLabel = issue.labels.some(label => 
                sageLabels.includes(label.name.toLowerCase())
              );
              
              if (hasSageLabel) {
                console.log(`ğŸ‰ ${issue.title} å®Œäº† - Master Issueé€²æ—æ›´æ–°ä¸­...`);
                
                // Master Issueã‚’æ¤œç´¢ï¼ˆParent Issueï¼‰
                const issues = await github.rest.issues.listForRepo({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  state: 'open',
                  labels: 'epic'
                });
                
                // Master Issueã«é€²æ—æ›´æ–°ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
                for (const masterIssue of issues.data) {
                  if (masterIssue.body.includes('ã‚¨ãƒ«ãƒ€ãƒ¼ã‚ºã‚®ãƒ«ãƒ‰çµ±åˆè¨ˆç”»')) {
                    await github.rest.issues.createComment({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      issue_number: masterIssue.number,
                      body: `ğŸ‰ **Sub Issueå®Œäº†é€šçŸ¥**
                      
                      âœ… #${issue.number} - ${issue.title}
                      
                      ## ğŸ“Š è‡ªå‹•é€²æ—æ›´æ–°
                      Sub Issueå®Œäº†ã«ã‚ˆã‚Šå…¨ä½“é€²æ—ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸã€‚
                      
                      ğŸ¤– Automated by Elder Flow GitHub Actions`
                    });
                  }
                }
              }
            }
            
            // é€²æ—ã‚³ãƒ¡ãƒ³ãƒˆè‡ªå‹•åˆ†æ
            if (context.eventName === 'issue_comment' && context.payload.action === 'created') {
              const commentBody = comment.body;
              
              // é€²æ—ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¤œå‡º
              const progressKeywords = ['å®Œäº†', 'é€²è¡Œä¸­', 'é–‹å§‹', 'å®Œäº†ç‡', '%'];
              const hasProgress = progressKeywords.some(keyword => 
                commentBody.includes(keyword)
              );
              
              if (hasProgress) {
                console.log(`ğŸ“ˆ é€²æ—æ›´æ–°æ¤œçŸ¥: Issue #${issue.number}`);
                
                // é€²æ—ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡ºã—ã¦ãƒ©ãƒ™ãƒ«æ›´æ–°
                if (commentBody.includes('å®Œäº†')) {
                  await github.rest.issues.addLabels({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue.number,
                    labels: ['status:completed']
                  });
                } else if (commentBody.includes('é€²è¡Œä¸­')) {
                  await github.rest.issues.addLabels({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue.number,
                    labels: ['status:in-progress']
                  });
                }
              }
            }
            
      - name: ğŸ” Elder Flowé€£æº
        run: |
          echo "ğŸŒŠ Elder Flowè‡ªå‹•åŒ–ã‚·ã‚¹ãƒ†ãƒ ã¨é€£æºä¸­..."
          # Elder Flowã‚·ã‚¹ãƒ†ãƒ ã«é€²æ—é€šçŸ¥
          if [ -f "libs/elder_system/flow/github_integration.py" ]; then
            python3 libs/elder_system/flow/github_integration.py \
              --issue-number="${{ github.event.issue.number }}" \
              --action="${{ github.event.action }}"
          fi