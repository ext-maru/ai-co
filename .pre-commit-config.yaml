# エルダーズギルド インシデント騎士団 Pre-commit設定
# 921個の問題を自動検出・修正し、今後の問題発生を防ぐ
# 完全自動化されたセルフヒーリングシステム

repos:
  # 基本的なPythonチェック
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      - id: trailing-whitespace
        name: "🧹 空白除去騎士"
      - id: end-of-file-fixer
        name: "📄 ファイル終端修正騎士"
      - id: check-yaml
        name: "📋 YAML検証騎士"
      - id: check-json
        name: "🔧 JSON検証騎士"
      - id: check-xml
        name: "📐 XML検証騎士"
      - id: check-toml
        name: "⚙️ TOML検証騎士"
      - id: check-merge-conflict
        name: "⚔️ マージ競合検出騎士"
      - id: check-added-large-files
        name: "📦 大容量ファイル検出騎士"
        args: [--maxkb=5000]
      - id: check-case-conflict
        name: "🔤 ファイル名競合検出騎士"
      - id: check-docstring-first
        name: "📝 Docstring検証騎士"
      - id: check-executables-have-shebangs
        name: "🚀 実行ファイル検証騎士"
      - id: debug-statements
        name: "🐛 デバッグ文検出騎士"
      - id: name-tests-test
        name: "🧪 テスト命名規則騎士"
        args: [--pytest-test-first]
      - id: check-ast
        name: "🐍 Python構文検証騎士"
      - id: fix-byte-order-marker
        name: "🔤 BOM除去騎士"
      - id: mixed-line-ending
        name: "📏 改行コード統一騎士"
        args: ['--fix=lf']

  # Python import修正（921個の問題の主要原因）
  - repo: https://github.com/PyCQA/isort
    rev: 5.13.2
    hooks:
      - id: isort
        name: "📦 インポート整理騎士"
        args: [--profile=black, --line-length=120, --force-single-line, --force-alphabetical-sort-within-sections]

  # 未使用インポート除去（自動修正）
  - repo: https://github.com/PyCQA/autoflake
    rev: v2.2.1
    hooks:
      - id: autoflake
        name: "🧹 未使用インポート除去騎士"
        args: [
          "--in-place",
          "--remove-all-unused-imports",
          "--remove-unused-variables",
          "--remove-duplicate-keys",
          "--expand-star-imports",
          "--ignore-init-module-imports"
        ]

  # Pythonコードフォーマット
  - repo: https://github.com/psf/black
    rev: 24.3.0
    hooks:
      - id: black
        name: "🎨 コード整形騎士"
        language_version: python3.12
        args: [--line-length=120]

  # Pythonリンター（Ruffによる高速チェック）
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.1.14
    hooks:
      - id: ruff
        name: "🔍 コード品質検査騎士"
        args: [--fix, --exit-non-zero-on-fix, --line-length=120]

  # セキュリティ検査
  - repo: https://github.com/PyCQA/bandit
    rev: 1.7.5
    hooks:
      - id: bandit
        name: "🛡️ セキュリティ検査騎士"
        args: [-ll, -i, -r, ., -x, tests,venv,node_modules,dashboard_env,projects]

  # Docstring検証
  - repo: https://github.com/pycqa/pydocstyle
    rev: 6.3.0
    hooks:
      - id: pydocstyle
        name: "📚 Docstring検証騎士"
        args: [--convention=google]

  # 型チェック
  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: v1.8.0
    hooks:
      - id: mypy
        name: "🔒 型検証騎士"
        args: [--ignore-missing-imports, --no-strict-optional]
        additional_dependencies: [types-requests, types-pyyaml]
        files: ^(libs|commands|workers)/.*\.py$

  # エルダーズギルド カスタムフック
  - repo: local
    hooks:
      # 既存のインシデント騎士団ガード
      - id: incident-knights-guard
        name: "🛡️ インシデント騎士団ガード"
        entry: python3 -m libs.precommit_incident_guard
        language: python
        pass_filenames: false
        always_run: true
        description: "エルダーズギルド独自のセキュリティ&リスク検出システム"

      # 新規：自己修復システム
      - id: knights-self-healing
        name: "⚔️ インシデント騎士団自動修復"
        entry: python3 scripts/knights_self_healing.py --auto-fix
        language: python
        pass_filenames: false
        always_run: true
        stages: [pre-commit]
        description: "921個の問題を自動検出・修正"

      # 新規：インポートエラー自動修復
      - id: import-error-auto-fix
        name: "📦 インポートエラー自動修復騎士"
        entry: python3 scripts/fix_import_errors.py
        language: python
        files: \.py$
        pass_filenames: true
        stages: [pre-commit]
        description: "インポートエラーを自動的に修正"

      # 新規：エルダーズ・ハーモニー整合性
      - id: elder-harmony-check
        name: "🏛️ エルダーズ・ハーモニー整合性チェック"
        entry: python3 scripts/check_elder_harmony.py
        language: python
        pass_filenames: false
        always_run: true
        stages: [pre-commit]
        description: "4賢者システムの整合性を確認"

      # 新規：環境変数自動補完
      - id: env-auto-setup
        name: "🔧 環境変数自動補完騎士"
        entry: python3 scripts/env_auto_setup.py
        language: python
        pass_filenames: false
        always_run: true
        stages: [pre-commit]
        description: "必要な環境変数を自動設定"

      # 新規：テストカバレッジ監視
      - id: test-coverage-guard
        name: "📊 テストカバレッジ監視騎士"
        entry: python3 scripts/coverage_guard.py --min-coverage=80
        language: python
        pass_filenames: false
        stages: [pre-push]
        description: "テストカバレッジ80%以上を保証"

# Configuration
default_language_version:
  python: python3.12

fail_fast: false

# CI-specific settings
ci:
  autofix_commit_msg: |
    [pre-commit.ci] auto fixes from pre-commit hooks

    for more information, see https://pre-commit.ci
  autofix_prs: true
  autoupdate_branch: ''
  autoupdate_commit_msg: '[pre-commit.ci] pre-commit autoupdate'
  autoupdate_schedule: weekly
  skip: []
  submodules: false
