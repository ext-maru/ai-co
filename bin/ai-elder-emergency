#!/usr/bin/env python3
"""
AI Elder Emergency - ç·Šæ€¥æ™‚å¯¾å¿œã‚³ãƒãƒ³ãƒ‰
ã‚·ã‚¹ãƒ†ãƒ éšœå®³ã‚„ç·Šæ€¥äº‹æ…‹ã§ã®è¿…é€Ÿãªå¯¾å¿œ
"""

import sys
import argparse
import subprocess
from datetime import datetime
from pathlib import Path

PROJECT_ROOT = Path(__file__).parent.parent

def trigger_emergency_council():
    """ç·Šæ€¥è©•è­°ä¼šã‚’å¬é›†"""
    print("ğŸš¨ ç·Šæ€¥ã‚¨ãƒ«ãƒ€ãƒ¼è©•è­°ä¼šã‚’å¬é›†ä¸­...")
    print("="*60)
    
    # è©•è­°ä¼šå¬é›†
    subprocess.run([
        sys.executable,
        str(PROJECT_ROOT / "commands" / "ai_elder_council.py"),
        "simulate",
        "--type", "emergency"
    ])
    
    # ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆé¨å£«å›£ã‚‚å‹•å“¡
    print("\nâš”ï¸ ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆé¨å£«å›£ã‚’ç·Šæ€¥å‹•å“¡...")
    subprocess.run([
        sys.executable, 
        str(PROJECT_ROOT / "commands" / "ai_incident_knights.py"),
        "status"
    ])

def system_health_check():
    """ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®å¥åº·è¨ºæ–­"""
    print("ğŸ¥ ã‚·ã‚¹ãƒ†ãƒ å¥åº·è¨ºæ–­å®Ÿè¡Œä¸­...")
    print("="*60)
    
    checks = [
        ("RabbitMQ", "systemctl is-active rabbitmq-server"),
        ("PostgreSQL", "systemctl is-active postgresql"),
        ("AI Workers", "ps aux | grep -c 'worker'"),
        ("Disk Space", "df -h / | tail -1 | awk '{print $5}'"),
        ("Memory", "free -m | grep Mem | awk '{print ($3/$2)*100}'")
    ]
    
    results = []
    for name, cmd in checks:
        result = subprocess.run(cmd, shell=True, capture_output=True, text=True)
        status = "âœ…" if result.returncode == 0 else "âŒ"
        results.append(f"{status} {name}: {result.stdout.strip()}")
    
    print("\n".join(results))
    return results

def rollback_system(version=None):
    """ã‚·ã‚¹ãƒ†ãƒ ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯"""
    print("â®ï¸ ã‚·ã‚¹ãƒ†ãƒ ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æº–å‚™ä¸­...")
    
    if not version:
        # æœ€æ–°ã®å®‰å®šãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—
        print("æœ€æ–°ã®å®‰å®šãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æ¤œç´¢ä¸­...")
        # å®Ÿéš›ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ã¯ã“ã“ã«å®Ÿè£…
        print("âš ï¸  ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½ã¯æ…é‡ã«ä½¿ç”¨ã—ã¦ãã ã•ã„")
    else:
        print(f"ãƒãƒ¼ã‚¸ãƒ§ãƒ³ {version} ã¸ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æº–å‚™ä¸­...")

def emergency_notification(message, severity="high"):
    """ç·Šæ€¥é€šçŸ¥é€ä¿¡"""
    print(f"\nğŸ“¢ ç·Šæ€¥é€šçŸ¥é€ä¿¡: [{severity.upper()}]")
    print(f"ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: {message}")
    
    # Slacké€šçŸ¥ï¼ˆå®Ÿè£…æ¸ˆã¿ã®å ´åˆï¼‰
    try:
        subprocess.run([
            sys.executable,
            "-c",
            f"""
from libs.slack_integration import send_notification
send_notification('#{severity}', '{message}', mention='@channel' if '{severity}' == 'critical' else None)
"""
        ])
        print("âœ… Slacké€šçŸ¥é€ä¿¡å®Œäº†")
    except:
        print("âš ï¸  Slacké€šçŸ¥é€ä¿¡å¤±æ•—")

def create_incident_report(title, description, severity="high"):
    """ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆãƒ¬ãƒãƒ¼ãƒˆä½œæˆ"""
    timestamp = datetime.now()
    report = {
        "id": timestamp.strftime("%Y%m%d_%H%M%S"),
        "timestamp": timestamp.isoformat(),
        "title": title,
        "description": description,
        "severity": severity,
        "reported_by": "Claude Elder",
        "status": "investigating"
    }
    
    # ãƒ¬ãƒãƒ¼ãƒˆä¿å­˜
    report_dir = PROJECT_ROOT / "knowledge_base" / "incident_reports"
    report_dir.mkdir(exist_ok=True)
    
    filename = f"incident_{report['id']}.json"
    filepath = report_dir / filename
    
    import json
    with open(filepath, 'w', encoding='utf-8') as f:
        json.dump(report, f, ensure_ascii=False, indent=2)
    
    print(f"\nğŸ“„ ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆãƒ¬ãƒãƒ¼ãƒˆä½œæˆ: {filepath}")
    return report

def emergency_fix_common_issues():
    """ã‚ˆãã‚ã‚‹å•é¡Œã®ç·Šæ€¥ä¿®æ­£"""
    print("\nğŸ”§ ä¸€èˆ¬çš„ãªå•é¡Œã®è‡ªå‹•ä¿®æ­£ã‚’è©¦è¡Œä¸­...")
    
    fixes = [
        {
            "name": "RabbitMQæ¥ç¶šãƒªã‚»ãƒƒãƒˆ",
            "cmd": "systemctl restart rabbitmq-server",
            "check": "systemctl is-active rabbitmq-server"
        },
        {
            "name": "å¤ã„ãƒ­ãƒƒã‚¯ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤",
            "cmd": "find /tmp -name '*.lock' -mtime +1 -delete",
            "check": "echo 'Cleaned'"
        },
        {
            "name": "ãƒ‡ã‚£ã‚¹ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ç¢ºä¿",
            "cmd": "find /var/log -name '*.log' -mtime +7 -delete",
            "check": "df -h /"
        }
    ]
    
    for fix in fixes:
        print(f"\nğŸ”§ {fix['name']}...")
        result = subprocess.run(fix['cmd'], shell=True, capture_output=True)
        if result.returncode == 0:
            print(f"âœ… {fix['name']} å®Œäº†")
            subprocess.run(fix['check'], shell=True)
        else:
            print(f"âŒ {fix['name']} å¤±æ•—")

def main():
    parser = argparse.ArgumentParser(
        description='ç·Šæ€¥æ™‚å¯¾å¿œã‚³ãƒãƒ³ãƒ‰ - ã‚·ã‚¹ãƒ†ãƒ éšœå®³æ™‚ã®è¿…é€Ÿãªå¯¾å¿œ'
    )
    
    subparsers = parser.add_subparsers(dest='command', help='ç·Šæ€¥å¯¾å¿œã‚³ãƒãƒ³ãƒ‰')
    
    # ç·Šæ€¥è©•è­°ä¼š
    council_parser = subparsers.add_parser('council', help='ç·Šæ€¥è©•è­°ä¼šå¬é›†')
    
    # ã‚·ã‚¹ãƒ†ãƒ ãƒã‚§ãƒƒã‚¯
    check_parser = subparsers.add_parser('check', help='ã‚·ã‚¹ãƒ†ãƒ å¥åº·è¨ºæ–­')
    
    # ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
    rollback_parser = subparsers.add_parser('rollback', help='ã‚·ã‚¹ãƒ†ãƒ ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯')
    rollback_parser.add_argument('--version', help='ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å…ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³')
    
    # ç·Šæ€¥é€šçŸ¥
    notify_parser = subparsers.add_parser('notify', help='ç·Šæ€¥é€šçŸ¥é€ä¿¡')
    notify_parser.add_argument('message', help='é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸')
    notify_parser.add_argument('--severity', default='high',
                             choices=['low', 'medium', 'high', 'critical'],
                             help='é‡è¦åº¦')
    
    # ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆä½œæˆ
    incident_parser = subparsers.add_parser('incident', help='ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆä½œæˆ')
    incident_parser.add_argument('title', help='ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆã‚¿ã‚¤ãƒˆãƒ«')
    incident_parser.add_argument('description', help='è©³ç´°èª¬æ˜')
    incident_parser.add_argument('--severity', default='high',
                               choices=['low', 'medium', 'high', 'critical'])
    
    # è‡ªå‹•ä¿®æ­£
    fix_parser = subparsers.add_parser('fix', help='ä¸€èˆ¬çš„ãªå•é¡Œã®è‡ªå‹•ä¿®æ­£')
    
    # ã‚ªãƒ¼ãƒ«ã‚¤ãƒ³ãƒ¯ãƒ³ç·Šæ€¥å¯¾å¿œ
    all_parser = subparsers.add_parser('all', help='å…¨ç·Šæ€¥å¯¾å¿œå®Ÿè¡Œ')
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    print(f"\nğŸš¨ ç·Šæ€¥å¯¾å¿œãƒ¢ãƒ¼ãƒ‰: {args.command}")
    print("="*60)
    
    if args.command == 'council':
        trigger_emergency_council()
    elif args.command == 'check':
        system_health_check()
    elif args.command == 'rollback':
        rollback_system(args.version)
    elif args.command == 'notify':
        emergency_notification(args.message, args.severity)
    elif args.command == 'incident':
        create_incident_report(args.title, args.description, args.severity)
    elif args.command == 'fix':
        emergency_fix_common_issues()
    elif args.command == 'all':
        # å…¨å¯¾å¿œå®Ÿè¡Œ
        print("ğŸš¨ å®Œå…¨ç·Šæ€¥å¯¾å¿œãƒ¢ãƒ¼ãƒ‰\n")
        system_health_check()
        print()
        emergency_fix_common_issues()
        print()
        trigger_emergency_council()
        print()
        emergency_notification("ç·Šæ€¥å¯¾å¿œãƒ¢ãƒ¼ãƒ‰å®Ÿè¡Œä¸­", "high")

if __name__ == "__main__":
    main()