#!/bin/bash
# AI Company Gité‹ç”¨ã‚³ãƒžãƒ³ãƒ‰

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
cd /home/aicompany/ai_co

# ä»®æƒ³ç’°å¢ƒã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ãƒˆï¼ˆå¿…è¦ãªå ´åˆï¼‰
if [ -f "/home/aicompany/ai_co/venv/bin/activate" ]; then
    source /home/aicompany/ai_co/venv/bin/activate
fi

# Gitã‚³ãƒžãƒ³ãƒ‰ã®ãƒ©ãƒƒãƒ‘ãƒ¼é–¢æ•°ï¼ˆæ‰€æœ‰æ¨©ãƒã‚§ãƒƒã‚¯ã‚’å›žé¿ï¼‰
git_safe() {
    if [ "$(whoami)" = "root" ]; then
        # rootã®å ´åˆã¯aicompanyãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦å®Ÿè¡Œ
        sudo -u aicompany git -C /home/aicompany/ai_co "$@"
    else
        git "$@"
    fi
}

case "$1" in
    status)
        echo "ðŸ“Š Git Status:"
        git_safe status
        echo ""
        echo "ðŸ“ Current branch:"
        git_safe branch --show-current
        echo ""
        echo "ðŸ“œ Recent commits:"
        git_safe log --oneline -n 10
        ;;
    
    flow)
        echo "ðŸŒŠ Git Flow Status:"
        echo "Branches:"
        git_safe branch -a
        echo ""
        echo "Develop ahead of main by:"
        git_safe rev-list --count main..develop 2>/dev/null || echo "0"
        echo "commits"
        ;;
    
    release)
        VERSION=${2:-$(date +%Y.%m.%d)}
        echo "ðŸš€ Creating release v$VERSION..."
        cd /home/aicompany/ai_co
        if [ "$(whoami)" = "root" ]; then
            sudo -u aicompany python3 -c "
from libs.git_flow_manager import GitFlowManager
gfm = GitFlowManager()
if gfm.create_release('$VERSION'):
    print('âœ… Release created successfully!')
else:
    print('âŒ Release failed')
"
        else
            python3 -c "
from libs.git_flow_manager import GitFlowManager
gfm = GitFlowManager()
if gfm.create_release('$VERSION'):
    print('âœ… Release created successfully!')
else:
    print('âŒ Release failed')
"
        fi
        ;;
    
    cleanup)
        echo "ðŸ§¹ Cleaning up merged branches..."
        git_safe branch --merged | grep -E 'auto/|feature/' | xargs -n 1 git_safe branch -d 2>/dev/null || true
        echo "âœ… Cleanup complete"
        ;;
    
    fix-ownership)
        echo "ðŸ”§ Fixing Git ownership issues..."
        git config --global --add safe.directory /home/aicompany/ai_co
        sudo -u aicompany git config --global --add safe.directory /home/aicompany/ai_co
        echo "âœ… Ownership issues fixed"
        ;;
    
    *)
        echo "Usage: ai-git {status|flow|release|cleanup|fix-ownership}"
        echo ""
        echo "Commands:"
        echo "  status        - Show git status"
        echo "  flow          - Show git flow status" 
        echo "  release       - Create a release (develop â†’ main)"
        echo "  cleanup       - Remove merged branches"
        echo "  fix-ownership - Fix Git ownership issues"
        ;;
esac
