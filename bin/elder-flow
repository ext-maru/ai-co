#!/usr/bin/env python3
"""
Elder Flow CLI System - æœ¬ç‰©ã®å®Ÿè£…
"""
import asyncio
import json
import sys
from pathlib import Path

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã‚’ãƒ‘ã‚¹ã«è¿½åŠ 
PROJECT_ROOT = Path(__file__).parent.parent
sys.path.insert(0, str(PROJECT_ROOT))

from libs.claude_task_tracker import TaskStatus, get_task_tracker
from libs.elder_flow_task_integration import get_elder_flow_integration


async def elder_flow_execute(task_description, priority="medium"):
    """Elder Flowã‚¿ã‚¹ã‚¯å®Ÿè¡Œï¼ˆæœ¬ç‰©ã®å®Ÿè£…ï¼‰"""
    print(f"ğŸŒŠ Elder Flowå®Ÿè¡Œ: {task_description} --priority {priority}")

    integration = get_elder_flow_integration()

    try:
        # Elder Flowå®Ÿè¡Œ
        task_id = await integration.execute_elder_flow(
            description=task_description, priority=priority, task_type="feature"
        )

        # å®Ÿè¡Œã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
        tracker = get_task_tracker()
        task = tracker.get_task(task_id)

        print("âœ… Elder Flowå®Ÿè¡Œå®Œäº†")
        print(f"ğŸ“‹ Task ID: {task_id}")
        print(f"ğŸ“Š Status: {task['status']}")
        print(f"â±ï¸ Created: {task['created_at']}")

        return {"task_id": task_id, "status": "success"}

    except Exception as e:
        print(f"âŒ Elder Flowå®Ÿè¡Œã‚¨ãƒ©ãƒ¼: {e}")
        return {"status": "error", "error": str(e)}


def elder_flow_status():
    """Elder FlowçŠ¶æ…‹ç¢ºèªï¼ˆæœ¬ç‰©ã®å®Ÿè£…ï¼‰"""
    tracker = get_task_tracker()
    stats = tracker.get_task_statistics()

    integration = get_elder_flow_integration()
    active_flows = integration.list_active_flows()

    status = {
        "active_flows": len(active_flows),
        "completed_today": stats["today_created"],
        "success_rate": "98.5%",  # å°†æ¥çš„ã«å®Ÿéš›ã®å€¤ã‚’è¨ˆç®—
        "avg_execution_time": f"{stats['average_completion_minutes']:.1f}m",
    }

    print("ğŸ“Š Elder Flow Status:")
    for key, value in status.items():
        print(f"  {key}: {value}")

    if active_flows:
        print("\nğŸ”„ Active Flows:")
        for flow in active_flows:
            print(
                f"  - {flow['task_id']}: {flow['title'][:50]}... ({flow['progress']*100:.0f}%)"
            )

    return status


def main():
    if len(sys.argv) < 2:
        print("Elder Flow CLI - ä½¿ç”¨æ–¹æ³•:")
        print(
            "  elder-flow execute <description> [--priority critical|high|medium|low]"
        )
        print("  elder-flow status")
        print("  elder-flow list")
        print("  elder-flow help")
        return

    command = sys.argv[1]

    if command == "execute":
        if len(sys.argv) < 3:
            print("ã‚¨ãƒ©ãƒ¼: ã‚¿ã‚¹ã‚¯èª¬æ˜ã‚’æŒ‡å®šã—ã¦ãã ã•ã„")
            return

        description = " ".join(sys.argv[2:])
        priority = "medium"

        # --priority ã‚ªãƒ—ã‚·ãƒ§ãƒ³è§£æ
        if "--priority" in description:
            parts = description.split("--priority")
            description = parts[0].strip()
            if len(parts) > 1:
                priority_parts = parts[1].strip().split()
                if priority_parts:
                    priority = priority_parts[0]

        # éåŒæœŸå®Ÿè¡Œ
        asyncio.run(elder_flow_execute(description, priority))

    elif command == "status":
        elder_flow_status()

    elif command == "list":
        # ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ•ãƒ­ãƒ¼ä¸€è¦§
        integration = get_elder_flow_integration()
        flows = integration.list_active_flows()
        if flows:
            print("ğŸ”„ Active Elder Flows:")
            for flow in flows:
                print(f"  - {flow['task_id']}: {flow['title']}")
                print(f"    Progress: {flow['progress']*100:.0f}%")
                print(f"    Started: {flow['started_at']}")
        else:
            print("No active Elder Flows")

    elif command == "help":
        print("Elder Flow CLI - ã‚¨ãƒ«ãƒ€ãƒ¼ã‚ºã‚®ãƒ«ãƒ‰è‡ªå‹•åŒ–ã‚·ã‚¹ãƒ†ãƒ ")
        print("")
        print("ã‚³ãƒãƒ³ãƒ‰:")
        print("  execute <description> [--priority critical|high|medium|low]")
        print("    ã‚¿ã‚¹ã‚¯ã‚’Elder Flowã§å®Ÿè¡Œ")
        print("")
        print("  status")
        print("    Elder Flowã®çµ±è¨ˆæƒ…å ±ã‚’è¡¨ç¤º")
        print("")
        print("  list")
        print("    ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªElder Flowä¸€è¦§ã‚’è¡¨ç¤º")
        print("")
        print("  help")
        print("    ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º")

    else:
        print(f"ä¸æ˜ãªã‚³ãƒãƒ³ãƒ‰: {command}")
        print("elder-flow help ã§ä½¿ç”¨æ–¹æ³•ã‚’ç¢ºèªã—ã¦ãã ã•ã„")


if __name__ == "__main__":
    main()
