#!/usr/bin/env python3
"""
AI Company ãƒ‡ãƒ¼ã‚¿ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ã‚³ãƒãƒ³ãƒ‰
é«˜åº¦ãƒ‡ãƒ¼ã‚¿ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®CLI

ä½¿ç”¨æ–¹æ³•:
  ai-analytics run         - å³åº§ã«åˆ†æã‚’å®Ÿè¡Œ
  ai-analytics report      - æœ€æ–°ãƒ¬ãƒãƒ¼ãƒˆã‚’è¡¨ç¤º
  ai-analytics dashboard   - ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’èµ·å‹•
  ai-analytics schedule    - ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ã‚’èµ·å‹•

è¨­è¨ˆ: ã‚¯ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ«ãƒ€ãƒ¼
å®Ÿè£…æ—¥: 2025å¹´7æœˆ9æ—¥
"""

import sys
import asyncio
import json
from pathlib import Path
from datetime import datetime

PROJECT_ROOT = Path(__file__).parent.parent
sys.path.insert(0, str(PROJECT_ROOT))

from libs.data_analytics_platform import DataAnalyticsPlatform
from web.analytics_dashboard_view import AnalyticsDashboardView

def print_banner():
    """ãƒãƒŠãƒ¼è¡¨ç¤º"""
    print("ğŸ“Š" * 30)
    print("ğŸ”  AI Company ãƒ‡ãƒ¼ã‚¿ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹  ğŸ”")
    print("ğŸ“Š  é«˜åº¦åˆ†æãƒ»äºˆæ¸¬ãƒ»æœ€é©åŒ–ã‚·ã‚¹ãƒ†ãƒ   ğŸ“Š")
    print("ğŸ“Š" * 30)
    print()

async def run_analysis():
    """åˆ†æã‚’å®Ÿè¡Œ"""
    print("ğŸš€ ãƒ‡ãƒ¼ã‚¿åˆ†æã‚’é–‹å§‹ã—ã¾ã™...")
    
    try:
        platform = DataAnalyticsPlatform(PROJECT_ROOT)
        report_path = await platform.run_full_analysis()
        
        print(f"\nâœ… åˆ†æå®Œäº†ï¼")
        print(f"ğŸ“Š ãƒ¬ãƒãƒ¼ãƒˆ: {report_path}")
        
        # ãƒ¬ãƒãƒ¼ãƒˆã®è¦ç´„ã‚’è¡¨ç¤º
        with open(report_path, 'r', encoding='utf-8') as f:
            report = json.load(f)
        
        print(f"\nğŸ“ˆ åˆ†æã‚µãƒãƒªãƒ¼:")
        print(f"  â€¢ åˆ†æé …ç›®: {report['summary']['total_analyses']}å€‹")
        print(f"  â€¢ å¹³å‡ä¿¡é ¼åº¦: {report['summary']['average_confidence'] * 100:.0f}%")
        print(f"  â€¢ æ´å¯Ÿ: {report['summary']['key_findings']}å€‹")
        print(f"  â€¢ æ¨å¥¨äº‹é …: {report['summary']['recommendations']}å€‹")
        
        if report['executive_insights']:
            print(f"\nğŸ” ä¸»è¦ãªæ´å¯Ÿ:")
            for insight in report['executive_insights'][:3]:
                print(f"  â€¢ {insight}")
        
        if report['action_items']:
            print(f"\nğŸ¯ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¢ã‚¤ãƒ†ãƒ :")
            for item in report['action_items'][:3]:
                print(f"  â€¢ {item}")
                
    except Exception as e:
        print(f"\nâŒ ã‚¨ãƒ©ãƒ¼: {e}")
        sys.exit(1)

def show_latest_report():
    """æœ€æ–°ãƒ¬ãƒãƒ¼ãƒˆã‚’è¡¨ç¤º"""
    print("ğŸ“Š æœ€æ–°ã®åˆ†æãƒ¬ãƒãƒ¼ãƒˆã‚’è¡¨ç¤ºã—ã¾ã™...\n")
    
    try:
        view = AnalyticsDashboardView(PROJECT_ROOT)
        report = view.get_latest_report()
        
        if not report:
            print("âŒ ãƒ¬ãƒãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
            print("   'ai-analytics run' ã§åˆ†æã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„")
            return
        
        formatted = view.format_report_for_display(report)
        
        print(f"ğŸ“… ç”Ÿæˆæ—¥æ™‚: {formatted['generated_at']}")
        print(f"ğŸ“Š åˆ†æé …ç›®: {formatted['summary']['total_analyses']}å€‹")
        print(f"ğŸ¯ ä¿¡é ¼åº¦: {formatted['summary']['average_confidence'] * 100:.0f}%\n")
        
        # å„åˆ†æçµæœã‚’è¡¨ç¤º
        for analysis in formatted['analyses']:
            print(f"\n{'='*60}")
            print(f"ğŸ“ˆ {analysis['type']} (ä¿¡é ¼åº¦: {analysis['confidence']*100:.0f}%)")
            print(f"{'='*60}")
            
            # ãƒ¡ãƒˆãƒªã‚¯ã‚¹
            if analysis['metrics']:
                print("\nğŸ“Š ãƒ¡ãƒˆãƒªã‚¯ã‚¹:")
                for metric in analysis['metrics']:
                    print(f"  â€¢ {metric['label']}: {metric['value']}{metric['unit']}")
            
            # æ´å¯Ÿ
            if analysis['insights']:
                print("\nğŸ” æ´å¯Ÿ:")
                for insight in analysis['insights']:
                    print(f"  â€¢ {insight}")
            
            # äºˆæ¸¬
            if analysis['predictions']:
                print("\nğŸ”® äºˆæ¸¬:")
                for key, value in analysis['predictions'].items():
                    print(f"  â€¢ {key}: {value}")
            
            # æ¨å¥¨äº‹é …
            if analysis['recommendations']:
                print("\nğŸ’¡ æ¨å¥¨äº‹é …:")
                for rec in analysis['recommendations']:
                    print(f"  â€¢ {rec}")
        
        # ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¢ã‚¤ãƒ†ãƒ 
        if formatted.get('action_items'):
            print(f"\n\n{'='*60}")
            print("ğŸ¯ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¢ã‚¤ãƒ†ãƒ ")
            print(f"{'='*60}")
            for item in formatted['action_items']:
                print(f"â€¢ {item}")
                
    except Exception as e:
        print(f"\nâŒ ã‚¨ãƒ©ãƒ¼: {e}")
        sys.exit(1)

def start_dashboard():
    """ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’èµ·å‹•"""
    print("ğŸš€ Elder Dashboard Evolution ã‚’èµ·å‹•ã—ã¾ã™...")
    print("ğŸ“Š ãƒ–ãƒ©ã‚¦ã‚¶ã§ http://localhost:5000 ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„\n")
    
    try:
        from web.elder_dashboard_evolution import ElderDashboardEvolution
        dashboard = ElderDashboardEvolution()
        dashboard.run(debug=False)
    except Exception as e:
        print(f"\nâŒ ã‚¨ãƒ©ãƒ¼: {e}")
        sys.exit(1)

def start_scheduler():
    """ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ã‚’èµ·å‹•"""
    print("ğŸ“… ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ã‚’èµ·å‹•ã—ã¾ã™...")
    print("   â€¢ æ¯æ—¥ 09:00 - åŒ…æ‹¬çš„åˆ†æ")
    print("   â€¢ æ¯æ—¥ 18:00 - åŒ…æ‹¬çš„åˆ†æ\n")
    
    try:
        from scripts.analytics_scheduler import AnalyticsScheduler
        scheduler = AnalyticsScheduler()
        scheduler.start()
    except Exception as e:
        print(f"\nâŒ ã‚¨ãƒ©ãƒ¼: {e}")
        sys.exit(1)

def show_help():
    """ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º"""
    print("ä½¿ç”¨æ–¹æ³•: ai-analytics [ã‚³ãƒãƒ³ãƒ‰]\n")
    print("ã‚³ãƒãƒ³ãƒ‰:")
    print("  run         å³åº§ã«åˆ†æã‚’å®Ÿè¡Œ")
    print("  report      æœ€æ–°ãƒ¬ãƒãƒ¼ãƒˆã‚’è¡¨ç¤º")
    print("  dashboard   ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’èµ·å‹•")
    print("  schedule    ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ã‚’èµ·å‹•")
    print("  help        ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º")
    print()
    print("ä¾‹:")
    print("  ai-analytics run      # åˆ†æã‚’å®Ÿè¡Œ")
    print("  ai-analytics report   # çµæœã‚’ç¢ºèª")

def main():
    """ãƒ¡ã‚¤ãƒ³å‡¦ç†"""
    print_banner()
    
    if len(sys.argv) < 2:
        show_help()
        sys.exit(0)
    
    command = sys.argv[1].lower()
    
    if command == 'run':
        asyncio.run(run_analysis())
    elif command == 'report':
        show_latest_report()
    elif command == 'dashboard':
        start_dashboard()
    elif command == 'schedule':
        start_scheduler()
    elif command == 'help':
        show_help()
    else:
        print(f"âŒ ä¸æ˜ãªã‚³ãƒãƒ³ãƒ‰: {command}")
        show_help()
        sys.exit(1)

if __name__ == "__main__":
    main()