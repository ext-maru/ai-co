#!/usr/bin/env python3
"""
AI Company ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã‚³ãƒãƒ³ãƒ‰
ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã®ç¢ºèªã¨å¯è¦–åŒ–ã‚’è¡Œã„ã¾ã™
"""

import argparse
import os
import sys
import webbrowser
from pathlib import Path

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã‚’Pythonãƒ‘ã‚¹ã«è¿½åŠ 
sys.path.insert(0, str(Path(__file__).parent.parent))

from scripts.coverage_report import CoverageReporter


def main():
    parser = argparse.ArgumentParser(
        description='AI Company ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ„ãƒ¼ãƒ«',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
ä½¿ç”¨ä¾‹:
  ai-test-coverage              # ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
  ai-test-coverage --html       # HTMLãƒ¬ãƒãƒ¼ãƒˆã‚’é–‹ã
  ai-test-coverage --watch      # ç¶™ç¶šçš„ã«ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’ç›£è¦–
  ai-test-coverage --threshold 90  # ã‚«ãƒãƒ¬ãƒƒã‚¸é–¾å€¤ã‚’è¨­å®š
        """
    )
    
    parser.add_argument(
        '--html', '-H',
        action='store_true',
        help='HTMLã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã'
    )
    
    parser.add_argument(
        '--watch', '-w',
        action='store_true',
        help='ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´ã‚’ç›£è¦–ã—ã¦è‡ªå‹•çš„ã«ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’æ›´æ–°'
    )
    
    parser.add_argument(
        '--threshold', '-t',
        type=float,
        default=80.0,
        help='ã‚«ãƒãƒ¬ãƒƒã‚¸ã®é–¾å€¤ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 80%%ï¼‰'
    )
    
    parser.add_argument(
        '--path', '-p',
        default='tests/unit',
        help='ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®ãƒ‘ã‚¹ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: tests/unitï¼‰'
    )
    
    args = parser.parse_args()
    
    reporter = CoverageReporter()
    
    if args.watch:
        print("ğŸ” ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´ã‚’ç›£è¦–ä¸­... (Ctrl+Cã§çµ‚äº†)")
        try:
            import time
            from watchdog.observers import Observer
            from watchdog.events import FileSystemEventHandler
            
            class TestWatcher(FileSystemEventHandler):
                def on_modified(self, event):
                    if event.src_path.endswith('.py'):
                        print(f"\nğŸ“ å¤‰æ›´æ¤œå‡º: {event.src_path}")
                        reporter.main()
            
            observer = Observer()
            observer.schedule(TestWatcher(), str(reporter.project_root), recursive=True)
            observer.start()
            
            try:
                while True:
                    time.sleep(1)
            except KeyboardInterrupt:
                observer.stop()
            observer.join()
            
        except ImportError:
            print("âŒ watchdogãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“")
            print("pip install watchdog ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„")
            sys.exit(1)
    
    else:
        # é€šå¸¸ã®ã‚«ãƒãƒ¬ãƒƒã‚¸å®Ÿè¡Œ
        reporter.main()
        
        # HTMLãƒ¬ãƒãƒ¼ãƒˆã‚’é–‹ã
        if args.html:
            html_path = reporter.htmlcov_dir / "index.html"
            if html_path.exists():
                print(f"\nğŸŒ ãƒ–ãƒ©ã‚¦ã‚¶ã§ãƒ¬ãƒãƒ¼ãƒˆã‚’é–‹ã„ã¦ã„ã¾ã™...")
                webbrowser.open(f"file://{html_path}")
            else:
                print("âŒ HTMLãƒ¬ãƒãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")


if __name__ == "__main__":
    main()