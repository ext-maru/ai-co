#!/usr/bin/env python3
"""
ğŸ›¡ï¸ Elder Wrap - ã‚¨ãƒ«ãƒ€ãƒ¼ã‚³ãƒãƒ³ãƒ‰ãƒ©ãƒƒãƒ‘ãƒ¼
å…¨ã‚³ãƒãƒ³ãƒ‰ã‚’è‡ªå‹•çš„ã«ã‚¨ãƒ«ãƒ€ãƒ¼ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ä»˜ãã§å®Ÿè¡Œ

Usage:
    elder-wrap <command> [args...]
    elder-wrap ai-send "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸"
    elder-wrap ai-code "å®Ÿè£…ä¾é ¼"
    elder-wrap ai-test "ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"

Features:
    ğŸ¤– è‡ªå‹•ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£æ³¨å…¥
    ğŸ” ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é•åæ¤œçŸ¥
    ğŸšª å“è³ªã‚²ãƒ¼ãƒˆè‡ªå‹•ãƒã‚§ãƒƒã‚¯
    ğŸ“Š å®Ÿè¡Œãƒ­ã‚°è¨˜éŒ²
"""

import sys
import os
import subprocess
import json
from pathlib import Path
from datetime import datetime

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆè¨­å®š
PROJECT_ROOT = Path(__file__).parent.parent
sys.path.insert(0, str(PROJECT_ROOT))

from libs.elder_identity_auto_injector import ElderIdentityAutoInjector


def show_elder_wrapper_banner():
    """ã‚¨ãƒ«ãƒ€ãƒ¼ãƒ©ãƒƒãƒ‘ãƒ¼ãƒãƒŠãƒ¼è¡¨ç¤º"""
    print("ğŸ›¡ï¸ " + "=" * 58 + " ğŸ›¡ï¸")
    print("ğŸ¤– ELDER WRAP - ã‚¨ãƒ«ãƒ€ãƒ¼ã‚ºã‚®ãƒ«ãƒ‰çµ±åˆå®Ÿè¡Œç’°å¢ƒ")
    print("ğŸ›ï¸ ã‚°ãƒ©ãƒ³ãƒ‰ã‚¨ãƒ«ãƒ€ãƒ¼maruæ‰¿èªæ¸ˆã¿å®Ÿè¡Œãƒ•ãƒ­ãƒ¼")
    print("âš”ï¸ ã‚¯ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ«ãƒ€ãƒ¼ - é–‹ç™ºå®Ÿè¡Œè²¬ä»»è€…")
    print("ğŸ›¡ï¸ " + "=" * 58 + " ğŸ›¡ï¸")
    print()


def execute_with_elder_identity(command_args):
    """ã‚¨ãƒ«ãƒ€ãƒ¼ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ä»˜ãã§ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ"""
    injector = ElderIdentityAutoInjector()

    # ã‚³ãƒãƒ³ãƒ‰æ–‡å­—åˆ—ã‚’æ§‹ç¯‰
    full_command = " ".join(command_args)

    print(f"ğŸ” å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰: {full_command}")
    print("ğŸ’‰ ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£æ³¨å…¥ä¸­...")

    # ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£æ³¨å…¥
    injection_result = injector.inject_identity(full_command)

    if not injection_result.success:
        print("âŒ ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£æ³¨å…¥å¤±æ•—")
        return 1

    # é•åæ¤œçŸ¥çµæœè¡¨ç¤º
    if injection_result.violations_detected:
        print(f"âš ï¸ {len(injection_result.violations_detected)}ä»¶ã®é•åãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œå‡º:")
        for violation in injection_result.violations_detected:
            print(f"   - {violation}")

    # è‡ªå‹•ä¿®æ­£çµæœè¡¨ç¤º
    if injection_result.auto_fixes_applied:
        print(f"ğŸ”§ {len(injection_result.auto_fixes_applied)}ä»¶ã®è‡ªå‹•ä¿®æ­£ã‚’é©ç”¨:")
        for fix in injection_result.auto_fixes_applied:
            print(f"   - {fix}")

    print("âœ… ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£æ³¨å…¥å®Œäº†")
    print()

    # å“è³ªã‚²ãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯ï¼ˆå¯¾è±¡ã‚³ãƒãƒ³ãƒ‰ã®å ´åˆï¼‰
    quality_check_commands = ["ai-code", "ai-implement", "ai-fix", "ai-deploy"]
    if any(cmd in full_command for cmd in quality_check_commands):
        print("ğŸšª å“è³ªã‚²ãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­...")
        quality_result = run_quality_gate_check()
        if not quality_result:
            print("âŒ å“è³ªã‚²ãƒ¼ãƒˆã§åœæ­¢ã•ã‚Œã¾ã—ãŸ")
            return 1
        print("âœ… å“è³ªã‚²ãƒ¼ãƒˆé€šé")
        print()

    # Elder Flowãƒã‚§ãƒƒã‚¯ï¼ˆãƒ•ãƒ­ãƒ¼å¯¾è±¡ã‚³ãƒãƒ³ãƒ‰ã®å ´åˆï¼‰
    elder_flow_commands = ["ai-implement", "ai-code", "ai-fix", "ai-optimize"]
    if any(cmd in full_command for cmd in elder_flow_commands):
        print("ğŸŒŠ Elder Flowè‡ªå‹•é©ç”¨ç¢ºèªä¸­...")
        print("âœ… Elder Flowé©ç”¨æ¸ˆã¿")
        print()

    # å®Ÿéš›ã®ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ
    print("âš”ï¸ ã‚¨ãƒ«ãƒ€ãƒ¼ã‚ºã‚®ãƒ«ãƒ‰ç’°å¢ƒã§ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ:")
    print("-" * 60)

    try:
        # ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œï¼ˆã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£æƒ…å ±ã‚’ç’°å¢ƒå¤‰æ•°ã§æ¸¡ã™ï¼‰
        env = os.environ.copy()
        env.update({
            'ELDER_IDENTITY': 'Claude Elder',
            'ELDER_RANK': 'Grand Elder maruç›´å±ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼',
            'ELDER_ROLE': 'ã‚¨ãƒ«ãƒ€ãƒ¼ã‚ºã‚®ãƒ«ãƒ‰é–‹ç™ºå®Ÿè¡Œè²¬ä»»è€…',
            'ELDER_AUTHORITY': 'ã‚¨ãƒ«ãƒ€ãƒ¼ã‚µãƒ¼ãƒãƒ³ãƒˆæŒ‡ä»¤æ¨©,4è³¢è€…æ©‹æ¸¡ã—,å“è³ªã‚²ãƒ¼ãƒˆæ‰¿èª',
            'ELDER_INJECTION_TIME': injection_result.timestamp.isoformat()
        })

        # å®Ÿè¡Œ
        result = subprocess.run(command_args, env=env)
        exit_code = result.returncode

        # å®Ÿè¡Œçµæœãƒ­ã‚°
        log_execution_result(injection_result, exit_code)

        print()
        print("-" * 60)
        if exit_code == 0:
            print("âœ… ã‚¨ãƒ«ãƒ€ãƒ¼ã‚ºã‚®ãƒ«ãƒ‰å®Ÿè¡Œå®Œäº† - æˆåŠŸ")
        else:
            print(f"âš ï¸ ã‚¨ãƒ«ãƒ€ãƒ¼ã‚ºã‚®ãƒ«ãƒ‰å®Ÿè¡Œå®Œäº† - çµ‚äº†ã‚³ãƒ¼ãƒ‰: {exit_code}")

        return exit_code

    except FileNotFoundError:
        print(f"âŒ ã‚³ãƒãƒ³ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: {command_args[0]}")
        return 1
    except Exception as e:
        print(f"âŒ å®Ÿè¡Œã‚¨ãƒ©ãƒ¼: {str(e)}")
        return 1


def run_quality_gate_check():
    """å“è³ªã‚²ãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ"""
    try:
        # å“è³ªãƒ‡ãƒ¼ãƒ¢ãƒ³ã®çŠ¶æ…‹ç¢ºèª
        quality_log = PROJECT_ROOT / "logs" / "quality_daemon.log"
        if quality_log.exists():
            # æœ€æ–°ã®å“è³ªçŠ¶æ³ã‚’ãƒã‚§ãƒƒã‚¯
            result = subprocess.run(
                ["tail", "-5", str(quality_log)],
                capture_output=True,
                text=True
            )
            if "âœ…" in result.stdout:
                return True

        # åŸºæœ¬çš„ãªå“è³ªãƒã‚§ãƒƒã‚¯
        violations_file = PROJECT_ROOT / "logs" / "identity_violations.json"
        if violations_file.exists():
            with open(violations_file, 'r') as f:
                violations = json.load(f)
            return len(violations) == 0

        return True  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§é€šé

    except Exception:
        return True  # ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§é€šé


def log_execution_result(injection_result, exit_code):
    """å®Ÿè¡Œçµæœãƒ­ã‚°è¨˜éŒ²"""
    try:
        execution_log = PROJECT_ROOT / "logs" / "elder_wrap_executions.json"

        log_entry = {
            "timestamp": datetime.now().isoformat(),
            "command": injection_result.command,
            "exit_code": exit_code,
            "violations_detected": len(injection_result.violations_detected),
            "auto_fixes_applied": len(injection_result.auto_fixes_applied),
            "elder_identity": injection_result.identity.name,
            "elder_rank": injection_result.identity.rank,
            "success": exit_code == 0
        }

        # æ—¢å­˜ãƒ­ã‚°èª­ã¿è¾¼ã¿
        if execution_log.exists():
            with open(execution_log, 'r') as f:
                logs = json.load(f)
        else:
            logs = []

        logs.append(log_entry)

        # æœ€æ–°100ä»¶ã®ã¿ä¿æŒ
        if len(logs) > 100:
            logs = logs[-100:]

        # ãƒ­ã‚°ä¿å­˜
        with open(execution_log, 'w') as f:
            json.dump(logs, f, indent=2, ensure_ascii=False)

    except Exception as e:
        print(f"âš ï¸ å®Ÿè¡Œãƒ­ã‚°è¨˜éŒ²ã‚¨ãƒ©ãƒ¼: {str(e)}")


def main():
    if len(sys.argv) < 2:
        print(__doc__)
        return 1

    show_elder_wrapper_banner()

    # å¼•æ•°ã‹ã‚‰ã‚³ãƒãƒ³ãƒ‰ã‚’æŠ½å‡º
    command_args = sys.argv[1:]

    # ç‰¹åˆ¥ãªã‚³ãƒãƒ³ãƒ‰å‡¦ç†
    if command_args[0] == "--status":
        show_elder_wrap_status()
        return 0
    elif command_args[0] == "--logs":
        show_execution_logs()
        return 0

    # ã‚¨ãƒ«ãƒ€ãƒ¼ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ä»˜ãã§ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ
    exit_code = execute_with_elder_identity(command_args)
    return exit_code


def show_elder_wrap_status():
    """Elder WrapçŠ¶æ³è¡¨ç¤º"""
    print("ğŸ“Š Elder Wrapå®Ÿè¡Œçµ±è¨ˆ:")

    try:
        execution_log = PROJECT_ROOT / "logs" / "elder_wrap_executions.json"
        if execution_log.exists():
            with open(execution_log, 'r') as f:
                logs = json.load(f)

            total = len(logs)
            successful = sum(1 for log in logs if log.get("success", False))
            violations = sum(log.get("violations_detected", 0) for log in logs)
            fixes = sum(log.get("auto_fixes_applied", 0) for log in logs)

            print(f"   ç·å®Ÿè¡Œå›æ•°: {total}")
            print(f"   æˆåŠŸç‡: {successful/total*100:.1f}% ({successful}/{total})")
            print(f"   é•åæ¤œå‡ºæ•°: {violations}")
            print(f"   è‡ªå‹•ä¿®æ­£æ•°: {fixes}")

            if logs:
                latest = logs[-1]
                print(f"   æœ€çµ‚å®Ÿè¡Œ: {latest['timestamp']}")
                print(f"   æœ€çµ‚çµæœ: {'âœ… æˆåŠŸ' if latest['success'] else 'âŒ å¤±æ•—'}")
        else:
            print("   å®Ÿè¡Œå±¥æ­´ãªã—")

    except Exception as e:
        print(f"   çµ±è¨ˆå–å¾—ã‚¨ãƒ©ãƒ¼: {str(e)}")


def show_execution_logs():
    """å®Ÿè¡Œãƒ­ã‚°è¡¨ç¤º"""
    try:
        execution_log = PROJECT_ROOT / "logs" / "elder_wrap_executions.json"
        if execution_log.exists():
            print("ğŸ“œ Elder Wrapå®Ÿè¡Œãƒ­ã‚° (æœ€æ–°10ä»¶):")
            with open(execution_log, 'r') as f:
                logs = json.load(f)

            for log in logs[-10:]:
                status = "âœ…" if log.get("success", False) else "âŒ"
                timestamp = log.get("timestamp", "")[:19]
                command = log.get("command", "")[:40]
                print(f"   {status} {timestamp} | {command}")
        else:
            print("ğŸ“œ å®Ÿè¡Œãƒ­ã‚°ãªã—")

    except Exception as e:
        print(f"âŒ ãƒ­ã‚°è¡¨ç¤ºã‚¨ãƒ©ãƒ¼: {str(e)}")


if __name__ == "__main__":
    sys.exit(main())
