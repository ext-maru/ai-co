{% extends "base.html" %}

{% block title %}ç®¡ç†è€…ãƒšãƒ¼ã‚¸ - ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ {% endblock %}

{% block header %}ğŸ› ï¸ ç®¡ç†è€…ãƒšãƒ¼ã‚¸{% endblock %}

{% block content %}
<div class="nav-links">
    <a href="/">ğŸ  ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸</a>
    <a href="/admin/customer/create">ğŸ‘¤ é¡§å®¢ä½œæˆ</a>
    <a href="/admin/settings">âš™ï¸ è¨­å®š</a>
    <a href="/admin">ğŸ”„ æ›´æ–°</a>
</div>

<div class="card">
    <h2>ğŸ“Š é¡§å®¢ä¸€è¦§</h2>
    <p>å…¨é¡§å®¢ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰çŠ¶æ³ã‚’ç¢ºèªã§ãã¾ã™ã€‚</p>
</div>

{% if customer_data %}
<div class="card" style="overflow-x: auto;">
    <table>
        <thead>
            <tr>
                <th>é¡§å®¢å</th>
                <th class="mobile-hide">é¡§å®¢ID</th>
                <th class="mobile-hide">é€£çµ¡å…ˆ</th>
                {% for image_type in image_types %}
                <th class="mobile-hide">{{ image_type.value|replace('_', ' ')|title }}</th>
                {% endfor %}
                <th>æ“ä½œ</th>
            </tr>
        </thead>
        <tbody>
            {% for data in customer_data %}
            <tr>
                <td>
                    <strong>{{ data.customer.name }}</strong><br>
                    <small style="color: #666;">{{ data.customer.email or '-' }}</small>
                    <!-- ãƒ¢ãƒã‚¤ãƒ«ç”¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
                    <div class="mobile-only" style="margin-top: 10px;">
                        {% for image_type in image_types %}
                        {% set status = data.upload_status[image_type.value] %}
                        <span class="status-symbol status-{{ status.status }}">{{ status.symbol }}</span>
                        {% endfor %}
                    </div>
                </td>
                <td class="mobile-hide">
                    <code>{{ data.customer.id }}</code><br>
                    <small style="color: #666;">{{ data.customer.created_at.strftime('%Y-%m-%d') }}</small>
                </td>
                <td class="mobile-hide">{{ data.customer.phone or '-' }}</td>
                {% for image_type in image_types %}
                <td class="mobile-hide" style="text-align: center;">
                    {% set status = data.upload_status[image_type.value] %}
                    <span class="status-symbol status-{{ status.status }}">
                        {{ status.symbol }}
                    </span>
                    {% if status.uploaded_at %}
                    <br><small style="color: #666;">{{ status.uploaded_at }}</small>
                    {% endif %}
                </td>
                {% endfor %}
                <td>
                    <a href="/admin/customer/{{ data.customer.id }}/images" class="btn btn-secondary" style="font-size: 12px;">
                        ğŸ“ è©³ç´°
                    </a>
                    <br>
                    <button onclick="copyCustomerUrl('{{ data.customer.id }}')" class="btn" style="font-size: 12px; margin-top: 5px;">
                        ğŸ“‹ URLå–å¾—
                    </button>
                    <br>
                    <a href="/customer/{{ data.customer.id }}" class="btn btn-secondary" style="font-size: 12px; margin-top: 5px;" target="_blank">
                        ğŸ”— é–‹ã
                    </a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="card">
    <p>é¡§å®¢ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
    <a href="/admin/customer/create" class="btn">ğŸ‘¤ é¡§å®¢ã‚’ä½œæˆ</a>
</div>
{% endif %}

<div class="card">
    <h3>ğŸ“‹ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹èª¬æ˜</h3>
    <table style="margin-top: 0;">
        <tr>
            <td><span class="status-symbol status-pending">Ã—</span></td>
            <td>æœªã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</td>
        </tr>
        <tr>
            <td><span class="status-symbol status-uploaded">ğŸ“¤</span></td>
            <td>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ï¼ˆç¢ºèªå¾…ã¡ï¼‰</td>
        </tr>
        <tr>
            <td><span class="status-symbol status-approved">â—‹</span></td>
            <td>æ‰¿èªæ¸ˆã¿</td>
        </tr>
        <tr>
            <td><span class="status-symbol status-rejected">Ã—</span></td>
            <td>å´ä¸‹</td>
        </tr>
    </table>
</div>

<div class="card">
    <h3>ğŸ“ˆ ã‚·ã‚¹ãƒ†ãƒ çµ±è¨ˆ</h3>
    <table style="margin-top: 0;">
        <tr>
            <td><strong>ç·é¡§å®¢æ•°</strong></td>
            <td>{{ customer_data|length }}ä»¶</td>
        </tr>
        <tr>
            <td><strong>ç”»åƒç¨®é¡</strong></td>
            <td>{{ image_types|length }}ç¨®é¡</td>
        </tr>
        <tr>
            <td><strong>æœ€å¤§ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º</strong></td>
            <td>16MB</td>
        </tr>
        <tr>
            <td><strong>å¯¾å¿œå½¢å¼</strong></td>
            <td>JPG, PNG, GIF</td>
        </tr>
    </table>
</div>
{% endblock %}

{% block scripts %}
<script>
// è‡ªå‹•æ›´æ–°ï¼ˆ60ç§’ã”ã¨ï¼‰
setInterval(() => {
    location.reload();
}, 60000);

// é¡§å®¢URLã®ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½
function copyCustomerUrl(customerId) {
    const url = `${window.location.origin}/customer/${customerId}`;
    
    // ãƒ¢ãƒ€ãƒ³ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰API
    if (navigator.clipboard) {
        navigator.clipboard.writeText(url).then(() => {
            showAlert(`é¡§å®¢URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ:\n${url}`, 'success');
        }).catch(err => {
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            fallbackCopyTextToClipboard(url);
        });
    } else {
        // å¤ã„ãƒ–ãƒ©ã‚¦ã‚¶ç”¨ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        fallbackCopyTextToClipboard(url);
    }
}

// ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ã®ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½
function fallbackCopyTextToClipboard(text) {
    const textArea = document.createElement("textarea");
    textArea.value = text;
    textArea.style.top = "0";
    textArea.style.left = "0";
    textArea.style.position = "fixed";
    
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        const successful = document.execCommand('copy');
        if (successful) {
            showAlert(`é¡§å®¢URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ:\n${text}`, 'success');
        } else {
            showAlert('URLã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        }
    } catch (err) {
        console.error('ã‚³ãƒ”ãƒ¼ã‚¨ãƒ©ãƒ¼:', err);
        showAlert('URLã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    }
    
    document.body.removeChild(textArea);
}

// ãƒ†ãƒ¼ãƒ–ãƒ«è¡Œã®ãƒ›ãƒãƒ¼åŠ¹æœ
document.querySelectorAll('tbody tr').forEach(row => {
    row.addEventListener('mouseenter', () => {
        row.style.backgroundColor = '#f8f9fa';
    });
    
    row.addEventListener('mouseleave', () => {
        row.style.backgroundColor = '';
    });
});
</script>
{% endblock %}