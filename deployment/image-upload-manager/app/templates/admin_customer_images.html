{% extends "base.html" %}

{% block title %}{{ customer.name }} - ç”»åƒç®¡ç†{% endblock %}

{% block header %}{{ customer.name }}æ§˜ - ç”»åƒç®¡ç†{% endblock %}

{% block content %}
<div class="nav-links">
    <a href="/admin">ğŸ‘ˆ ç®¡ç†è€…ãƒšãƒ¼ã‚¸</a>
    <a href="/customer/{{ customer.id }}" target="_blank">ğŸ”— é¡§å®¢ãƒšãƒ¼ã‚¸</a>
</div>

<div class="card">
    <h2>ğŸ‘¤ é¡§å®¢æƒ…å ±</h2>
    <table style="margin-top: 0;">
        <tr>
            <td><strong>é¡§å®¢å</strong></td>
            <td>{{ customer.name }}</td>
        </tr>
        <tr>
            <td><strong>é¡§å®¢ID</strong></td>
            <td><code>{{ customer.id }}</code></td>
        </tr>
        <tr>
            <td><strong>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</strong></td>
            <td>{{ customer.email or '-' }}</td>
        </tr>
        <tr>
            <td><strong>é›»è©±ç•ªå·</strong></td>
            <td>{{ customer.phone or '-' }}</td>
        </tr>
        <tr>
            <td><strong>ç™»éŒ²æ—¥</strong></td>
            <td>{{ customer.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
        </tr>
    </table>
</div>

<div class="card">
    <h2>ğŸ“¸ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”»åƒ</h2>
    
    {% if images %}
    <div class="image-type-grid">
        {% for image in images %}
        <div class="image-type-card">
            <h3>{{ image.image_type.value|replace('_', ' ')|title }}</h3>
            
            <div class="status-symbol status-{{ image.status.value }}">
                {{ image.status.value }}
            </div>
            
            {% if image.filename %}
            <div style="margin: 15px 0;">
                <img src="/admin/image/{{ image.id }}/view" alt="ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”»åƒ" 
                     style="max-width: 100%; max-height: 200px; border: 1px solid #ddd; border-radius: 5px;"
                     onclick="openImageModal({{ image.id }})">
            </div>
            
            <p><strong>ãƒ•ã‚¡ã‚¤ãƒ«å:</strong> {{ image.original_filename }}</p>
            <p><strong>ã‚µã‚¤ã‚º:</strong> {{ "%.1f"|format(image.file_size / 1024 / 1024) }}MB</p>
            {% endif %}
            
            <p><strong>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ—¥æ™‚:</strong> 
                {{ image.uploaded_at.strftime('%Y-%m-%d %H:%M') if image.uploaded_at else '-' }}
            </p>
            
            {% if image.reviewed_at %}
            <p><strong>ç¢ºèªæ—¥æ™‚:</strong> {{ image.reviewed_at.strftime('%Y-%m-%d %H:%M') }}</p>
            {% endif %}
            
            {% if image.reviewer_notes %}
            <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin: 10px 0;">
                <strong>ç®¡ç†è€…ã‚³ãƒ¡ãƒ³ãƒˆ:</strong><br>
                {{ image.reviewer_notes }}
            </div>
            {% endif %}
            
            {% if image.status.value == 'uploaded' %}
            <div style="margin-top: 15px;">
                <button onclick="reviewImage({{ image.id }}, 'approve')" class="btn btn-success">
                    âœ… æ‰¿èª
                </button>
                <button onclick="reviewImage({{ image.id }}, 'reject')" class="btn btn-danger">
                    âŒ å´ä¸‹
                </button>
            </div>
            {% endif %}
            
            {% if image.status.value in ['approved', 'rejected'] %}
            <div style="margin-top: 15px;">
                <button onclick="reviewImage({{ image.id }}, 'reject')" class="btn btn-danger">
                    âŒ å´ä¸‹ã«å¤‰æ›´
                </button>
                <button onclick="reviewImage({{ image.id }}, 'approve')" class="btn btn-success">
                    âœ… æ‰¿èªã«å¤‰æ›´
                </button>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸç”»åƒã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
    {% endif %}
</div>

<!-- ç”»åƒãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="imageModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000;" onclick="closeImageModal()">
    <div style="display: flex; justify-content: center; align-items: center; height: 100%;">
        <img id="modalImage" style="max-width: 90%; max-height: 90%; border-radius: 5px;">
    </div>
</div>

<!-- ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="reviewModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1001;">
    <div style="display: flex; justify-content: center; align-items: center; height: 100%;">
        <div style="background: white; padding: 20px; border-radius: 8px; max-width: 500px; width: 90%;">
            <h3 id="reviewModalTitle">ç”»åƒãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
            <div class="form-group">
                <label for="reviewNotes">ç®¡ç†è€…ã‚³ãƒ¡ãƒ³ãƒˆ</label>
                <textarea id="reviewNotes" rows="4" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."></textarea>
            </div>
            <div style="text-align: right; margin-top: 20px;">
                <button onclick="closeReviewModal()" class="btn btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button onclick="submitReview()" class="btn btn-success" id="submitReviewBtn">ç¢ºå®š</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentImageId = null;
let currentAction = null;

function openImageModal(imageId) {
    const modal = document.getElementById('imageModal');
    const modalImage = document.getElementById('modalImage');
    
    modalImage.src = `/admin/image/${imageId}/view`;
    modal.style.display = 'block';
}

function closeImageModal() {
    document.getElementById('imageModal').style.display = 'none';
}

function reviewImage(imageId, action) {
    currentImageId = imageId;
    currentAction = action;
    
    const modal = document.getElementById('reviewModal');
    const title = document.getElementById('reviewModalTitle');
    const submitBtn = document.getElementById('submitReviewBtn');
    
    if (action === 'approve') {
        title.textContent = 'ç”»åƒã‚’æ‰¿èª';
        submitBtn.textContent = 'æ‰¿èª';
        submitBtn.className = 'btn btn-success';
    } else {
        title.textContent = 'ç”»åƒã‚’å´ä¸‹';
        submitBtn.textContent = 'å´ä¸‹';
        submitBtn.className = 'btn btn-danger';
    }
    
    document.getElementById('reviewNotes').value = '';
    modal.style.display = 'block';
}

function closeReviewModal() {
    document.getElementById('reviewModal').style.display = 'none';
    currentImageId = null;
    currentAction = null;
}

function submitReview() {
    if (!currentImageId || !currentAction) {
        return;
    }
    
    const notes = document.getElementById('reviewNotes').value;
    
    showLoading();
    
    const formData = new FormData();
    formData.append('action', currentAction);
    formData.append('notes', notes);
    
    fetch(`/admin/image/${currentImageId}/review`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        
        if (data.success) {
            showAlert(data.message, 'success');
            closeReviewModal();
            
            // ç”»é¢æ›´æ–°
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            showAlert(data.error || 'ãƒ¬ãƒ“ãƒ¥ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        }
    })
    .catch(error => {
        hideLoading();
        console.error('ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒ©ãƒ¼:', error);
        showAlert('ãƒ¬ãƒ“ãƒ¥ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    });
}

// ESCã‚­ãƒ¼ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeImageModal();
        closeReviewModal();
    }
});

// è‡ªå‹•æ›´æ–°ï¼ˆ60ç§’ã”ã¨ï¼‰
setInterval(() => {
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã„ã¦ã„ãªã„å ´åˆã®ã¿æ›´æ–°
    const imageModal = document.getElementById('imageModal');
    const reviewModal = document.getElementById('reviewModal');
    
    if (imageModal.style.display === 'none' && reviewModal.style.display === 'none') {
        location.reload();
    }
}, 60000);
</script>
{% endblock %}