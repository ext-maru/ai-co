{% extends "base.html" %}

{% block title %}ã‚·ã‚¹ãƒ†ãƒ è¨­å®š - ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ {% endblock %}

{% block header %}âš™ï¸ ã‚·ã‚¹ãƒ†ãƒ è¨­å®š{% endblock %}

{% block content %}
<div class="nav-links">
    <a href="/admin">ğŸ‘ˆ ç®¡ç†è€…ãƒšãƒ¼ã‚¸</a>
</div>

<form method="POST" enctype="multipart/form-data">
    <!-- Google Driveè¨­å®š -->
    <div class="card">
        <h2>â˜ï¸ Google Driveè¨­å®š</h2>
        
        <!-- æ¥ç¶šçŠ¶æ…‹è¡¨ç¤º -->
        <div style="background: {% if google_drive_status.connected %}#d4edda{% elif google_drive_status.enabled %}#f8d7da{% else %}#e2e3e5{% endif %}; 
                    padding: 15px; border-radius: 5px; margin-bottom: 20px;">
            <strong>æ¥ç¶šçŠ¶æ…‹:</strong>
            {% if google_drive_status.connected %}
                âœ… æ¥ç¶šæ¸ˆã¿ ({{ google_drive_status.user }})
            {% elif google_drive_status.enabled %}
                âŒ æ¥ç¶šã‚¨ãƒ©ãƒ¼
                {% if google_drive_status.error %}
                    <br><small>{{ google_drive_status.error }}</small>
                {% endif %}
            {% else %}
                âšª ç„¡åŠ¹
            {% endif %}
            
            {% if not google_drive_status.credentials_exists %}
                <br>âš ï¸ èªè¨¼ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“
                <br><small>é…ç½®å…ˆ: {{ google_drive_status.credentials_path }}</small>
            {% endif %}
        </div>
        
        <div class="form-group">
            <label>
                <input type="checkbox" name="google_drive_enabled" id="google_drive_enabled"
                       {% if settings.google_drive_enabled %}checked{% endif %}
                       onchange="toggleGoogleDriveSettings()">
                Google Driveé€£æºã‚’æœ‰åŠ¹ã«ã™ã‚‹
            </label>
        </div>
        
        <div id="google_drive_settings" style="{% if not settings.google_drive_enabled %}display: none;{% endif %}">
            <div class="form-group">
                <label for="google_credentials_file">èªè¨¼JSONãƒ•ã‚¡ã‚¤ãƒ«</label>
                <input type="file" id="google_credentials_file" name="google_credentials_file" 
                       accept=".json">
                <small style="display: block; margin-top: 5px; color: #666;">
                    Google Cloud Consoleã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸèªè¨¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„
                    {% if google_drive_status.credentials_exists %}
                    <br><span style="color: #28a745;">âœ… èªè¨¼ãƒ•ã‚¡ã‚¤ãƒ«ã¯æ—¢ã«é…ç½®ã•ã‚Œã¦ã„ã¾ã™</span>
                    {% else %}
                    <br><span style="color: #dc3545;">âŒ èªè¨¼ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</span>
                    {% endif %}
                </small>
            </div>
            
            <div class="form-group">
                <label for="google_drive_folder_id">Google Driveãƒ•ã‚©ãƒ«ãƒ€ID *</label>
                <input type="text" id="google_drive_folder_id" name="google_drive_folder_id" 
                       value="{{ settings.google_drive_folder_id or '' }}"
                       placeholder="ä¾‹: 1abcdefghijklmnopqrstuvwxyz">
                <small style="display: block; margin-top: 5px; color: #666;">
                    Google Driveã®ãƒ•ã‚©ãƒ«ãƒ€URLã‹ã‚‰å–å¾—ã§ãã¾ã™<br>
                    ä¾‹: https://drive.google.com/drive/folders/<strong>1abcdefghijklmnopqrstuvwxyz</strong>
                </small>
            </div>
            
            <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-top: 20px;">
                <h4>ğŸ“‹ è¨­å®šæ‰‹é †</h4>
                <ol style="padding-left: 20px; margin-top: 10px;">
                    <li><a href="/admin/settings/google-drive-guide" target="_blank">Google Driveè¨­å®šã‚¬ã‚¤ãƒ‰</a>ã‚’å‚ç…§</li>
                    <li>Google Cloud Consoleã§ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¨APIã‚’è¨­å®š</li>
                    <li>èªè¨¼JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</li>
                    <li>ä¸Šã®ã€Œèªè¨¼JSONãƒ•ã‚¡ã‚¤ãƒ«ã€ã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</li>
                    <li>Google Driveã§ãƒ•ã‚©ãƒ«ãƒ€IDã‚’å–å¾—ã—ã¦å…¥åŠ›</li>
                    <li>è¨­å®šã‚’ä¿å­˜ã—ã¦æ¥ç¶šãƒ†ã‚¹ãƒˆ</li>
                </ol>
            </div>
        </div>
    </div>

    <!-- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰è¨­å®š -->
    <div class="card">
        <h2>ğŸ“ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰è¨­å®š</h2>
        
        <div class="form-group">
            <label for="max_file_size">æœ€å¤§ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º (MB)</label>
            <input type="number" id="max_file_size" name="max_file_size" 
                   value="{{ settings.max_file_size or '16' }}"
                   min="1" max="100">
        </div>
        
        <div class="form-group">
            <label for="allowed_extensions">è¨±å¯ã™ã‚‹æ‹¡å¼µå­</label>
            <input type="text" id="allowed_extensions" name="allowed_extensions" 
                   value="{{ settings.allowed_extensions or 'jpg,jpeg,png,gif' }}"
                   placeholder="ä¾‹: jpg,jpeg,png,gif">
            <small style="display: block; margin-top: 5px; color: #666;">
                ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§å…¥åŠ›ã—ã¦ãã ã•ã„
            </small>
        </div>
    </div>

    <!-- ç”»åƒç¨®é¡è¨­å®šï¼ˆå°†æ¥ã®æ‹¡å¼µç”¨ï¼‰ -->
    <div class="card">
        <h2>ğŸ“¸ ç”»åƒç¨®é¡è¨­å®š</h2>
        <p>ç¾åœ¨ã®ç”»åƒç¨®é¡:</p>
        <ul style="padding-left: 20px;">
            <li>èº«åˆ†è¨¼æ˜æ›¸ (identity_card)</li>
            <li>ä½æ°‘ç¥¨ (residence_cert)</li>
            <li>åå…¥è¨¼æ˜æ›¸ (income_proof)</li>
            <li>å¥‘ç´„æ›¸ (contract)</li>
            <li>éŠ€è¡Œæ˜ç´° (bank_statement)</li>
            <li>ãã®ä»–æ›¸é¡ (other_document)</li>
        </ul>
        <p style="margin-top: 15px; color: #666;">
            <small>â€» ç”»åƒç¨®é¡ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã¯ä»Šå¾Œã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã§å¯¾å¿œäºˆå®šã§ã™</small>
        </p>
    </div>

    <!-- ã‚·ã‚¹ãƒ†ãƒ æƒ…å ± -->
    <div class="card">
        <h2>â„¹ï¸ ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±</h2>
        <table style="margin-top: 0;">
            <tr>
                <td><strong>ãƒãƒ¼ã‚¸ãƒ§ãƒ³</strong></td>
                <td>1.0.0</td>
            </tr>
            <tr>
                <td><strong>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹</strong></td>
                <td>SQLite</td>
            </tr>
            <tr>
                <td><strong>ç”»åƒä¿å­˜å…ˆ</strong></td>
                <td>uploads/</td>
            </tr>
            <tr>
                <td><strong>å®Ÿè¡Œç’°å¢ƒ</strong></td>
                <td>{% if 'DOCKER' in os.environ %}Docker{% else %}ãƒ­ãƒ¼ã‚«ãƒ«{% endif %}</td>
            </tr>
        </table>
    </div>

    <div style="text-align: center; margin-top: 30px;">
        <button type="submit" class="btn btn-success">
            ğŸ’¾ è¨­å®šã‚’ä¿å­˜
        </button>
        <a href="/admin" class="btn btn-secondary">
            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        </a>
    </div>
</form>

<!-- Google Driveè¨­å®šã®è©³ç´°ã‚¬ã‚¤ãƒ‰è¡¨ç¤ºç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="guideModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000;">
    <div style="background: white; margin: 50px auto; padding: 20px; max-width: 800px; max-height: 80vh; overflow-y: auto; border-radius: 8px;">
        <h2>ğŸ“š Google Driveè¨­å®šã‚¬ã‚¤ãƒ‰</h2>
        <div id="guideContent">
            <!-- JavaScriptã§å‹•çš„ã«èª­ã¿è¾¼ã¿ -->
        </div>
        <button onclick="closeGuideModal()" class="btn btn-secondary" style="margin-top: 20px;">
            é–‰ã˜ã‚‹
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function toggleGoogleDriveSettings() {
    const checkbox = document.getElementById('google_drive_enabled');
    const settings = document.getElementById('google_drive_settings');
    
    if (checkbox.checked) {
        settings.style.display = 'block';
    } else {
        settings.style.display = 'none';
    }
}

// ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‰ã®æ¤œè¨¼
document.querySelector('form').addEventListener('submit', function(e) {
    const googleDriveEnabled = document.getElementById('google_drive_enabled').checked;
    const folderId = document.getElementById('google_drive_folder_id').value.trim();
    const credentialsFile = document.getElementById('google_credentials_file').files[0];
    
    if (googleDriveEnabled && !folderId) {
        e.preventDefault();
        showAlert('Google Driveãƒ•ã‚©ãƒ«ãƒ€IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
    }
    
    // èªè¨¼ãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œè¨¼
    if (credentialsFile) {
        if (!credentialsFile.name.endsWith('.json')) {
            e.preventDefault();
            showAlert('JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
            return;
        }
        
        if (credentialsFile.size > 1024 * 1024) { // 1MBåˆ¶é™
            e.preventDefault();
            showAlert('èªè¨¼ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ï¼ˆæœ€å¤§1MBï¼‰', 'error');
            return;
        }
    }
    
    showLoading();
});

// ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
document.getElementById('google_credentials_file').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const json = JSON.parse(e.target.result);
                if (json.type === 'service_account' && json.client_email) {
                    showAlert('èªè¨¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã—ã¾ã—ãŸ', 'success');
                } else {
                    showAlert('ç„¡åŠ¹ãªèªè¨¼ãƒ•ã‚¡ã‚¤ãƒ«ã§ã™', 'error');
                }
            } catch (error) {
                showAlert('JSONãƒ•ã‚¡ã‚¤ãƒ«ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        };
        reader.readAsText(file);
    }
});

// ã‚¬ã‚¤ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ«
function showGuideModal() {
    document.getElementById('guideModal').style.display = 'block';
    
    // ã‚¬ã‚¤ãƒ‰å†…å®¹ã‚’å‹•çš„ã«èª­ã¿è¾¼ã¿ï¼ˆå®Ÿè£…ã®ä¾‹ï¼‰
    fetch('/admin/settings/google-drive-guide-content')
        .then(response => response.text())
        .then(html => {
            document.getElementById('guideContent').innerHTML = html;
        })
        .catch(error => {
            document.getElementById('guideContent').innerHTML = 
                '<p>ã‚¬ã‚¤ãƒ‰ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br>' +
                '<a href="/config/google_drive_setup.md" target="_blank">ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›´æ¥å‚ç…§ã—ã¦ãã ã•ã„</a></p>';
        });
}

function closeGuideModal() {
    document.getElementById('guideModal').style.display = 'none';
}

// ESCã‚­ãƒ¼ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeGuideModal();
    }
});

// è¨­å®šå€¤ã®è‡ªå‹•ä¿å­˜ï¼ˆå¤‰æ›´æ™‚ã«ä¸€æ™‚ä¿å­˜ï¼‰
let settingsChanged = false;

document.querySelectorAll('input').forEach(input => {
    input.addEventListener('change', function() {
        settingsChanged = true;
    });
});

// ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã®è­¦å‘Š
window.addEventListener('beforeunload', function(e) {
    if (settingsChanged) {
        e.preventDefault();
        e.returnValue = '';
    }
});

// ä¿å­˜ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã«å¤‰æ›´ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
document.querySelector('button[type="submit"]').addEventListener('click', function() {
    settingsChanged = false;
});
</script>
{% endblock %}