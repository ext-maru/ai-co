{% extends "base.html" %}

{% block title %}{{ customer.name }} - ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰{% endblock %}

{% block header %}{{ customer.name }}æ§˜ - ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰{% endblock %}

{% block content %}
<div class="card">
    <h2>ğŸ“¸ ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>
    <p>ä»¥ä¸‹ã®æ›¸é¡ã‚’é †ç•ªã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚</p>
    <p><strong>å¯¾å¿œå½¢å¼:</strong> JPG, PNG, GIF (æœ€å¤§16MB)</p>
</div>

<div class="image-type-grid">
    {% for image_type, status in image_status.items() %}
    <div class="image-type-card">
        <h3>{{ status.display_name }}</h3>
        <div class="status-symbol status-{{ status.status }}">
            {{ status.symbol }}
        </div>
        <p><strong>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</strong> 
            {% if status.status == 'pending' %}
                æœªã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
            {% elif status.status == 'uploaded' %}
                ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ï¼ˆç¢ºèªä¸­ï¼‰
            {% elif status.status == 'approved' %}
                æ‰¿èªæ¸ˆã¿
            {% elif status.status == 'rejected' %}
                å´ä¸‹
            {% endif %}
        </p>
        
        {% if status.uploaded_at %}
            <p><small>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ—¥æ™‚: {{ status.uploaded_at }}</small></p>
        {% endif %}
        
        {% if status.reviewer_notes %}
            <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin: 10px 0;">
                <strong>ç®¡ç†è€…ã‚³ãƒ¡ãƒ³ãƒˆ:</strong><br>
                {{ status.reviewer_notes }}
            </div>
        {% endif %}
        
        {% if status.status in ['pending', 'rejected'] %}
            <div class="file-upload" data-image-type="{{ image_type }}">
                <input type="file" id="file-{{ image_type }}" accept="image/*" onchange="uploadFile('{{ image_type }}')">
                <label for="file-{{ image_type }}" class="upload-btn">
                    ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
                </label>
                <p style="margin-top: 10px; font-size: 14px; color: #666;">
                    ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„
                </p>
            </div>
        {% endif %}
        
        <div id="progress-{{ image_type }}" style="display: none;">
            <div style="background: #e0e0e0; border-radius: 10px; overflow: hidden; margin: 10px 0;">
                <div id="progress-bar-{{ image_type }}" style="background: #3498db; height: 20px; width: 0%; transition: width 0.3s;"></div>
            </div>
            <p id="progress-text-{{ image_type }}">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...</p>
        </div>
    </div>
    {% endfor %}
</div>

<div class="card" style="overflow-x: auto;">
    <h3>ğŸ“‹ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰çŠ¶æ³</h3>
    <table>
        <thead>
            <tr>
                <th>æ›¸é¡ç¨®é¡</th>
                <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                <th>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ—¥æ™‚</th>
                <th>ç®¡ç†è€…ã‚³ãƒ¡ãƒ³ãƒˆ</th>
            </tr>
        </thead>
        <tbody>
            {% for image_type, status in image_status.items() %}
            <tr>
                <td>{{ status.display_name }}</td>
                <td>
                    <span class="status-symbol status-{{ status.status }}">
                        {{ status.symbol }}
                    </span>
                    {% if status.status == 'pending' %}
                        æœªã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                    {% elif status.status == 'uploaded' %}
                        ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿
                    {% elif status.status == 'approved' %}
                        æ‰¿èªæ¸ˆã¿
                    {% elif status.status == 'rejected' %}
                        å´ä¸‹
                    {% endif %}
                </td>
                <td>{{ status.uploaded_at or '-' }}</td>
                <td>{{ status.reviewer_notes or '-' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="card">
    <h3>â„¹ï¸ æ³¨æ„äº‹é …</h3>
    <ul style="padding-left: 20px;">
        <li>ç”»åƒã¯è‡ªå‹•çš„ã«ãƒªã‚µã‚¤ã‚ºã•ã‚Œã€å®¹é‡ãŒæœ€é©åŒ–ã•ã‚Œã¾ã™</li>
        <li>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¾Œã¯ç®¡ç†è€…ã«ã‚ˆã‚‹ç¢ºèªãŒè¡Œã‚ã‚Œã¾ã™</li>
        <li>å´ä¸‹ã•ã‚ŒãŸå ´åˆã¯ã€å†åº¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„</li>
        <li>æ‰¿èªæ¸ˆã¿ã®ç”»åƒã¯è‡ªå‹•çš„ã«GoogleDriveã«ä¿å­˜ã•ã‚Œã¾ã™</li>
    </ul>
</div>
{% endblock %}

{% block scripts %}
<script>
function uploadFile(imageType) {
    const fileInput = document.getElementById(`file-${imageType}`);
    const file = fileInput.files[0];
    
    if (!file) {
        return;
    }
    
    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯
    if (file.size > 16 * 1024 * 1024) {
        showAlert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ï¼ˆæœ€å¤§16MBï¼‰', 'error');
        return;
    }
    
    // é€²æ—è¡¨ç¤º
    const progressDiv = document.getElementById(`progress-${imageType}`);
    const progressBar = document.getElementById(`progress-bar-${imageType}`);
    const progressText = document.getElementById(`progress-text-${imageType}`);
    
    progressDiv.style.display = 'block';
    progressBar.style.width = '0%';
    progressText.textContent = 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...';
    
    // FormDataä½œæˆ
    const formData = new FormData();
    formData.append('file', file);
    formData.append('image_type', imageType);
    
    // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œ
    fetch(`/customer/{{ customer.id }}/upload`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        progressDiv.style.display = 'none';
        
        if (data.success) {
            showAlert(data.message, 'success');
            
            // ç”»é¢æ›´æ–°
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            showAlert(data.error || 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        }
    })
    .catch(error => {
        progressDiv.style.display = 'none';
        console.error('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
        showAlert('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    });
    
    // é€²æ—ãƒãƒ¼æ›´æ–°ï¼ˆãƒ‡ãƒ¢ç”¨ï¼‰
    let progress = 0;
    const progressInterval = setInterval(() => {
        progress += 10;
        progressBar.style.width = `${progress}%`;
        
        if (progress >= 90) {
            clearInterval(progressInterval);
            progressText.textContent = 'å‡¦ç†ä¸­...';
        }
    }, 100);
}

// ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—å¯¾å¿œ
document.querySelectorAll('.file-upload').forEach(uploadArea => {
    const imageType = uploadArea.dataset.imageType;
    
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.style.background = '#ecf0f1';
    });
    
    uploadArea.addEventListener('dragleave', (e) => {
        e.preventDefault();
        uploadArea.style.background = '';
    });
    
    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.style.background = '';
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            const fileInput = document.getElementById(`file-${imageType}`);
            fileInput.files = files;
            uploadFile(imageType);
        }
    });
});

// è‡ªå‹•æ›´æ–°ï¼ˆ30ç§’ã”ã¨ï¼‰
setInterval(() => {
    // ç¾åœ¨ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­ã§ãªã„å ´åˆã®ã¿æ›´æ–°
    const progressDivs = document.querySelectorAll('[id^="progress-"]');
    const isUploading = Array.from(progressDivs).some(div => div.style.display !== 'none');
    
    if (!isUploading) {
        fetch(window.location.href)
            .then(response => response.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const newTable = doc.querySelector('table');
                if (newTable) {
                    document.querySelector('table').innerHTML = newTable.innerHTML;
                }
            })
            .catch(error => console.error('è‡ªå‹•æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error));
    }
}, 30000);
</script>
{% endblock %}