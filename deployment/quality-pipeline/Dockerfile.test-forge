# ğŸ”¨ TestForge Servant Docker Image
FROM python:3.10-slim

# ãƒ©ãƒ™ãƒ«
LABEL maintainer="Elder Council <elders@ai-company.com>"
LABEL description="Test Forge Servant - Test Quality Judge"
LABEL version="1.0.0"

# ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
WORKDIR /app

# ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æ›´æ–°
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    gcc \
    git \
    && rm -rf /var/lib/apt/lists/*

# ä¾å­˜é–¢ä¿‚ã‚’ã‚³ãƒ”ãƒ¼
COPY requirements.txt /app/
RUN pip install --no-cache-dir -r requirements.txt

# python-a2a ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN pip install --no-cache-dir python-a2a==0.5.9

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼
COPY libs/quality/engines/test_automation_engine.py /app/libs/quality/engines/
COPY libs/quality/servants/test_forge_servant.py /app/libs/quality/servants/
COPY libs/quality/servants/__init__.py /app/libs/quality/servants/
COPY libs/quality/__init__.py /app/libs/quality/
COPY libs/__init__.py /app/libs/

# éroot ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
RUN useradd -m -u 1000 servant && \
    chown -R servant:servant /app

USER servant

# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD python -c "import httpx; httpx.get('http://localhost:8811/health')"

# ãƒãƒ¼ãƒˆå…¬é–‹
EXPOSE 8811

# ç’°å¢ƒå¤‰æ•°
ENV PYTHONUNBUFFERED=1
ENV SERVANT_NAME=test-forge
ENV SERVANT_PORT=8811
ENV LOG_LEVEL=INFO

# èµ·å‹•ã‚³ãƒãƒ³ãƒ‰
CMD ["python", "-m", "libs.quality.servants.test_forge_servant"]