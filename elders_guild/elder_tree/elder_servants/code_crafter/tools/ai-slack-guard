#!/bin/bash
# SlackWorkerç›£è¦–ã®èµ·å‹•/åœæ­¢ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

WATCHDOG_SCRIPT="/home/aicompany/ai_co/slack_worker_watchdog.sh"
WATCHDOG_PID_FILE="/tmp/slack_watchdog.pid"

case "$1" in
    start)
        if [ -f "$WATCHDOG_PID_FILE" ] && kill -0 $(cat "$WATCHDOG_PID_FILE") 2>/dev/null; then
            echo "ğŸ” SlackWorkerç›£è¦–ã¯æ—¢ã«å®Ÿè¡Œä¸­ã§ã™"
            exit 1
        fi

        echo "ğŸš€ SlackWorkerç›£è¦–ã‚’é–‹å§‹ã—ã¾ã™..."
        nohup "$WATCHDOG_SCRIPT" > /dev/null 2>&1 &
        echo $! > "$WATCHDOG_PID_FILE"
        echo "âœ… SlackWorkerç›£è¦–é–‹å§‹å®Œäº† (PID: $(cat $WATCHDOG_PID_FILE))"
        ;;

    stop)
        if [ -f "$WATCHDOG_PID_FILE" ]; then
            PID=$(cat "$WATCHDOG_PID_FILE")
            if kill -0 "$PID" 2>/dev/null; then
                kill "$PID"
                rm -f "$WATCHDOG_PID_FILE"
                echo "ğŸ›‘ SlackWorkerç›£è¦–ã‚’åœæ­¢ã—ã¾ã—ãŸ"
            else
                echo "âš ï¸ SlackWorkerç›£è¦–ãƒ—ãƒ­ã‚»ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
                rm -f "$WATCHDOG_PID_FILE"
            fi
        else
            echo "âš ï¸ SlackWorkerç›£è¦–ã¯å®Ÿè¡Œã•ã‚Œã¦ã„ã¾ã›ã‚“"
        fi
        ;;

    status)
        if [ -f "$WATCHDOG_PID_FILE" ] && kill -0 $(cat "$WATCHDOG_PID_FILE") 2>/dev/null; then
            echo "âœ… SlackWorkerç›£è¦–å®Ÿè¡Œä¸­ (PID: $(cat $WATCHDOG_PID_FILE))"
        else
            echo "âŒ SlackWorkerç›£è¦–åœæ­¢ä¸­"
        fi
        ;;

    *)
        echo "ä½¿ç”¨æ–¹æ³•: $0 {start|stop|status}"
        echo ""
        echo "  start  - SlackWorkerç›£è¦–é–‹å§‹"
        echo "  stop   - SlackWorkerç›£è¦–åœæ­¢"
        echo "  status - SlackWorkerç›£è¦–çŠ¶æ³ç¢ºèª"
        exit 1
        ;;
esac
