#!/usr/bin/env python3
"""
Claude Elder Auto Flow CLI - ã‚¯ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ«ãƒ€ãƒ¼è‡ªå‹•Elder Flowç®¡ç†ã‚³ãƒãƒ³ãƒ‰
Created: 2025-01-20
Author: Claude Elder

ã‚¯ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ«ãƒ€ãƒ¼ã®è‡ªå‹•Elder Flowé©ç”¨ã‚·ã‚¹ãƒ†ãƒ ã‚’ç®¡ç†ã™ã‚‹CLIãƒ„ãƒ¼ãƒ«
"""

import argparse
import asyncio
import json
import sys
from pathlib import Path

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã‚’ãƒ‘ã‚¹ã«è¿½åŠ 
project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))

from libs.claude_elder_auto_flow_interceptor import get_claude_elder_interceptor
from libs.claude_elder_request_processor import get_claude_elder_processor


def print_banner():
    """ãƒãƒŠãƒ¼è¡¨ç¤º"""
    print("ğŸŒŠ Claude Elder Auto Flow Management System")
    print("ğŸ›ï¸ ã‚¯ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ«ãƒ€ãƒ¼è‡ªå‹•Elder Flowé©ç”¨ã‚·ã‚¹ãƒ†ãƒ ")
    print("=" * 60)


async def cmd_status(args):
    """ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª"""
    print_banner()

    processor = get_claude_elder_processor()
    interceptor = get_claude_elder_interceptor()

    print("ğŸ“Š ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹")
    print("-" * 30)

    # ã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ã‚¿ãƒ¼çŠ¶æ…‹
    interceptor_status = interceptor.get_status()
    print(f"ğŸ›ï¸  è‡ªå‹•Elder Flow: {'ğŸŸ¢ æœ‰åŠ¹' if interceptor_status['enabled'] else 'ğŸ”´ ç„¡åŠ¹'}")
    print(f"ğŸ“‹ ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚«ãƒ†ã‚´ãƒª: {interceptor_status['pattern_categories']}")
    print(f"ğŸ” ç·ãƒ‘ã‚¿ãƒ¼ãƒ³æ•°: {interceptor_status['total_patterns']}")
    print(f"â­ï¸  ãƒã‚¤ãƒ‘ã‚¹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: {len(interceptor_status['bypass_keywords'])}")
    print()

    # å‡¦ç†çµ±è¨ˆ
    stats = processor.get_processing_stats()
    print("ğŸ“ˆ å‡¦ç†çµ±è¨ˆ")
    print("-" * 30)
    print(f"ğŸ“¥ ç·ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°: {stats['total_requests']}")
    print(
        f"ğŸŒŠ Elder Flowé©ç”¨: {stats['elder_flow_applied']} ({stats['elder_flow_success_rate']:.1f}%)"
    )
    print(f"â­ï¸  ãƒã‚¤ãƒ‘ã‚¹: {stats['bypass_count']} ({stats['bypass_rate']:.1f}%)")
    print(f"ğŸ”„ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: {stats['fallback_count']} ({stats['fallback_rate']:.1f}%)")
    print(f"âŒ ã‚¨ãƒ©ãƒ¼: {stats['error_count']} ({stats['error_rate']:.1f}%)")
    print()

    if args.verbose:
        print("ğŸ”§ è©³ç´°è¨­å®š")
        print("-" * 30)
        print(f"ãƒã‚¤ãƒ‘ã‚¹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: {', '.join(interceptor_status['bypass_keywords'])}")
        print()


async def cmd_enable(args):
    """è‡ªå‹•Elder Flowæœ‰åŠ¹åŒ–"""
    print_banner()

    interceptor = get_claude_elder_interceptor()
    interceptor.enable_auto_flow()

    print("âœ… ã‚¯ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ«ãƒ€ãƒ¼è‡ªå‹•Elder Flowé©ç”¨ãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¾ã—ãŸ")
    print()
    print("ğŸ“‹ é©ç”¨æ¡ä»¶:")
    print("  - å®Ÿè£…ç³»: implement, add, create, build, develop, æ–°æ©Ÿèƒ½, OAuth, APIç­‰")
    print("  - ä¿®æ­£ç³»: fix, bug, ã‚¨ãƒ©ãƒ¼, å•é¡Œ, issue, ãƒã‚°ç­‰")
    print("  - æœ€é©åŒ–ç³»: optimize, refactor, improve, ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç­‰")
    print("  - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç³»: security, èªè¨¼, è„†å¼±æ€§, æ¨©é™ç­‰")
    print("  - ãƒ†ã‚¹ãƒˆç³»: test, TDD, ã‚«ãƒãƒ¬ãƒƒã‚¸, æ¤œè¨¼ç­‰")
    print("  - å¼·åˆ¶é©ç”¨: elder flow, elder-flow, ã‚¨ãƒ«ãƒ€ãƒ¼ãƒ•ãƒ­ãƒ¼ç­‰")
    print()
    print("â­ï¸  ãƒã‚¤ãƒ‘ã‚¹æ¡ä»¶:")
    print("  - help, status, explain, show, list, describe ã‚’å«ã‚€æ–‡")


async def cmd_disable(args):
    """è‡ªå‹•Elder Flowç„¡åŠ¹åŒ–"""
    print_banner()

    interceptor = get_claude_elder_interceptor()
    interceptor.disable_auto_flow()

    print("â¸ï¸ ã‚¯ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ«ãƒ€ãƒ¼è‡ªå‹•Elder Flowé©ç”¨ãŒç„¡åŠ¹åŒ–ã•ã‚Œã¾ã—ãŸ")
    print("ğŸ“ ã™ã¹ã¦ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒé€šå¸¸ã®Claude Elderå‡¦ç†ã§å®Ÿè¡Œã•ã‚Œã¾ã™")


async def cmd_test(args):
    """ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°ãƒ†ã‚¹ãƒˆ"""
    print_banner()

    if args.input:
        test_inputs = [args.input]
    elif args.file:
        with open(args.file, "r", encoding="utf-8") as f:
            test_inputs = [line.strip() for line in f if line.strip()]
    else:
        test_inputs = [
            "OAuth2.0èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã‚’å®Ÿè£…ã—ã¦ãã ã•ã„",
            "APIã®ãƒã‚°ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„",
            "ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’æœ€é©åŒ–ã—ãŸã„",
            "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ã‚’ä¿®æ­£",
            "ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’å‘ä¸Šã•ã›ã‚‹",
            "Elder Flowã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†æ©Ÿèƒ½ã‚’ä½œæˆ",
            "help",
            "ç¾åœ¨ã®çŠ¶æ³ã‚’èª¬æ˜ã—ã¦ãã ã•ã„",
            "ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°ã—ã¦ãã ã•ã„",
        ]

    processor = get_claude_elder_processor()
    result = await processor.test_request_processing(test_inputs)

    print("ğŸ§ª ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°ãƒ†ã‚¹ãƒˆçµæœ")
    print(f"ğŸ“‹ ãƒ†ã‚¹ãƒˆæ•°: {result['test_count']}")
    print(f"ğŸŒŠ Elder Flowé©ç”¨äºˆå®š: {result['summary']['would_apply_elder_flow']}")
    print(f"â­ï¸  ãƒã‚¤ãƒ‘ã‚¹äºˆå®š: {result['summary']['would_bypass']}")
    print()

    for test_result in result["results"]:
        icon = "ğŸŒŠ" if test_result["would_apply_elder_flow"] else "â­ï¸"
        print(f"{icon} {test_result['test_number']:2d}. {test_result['input']}")

        if test_result["would_apply_elder_flow"] and test_result["flow_info"]:
            info = test_result["flow_info"]
            print(f"     ğŸ“‚ ã‚«ãƒ†ã‚´ãƒª: {info['category']}")
            print(f"     âš¡ å„ªå…ˆåº¦: {info['priority']}")
            print(f"     ğŸ“Š ä¿¡é ¼åº¦: {info['confidence']:.2f}")
            if info.get("force"):
                print(f"     ğŸ”¥ å¼·åˆ¶é©ç”¨")
        print()


async def cmd_config(args):
    """è¨­å®šç®¡ç†"""
    print_banner()

    processor = get_claude_elder_processor()

    if args.action == "show":
        interceptor = get_claude_elder_interceptor()
        config = interceptor.get_status()

        print("ğŸ”§ ç¾åœ¨ã®è¨­å®š")
        print(json.dumps(config, indent=2, ensure_ascii=False))

    elif args.action == "set":
        if not args.config_file:
            print("âŒ --config-file ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒå¿…è¦ã§ã™")
            return 1

        with open(args.config_file, "r", encoding="utf-8") as f:
            config = json.load(f)

        processor.configure_interceptor(config)
        print("âœ… è¨­å®šã‚’æ›´æ–°ã—ã¾ã—ãŸ")

    elif args.action == "reset":
        processor.reset_stats()
        print("âœ… çµ±è¨ˆã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ")


async def cmd_add_bypass(args):
    """ãƒã‚¤ãƒ‘ã‚¹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰è¿½åŠ """
    print_banner()

    interceptor = get_claude_elder_interceptor()

    for keyword in args.keywords:
        interceptor.add_bypass_keyword(keyword)

    print(f"âœ… ãƒã‚¤ãƒ‘ã‚¹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¾ã—ãŸ: {', '.join(args.keywords)}")

    # ç¾åœ¨ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ä¸€è¦§è¡¨ç¤º
    current_keywords = interceptor.get_status()["bypass_keywords"]
    print(f"ğŸ“‹ ç¾åœ¨ã®ãƒã‚¤ãƒ‘ã‚¹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: {', '.join(current_keywords)}")


async def cmd_remove_bypass(args):
    """ãƒã‚¤ãƒ‘ã‚¹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å‰Šé™¤"""
    print_banner()

    interceptor = get_claude_elder_interceptor()

    for keyword in args.keywords:
        interceptor.remove_bypass_keyword(keyword)

    print(f"âœ… ãƒã‚¤ãƒ‘ã‚¹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¾ã—ãŸ: {', '.join(args.keywords)}")

    # ç¾åœ¨ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ä¸€è¦§è¡¨ç¤º
    current_keywords = interceptor.get_status()["bypass_keywords"]
    print(f"ğŸ“‹ ç¾åœ¨ã®ãƒã‚¤ãƒ‘ã‚¹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: {', '.join(current_keywords)}")


def cmd_help(args):
    """ãƒ˜ãƒ«ãƒ—è¡¨ç¤º"""
    print_banner()

    print("ğŸ”§ Claude Elder Auto Flow Management Commands:")
    print()
    print("ğŸ“Š çŠ¶æ…‹ç¢ºèª:")
    print("  status                    - ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ã¨çµ±è¨ˆã‚’è¡¨ç¤º")
    print("    --verbose               - è©³ç´°æƒ…å ±è¡¨ç¤º")
    print()
    print("ğŸ›ï¸  åˆ¶å¾¡:")
    print("  enable                    - è‡ªå‹•Elder Flowé©ç”¨ã‚’æœ‰åŠ¹åŒ–")
    print("  disable                   - è‡ªå‹•Elder Flowé©ç”¨ã‚’ç„¡åŠ¹åŒ–")
    print()
    print("ğŸ§ª ãƒ†ã‚¹ãƒˆ:")
    print("  test                      - ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°ãƒ†ã‚¹ãƒˆï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä¾‹æ–‡ä½¿ç”¨ï¼‰")
    print("    --input <text>          - æŒ‡å®šã—ãŸãƒ†ã‚­ã‚¹ãƒˆã§ãƒ†ã‚¹ãƒˆ")
    print("    --file <path>           - ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ†ã‚¹ãƒˆä¾‹æ–‡ã‚’èª­ã¿è¾¼ã¿")
    print()
    print("ğŸ”§ è¨­å®š:")
    print("  config show               - ç¾åœ¨ã®è¨­å®šã‚’è¡¨ç¤º")
    print("  config set --config-file  - è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰è¨­å®šã‚’æ›´æ–°")
    print("  config reset              - çµ±è¨ˆã‚’ãƒªã‚»ãƒƒãƒˆ")
    print()
    print("â­ï¸  ãƒã‚¤ãƒ‘ã‚¹ç®¡ç†:")
    print("  add-bypass <keywords...>  - ãƒã‚¤ãƒ‘ã‚¹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è¿½åŠ ")
    print("  remove-bypass <keywords>  - ãƒã‚¤ãƒ‘ã‚¹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å‰Šé™¤")
    print()
    print("  help                      - ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º")
    print()
    print("ğŸ“‹ ä½¿ç”¨ä¾‹:")
    print("  claude-elder-auto-flow status")
    print("  claude-elder-auto-flow enable")
    print("  claude-elder-auto-flow test --input 'OAuth2.0èªè¨¼ã‚’å®Ÿè£…'")
    print("  claude-elder-auto-flow add-bypass èª¿æŸ» ãƒ¬ãƒãƒ¼ãƒˆ")
    print("  claude-elder-auto-flow config show")


def main():
    """ãƒ¡ã‚¤ãƒ³é–¢æ•°"""
    parser = argparse.ArgumentParser(
        description="Claude Elder Auto Flow Management System",
        formatter_class=argparse.RawDescriptionHelpFormatter,
    )

    subparsers = parser.add_subparsers(dest="command", help="Available commands")

    # status ã‚³ãƒãƒ³ãƒ‰
    parser_status = subparsers.add_parser("status", help="Show system status")
    parser_status.add_argument(
        "--verbose", "-v", action="store_true", help="Verbose output"
    )
    parser_status.set_defaults(func=cmd_status)

    # enable ã‚³ãƒãƒ³ãƒ‰
    parser_enable = subparsers.add_parser("enable", help="Enable auto Elder Flow")
    parser_enable.set_defaults(func=cmd_enable)

    # disable ã‚³ãƒãƒ³ãƒ‰
    parser_disable = subparsers.add_parser("disable", help="Disable auto Elder Flow")
    parser_disable.set_defaults(func=cmd_disable)

    # test ã‚³ãƒãƒ³ãƒ‰
    parser_test = subparsers.add_parser("test", help="Test pattern matching")
    parser_test.add_argument("--input", help="Test input text")
    parser_test.add_argument("--file", help="Test input file")
    parser_test.set_defaults(func=cmd_test)

    # config ã‚³ãƒãƒ³ãƒ‰
    parser_config = subparsers.add_parser("config", help="Configuration management")
    parser_config.add_argument(
        "action", choices=["show", "set", "reset"], help="Config action"
    )
    parser_config.add_argument("--config-file", help="Configuration file path")
    parser_config.set_defaults(func=cmd_config)

    # add-bypass ã‚³ãƒãƒ³ãƒ‰
    parser_add_bypass = subparsers.add_parser("add-bypass", help="Add bypass keywords")
    parser_add_bypass.add_argument("keywords", nargs="+", help="Keywords to add")
    parser_add_bypass.set_defaults(func=cmd_add_bypass)

    # remove-bypass ã‚³ãƒãƒ³ãƒ‰
    parser_remove_bypass = subparsers.add_parser(
        "remove-bypass", help="Remove bypass keywords"
    )
    parser_remove_bypass.add_argument("keywords", nargs="+", help="Keywords to remove")
    parser_remove_bypass.set_defaults(func=cmd_remove_bypass)

    # help ã‚³ãƒãƒ³ãƒ‰
    parser_help = subparsers.add_parser("help", help="Show help")
    parser_help.set_defaults(func=cmd_help)

    args = parser.parse_args()

    if not args.command:
        cmd_help(args)
        return 0

    if args.command == "help":
        cmd_help(args)
        return 0

    # éåŒæœŸã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ
    if asyncio.iscoroutinefunction(args.func):
        return asyncio.run(args.func(args))
    else:
        return args.func(args)


if __name__ == "__main__":
    sys.exit(main())
