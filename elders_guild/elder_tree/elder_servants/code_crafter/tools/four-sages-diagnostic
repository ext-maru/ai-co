#!/usr/bin/env python3
"""
ğŸ¥ Four Sages Diagnostic CLI
4è³¢è€…ã‚·ã‚¹ãƒ†ãƒ è¨ºæ–­ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ãƒ„ãƒ¼ãƒ«
"""

import argparse
import asyncio
import json
import sys
from pathlib import Path

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã‚’ãƒ‘ã‚¹ã«è¿½åŠ 
project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))

from libs.four_sages_diagnostic_system import FourSagesDiagnosticSystem, run_four_sages_diagnosis


async def main():
    """ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œé–¢æ•°"""
    parser = argparse.ArgumentParser(
        description="ğŸ¥ Four Sages System Diagnostic Tool",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  four-sages-diagnostic                    # åŸºæœ¬è¨ºæ–­å®Ÿè¡Œ
  four-sages-diagnostic --auto-fix         # è¨ºæ–­ï¼‹è‡ªå‹•ä¿®å¾©
  four-sages-diagnostic --json-output      # JSONå½¢å¼ã§å‡ºåŠ›
  four-sages-diagnostic --components env,db # ç‰¹å®šã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ã¿è¨ºæ–­
        """
    )
    
    parser.add_argument(
        "--auto-fix", 
        action="store_true",
        help="è‡ªå‹•ä¿®å¾©ã‚’å•ã„åˆã‚ã›ãªã—ã§å®Ÿè¡Œ"
    )
    
    parser.add_argument(
        "--json-output",
        action="store_true", 
        help="çµæœã‚’JSONå½¢å¼ã§å‡ºåŠ›"
    )
    
    parser.add_argument(
        "--components",
        help="è¨ºæ–­å¯¾è±¡ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ (env,db,kb,proc,fs,config)"
    )
    
    parser.add_argument(
        "--output-file",
        help="çµæœå‡ºåŠ›å…ˆãƒ•ã‚¡ã‚¤ãƒ«"
    )
    
    parser.add_argument(
        "--base-path",
        help="ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹",
        default="/home/aicompany/ai_co"
    )
    
    parser.add_argument(
        "--verbose", "-v",
        action="store_true",
        help="è©³ç´°å‡ºåŠ›"
    )
    
    args = parser.parse_args()
    
    try:
        # è¨ºæ–­ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
        diagnostic = FourSagesDiagnosticSystem()
        diagnostic.base_path = Path(args.base_path)
        
        if not args.json_output:
            print("ğŸ¥ 4è³¢è€…ã‚·ã‚¹ãƒ†ãƒ è¨ºæ–­ã‚’é–‹å§‹ã—ã¾ã™...")
        
        # è¨ºæ–­å®Ÿè¡Œ
        report = await diagnostic.run_full_diagnosis()
        
        # è‡ªå‹•ä¿®å¾©å®Ÿè¡Œï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
        if args.auto_fix or (not args.json_output and report['summary']['auto_fixable'] > 0):
            if args.auto_fix or input("\nğŸ”§ è‡ªå‹•ä¿®å¾©ã‚’å®Ÿè¡Œã—ã¾ã™ã‹? (y/n): ").lower() == 'y':
                if not args.json_output:
                    print("ğŸ”§ è‡ªå‹•ä¿®å¾©ã‚’å®Ÿè¡Œä¸­...")
                    
                fix_results = await diagnostic.apply_auto_fixes()
                
                if not args.json_output:
                    print(f"  ä¿®å¾©å®Œäº†: {fix_results['fixes_applied']}")
                    print(f"  ä¿®å¾©å¤±æ•—: {fix_results['fixes_failed']}")
                    
                    if fix_results['fixes_applied'] > 0:
                        print("ğŸ”„ å†è¨ºæ–­ã‚’å®Ÿè¡Œä¸­...")
                        report = await diagnostic.run_full_diagnosis()
                
                # ä¿®å¾©çµæœã‚’ãƒ¬ãƒãƒ¼ãƒˆã«è¿½åŠ 
                report['fix_results'] = fix_results
        
        # çµæœå‡ºåŠ›
        if args.json_output:
            output = json.dumps(report, indent=2, default=str)
            if args.output_file:
                with open(args.output_file, 'w') as f:
                    f.write(output)
                print(f"è¨ºæ–­çµæœã‚’ {args.output_file} ã«ä¿å­˜ã—ã¾ã—ãŸ")
            else:
                print(output)
        else:
            # ãƒ’ãƒ¥ãƒ¼ãƒãƒ³ãƒªãƒ¼ãƒ€ãƒ–ãƒ«ãªå‡ºåŠ›
            display_report(report, verbose=args.verbose)
            
            if args.output_file:
                with open(args.output_file, 'w') as f:
                    json.dump(report, f, indent=2, default=str)
                print(f"\nğŸ“„ è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆã‚’ {args.output_file} ã«ä¿å­˜ã—ã¾ã—ãŸ")
        
        # çµ‚äº†ã‚³ãƒ¼ãƒ‰æ±ºå®š
        if report['overall_status'] in ['critical', 'error']:
            sys.exit(2)
        elif report['overall_status'] == 'warning':
            sys.exit(1)
        else:
            sys.exit(0)
            
    except KeyboardInterrupt:
        print("\nâŒ è¨ºæ–­ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ")
        sys.exit(130)
    except Exception as e:
        print(f"âŒ è¨ºæ–­å®Ÿè¡Œä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
        if args.verbose:
            import traceback
            traceback.print_exc()
        sys.exit(1)


def display_report(report, verbose=False):
    """ãƒ¬ãƒãƒ¼ãƒˆã‚’ãƒ’ãƒ¥ãƒ¼ãƒãƒ³ãƒªãƒ¼ãƒ€ãƒ–ãƒ«å½¢å¼ã§è¡¨ç¤º"""
    print(f"\nğŸ“Š è¨ºæ–­ãƒ¬ãƒãƒ¼ãƒˆ - {report['timestamp']}")
    print(f"å…¨ä½“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: {get_status_emoji(report['overall_status'])} {report['overall_status'].upper()}")
    print(f"å¥å…¨æ€§ã‚¹ã‚³ã‚¢: {report['health_score']:.1f}/100")
    
    summary = report['summary']
    print(f"\nğŸ“‹ ã‚µãƒãƒªãƒ¼:")
    print(f"  ç·ãƒ†ã‚¹ãƒˆæ•°: {summary['total_tests']}")
    print(f"  å¥å…¨: {summary['healthy']} | è­¦å‘Š: {summary['warnings']} | ã‚¨ãƒ©ãƒ¼: {summary['errors']} | é‡å¤§: {summary['critical']}")
    
    if summary['auto_fixable'] > 0:
        print(f"  ğŸ”§ è‡ªå‹•ä¿®å¾©å¯èƒ½: {summary['auto_fixable']}")
    
    # ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåˆ¥çŠ¶æ³
    if verbose:
        print(f"\nğŸ” ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåˆ¥è©³ç´°:")
        for component_name, results in report['components'].items():
            if results:
                component_status = get_component_status(results)
                print(f"  {get_component_emoji(component_name)} {component_name}: {component_status}")
                
                for result in results:
                    status_emoji = get_status_emoji(result['status'])
                    print(f"    {status_emoji} {result['test_name']}: {result['message']}")
    
    # æ¨å¥¨äº‹é …
    if report['recommendations']:
        print(f"\nğŸ’¡ æ¨å¥¨äº‹é …:")
        for recommendation in report['recommendations']:
            print(f"  {recommendation}")
    
    # ä¿®å¾©çµæœï¼ˆã‚ã‚Œã°ï¼‰
    if 'fix_results' in report:
        fix_results = report['fix_results']
        print(f"\nğŸ”§ è‡ªå‹•ä¿®å¾©çµæœ:")
        print(f"  ä¿®å¾©å®Œäº†: {fix_results['fixes_applied']}")
        print(f"  ä¿®å¾©å¤±æ•—: {fix_results['fixes_failed']}")
        
        if verbose and fix_results['applied']:
            print(f"  ä¿®å¾©å†…å®¹:")
            for fix in fix_results['applied']:
                print(f"    âœ… {fix['component']}: {fix['action']}")


def get_status_emoji(status):
    """ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹çµµæ–‡å­—ã‚’å–å¾—"""
    emojis = {
        'healthy': 'âœ…',
        'warning': 'âš ï¸', 
        'error': 'âŒ',
        'critical': 'ğŸš¨'
    }
    return emojis.get(status, 'â“')


def get_component_emoji(component):
    """ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆçµµæ–‡å­—ã‚’å–å¾—"""
    emojis = {
        'environment': 'ğŸŒ',
        'database': 'ğŸ’¾',
        'knowledge_base': 'ğŸ“š',
        'processes': 'âš™ï¸',
        'filesystem': 'ğŸ“',
        'configuration': 'âš™ï¸'
    }
    return emojis.get(component, 'ğŸ”§')


def get_component_status(results):
    """ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå…¨ä½“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å–å¾—"""
    statuses = [r['status'] for r in results]
    if 'critical' in statuses:
        return 'ğŸš¨ CRITICAL'
    elif 'error' in statuses:
        return 'âŒ ERROR'
    elif 'warning' in statuses:
        return 'âš ï¸ WARNING'
    else:
        return 'âœ… HEALTHY'


if __name__ == "__main__":
    asyncio.run(main())