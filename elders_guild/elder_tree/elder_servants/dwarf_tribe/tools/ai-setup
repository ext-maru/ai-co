#!/bin/bash
#
# AI Setup - AI Companyç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ„ãƒ¼ãƒ«
#

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"

echo "ğŸš€ AI Company Environment Setup"
echo "=================================="

cd "$PROJECT_DIR"

# 1. .envãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèªãƒ»ä½œæˆ
if [[ ! -f ".env" ]]; then
    if [[ -f ".env.template" ]]; then
        echo "ğŸ“‹ Creating .env file from template..."
        cp .env.template .env
        echo "âœ… .env file created"
        echo "âš ï¸  Please edit .env file and fill in your API keys and tokens"
        echo ""
    else
        echo "âŒ .env.template not found"
        exit 1
    fi
else
    echo "âœ… .env file already exists"
fi

# 2. ä»®æƒ³ç’°å¢ƒã®ç¢ºèª
if [[ ! -d "venv" ]]; then
    echo "ğŸ“¦ Creating Python virtual environment..."
    python3 -m venv venv
    echo "âœ… Virtual environment created"
else
    echo "âœ… Virtual environment already exists"
fi

# 3. ä»®æƒ³ç’°å¢ƒã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ãƒˆ
if [[ ! "$AI_VENV_ACTIVE" == "1" ]]; then
    echo "ğŸ”„ Activating virtual environment..."
    source venv/bin/activate
    export AI_VENV_ACTIVE=1
    echo "âœ… Virtual environment activated"
else
    echo "âœ… Virtual environment already active"
fi

# 4. ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
if [[ -f "requirements.txt" ]]; then
    echo "ğŸ“¥ Installing Python dependencies..."
    pip install -r requirements.txt
    echo "âœ… Dependencies installed"
else
    echo "âš ï¸  requirements.txt not found, skipping dependency installation"
fi

# 5. ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã®ç¢ºèªãƒ»ä½œæˆ
echo "ğŸ“ Creating directory structure..."
mkdir -p logs
mkdir -p output
mkdir -p data
mkdir -p web
echo "âœ… Directory structure created"

# 6. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–
if [[ -f "scripts/setup_database.sh" ]]; then
    echo "ğŸ—„ï¸  Initializing database..."
    chmod +x scripts/setup_database.sh
    ./scripts/setup_database.sh
    echo "âœ… Database initialized"
fi

# 7. è¨­å®šæ¤œè¨¼
echo "ğŸ” Verifying environment setup..."
python3 -c "
import sys
sys.path.append('$PROJECT_DIR')

try:
    from libs.env_config import verify_setup
    success = verify_setup()

    if success:
        print()
        print('ğŸ‰ Setup completed successfully!')
        print()
        print('Next steps:')
        print('1. Edit .env file with your API keys')
        print('2. Start the system: ai-start')
        print('3. Check status: ai-status')
        exit(0)
    else:
        print()
        print('âš ï¸  Setup completed but some configuration issues found')
        print('Please check the .env file')
        exit(1)

except Exception as e:
    print(f'âŒ Setup verification failed: {e}')
    exit(1)
"

setup_exit_code=$?

echo ""
echo "=========================================="

if [[ $setup_exit_code -eq 0 ]]; then
    echo "âœ… AI Company setup completed successfully!"
    echo ""
    echo "Quick start commands:"
    echo "  ai-start     # Start the system"
    echo "  ai-status    # Check system status"
    echo "  ai-help      # Get help"
else
    echo "âš ï¸  Setup completed with warnings"
    echo "Please review the .env file configuration"
fi
