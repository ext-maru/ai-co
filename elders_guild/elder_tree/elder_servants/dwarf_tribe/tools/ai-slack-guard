#!/bin/bash
# SlackWorker監視の起動/停止スクリプト

WATCHDOG_SCRIPT="/home/aicompany/ai_co/slack_worker_watchdog.sh"
WATCHDOG_PID_FILE="/tmp/slack_watchdog.pid"

case "$1" in
    start)
        if [ -f "$WATCHDOG_PID_FILE" ] && kill -0 $(cat "$WATCHDOG_PID_FILE") 2>/dev/null; then
            echo "🔍 SlackWorker監視は既に実行中です"
            exit 1
        fi

        echo "🚀 SlackWorker監視を開始します..."
        nohup "$WATCHDOG_SCRIPT" > /dev/null 2>&1 &
        echo $! > "$WATCHDOG_PID_FILE"
        echo "✅ SlackWorker監視開始完了 (PID: $(cat $WATCHDOG_PID_FILE))"
        ;;

    stop)
        if [ -f "$WATCHDOG_PID_FILE" ]; then
            PID=$(cat "$WATCHDOG_PID_FILE")
            if kill -0 "$PID" 2>/dev/null; then
                kill "$PID"
                rm -f "$WATCHDOG_PID_FILE"
                echo "🛑 SlackWorker監視を停止しました"
            else
                echo "⚠️ SlackWorker監視プロセスが見つかりません"
                rm -f "$WATCHDOG_PID_FILE"
            fi
        else
            echo "⚠️ SlackWorker監視は実行されていません"
        fi
        ;;

    status)
        if [ -f "$WATCHDOG_PID_FILE" ] && kill -0 $(cat "$WATCHDOG_PID_FILE") 2>/dev/null; then
            echo "✅ SlackWorker監視実行中 (PID: $(cat $WATCHDOG_PID_FILE))"
        else
            echo "❌ SlackWorker監視停止中"
        fi
        ;;

    *)
        echo "使用方法: $0 {start|stop|status}"
        echo ""
        echo "  start  - SlackWorker監視開始"
        echo "  stop   - SlackWorker監視停止"
        echo "  status - SlackWorker監視状況確認"
        exit 1
        ;;
esac
