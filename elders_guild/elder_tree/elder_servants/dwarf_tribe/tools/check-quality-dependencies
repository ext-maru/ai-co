#!/bin/bash
# ğŸ”§ Elder Guild Quality Dependencies Checker
# ã‚¨ãƒ«ãƒ€ãƒ¼ã‚ºã‚®ãƒ«ãƒ‰å“è³ªã‚·ã‚¹ãƒ†ãƒ ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚«ãƒ¼
#
# Features:
# - å¿…é ˆä¾å­˜é–¢ä¿‚ã®è‡ªå‹•æ¤œå‡º
# - ä¸è¶³ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®è‡ªå‹•ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
# - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šã®æ¤œè¨¼
# - æ¨©é™ãƒ»ç’°å¢ƒã®ç¢ºèª

set -euo pipefail
IFS=$'\n\t'

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š
export PATH="/usr/local/bin:/usr/bin:/bin"
umask 077

# Rootå®Ÿè¡Œé˜²æ­¢
if [[ $(id -u) -eq 0 ]]; then
    echo "âŒ ERROR: Dependency checker cannot run as root"
    exit 1
fi

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m' # No Color

print_header() {
    echo -e "${PURPLE}${BOLD}"
    echo "ğŸ”§ ELDER GUILD QUALITY DEPENDENCIES CHECKER"
    echo "    ã‚¨ãƒ«ãƒ€ãƒ¼ã‚ºã‚®ãƒ«ãƒ‰å“è³ªã‚·ã‚¹ãƒ†ãƒ ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚«ãƒ¼"
    echo "    Version: 1.0 - Secure Dependency Management"
    echo -e "${NC}"
}

print_status() {
    echo -e "${CYAN}ğŸ”§ $1${NC}"
}

print_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

print_error() {
    echo -e "${RED}âŒ $1${NC}"
}

# å¿…é ˆã‚³ãƒãƒ³ãƒ‰ã®å®šç¾©
REQUIRED_COMMANDS=(
    "python3:Python 3 interpreter"
    "pip3:Python package installer"
    "git:Git version control"
    "bc:Basic calculator for numeric operations"
    "jq:JSON processor"
    "psql:PostgreSQL client"
)

# å¿…é ˆPythonãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å®šç¾©
REQUIRED_PYTHON_MODULES=(
    "psutil:System and process utilities"
    "psycopg2:PostgreSQL adapter"
    "requests:HTTP library"
    "numpy:Numerical computing"
    "configparser:Configuration file parser"
)

# ã‚ªãƒ—ã‚·ãƒ§ãƒ³Pythonãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å®šç¾©
OPTIONAL_PYTHON_MODULES=(
    "radon:Code complexity analysis"
    "bandit:Security analysis"
    "pylint:Code analysis"
    "mypy:Static type checker"
    "openai:OpenAI API client"
)

check_command_availability() {
    local missing_commands=()
    
    print_status "Checking required system commands..."
    
    for cmd_info in "${REQUIRED_COMMANDS[@]}"; do
        local cmd=$(echo "$cmd_info" | cut -d: -f1)
        local desc=$(echo "$cmd_info" | cut -d: -f2)
        
        if command -v "$cmd" &> /dev/null; then
            print_success "$cmd ($desc) - available"
        else
            print_error "$cmd ($desc) - MISSING"
            missing_commands+=("$cmd")
        fi
    done
    
    if [[ ${#missing_commands[@]} -gt 0 ]]; then
        print_warning "Missing commands: ${missing_commands[*]}"
        return 1
    fi
    
    return 0
}

check_python_modules() {
    local missing_required=()
    local missing_optional=()
    
    print_status "Checking required Python modules..."
    
    # å¿…é ˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
    for module_info in "${REQUIRED_PYTHON_MODULES[@]}"; do
        local module=$(echo "$module_info" | cut -d: -f1)
        local desc=$(echo "$module_info" | cut -d: -f2)
        
        if python3 -c "import $module" &> /dev/null; then
            print_success "$module ($desc) - available"
        else
            print_error "$module ($desc) - MISSING"
            missing_required+=("$module")
        fi
    done
    
    print_status "Checking optional Python modules..."
    
    # ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
    for module_info in "${OPTIONAL_PYTHON_MODULES[@]}"; do
        local module=$(echo "$module_info" | cut -d: -f1)
        local desc=$(echo "$module_info" | cut -d: -f2)
        
        if python3 -c "import $module" &> /dev/null; then
            print_success "$module ($desc) - available"
        else
            print_warning "$module ($desc) - missing (optional)"
            missing_optional+=("$module")
        fi
    done
    
    # çµæœè¡¨ç¤º
    if [[ ${#missing_required[@]} -gt 0 ]]; then
        print_error "Missing required modules: ${missing_required[*]}"
    fi
    
    if [[ ${#missing_optional[@]} -gt 0 ]]; then
        print_warning "Missing optional modules: ${missing_optional[*]}"
    fi
    
    # å¿…é ˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒä¸è¶³ã—ã¦ã„ã‚‹å ´åˆã¯å¤±æ•—
    [[ ${#missing_required[@]} -eq 0 ]]
}

install_system_dependencies() {
    print_status "Installing missing system dependencies..."
    
    # Ubuntu/Debianãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®ç¢ºèª
    if command -v apt-get &> /dev/null; then
        print_status "Using apt-get package manager"
        
        # ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒªã‚¹ãƒˆã®æ›´æ–°
        sudo apt-get update || {
            print_error "Failed to update package list"
            return 1
        }
        
        # å¿…é ˆãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        local packages=(
            "bc"
            "jq" 
            "postgresql-client"
            "python3-pip"
            "python3-dev"
            "build-essential"
        )
        
        for package in "${packages[@]}"; do
            if ! dpkg -l "$package" &> /dev/null; then
                print_status "Installing $package..."
                sudo apt-get install -y "$package" || {
                    print_error "Failed to install $package"
                    return 1
                }
                print_success "$package installed"
            else
                print_success "$package already installed"
            fi
        done
        
    else
        print_error "Unsupported package manager. Please install dependencies manually:"
        echo "  - bc (basic calculator)"
        echo "  - jq (JSON processor)"
        echo "  - postgresql-client"
        echo "  - python3-pip"
        return 1
    fi
}

install_python_dependencies() {
    print_status "Installing Python dependencies..."
    
    # å¿…é ˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    local required_pip_packages=(
        "psutil"
        "psycopg2-binary"
        "requests" 
        "numpy"
    )
    
    for package in "${required_pip_packages[@]}"; do
        print_status "Installing Python package: $package"
        pip3 install --user "$package" || {
            print_error "Failed to install $package"
            return 1
        }
        print_success "$package installed"
    done
    
    # ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆå¤±æ•—ã—ã¦ã‚‚ç¶šè¡Œï¼‰
    local optional_pip_packages=(
        "radon"
        "bandit"
        "pylint"
        "mypy"
    )
    
    print_status "Installing optional Python packages..."
    for package in "${optional_pip_packages[@]}"; do
        print_status "Installing optional package: $package"
        if pip3 install --user "$package"; then
            print_success "$package installed"
        else
            print_warning "$package installation failed (optional)"
        fi
    done
}

check_postgresql_connectivity() {
    print_status "Testing PostgreSQL connectivity..."
    
    local test_db="elders_guild_pgvector"
    local test_user="postgres"
    local test_host="localhost"
    
    if psql -h "$test_host" -U "$test_user" -d "$test_db" -c "SELECT 1;" &>/dev/null; then
        print_success "PostgreSQL connection successful"
        
        # pgvectoræ‹¡å¼µã®ç¢ºèª
        if psql -h "$test_host" -U "$test_user" -d "$test_db" -c "SELECT * FROM pg_extension WHERE extname='vector';" | grep -q vector; then
            print_success "pgvector extension available"
        else
            print_warning "pgvector extension not found (may need installation)"
        fi
        
    else
        print_warning "PostgreSQL connection failed"
        print_status "Database features may not work properly"
        print_status "To fix: ensure PostgreSQL is running and database exists"
    fi
}

check_file_permissions() {
    print_status "Checking file permissions..."
    
    local project_root="/home/aicompany/ai_co"
    
    # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ç¢ºèª
    if [[ ! -d "$project_root" ]]; then
        print_error "Project root not found: $project_root"
        return 1
    fi
    
    # æ›¸ãè¾¼ã¿æ¨©é™ã®ç¢ºèª
    if [[ ! -w "$project_root" ]]; then
        print_error "No write permission to project root: $project_root"
        return 1
    fi
    
    # å¿…è¦ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆãƒ»æ¨©é™è¨­å®š
    local required_dirs=(
        "$project_root/data"
        "$project_root/logs"
        "$project_root/data/merge_quality_reports"
        "$project_root/data/merge_approvals"
        "$project_root/data/quality_cache"
    )
    
    for dir in "${required_dirs[@]}"; do
        if [[ ! -d "$dir" ]]; then
            mkdir -p "$dir" || {
                print_error "Failed to create directory: $dir"
                return 1
            }
            print_success "Created directory: $dir"
        fi
        
        # ã‚»ã‚­ãƒ¥ã‚¢ãªæ¨©é™è¨­å®š
        chmod 700 "$dir" || {
            print_error "Failed to set permissions for: $dir"
            return 1
        }
    done
    
    print_success "File permissions verified"
}

generate_dependency_report() {
    print_status "Generating dependency report..."
    
    local report_file="/home/aicompany/ai_co/data/dependency_check_$(date +%Y%m%d_%H%M%S).json"
    
    cat > "$report_file" << EOF
{
    "timestamp": "$(date -Iseconds)",
    "check_version": "1.0",
    "system_info": {
        "os": "$(uname -s)",
        "kernel": "$(uname -r)",
        "architecture": "$(uname -m)",
        "user": "$(whoami)",
        "python_version": "$(python3 --version 2>&1)",
        "pip_version": "$(pip3 --version 2>&1)"
    },
    "commands_check": {
        "total_required": ${#REQUIRED_COMMANDS[@]},
        "available": $(check_command_availability && echo "true" || echo "false")
    },
    "python_modules_check": {
        "required_modules": ${#REQUIRED_PYTHON_MODULES[@]},
        "optional_modules": ${#OPTIONAL_PYTHON_MODULES[@]},
        "all_available": $(check_python_modules && echo "true" || echo "false")
    },
    "postgresql_check": {
        "connectivity": $(check_postgresql_connectivity &>/dev/null && echo "true" || echo "false")
    },
    "permissions_check": {
        "verified": $(check_file_permissions &>/dev/null && echo "true" || echo "false")
    },
    "elder_guild_compliance": {
        "ready_for_production": false,
        "requires_attention": true
    }
}
EOF
    
    print_success "Dependency report saved: $report_file"
}

run_full_dependency_check() {
    print_header
    
    local overall_success=true
    
    # 1. ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒãƒ³ãƒ‰ãƒã‚§ãƒƒã‚¯
    if ! check_command_availability; then
        print_status "Attempting to install missing system dependencies..."
        if ! install_system_dependencies; then
            overall_success=false
        fi
    fi
    
    # 2. Pythonãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯
    if ! check_python_modules; then
        print_status "Attempting to install missing Python dependencies..."
        if ! install_python_dependencies; then
            overall_success=false
        fi
    fi
    
    # 3. PostgreSQLæ¥ç¶šãƒã‚§ãƒƒã‚¯
    check_postgresql_connectivity
    
    # 4. ãƒ•ã‚¡ã‚¤ãƒ«æ¨©é™ãƒã‚§ãƒƒã‚¯
    if ! check_file_permissions; then
        overall_success=false
    fi
    
    # 5. ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
    generate_dependency_report
    
    # çµæœè¡¨ç¤º
    echo ""
    if [[ "$overall_success" == "true" ]]; then
        print_success "ğŸ‰ All dependency checks passed!"
        print_success "Elder Guild Quality System is ready for operation"
    else
        print_error "âš ï¸ Some dependency issues remain"
        print_error "Please resolve the above issues before using the quality system"
        echo ""
        echo -e "${YELLOW}For help with dependency issues:${NC}"
        echo "  1. Check the dependency report in data/ directory"
        echo "  2. Ensure you have sudo privileges for system packages"
        echo "  3. Check internet connectivity for package downloads"
        echo "  4. Verify PostgreSQL is installed and running"
    fi
    
    return $([ "$overall_success" == "true" ] && echo 0 || echo 1)
}

# ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œ
main() {
    # å¼•æ•°å‡¦ç†
    case "${1:-full}" in
        "commands")
            check_command_availability
            ;;
        "python")
            check_python_modules
            ;;
        "install")
            install_system_dependencies && install_python_dependencies
            ;;
        "permissions")
            check_file_permissions
            ;;
        "postgres")
            check_postgresql_connectivity
            ;;
        "full"|*)
            run_full_dependency_check
            ;;
    esac
}

# ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
main "$@"