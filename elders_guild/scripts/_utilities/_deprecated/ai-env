#!/bin/bash
#
# AI Env - ã‚·ãƒ³ãƒ—ãƒ«ç’°å¢ƒå¤‰æ•°ç®¡ç†
#

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"

COMMAND="$1"

if [[ -z "$COMMAND" ]]; then
    echo "Usage: ai-env <command>"
    echo ""
    echo "Commands:"
    echo "  check       Check environment configuration"
    echo "  setup       Setup .env file from template"
    echo "  verify      Verify required variables are set"
    echo "  show        Show current environment (masked)"
    echo ""
    exit 1
fi

cd "$PROJECT_DIR"

case "$COMMAND" in
    check)
        echo "ğŸ” Environment Configuration Check"
        echo "=================================="

        # ä»®æƒ³ç’°å¢ƒãƒã‚§ãƒƒã‚¯
        if [[ ! "$AI_VENV_ACTIVE" == "1" ]]; then
            if [[ -f "venv/bin/activate" ]]; then
                source venv/bin/activate
                export AI_VENV_ACTIVE=1
            fi
        fi

        python3 -c "
import sys
sys.path.append('$PROJECT_DIR')

try:
    from libs.env_config import verify_setup
    verify_setup()
except Exception as e:
    print(f'âŒ Check failed: {e}')
    print('ğŸ’¡ Try: ai-setup')
"
        ;;

    setup)
        echo "ğŸ“‹ Setting up .env file"
        echo "======================="

        if [[ -f ".env" ]]; then
            echo "âš ï¸  .env file already exists"
            echo "Do you want to overwrite it? (y/N)"
            read -r response
            if [[ ! "$response" =~ ^[Yy]$ ]]; then
                echo "Setup cancelled"
                exit 0
            fi
        fi

        if [[ -f ".env.template" ]]; then
            cp .env.template .env
            echo "âœ… .env file created from template"
            echo ""
            echo "ğŸ“ Please edit .env file and fill in your values:"
            echo "   - ANTHROPIC_API_KEY"
            echo "   - SLACK_BOT_TOKEN"
            echo "   - SLACK_APP_TOKEN"
            echo "   - SLACK_CHANNEL"
        else
            echo "âŒ .env.template not found"
            exit 1
        fi
        ;;

    verify)
        echo "âœ… Verifying Required Environment Variables"
        echo "=========================================="

        # å¿…é ˆå¤‰æ•°ãƒªã‚¹ãƒˆ
        REQUIRED_VARS=(
            "ANTHROPIC_API_KEY"
            "SLACK_BOT_TOKEN"
            "SLACK_CHANNEL"
            "PYTHONPATH"
        )

        # .envãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
        if [[ -f ".env" ]]; then
            set -a
            source .env
            set +a
        fi

        all_good=true

        for var in "${REQUIRED_VARS[@]}"; do
            if [[ -n "${!var}" && "${!var}" != "your_"*"_here" ]]; then
                echo "âœ… $var: Set"
            else
                echo "âŒ $var: Missing or placeholder"
                all_good=false
            fi
        done

        echo ""
        if [[ "$all_good" == "true" ]]; then
            echo "ğŸ‰ All required variables are set!"
        else
            echo "âš ï¸  Some required variables are missing"
            echo "ğŸ’¡ Edit .env file to set missing values"
        fi
        ;;

    show)
        echo "ğŸ” Current Environment Configuration"
        echo "==================================="

        # .envãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
        if [[ -f ".env" ]]; then
            set -a
            source .env
            set +a
        fi

        # é‡è¦ãªå¤‰æ•°ã‚’è¡¨ç¤ºï¼ˆãƒã‚¹ã‚¯ä»˜ãï¼‰
        SHOW_VARS=(
            "ANTHROPIC_API_KEY"
            "SLACK_BOT_TOKEN"
            "SLACK_APP_TOKEN"
            "SLACK_CHANNEL"
            "RABBITMQ_HOST"
            "PYTHONPATH"
            "AI_VENV_ACTIVE"
        )

        for var in "${SHOW_VARS[@]}"; do
            value="${!var}"
            if [[ -n "$value" ]]; then
                # ã‚»ãƒ³ã‚·ãƒ†ã‚£ãƒ–æƒ…å ±ã‚’ãƒã‚¹ã‚¯
                if [[ "$var" == *"TOKEN"* || "$var" == *"KEY"* ]]; then
                    if [[ ${#value} -gt 8 ]]; then
                        masked="${value:0:4}****${value: -4}"
                    else
                        masked="****"
                    fi
                    echo "ğŸ”‘ $var: $masked"
                else
                    echo "ğŸ“ $var: $value"
                fi
            else
                echo "âŒ $var: Not set"
            fi
        done
        ;;

    *)
        echo "âŒ Unknown command: $COMMAND"
        exit 1
        ;;
esac
