#!/usr/bin/env python3
"""
Elder - ã‚¨ãƒ«ãƒ€ãƒ¼ã‚ºçŸ¥è­˜ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ CLI
çŸ¥è­˜ã®è¿½åŠ ã€æ¤œç´¢ã€ç®¡ç†ã‚’è¡Œã†ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
"""

import argparse
import json
import os
import sys
from typing import Any, Dict, List

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ«ãƒ¼ãƒˆãƒ‘ã‚¹ã‚’è¿½åŠ 
sys.path.append("/home/aicompany/ai_co")

# elder cast æ©Ÿèƒ½ã®å¾©æ´»
if len(sys.argv) > 1 and sys.argv[1] == "cast":
    # elder-cast ã‚³ãƒãƒ³ãƒ‰ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼ˆTTYä¿æŒã®ãŸã‚execã‚’ä½¿ç”¨ï¼‰
    import os
    cast_args = ["elder-cast"] + sys.argv[2:]
    os.execvp("elder-cast", cast_args)
    # execvpã¯æˆ»ã‚‰ãªã„ã®ã§exitä¸è¦

print("âš ï¸ elderã‚³ãƒãƒ³ãƒ‰ã¯ç¾åœ¨4è³¢è€…ã‚·ã‚¹ãƒ†ãƒ ã«çµ±åˆã•ã‚Œã¦ã„ã¾ã™")
print()
print("ğŸ”® é­”æ³•è© å”±ã‚³ãƒãƒ³ãƒ‰:")
print("  elder cast çŸ¥è­˜å¬å–š 'ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰'")
print("  elder cast 4è³¢è€…ä¼šè­° 'ãƒˆãƒ”ãƒƒã‚¯'")
print("  elder cast å®Œå…¨è‡ªå‹•åŒ– 'ã‚¿ã‚¹ã‚¯å' --power high")
print()
print("ğŸ¤– ãã®ä»–åˆ©ç”¨å¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰:")
print("  - elder-flow execute 'ã‚¿ã‚¹ã‚¯å' --priority high")
print("  - elder-cast çŸ¥è­˜å¬å–š 'ã‚¯ã‚¨ãƒª' --power medium")
print()
print("ğŸ“š è©³ç´°ãƒ˜ãƒ«ãƒ—:")
print("  elder-cast --help")
print()
exit(0)


class AIElderCLI:
    """AI Elder CLIã®ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹"""

    def __init__(self):
        self.manager = EldersKnowledgeManager()

    def search(
        self, query: str, limit: int = 10, category: str = None, elder: str = None
    ):
        """çŸ¥è­˜ã‚’æ¤œç´¢"""
        print(f"\nğŸ” æ¤œç´¢ä¸­: '{query}'")

        # ã‚«ãƒ†ã‚´ãƒªIDã¨ã‚¨ãƒ«ãƒ€ãƒ¼IDã®å–å¾—
        category_id = None
        elder_id = None

        if category:
            categories = self.manager.get_categories()
            for cat in categories:
                if cat["name"].lower() == category.lower():
                    category_id = cat["id"]
                    break

        if elder:
            elders = self.manager.get_elders()
            for e in elders:
                if e["name"].lower() == elder.lower():
                    elder_id = e["id"]
                    break

        # æ¤œç´¢å®Ÿè¡Œ
        results = self.manager.search_knowledge(
            query, limit=limit, category_id=category_id, elder_id=elder_id
        )

        if not results:
            print("âŒ è©²å½“ã™ã‚‹çŸ¥è­˜ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚")
            return

        print(f"\nâœ… {len(results)}ä»¶ã®çŸ¥è­˜ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ:\n")

        for i, result in enumerate(results, 1):
            print(f"{i}. ğŸ“š {result['title']}")
            print(f"   ğŸ‘¤ ã‚¨ãƒ«ãƒ€ãƒ¼: {result['elder_name']}")
            print(f"   ğŸ“ ã‚«ãƒ†ã‚´ãƒª: {result['category_name']}")
            if "similarity_score" in result:
                print(f"   ğŸ¯ é¡ä¼¼åº¦: {result['similarity_score']:.2%}")
            print(f"   ğŸ“ å†…å®¹: {result['content'][:100]}...")
            if result["tags"]:
                print(f"   ğŸ·ï¸  ã‚¿ã‚°: {', '.join(result['tags'])}")
            print()

    def add(
        self,
        title: str,
        content: str,
        category: str = "æŠ€è¡“",
        elder: str = "æŠ€è¡“é•·è€",
        tags: List[str] = None,
        importance: float = 0.5,
    ):
        """æ–°ã—ã„çŸ¥è­˜ã‚’è¿½åŠ """
        # ã‚«ãƒ†ã‚´ãƒªã¨ã‚¨ãƒ«ãƒ€ãƒ¼ã®æ¤œè¨¼
        categories = self.manager.get_categories()
        category_id = 1  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
        for cat in categories:
            if cat["name"] == category:
                category_id = cat["id"]
                break

        elders = self.manager.get_elders()
        elder_id = 1  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
        for e in elders:
            if e["name"] == elder:
                elder_id = e["id"]
                break

        # çŸ¥è­˜ã®è¿½åŠ 
        try:
            knowledge_id = self.manager.add_knowledge(
                title=title,
                content=content,
                category_id=category_id,
                elder_id=elder_id,
                tags=tags or [],
                importance_score=importance,
            )
            print(f"âœ… çŸ¥è­˜ã‚’è¿½åŠ ã—ã¾ã—ãŸ (ID: {knowledge_id})")
            print(f"   ğŸ“š ã‚¿ã‚¤ãƒˆãƒ«: {title}")
            print(f"   ğŸ‘¤ ã‚¨ãƒ«ãƒ€ãƒ¼: {elder}")
            print(f"   ğŸ“ ã‚«ãƒ†ã‚´ãƒª: {category}")
        except Exception as e:
            print(f"âŒ ã‚¨ãƒ©ãƒ¼: {e}")

    def list_categories(self):
        """ã‚«ãƒ†ã‚´ãƒªä¸€è¦§ã‚’è¡¨ç¤º"""
        categories = self.manager.get_categories()
        print("\nğŸ“ ã‚«ãƒ†ã‚´ãƒªä¸€è¦§:")
        for cat in categories:
            print(f"  - {cat['name']}: {cat['description']}")

    def list_elders(self):
        """ã‚¨ãƒ«ãƒ€ãƒ¼ä¸€è¦§ã‚’è¡¨ç¤º"""
        elders = self.manager.get_elders()
        print("\nğŸ‘¥ ã‚¨ãƒ«ãƒ€ãƒ¼ä¸€è¦§:")
        for elder in elders:
            expertise = ", ".join(elder["expertise"]) if elder["expertise"] else "ãªã—"
            print(f"  - {elder['name']} (ä¿¡é ¼åº¦: {elder['reliability_score']:.1f})")
            print(f"    å°‚é–€åˆ†é‡: {expertise}")
            print(f"    èª¬æ˜: {elder['description']}")

    def add_elder(
        self,
        name: str,
        expertise: List[str],
        description: str = "",
        reliability: float = 1.0,
    ):
        """æ–°ã—ã„ã‚¨ãƒ«ãƒ€ãƒ¼ã‚’è¿½åŠ """
        try:
            elder_id = self.manager.add_elder(
                name=name,
                expertise=expertise,
                description=description,
                reliability_score=reliability,
            )
            print(f"âœ… ã‚¨ãƒ«ãƒ€ãƒ¼ã‚’è¿½åŠ ã—ã¾ã—ãŸ (ID: {elder_id})")
            print(f"   ğŸ‘¤ åå‰: {name}")
            print(f"   ğŸ“ å°‚é–€åˆ†é‡: {', '.join(expertise)}")
        except Exception as e:
            print(f"âŒ ã‚¨ãƒ©ãƒ¼: {e}")

    def import_json(self, filepath: str):
        """JSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰çŸ¥è­˜ã‚’ä¸€æ‹¬ã‚¤ãƒ³ãƒãƒ¼ãƒˆ"""
        try:
            with open(filepath, "r", encoding="utf-8") as f:
                data = json.load(f)

            if not isinstance(data, list):
                print("âŒ JSONãƒ•ã‚¡ã‚¤ãƒ«ã¯çŸ¥è­˜ã‚¨ãƒ³ãƒˆãƒªã®é…åˆ—ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™")
                return

            print(f"ğŸ“¥ {len(data)}ä»¶ã®çŸ¥è­˜ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­...")
            success, errors = self.manager.bulk_import_knowledge(data)
            print(f"âœ… ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†: æˆåŠŸ {success}ä»¶, ã‚¨ãƒ©ãƒ¼ {errors}ä»¶")
        except Exception as e:
            print(f"âŒ ã‚¨ãƒ©ãƒ¼: {e}")


def main():
    parser = argparse.ArgumentParser(
        description="AI Elder - ã‚¨ãƒ«ãƒ€ãƒ¼ã‚ºçŸ¥è­˜ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
ä½¿ç”¨ä¾‹:
  # çŸ¥è­˜ã‚’æ¤œç´¢
  ai-elder search "ãƒ™ã‚¯ãƒˆãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹"

  # ã‚«ãƒ†ã‚´ãƒªã‚’æŒ‡å®šã—ã¦æ¤œç´¢
  ai-elder search "ç¡çœ " --category "ç”Ÿæ´»ã®çŸ¥æµ" --limit 5

  # æ–°ã—ã„çŸ¥è­˜ã‚’è¿½åŠ 
  ai-elder add "ã‚¿ã‚¤ãƒˆãƒ«" "å†…å®¹" --category "æŠ€è¡“" --tags "Python,AI"

  # ã‚«ãƒ†ã‚´ãƒªä¸€è¦§ã‚’è¡¨ç¤º
  ai-elder list-categories

  # ã‚¨ãƒ«ãƒ€ãƒ¼ä¸€è¦§ã‚’è¡¨ç¤º
  ai-elder list-elders

  # æ–°ã—ã„ã‚¨ãƒ«ãƒ€ãƒ¼ã‚’è¿½åŠ 
  ai-elder add-elder "AIå°‚é–€å®¶" --expertise "æ©Ÿæ¢°å­¦ç¿’,æ·±å±¤å­¦ç¿’" --description "AIã®å°‚é–€å®¶"

  # JSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ä¸€æ‹¬ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
  ai-elder import knowledge.json
""",
    )

    subparsers = parser.add_subparsers(dest="command", help="å®Ÿè¡Œã™ã‚‹ã‚³ãƒãƒ³ãƒ‰")

    # search ã‚³ãƒãƒ³ãƒ‰
    search_parser = subparsers.add_parser("search", help="çŸ¥è­˜ã‚’æ¤œç´¢")
    search_parser.add_argument("query", help="æ¤œç´¢ã‚¯ã‚¨ãƒª")
    search_parser.add_argument("--limit", type=int, default=10, help="è¡¨ç¤ºä»¶æ•°")
    search_parser.add_argument("--category", help="ã‚«ãƒ†ã‚´ãƒªã§çµã‚Šè¾¼ã¿")
    search_parser.add_argument("--elder", help="ã‚¨ãƒ«ãƒ€ãƒ¼ã§çµã‚Šè¾¼ã¿")

    # add ã‚³ãƒãƒ³ãƒ‰
    add_parser = subparsers.add_parser("add", help="æ–°ã—ã„çŸ¥è­˜ã‚’è¿½åŠ ")
    add_parser.add_argument("title", help="çŸ¥è­˜ã®ã‚¿ã‚¤ãƒˆãƒ«")
    add_parser.add_argument("content", help="çŸ¥è­˜ã®å†…å®¹")
    add_parser.add_argument("--category", default="æŠ€è¡“", help="ã‚«ãƒ†ã‚´ãƒª")
    add_parser.add_argument("--elder", default="æŠ€è¡“é•·è€", help="ã‚¨ãƒ«ãƒ€ãƒ¼")
    add_parser.add_argument("--tags", nargs="+", help="ã‚¿ã‚°ï¼ˆã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šï¼‰")
    add_parser.add_argument("--importance", type=float, default=0.5, help="é‡è¦åº¦ (0-1)")

    # list-categories ã‚³ãƒãƒ³ãƒ‰
    subparsers.add_parser("list-categories", help="ã‚«ãƒ†ã‚´ãƒªä¸€è¦§ã‚’è¡¨ç¤º")

    # list-elders ã‚³ãƒãƒ³ãƒ‰
    subparsers.add_parser("list-elders", help="ã‚¨ãƒ«ãƒ€ãƒ¼ä¸€è¦§ã‚’è¡¨ç¤º")

    # add-elder ã‚³ãƒãƒ³ãƒ‰
    elder_parser = subparsers.add_parser("add-elder", help="æ–°ã—ã„ã‚¨ãƒ«ãƒ€ãƒ¼ã‚’è¿½åŠ ")
    elder_parser.add_argument("name", help="ã‚¨ãƒ«ãƒ€ãƒ¼ã®åå‰")
    elder_parser.add_argument(
        "--expertise", nargs="+", required=True, help="å°‚é–€åˆ†é‡ï¼ˆã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šï¼‰"
    )
    elder_parser.add_argument("--description", default="", help="èª¬æ˜")
    elder_parser.add_argument(
        "--reliability", type=float, default=1.0, help="ä¿¡é ¼åº¦ (0-1)"
    )

    # import ã‚³ãƒãƒ³ãƒ‰
    import_parser = subparsers.add_parser("import", help="JSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ä¸€æ‹¬ã‚¤ãƒ³ãƒãƒ¼ãƒˆ")
    import_parser.add_argument("filepath", help="JSONãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹")

    args = parser.parse_args()

    if not args.command:
        parser.print_help()
        return

    cli = AIElderCLI()

    if args.command == "search":
        cli.search(args.query, args.limit, args.category, args.elder)
    elif args.command == "add":
        cli.add(
            args.title,
            args.content,
            args.category,
            args.elder,
            args.tags,
            args.importance,
        )
    elif args.command == "list-categories":
        cli.list_categories()
    elif args.command == "list-elders":
        cli.list_elders()
    elif args.command == "add-elder":
        cli.add_elder(args.name, args.expertise, args.description, args.reliability)
    elif args.command == "import":
        cli.import_json(args.filepath)


if __name__ == "__main__":
    main()
