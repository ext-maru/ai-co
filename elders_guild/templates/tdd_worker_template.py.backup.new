#!/usr/bin/env python3
"""
{WorkerName} - AI Company Worker
TDDãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ: Red â†’ Green â†’ Refactor

ã“ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ç”¨ã—ã¦æ–°ã—ã„ãƒ¯ãƒ¼ã‚«ãƒ¼ã‚’é–‹ç™ºã—ã¦ãã ã•ã„ã€‚
1. tests/unit/test_{worker_name}.pyã«ãƒ†ã‚¹ãƒˆã‚’ä½œæˆ
2. ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®Ÿè£…
3. ãƒ†ã‚¹ãƒˆãŒé€šã‚‹ã“ã¨ã‚’ç¢ºèª
4. ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
"""

import json
from typing import Dict, Any, Optional
from pathlib import Path

from core.base_worker import BaseWorker
from libs.slack_notifier import SlackNotifier


class {WorkerName}(BaseWorker):
    """{WorkerName}ã®å®Ÿè£…

    æ©Ÿèƒ½:
    - [æ©Ÿèƒ½1ã®èª¬æ˜]
    - [æ©Ÿèƒ½2ã®èª¬æ˜]
    - [æ©Ÿèƒ½3ã®èª¬æ˜]
    """

    def __init__(self, worker_id: Optional[str] = None):
        """
        Args:
            worker_id: ãƒ¯ãƒ¼ã‚«ãƒ¼IDï¼ˆçœç•¥æ™‚ã¯è‡ªå‹•ç”Ÿæˆï¼‰
        """
        # TODO: ãƒ¯ãƒ¼ã‚«ãƒ¼ã‚¿ã‚¤ãƒ—ã‚’é©åˆ‡ã«è¨­å®š
        super().__init__(
            worker_type='{worker_type}',
            worker_id=worker_id
        )

        # TODO: å¿…è¦ãªåˆæœŸåŒ–å‡¦ç†ã‚’è¿½åŠ 
        self.slack_notifier = SlackNotifier()
        self._init_worker_specific_settings()

    def _init_worker_specific_settings(self):
        """ãƒ¯ãƒ¼ã‚«ãƒ¼å›ºæœ‰ã®è¨­å®šã‚’åˆæœŸåŒ–"""
        # TODO: ãƒ¯ãƒ¼ã‚«ãƒ¼å›ºæœ‰ã®è¨­å®šã‚’å®Ÿè£…
        pass

    def process_message(self, ch, method, properties, body):
        """ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç†ã®ãƒ¡ã‚¤ãƒ³å®Ÿè£…

        Args:
            ch: RabbitMQãƒãƒ£ãƒ³ãƒãƒ«
            method: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ¡ã‚½ãƒƒãƒ‰
            properties: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£
            body: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æœ¬æ–‡
        """
        task_id = None

        try:
            # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒ‘ãƒ¼ã‚¹
            message = json.loads(body)
            task_id = message.get('task_id', 'unknown')
            self.current_task = task_id

            self.logger.info(f"ğŸ“¥ ã‚¿ã‚¹ã‚¯å—ä¿¡: {task_id}")

            # TODO: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ¤œè¨¼ã‚’å®Ÿè£…
            if not self._validate_message(message):
                raise ValueError("Invalid message format")

            # TODO: ãƒ¡ã‚¤ãƒ³å‡¦ç†ã‚’å®Ÿè£…
            result = self._process_task(message)

            # çµæœé€ä¿¡
            self._send_success_result(result, task_id)

            # çµ±è¨ˆæ›´æ–°
            self._increment_stats('processed_count')
            self._update_stats('last_task_id', task_id)

            # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç¢ºèª
            ch.basic_ack(delivery_tag=method.delivery_tag)

        except Exception as e:
            self.handle_error(e, f"process_message({task_id})")

            # ã‚¨ãƒ©ãƒ¼çµæœé€ä¿¡
            if task_id:
                self._send_error_result(str(e), task_id)

            # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç¢ºèªï¼ˆã‚¨ãƒ©ãƒ¼ã§ã‚‚ç¢ºèªï¼‰
            ch.basic_ack(delivery_tag=method.delivery_tag)

        finally:
            self.current_task = None

    def _validate_message(self, message: Dict[str, Any]) -> bool:
        """ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ¤œè¨¼

        Args:
            message: æ¤œè¨¼ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

        Returns:
            bool: æ¤œè¨¼çµæœ
        """
        # TODO: å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®æ¤œè¨¼ã‚’å®Ÿè£…
        required_fields = ['task_id', 'action']

        for field in required_fields:
            if field not in message:
                self.logger.error(f"å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒä¸è¶³: {field}")
                return False

        return True

    def _process_task(self, message: Dict[str, Any]) -> Dict[str, Any]:
        """ã‚¿ã‚¹ã‚¯ã®å‡¦ç†

        Args:
            message: å‡¦ç†ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

        Returns:
            Dict[str, Any]: å‡¦ç†çµæœ
        """
        action = message.get('action')

        # TODO: ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«å¿œã˜ãŸå‡¦ç†ã‚’å®Ÿè£…
        if action == 'example_action':
            return self._handle_example_action(message)
        else:
            raise ValueError(f"Unknown action: {action}")

    def _handle_example_action(self, message: Dict[str, Any]) -> Dict[str, Any]:
        """ã‚µãƒ³ãƒ—ãƒ«ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®å‡¦ç†

        Args:
            message: å‡¦ç†ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

        Returns:
            Dict[str, Any]: å‡¦ç†çµæœ
        """
        # TODO: å®Ÿéš›ã®å‡¦ç†ã‚’å®Ÿè£…
        return {
            'status': 'completed',
            'result': 'Example action completed',
            'processed_data': message.get('data', {})
        }

    def _send_success_result(self, result: Dict[str, Any], task_id: str):
        """æˆåŠŸçµæœã®é€ä¿¡

        Args:
            result: å‡¦ç†çµæœ
            task_id: ã‚¿ã‚¹ã‚¯ID
        """
        response = {
            'task_id': task_id,
            'worker_id': self.worker_id,
            'status': 'completed',
            'result': result,
            'timestamp': self._get_timestamp()
        }

        self.send_result(response)

        # Slacké€šçŸ¥ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
        if self._should_notify_slack(result):
            self.slack_notifier.send_task_completion_simple(
                task_id=task_id,
                worker=self.worker_id,
                prompt="Task completed",
                response=json.dumps(result, ensure_ascii=False)
            )

    def _send_error_result(self, error: str, task_id: str):
        """ã‚¨ãƒ©ãƒ¼çµæœã®é€ä¿¡

        Args:
            error: ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            task_id: ã‚¿ã‚¹ã‚¯ID
        """
        response = {
            'task_id': task_id,
            'worker_id': self.worker_id,
            'status': 'failed',
            'error': error,
            'timestamp': self._get_timestamp()
        }

        self.send_result(response)

    def _should_notify_slack(self, result: Dict[str, Any]) -> bool:
        """Slacké€šçŸ¥ãŒå¿…è¦ã‹ã©ã†ã‹ã‚’åˆ¤å®š

        Args:
            result: å‡¦ç†çµæœ

        Returns:
            bool: é€šçŸ¥ãŒå¿…è¦ãªå ´åˆTrue
        """
        # TODO: é€šçŸ¥æ¡ä»¶ã‚’å®Ÿè£…
        return result.get('notify_slack', False)

    def _get_timestamp(self) -> str:
        """ç¾åœ¨ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’å–å¾—

        Returns:
            str: ISOå½¢å¼ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
        """
        from datetime import datetime
        return datetime.now().isoformat()


def main():
    """ãƒ¡ã‚¤ãƒ³å‡¦ç†"""
    worker = {WorkerName}()

    try:
        worker.logger.info("ğŸš€ {WorkerName}ã‚’èµ·å‹•ã—ã¾ã™...")
        worker.start()
    except KeyboardInterrupt:
        worker.logger.info("â¹ï¸ åœæ­¢ã‚·ã‚°ãƒŠãƒ«ã‚’å—ä¿¡ã—ã¾ã—ãŸ")
    except Exception as e:
        worker.logger.error(f"âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
        worker.handle_error(e, "main")
    finally:
        worker.disconnect()
        worker.logger.info("ğŸ‘‹ {WorkerName}ã‚’çµ‚äº†ã—ã¾ã—ãŸ")


if __name__ == "__main__":
    main()
