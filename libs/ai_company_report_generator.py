"""
AI Company Report Generator - ã‚¨ãƒ«ãƒ€ãƒ¼ã‚ºã‚®ãƒ«ãƒ‰ ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ 

ä¼æ¥­å‘ã‘AIå°å…¥ãƒ¬ãƒãƒ¼ãƒˆã€é‹ç”¨çŠ¶æ³ãƒ¬ãƒãƒ¼ãƒˆã€æˆæœåˆ†æãƒ¬ãƒãƒ¼ãƒˆã‚’
è‡ªå‹•ç”Ÿæˆã™ã‚‹ã‚·ã‚¹ãƒ†ãƒ 
"""

import json
import logging
from datetime import datetime, timedelta
from pathlib import Path
from typing import Any, Dict, List, Optional
import os

logger = logging.getLogger(__name__)


class AICompanyReportGenerator:
    """AIä¼æ¥­ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚¨ãƒ³ã‚¸ãƒ³"""
    
    def __init__(self, output_dir: str = "reports"):
        self.output_dir = Path(output_dir)
        self.output_dir.mkdir(exist_ok=True)
        
    def generate_ai_adoption_report(self, company_data: Dict[str, Any]) -> str:
        """AIå°å…¥çŠ¶æ³ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ"""
        try:
            report_content = f"""# AIå°å…¥çŠ¶æ³ãƒ¬ãƒãƒ¼ãƒˆ
            
## ä¼æ¥­æ¦‚è¦
- **ä¼æ¥­å**: {company_data.get('company_name', 'N/A')}
- **æ¥­ç•Œ**: {company_data.get('industry', 'N/A')}
- **å¾“æ¥­å“¡æ•°**: {company_data.get('employees', 'N/A')}äºº
- **ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆæ—¥**: {datetime.now().strftime('%Yå¹´%mæœˆ%dæ—¥')}

## AIå°å…¥çŠ¶æ³

### å°å…¥æ¸ˆã¿AIã‚·ã‚¹ãƒ†ãƒ 
"""
            
            ai_systems = company_data.get('ai_systems', [])
            for system in ai_systems:
                report_content += f"""
- **{system.get('name', 'Unknown')}**
  - ç”¨é€”: {system.get('purpose', 'N/A')}
  - å°å…¥æ—¥: {system.get('deployed_date', 'N/A')}
  - åŠ¹æœ: {system.get('impact', 'N/A')}
"""
            
            report_content += f"""

## ROIåˆ†æ
- **æŠ•è³‡é¡**: Â¥{company_data.get('investment', 0):,}
- **å¹´é–“ç¯€ç´„é¡**: Â¥{company_data.get('annual_savings', 0):,}
- **ROI**: {company_data.get('roi', 0)}%

## æ¨å¥¨äº‹é …
1. ç¶™ç¶šçš„ãªAIäººæè‚²æˆ
2. ãƒ‡ãƒ¼ã‚¿å“è³ªå‘ä¸Š
3. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–å¼·åŒ–

---
*Generated by Elder Guild AI Company Report Generator*
"""
            
            # ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜
            filename = f"ai_adoption_{company_data.get('company_name', 'company')}_{datetime.now().strftime('%Y%m%d')}.md"
            filepath = self.output_dir / filename
            
            with open(filepath, 'w', encoding='utf-8') as f:
                f.write(report_content)
            
            logger.info(f"AI adoption report generated: {filepath}")
            return str(filepath)
            
        except Exception as e:
            logger.error(f"Report generation failed: {e}")
            return ""
    
    def generate_performance_report(self, metrics: Dict[str, Any]) -> str:
        """AIæ€§èƒ½ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ"""
        try:
            report_content = f"""# AIæ€§èƒ½åˆ†æãƒ¬ãƒãƒ¼ãƒˆ

## æœŸé–“
- **é–‹å§‹æ—¥**: {metrics.get('start_date', 'N/A')}
- **çµ‚äº†æ—¥**: {metrics.get('end_date', 'N/A')}

## ä¸»è¦æŒ‡æ¨™

### å‡¦ç†æ€§èƒ½
- **ç·å‡¦ç†ä»¶æ•°**: {metrics.get('total_processed', 0):,}ä»¶
- **å¹³å‡å‡¦ç†æ™‚é–“**: {metrics.get('avg_processing_time', 0)}ms
- **æˆåŠŸç‡**: {metrics.get('success_rate', 0)}%

### ã‚·ã‚¹ãƒ†ãƒ ç¨¼åƒç‡
- **ç¨¼åƒæ™‚é–“**: {metrics.get('uptime_hours', 0)}æ™‚é–“
- **ãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ **: {metrics.get('downtime_minutes', 0)}åˆ†
- **å¯ç”¨æ€§**: {metrics.get('availability', 0)}%

### ã‚³ã‚¹ãƒˆåŠ¹ç‡
- **å‡¦ç†ã‚ãŸã‚Šã‚³ã‚¹ãƒˆ**: Â¥{metrics.get('cost_per_process', 0)}
- **æœˆé–“é‹ç”¨ã‚³ã‚¹ãƒˆ**: Â¥{metrics.get('monthly_cost', 0):,}

## ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ
{self._generate_trend_analysis(metrics)}

---
*Generated on {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}*
"""
            
            filename = f"performance_report_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"
            filepath = self.output_dir / filename
            
            with open(filepath, 'w', encoding='utf-8') as f:
                f.write(report_content)
                
            logger.info(f"Performance report generated: {filepath}")
            return str(filepath)
            
        except Exception as e:
            logger.error(f"Performance report generation failed: {e}")
            return ""
    
    def _generate_trend_analysis(self, metrics: Dict[str, Any]) -> str:
        """ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆ"""
        trends = metrics.get('trends', {})
        
        analysis = ""
        if trends.get('processing_trend', 0) > 0:
            analysis += "- ğŸ“ˆ å‡¦ç†é‡ã¯å¢—åŠ å‚¾å‘\n"
        elif trends.get('processing_trend', 0) < 0:
            analysis += "- ğŸ“‰ å‡¦ç†é‡ã¯æ¸›å°‘å‚¾å‘\n"
        else:
            analysis += "- ğŸ“Š å‡¦ç†é‡ã¯å®‰å®š\n"
            
        if trends.get('performance_trend', 0) > 0:
            analysis += "- âš¡ æ€§èƒ½ãŒå‘ä¸Š\n"
        elif trends.get('performance_trend', 0) < 0:
            analysis += "- ğŸŒ æ€§èƒ½ã«èª²é¡Œã‚ã‚Š\n"
        else:
            analysis += "- ğŸ”„ æ€§èƒ½ã¯å®‰å®š\n"
            
        return analysis or "- ãƒ‡ãƒ¼ã‚¿ä¸è¶³ã®ãŸã‚åˆ†æä¸å¯"


# ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°
def generate_ai_report(company_data: Dict[str, Any]) -> str:
    """AIå°å…¥ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ï¼‰"""
    generator = AICompanyReportGenerator()
    return generator.generate_ai_adoption_report(company_data)

def generate_performance_report(metrics: Dict[str, Any]) -> str:
    """æ€§èƒ½ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ï¼‰"""
    generator = AICompanyReportGenerator()
    return generator.generate_performance_report(metrics)
