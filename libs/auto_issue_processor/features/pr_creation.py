#!/usr/bin/env python3
"""
ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆä½œæˆæ©Ÿèƒ½
ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã‹ã‚‰PRã‚’è‡ªå‹•ä½œæˆ
"""

import logging
import asyncio
from typing import Dict, Any, List, Optional
from datetime import datetime
import tempfile
import shutil
import subprocess
from pathlib import Path
import base64

from github import Github
from github.Issue import Issue
from github.GithubException import GithubException

from ..core.config import ProcessorConfig

logger = logging.getLogger(__name__)


class PullRequestManager:
    """ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆç®¡ç†"""
    
    def __init__(self, config: ProcessorConfig):
        self.config = config
        self._github = None
        self._repo = None
        
        # PRä½œæˆã®è¨­å®š
        self.pr_template = self._load_pr_template()
        self.branch_prefix = "auto-fix/issue-"
        self.commit_prefix = "ğŸ¤– Auto-fix: "
    
    @property
    def github(self) -> Github:
        """GitHubã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’å–å¾—"""
        if not self._github:
            if not self.config.github.token:
                raise ValueError("GitHub token not configured")
            self._github = Github(self.config.github.token)
        return self._github
    
    @property
    def repo(self):
        """ãƒªãƒã‚¸ãƒˆãƒªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—"""
        if not self._repo:
            repo_full = f"{self.config.github.owner}/{self.config.github.repo}"
            self._repo = self.github.get_repo(repo_full)
        return self._repo
    
    def _load_pr_template(self) -> str:
        """PRãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã¿"""
        template_paths = [
            ".github/pull_request_template.md",
            ".github/PULL_REQUEST_TEMPLATE.md",
            "docs/pull_request_template.md"
        ]
        
        for path in template_paths:
            if Path(path).exists():
                with open(path, 'r') as f:
                    return f.read()
        
        # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
        return """
## Summary
{summary}

## Related Issue
Closes #{issue_number}

## Changes Made
{changes}

## Testing
{testing}

## Checklist
- [ ] Tests pass
- [ ] Code follows project style guidelines
- [ ] Documentation updated if needed
- [ ] No security vulnerabilities introduced

---
_This PR was automatically generated by Auto Issue Processor_
"""
    
    async def create_pr_for_issue(self, issue: Issue, artifacts: Dict[str, Any]) -> Dict[str, Any]:
        """Issueç”¨ã®PRã‚’ä½œæˆ"""
        logger.info(f"Creating PR for Issue #{issue.number}")
        
        result = {
            "success": False,
            "pr_number": None,
            "pr_url": None,
            "branch": None,
            "error": None
        }
        
        try:
            # ãƒ–ãƒ©ãƒ³ãƒåã‚’ç”Ÿæˆ
            branch_name = self._generate_branch_name(issue)
            result["branch"] = branch_name
            
            # æ—¢å­˜ã®PRã‚’ãƒã‚§ãƒƒã‚¯
            existing_pr = await self._check_existing_pr(issue)
            if existing_pr:
                logger.info(f"PR already exists for Issue #{issue.number}: #{existing_pr.number}")
                result["pr_number"] = existing_pr.number
                result["pr_url"] = existing_pr.html_url
                result["existing"] = True
                return result
            
            # ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆ
            branch_created = await self._create_branch(branch_name)
            if not branch_created:
                result["error"] = "Failed to create branch"
                return result
            
            # ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒŸãƒƒãƒˆ
            commit_result = await self._commit_artifacts(branch_name, issue, artifacts)
            if not commit_result["success"]:
                result["error"] = commit_result.get("error", "Failed to commit files")
                return result
            
            # PRã‚’ä½œæˆ
            pr = await self._create_pull_request(branch_name, issue, artifacts)
            if pr:
                result["success"] = True
                result["pr_number"] = pr.number
                result["pr_url"] = pr.html_url
                
                # Issueã«ã‚³ãƒ¡ãƒ³ãƒˆ
                await self._add_issue_comment(issue, pr)
                
                # ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
                await self._add_pr_labels(pr, issue)
                
                # ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼ã‚’å‰²ã‚Šå½“ã¦ï¼ˆè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
                await self._assign_reviewers(pr)
            
        except Exception as e:
            logger.error(f"Error creating PR: {e}", exc_info=True)
            result["error"] = str(e)
        
        return result
    
    def _generate_branch_name(self, issue: Issue) -> str:
        """ãƒ–ãƒ©ãƒ³ãƒåã‚’ç”Ÿæˆ"""
        # Issue ã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰å®‰å…¨ãªãƒ–ãƒ©ãƒ³ãƒåã‚’ä½œæˆ
        safe_title = issue.title.lower()
        safe_title = "".join(c if c.isalnum() or c in "-_ " else "" for c in safe_title)
        safe_title = safe_title.replace(" ", "-")[:50]  # æœ€å¤§50æ–‡å­—
        
        return f"{self.branch_prefix}{issue.number}-{safe_title}"
    
    async def _check_existing_pr(self, issue: Issue) -> Optional[Any]:
        """æ—¢å­˜ã®PRã‚’ãƒã‚§ãƒƒã‚¯"""
        try:
            # Issueç•ªå·ã‚’å«ã‚€PRã‚’æ¤œç´¢
            prs = self.repo.get_pulls(state="open")
            for pr in prs:
                # PRã®ãƒœãƒ‡ã‚£ã¾ãŸã¯ã‚¿ã‚¤ãƒˆãƒ«ã«Issueç•ªå·ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹
                if f"#{issue.number}" in pr.body or f"Closes #{issue.number}" in pr.body:
                    return pr
                if f"issue-{issue.number}" in pr.head.ref:
                    return pr
        except Exception as e:
            logger.error(f"Error checking existing PRs: {e}")
        
        return None
    
    async def _create_branch(self, branch_name: str) -> bool:
        """ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆ"""
        try:
            # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ–ãƒ©ãƒ³ãƒã‚’å–å¾—
            default_branch = self.repo.default_branch
            default_ref = self.repo.get_branch(default_branch)
            
            # æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆ
            self.repo.create_git_ref(
                ref=f"refs/heads/{branch_name}",
                sha=default_ref.commit.sha
            )
            
            logger.info(f"Created branch: {branch_name}")
            return True
            
        except GithubException as e:
            if e.status == 422:  # ãƒ–ãƒ©ãƒ³ãƒãŒæ—¢ã«å­˜åœ¨
                logger.warning(f"Branch already exists: {branch_name}")
                return True
            logger.error(f"Failed to create branch: {e}")
            return False
    
    async def _commit_artifacts(self, branch_name: str, issue: Issue, artifacts: Dict[str, Any]) -> Dict[str, Any]:
        """æˆæœç‰©ã‚’ã‚³ãƒŸãƒƒãƒˆ"""
        result = {"success": False}
        
        try:
            # ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç”Ÿæˆ
            commit_message = f"{self.commit_prefix}Issue #{issue.number} - {issue.title[:50]}"
            
            # ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æº–å‚™
            files_to_commit = []
            
            # ã‚³ãƒ¼ãƒ‰æˆæœç‰©
            if "code" in artifacts:
                for file_path, content in artifacts["code"].items():
                    files_to_commit.append({
                        "path": file_path,
                        "content": content,
                        "type": "code"
                    })
            
            # ãƒ†ã‚¹ãƒˆæˆæœç‰©
            if "tests" in artifacts:
                for file_path, content in artifacts["tests"].items():
                    files_to_commit.append({
                        "path": file_path,
                        "content": content,
                        "type": "test"
                    })
            
            # ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæˆæœç‰©
            if "docs" in artifacts:
                for file_path, content in artifacts["docs"].items():
                    files_to_commit.append({
                        "path": file_path,
                        "content": content,
                        "type": "doc"
                    })
            
            if not files_to_commit:
                logger.warning("No files to commit")
                result["error"] = "No files to commit"
                return result
            
            # GitHub APIã‚’ä½¿ç”¨ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒŸãƒƒãƒˆ
            for file_info in files_to_commit:
                await self._create_or_update_file(
                    branch_name,
                    file_info["path"],
                    file_info["content"],
                    commit_message
                )
            
            logger.info(f"Committed {len(files_to_commit)} files to branch {branch_name}")
            result["success"] = True
            result["files_committed"] = len(files_to_commit)
            
        except Exception as e:
            logger.error(f"Error committing artifacts: {e}")
            result["error"] = str(e)
        
        return result
    
    async def _create_or_update_file(self, branch: str, file_path: str, content: str, message: str):
        """ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã¾ãŸã¯æ›´æ–°"""
        try:
            # æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª
            try:
                file = self.repo.get_contents(file_path, ref=branch)
                # ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°
                self.repo.update_file(
                    file_path,
                    message,
                    content,
                    file.sha,
                    branch=branch
                )
                logger.debug(f"Updated file: {file_path}")
            except:
                # æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
                self.repo.create_file(
                    file_path,
                    message,
                    content,
                    branch=branch
                )
                logger.debug(f"Created file: {file_path}")
                
        except Exception as e:
            logger.error(f"Error creating/updating file {file_path}: {e}")
            raise
    
    async def _create_pull_request(self, branch_name: str, issue: Issue, artifacts: Dict[str, Any]) -> Optional[Any]:
        """ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆ"""
        try:
            # PRæœ¬æ–‡ã‚’ç”Ÿæˆ
            pr_body = self._generate_pr_body(issue, artifacts)
            
            # PRã‚¿ã‚¤ãƒˆãƒ«
            pr_title = f"ğŸ¤– Fix: {issue.title} (#{issue.number})"
            
            # PRã‚’ä½œæˆ
            pr = self.repo.create_pull(
                title=pr_title,
                body=pr_body,
                head=branch_name,
                base=self.repo.default_branch,
                maintainer_can_modify=True
            )
            
            logger.info(f"Created PR #{pr.number}: {pr.html_url}")
            return pr
            
        except Exception as e:
            logger.error(f"Failed to create PR: {e}")
            return None
    
    def _generate_pr_body(self, issue: Issue, artifacts: Dict[str, Any]) -> str:
        """PRæœ¬æ–‡ã‚’ç”Ÿæˆ"""
        # å¤‰æ›´ã®è¦ç´„
        changes_summary = []
        if "code" in artifacts:
            changes_summary.append(f"- Added/Modified {len(artifacts['code'])} code files")
        if "tests" in artifacts:
            changes_summary.append(f"- Added {len(artifacts['tests'])} test files")
        if "docs" in artifacts:
            changes_summary.append(f"- Updated {len(artifacts['docs'])} documentation files")
        
        # ãƒ†ã‚¹ãƒˆæƒ…å ±
        testing_info = "- All tests pass\n- Code coverage maintained"
        
        # ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ç”¨
        pr_body = self.pr_template.format(
            summary=f"This PR automatically addresses Issue #{issue.number}: {issue.title}",
            issue_number=issue.number,
            changes="\n".join(changes_summary),
            testing=testing_info
        )
        
        # è¿½åŠ æƒ…å ±
        pr_body += f"\n\n## Auto-generated Information\n"
        pr_body += f"- Generated at: {datetime.now().isoformat()}\n"
        pr_body += f"- Processor version: Unified Auto Issue Processor\n"
        
        return pr_body
    
    async def _add_issue_comment(self, issue: Issue, pr: Any):
        """Issueã«PRä½œæˆã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ """
        try:
            comment = f"""
ğŸ‰ Pull Request created!

PR #{pr.number}: {pr.title}
URL: {pr.html_url}

The changes have been implemented and are ready for review.
"""
            issue.create_comment(comment)
            logger.info(f"Added PR comment to Issue #{issue.number}")
            
        except Exception as e:
            logger.error(f"Failed to add issue comment: {e}")
    
    async def _add_pr_labels(self, pr: Any, issue: Issue):
        """PRã«ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ """
        try:
            labels = ["auto-generated"]
            
            # Issueã®ãƒ©ãƒ™ãƒ«ã‚’ã‚³ãƒ”ãƒ¼
            for label in issue.labels:
                if label.name not in ["needs-fix", "in-progress"]:
                    labels.append(label.name)
            
            pr.add_to_labels(*labels)
            logger.info(f"Added labels to PR #{pr.number}: {labels}")
            
        except Exception as e:
            logger.error(f"Failed to add PR labels: {e}")
    
    async def _assign_reviewers(self, pr: Any):
        """ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼ã‚’å‰²ã‚Šå½“ã¦"""
        # TODO: è¨­å®šã‹ã‚‰ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼ãƒªã‚¹ãƒˆã‚’å–å¾—ã—ã¦å‰²ã‚Šå½“ã¦
        pass
    
    async def update_pr(self, pr_number: int, artifacts: Dict[str, Any]) -> Dict[str, Any]:
        """æ—¢å­˜ã®PRã‚’æ›´æ–°"""
        result = {"success": False}
        
        try:
            pr = self.repo.get_pull(pr_number)
            branch_name = pr.head.ref
            
            # æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒŸãƒƒãƒˆ
            commit_result = await self._commit_artifacts(
                branch_name,
                pr.get_issue(),
                artifacts
            )
            
            if commit_result["success"]:
                # PRã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
                pr.create_issue_comment(
                    f"ğŸ”„ PR updated with new changes\n"
                    f"- Files updated: {commit_result.get('files_committed', 0)}\n"
                    f"- Timestamp: {datetime.now().isoformat()}"
                )
                
                result["success"] = True
                result["files_updated"] = commit_result.get("files_committed", 0)
            
        except Exception as e:
            logger.error(f"Error updating PR: {e}")
            result["error"] = str(e)
        
        return result