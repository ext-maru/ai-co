#!/usr/bin/env python3
"""
SafeGitOperationsçµ±åˆãƒ‘ãƒƒãƒ for Auto Issue Processor
Issue #188å¯¾å¿œ: PRä½œæˆæ©Ÿèƒ½ã®ä¿®æ­£
"""

async def _create_pull_request_with_safegit(
    self, issue_number, issue_title, issue_body, task_name
):
    """è‡ªå‹•ã§PRä½œæˆï¼ˆSafeGitOperationsä½¿ç”¨ï¼‰"""
    try:
        # SafeGitOperationsã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
        git_ops = SafeGitOperations()
        
        # ãƒ–ãƒ©ãƒ³ãƒåã‚’ç”Ÿæˆï¼ˆã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        timestamp = datetime.now().strftime("%H%M%S")
        use_timestamp = os.getenv("AUTO_ISSUE_USE_TIMESTAMP", "false").lower() == "true"
        
        if use_timestamp:
            branch_name = f"auto-fix/issue-{issue_number}-{timestamp}"
        else:
            branch_name = f"auto-fix-issue-{issue_number}"

        # ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒã‚’ä¿å­˜
        current_branch = git_ops.get_current_branch()
        
        # æœªã‚³ãƒŸãƒƒãƒˆã®å¤‰æ›´ã‚’ä¸€æ™‚ä¿å­˜
        stash_result = git_ops.stash_changes()
        if not stash_result["success"]:
            self.logger.warning(f"Failed to stash changes: {stash_result.get('error', 'Unknown error')}")
        
        try:
            # PRç”¨ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆï¼ˆæ—¢å­˜ãƒ–ãƒ©ãƒ³ãƒã¯è‡ªå‹•å‰Šé™¤ã•ã‚Œã‚‹ï¼‰
            branch_result = git_ops.create_pr_branch_workflow(
                branch_name=branch_name,
                commit_message=f"fix: Auto-fix for issue #{issue_number} - {issue_title[:50]}",
                files_to_add=[]
            )
            
            if not branch_result["success"]:
                self.logger.error(f"Failed to create branch: {branch_result.get('error', 'Unknown error')}")
                return {
                    "success": False,
                    "error": f"ãƒ–ãƒ©ãƒ³ãƒä½œæˆã‚¨ãƒ©ãƒ¼: {branch_result.get('error', 'Unknown error')}"
                }
            
            # ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ç”¨ã—ã¦ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
            files_created = []
            
            # ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ä½œæˆ
            context = self.template_manager.create_context_from_issue(
                issue_number=issue_number,
                issue_title=issue_title,
                issue_body=issue_body
            )
            
            # æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯ã‚’æ¤œå‡º
            tech_stack = context['tech_stack']
            self.logger.info(f"Detected tech stack for issue #{issue_number}: {tech_stack}")
            
            # å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆ
            os.makedirs("auto_implementations", exist_ok=True)
            impl_code = self.template_manager.generate_code(
                template_type='class',
                tech_stack=tech_stack,
                context=context
            )
            
            impl_file_path = f"auto_implementations/issue_{issue_number}_implementation.py"
            with open(impl_file_path, "w") as f:
                f.write(impl_code)
            files_created.append(impl_file_path)
            
            # ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆ
            os.makedirs("tests/auto_generated", exist_ok=True)
            test_code = self.template_manager.generate_code(
                template_type='test',
                tech_stack=tech_stack,
                context=context
            )
            
            test_file_path = f"tests/auto_generated/test_issue_{issue_number}.py"
            with open(test_file_path, "w") as f:
                f.write(test_code)
            files_created.append(test_file_path)
            
            # è¨­è¨ˆæ›¸ã‚‚ä½œæˆ
            fix_file_path = f"auto_fixes/issue_{issue_number}_fix.md"
            os.makedirs("auto_fixes", exist_ok=True)
            
            with open(fix_file_path, "w") as f:
                f.write(f"""# Auto-fix for Issue #{issue_number}

## Task: {task_name}

## Original Issue
{issue_title}

{issue_body}

## Generated Files
- Implementation: `{impl_file_path}`
- Test: `{test_file_path}`
- Tech Stack: {tech_stack}

## Template System Info
- Detected keywords: {', '.join(context['requirements']['imports'])}
- Template version: Jinja2 Enhanced Templates (Issue #184 Phase 1)

---
*This file was auto-generated by Elder Flow Auto Issue Processor with Template System*
""")
            files_created.append(fix_file_path)
            
            # ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒŸãƒƒãƒˆï¼ˆSafeGitOperationsä½¿ç”¨ï¼‰
            commit_result = git_ops.auto_commit_if_changes(
                files=files_created,
                commit_message=f"fix: Auto-fix for issue #{issue_number} - {issue_title[:50]}"
            )
            
            if commit_result["success"]:
                # ãƒ–ãƒ©ãƒ³ãƒã‚’push
                push_result = git_ops.push_branch_safely(branch_name)
                if not push_result["success"]:
                    self.logger.error(f"Failed to push branch: {push_result.get('error', 'Unknown error')}")
                    return {
                        "success": False,
                        "error": f"ãƒ–ãƒ©ãƒ³ãƒã®ãƒ—ãƒƒã‚·ãƒ¥ã«å¤±æ•—: {push_result.get('error', 'Unknown error')}"
                    }
            else:
                self.logger.info("No changes to commit or commit failed")
                # å¤‰æ›´ãŒãªã„å ´åˆã§ã‚‚PRã¯ä½œæˆå¯èƒ½
                
        finally:
            # å…ƒã®ãƒ–ãƒ©ãƒ³ãƒã«æˆ»ã‚‹
            git_ops.checkout_branch(current_branch)
            
            # stashã—ãŸå¤‰æ›´ã‚’å¾©å…ƒ
            if stash_result["success"]:
                git_ops.stash_pop()

        # PRä½œæˆ
        pr_result = self.pr_creator.create_pull_request(
            title=f"Auto-fix: {issue_title} (#{issue_number})",
            head=branch_name,
            base="main",
            body=f"""ğŸ¤– **Auto Issue Processor** ã«ã‚ˆã‚‹è‡ªå‹•ä¿®æ­£

## ä¿®æ­£å†…å®¹
{task_name}

## å¯¾è±¡Issue
Closes #{issue_number}

## å…ƒã®Issueå†…å®¹
{issue_body}

## ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«
- å®Ÿè£…: `{impl_file_path}`
- ãƒ†ã‚¹ãƒˆ: `{test_file_path}`
- æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯: {tech_stack}

---
*ã“ã®PRã¯Auto Issue Processorã«ã‚ˆã‚ŠSafeGitOperationsã‚’ä½¿ç”¨ã—ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*
""",
            labels=["auto-generated", "auto-fix"],
            draft=False,  # é€šå¸¸ã®PRã¨ã—ã¦ä½œæˆï¼ˆè‡ªå‹•ãƒãƒ¼ã‚¸å¯èƒ½ï¼‰
        )

        if pr_result.get("success"):
            pr_data = pr_result.get("pull_request", {})
            return {
                "success": True,
                "pr_url": pr_data.get("html_url"),
                "pr_number": pr_data.get("number"),
                "branch_name": branch_name,
            }
        else:
            return {
                "success": False,
                "error": pr_result.get("error", "ä¸æ˜ãªPRä½œæˆã‚¨ãƒ©ãƒ¼"),
            }

    except Exception as e:
        return {"success": False, "error": f"PRä½œæˆä¾‹å¤–: {str(e)}"}