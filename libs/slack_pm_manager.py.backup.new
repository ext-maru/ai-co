"""
Slack PM Manager - Slackå¯¾è©±å‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼
æŒ‡ç¤ºè€…ã¨ã®ä¼šè©±, ä½œæ¥­é€²è¡Œã€å ±å‘Šã‚’ç®¡ç†
"""

import json
import time
import logging
import threading
import re
from datetime import datetime, timedelta
from typing import Dict, List, Optional, Any, Callable
from dataclasses import dataclass, asdict
from enum import Enum
import uuid

from slack_sdk import WebClient
from slack_sdk.rtm_v2 import RTMClient

class ConversationState(Enum):
    IDLE = "idle"
    LISTENING = "listening"
    CLARIFYING = "clarifying"
    PLANNING = "planning"
    CONFIRMING = "confirming"
    EXECUTING = "executing"
    REPORTING = "reporting"
    AWAITING_APPROVAL = "awaiting_approval"

class MessageType(Enum):
    TASK_REQUEST = "task_request"
    CLARIFICATION = "clarification"
    APPROVAL = "approval"
    STATUS_CHECK = "status_check"
    MODIFICATION = "modification"
    CANCEL = "cancel"
    HELP = "help"
    CHAT = "chat"

@dataclass
class PMSession:
    session_id: str
    user_id: str
    channel_id: str
    state: ConversationState
    created_at: datetime
    last_activity: datetime
    current_task_id: Optional[str] = None
    context: Dict[str, Any] = None
    conversation_history: List[Dict] = None
    pending_approval: Optional[str] = None

    def __post_init__(self):
        if self.context is None:
            self.context = {}
        if self.conversation_history is None:
            self.conversation_history = []

class SlackPMManager:
    """
    Slackçµ±åˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼
    """

    def __init__(self, config_path: str = None):
        self.logger = logging.getLogger(__name__)
        self.config = self._load_config(config_path)

        # Slack ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
        self.web_client = WebClient(token=self.config['slack']['bot_token'])
        self.rtm_client = None

        # ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
        self.active_sessions: Dict[str, PMSession] = {}  # user_id -> session
        self.session_timeout = timedelta(hours=2)

        # PMæ©Ÿèƒ½
        self.pm_capabilities = {
            'task_breakdown': True,
            'progress_tracking': True,
            'automatic_reporting': True,
            'approval_workflow': True,
            'context_awareness': True
        }

        # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è§£æãƒ‘ã‚¿ãƒ¼ãƒ³
        self._setup_message_patterns()

        # ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
        self.on_task_created: Optional[Callable] = None
        self.on_approval_needed: Optional[Callable] = None
        self.on_task_completed: Optional[Callable] = None

        # ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¿ã‚¹ã‚¯
        self.running = False
        self.cleanup_thread = None

    def _load_config(self, config_path: str) -> Dict:
        """è¨­å®šèª­ã¿è¾¼ã¿"""
        default_config = {
            'slack': {
                'bot_token': '',
                'app_token': '',
                'pm_channels': [],  # PMãŒå‹•ä½œã™ã‚‹ãƒãƒ£ãƒ³ãƒãƒ«
                'admin_users': [],  # ç®¡ç†è€…ãƒ¦ãƒ¼ã‚¶ãƒ¼
                'response_delay': 1,  # å¿œç­”é…å»¶ï¼ˆç§’ï¼‰
            },
            'pm_settings': {
                'auto_start_tasks': False,  # ã‚¿ã‚¹ã‚¯ã®è‡ªå‹•é–‹å§‹
                'require_approval': True,   # æ‰¿èªãŒå¿…è¦
                'max_concurrent_tasks': 3,  # åŒæ™‚å®Ÿè¡Œã‚¿ã‚¹ã‚¯æ•°
                'session_timeout_hours': 2,
                'progress_report_interval': 1800,  # 30åˆ†
            }
        }\n        \n        if config_path:\n            try:\n                with open(config_path, 'r') as f:\n                    file_config = json.load(f)\n                    return {**default_config, **file_config.get('slack_pm', {})}\n            except Exception as e:\n                self.logger.warning(f\"è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å¤±æ•—: {e}\")\n        \n        return default_config\n    \n    def _setup_message_patterns(self):\n        \"\"\"ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è§£æãƒ‘ã‚¿ãƒ¼ãƒ³ã®è¨­å®š\"\"\"\n        self.patterns = {\n            MessageType.TASK_REQUEST: [\n                r'(.+)ã‚’(ä½œã£ã¦|ä½œæˆã—ã¦|å®Ÿè£…ã—ã¦|é–‹ç™ºã—ã¦)',\n                r'(.+)ã®(æ©Ÿèƒ½|ã‚·ã‚¹ãƒ†ãƒ |ãƒ—ãƒ­ã‚°ãƒ©ãƒ )ã‚’(.+)',\n                r'(ã‚¿ã‚¹ã‚¯|ä½œæ¥­|ä»•äº‹)[:ï¼š](.+)',\n                r'ãŠç–²ã‚Œæ§˜.*(.+)ã‚’ãŠé¡˜ã„',\n                r'(.+)ã«ã¤ã„ã¦(å¯¾å¿œ|å‡¦ç†|å®Ÿè¡Œ)ã—ã¦',\n            ],\n            MessageType.STATUS_CHECK: [\n                r'(é€²æ—|çŠ¶æ³|çŠ¶æ…‹)(ã¯|ã‚’)(ã©ã†|ç¢ºèª|æ•™ãˆã¦)',\n                r'(ã‚¿ã‚¹ã‚¯|ä½œæ¥­)ã®(é€²ã¿å…·åˆ|çŠ¶æ³)',\n                r'ä»Š(ä½•|ã©ã“ã¾ã§|ã©ã®è¾º)',\n                r'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹.*ç¢ºèª',\n            ],\n            MessageType.APPROVAL: [\n                r'(OK|äº†è§£|æ‰¿èª|è‰¯ã„|ã¯ã„|yes)',\n                r'(é€²ã‚ã¦|å®Ÿè¡Œã—ã¦|é–‹å§‹ã—ã¦)',\n                r'(ãã‚Œã§|ãã®é€šã‚Š|ãã®æ–¹å‘ã§)',\n            ],\n            MessageType.MODIFICATION: [\n                r'(å¤‰æ›´|ä¿®æ­£|èª¿æ•´)(.+)',\n                r'(.+)ã‚’(.+)ã«(å¤‰ãˆã¦|ä¿®æ­£ã—ã¦)',\n                r'(ã‚„ã‚Šç›´ã—|å†æ¤œè¨)',\n            ],\n            MessageType.CANCEL: [\n                r'(ã‚­ãƒ£ãƒ³ã‚»ãƒ«|ä¸­æ­¢|åœæ­¢|ã‚„ã‚)',\n                r'(ä¸è¦|ã„ã‚‰ãªã„)',\n            ],\n            MessageType.HELP: [\n                r'(ãƒ˜ãƒ«ãƒ—|ä½¿ã„æ–¹|æ©Ÿèƒ½|ã§ãã‚‹ã“ã¨)',\n                r'(help|what can you do)',\n            ]\n        }\n    \n    def start_rtm(self):\n        \"\"\"ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚°é–‹å§‹\"\"\"\n        try:\n            self.rtm_client = RTMClient(\n                token=self.config['slack']['app_token']\n            )\n            \n            @self.rtm_client.on(\"message\")\n            def handle_message(client: RTMClient, event: dict):\n                self._handle_slack_message(event)\n            \n            self.running = True\n            \n            # ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¿ã‚¹ã‚¯é–‹å§‹\n            self.cleanup_thread = threading.Thread(target=self._cleanup_worker, daemon=True)\n            self.cleanup_thread.start()\n            \n            # RTMé–‹å§‹\n            self.rtm_client.start()\n            \n            self.logger.info(\"ğŸš€ Slack PM Manager RTMé–‹å§‹\")\n            \n        except Exception as e:\n            self.logger.error(f\"RTMé–‹å§‹å¤±æ•—: {e}\")\n    \n    def stop_rtm(self):\n        \"\"\"ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚°åœæ­¢\"\"\"\n        self.running = False\n        \n        if self.rtm_client:\n            self.rtm_client.close()\n        \n        if self.cleanup_thread:\n            self.cleanup_thread.join(timeout=5)\n        \n        self.logger.info(\"ğŸ›‘ Slack PM Manager åœæ­¢\")\n    \n    def _handle_slack_message(self, event: dict):\n        \"\"\"Slackãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å‡¦ç†\"\"\"\n        try:\n            # ãƒœãƒƒãƒˆè‡ªèº«ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ç„¡è¦–\n            if event.get('bot_id'):\n                return\n            \n            user_id = event.get('user')\n            channel_id = event.get('channel')\n            text = event.get('text', '')\n            ts = event.get('ts')\n            \n            if not all([user_id, channel_id, text]):\n                return\n            \n            # PMãƒãƒ£ãƒ³ãƒãƒ«ã§ãªã„å ´åˆã¯ç„¡è¦–\n            if self.config['slack']['pm_channels'] and channel_id not in self.config['slack']['pm_channels']:\n                return\n            \n            # ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ç¢ºèª\n            if not self._is_mentioned(text):\n                return\n            \n            # ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³éƒ¨åˆ†ã‚’é™¤å»\n            clean_text = self._clean_mention(text)\n            \n            self.logger.info(f\"ğŸ“¨ Slack PM ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡: {user_id} -> {clean_text[:50]}...\")\n            \n            # ã‚»ãƒƒã‚·ãƒ§ãƒ³å–å¾—ã¾ãŸã¯ä½œæˆ\n            session = self._get_or_create_session(user_id, channel_id)\n            \n            # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¿ã‚¤ãƒ—åˆ¤å®š\n            message_type = self._classify_message(clean_text, session)\n            \n            # ã‚»ãƒƒã‚·ãƒ§ãƒ³æ›´æ–°\n            session.last_activity = datetime.now()\n            session.conversation_history.append({\n                'timestamp': ts,\n                'user_message': clean_text,\n                'message_type': message_type.value\n            })\n            \n            # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸå‡¦ç†\n            self._process_message_by_type(session, clean_text, message_type)\n            \n        except Exception as e:\n            self.logger.error(f\"Slackãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç†ã‚¨ãƒ©ãƒ¼: {e}\")\n            self._send_error_message(event.get('channel'), \"ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\")\n    \n    def _is_mentioned(self, text: str) -> bool:\n        \"\"\"ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ç¢ºèª\"\"\"\n        # @bot_userã‚„DMã®å ´åˆã¯True\n        return '<@' in text or True  # ç°¡æ˜“å®Ÿè£…\n    \n    def _clean_mention(self, text: str) -> str:\n        \"\"\"ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³éƒ¨åˆ†ã‚’é™¤å»\"\"\"\n        return re.sub(r'<@[^>]+>', '', text).strip()\n    \n    def _get_or_create_session(self, user_id: str, channel_id: str) -> PMSession:\n        \"\"\"ã‚»ãƒƒã‚·ãƒ§ãƒ³å–å¾—ã¾ãŸã¯ä½œæˆ\"\"\"\n        if user_id in self.active_sessions:\n            session = self.active_sessions[user_id]\n            # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãƒã‚§ãƒƒã‚¯\n            if datetime.now() - session.last_activity > self.session_timeout:\n                self.logger.info(f\"ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: {user_id}\")\n                del self.active_sessions[user_id]\n            else:\n                return session\n        \n        # æ–°ã—ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ\n        session = PMSession(\n            session_id=str(uuid.uuid4()),\n            user_id=user_id,\n            channel_id=channel_id,\n            state=ConversationState.IDLE,\n            created_at=datetime.now(),\n            last_activity=datetime.now()\n        )\n        \n        self.active_sessions[user_id] = session\n        self.logger.info(f\"æ–°ã—ã„PMã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ: {user_id}\")\n        \n        return session\n    \n    def _classify_message(self, text: str, session: PMSession) -> MessageType:\n        \"\"\"ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¿ã‚¤ãƒ—ã®åˆ†é¡\"\"\"\n        text_lower = text.lower()\n        \n        # ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã«å¿œã˜ãŸåˆ¤å®š\n        if session.state == ConversationState.AWAITING_APPROVAL:\n            for pattern in self.patterns[MessageType.APPROVAL]:\n                if re.search(pattern, text_lower, re.IGNORECASE):\n                    return MessageType.APPROVAL\n            return MessageType.MODIFICATION  # æ‰¿èªå¾…ã¡ä¸­ã®éæ‰¿èªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ä¿®æ­£è¦æ±‚\n        \n        # ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°\n        for msg_type, patterns in self.patterns.items():\n            for pattern in patterns:\n                if re.search(pattern, text_lower, re.IGNORECASE):\n                    return msg_type\n        \n        # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ã‚¿ã‚¹ã‚¯è¦æ±‚\n        if session.state == ConversationState.IDLE:\n            return MessageType.TASK_REQUEST\n        else:\n            return MessageType.CHAT\n    \n    def _process_message_by_type(self, session: PMSession, text: str, message_type: MessageType):\n        \"\"\"ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¿ã‚¤ãƒ—åˆ¥å‡¦ç†\"\"\"\n        \n        if message_type == MessageType.TASK_REQUEST:\n            self._handle_task_request(session, text)\n        elif message_type == MessageType.STATUS_CHECK:\n            self._handle_status_check(session)\n        elif message_type == MessageType.APPROVAL:\n            self._handle_approval(session, text)\n        elif message_type == MessageType.MODIFICATION:\n            self._handle_modification(session, text)\n        elif message_type == MessageType.CANCEL:\n            self._handle_cancel(session)\n        elif message_type == MessageType.HELP:\n            self._handle_help(session)\n        else:\n            self._handle_chat(session, text)\n    \n    def _handle_task_request(self, session: PMSession, text: str):\n        \"\"\"ã‚¿ã‚¹ã‚¯è¦æ±‚ã®å‡¦ç†\"\"\"\n        session.state = ConversationState.PLANNING\n        \n        # ã‚¿ã‚¹ã‚¯åˆ†æ\n        task_analysis = self._analyze_task(text)\n        \n        # ãƒ—ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°å¿œç­”\n        planning_response = self._generate_planning_response(task_analysis)\n        \n        # Slackå¿œç­”\n        self._send_slack_message(\n            session.channel_id,\n            f\"ğŸ“‹ **ã‚¿ã‚¹ã‚¯è¦æ±‚ã‚’å—ä¿¡ã—ã¾ã—ãŸ**\\n\\n\"\n            f\"**åˆ†æçµæœ:**\\n{task_analysis['summary']}\\n\\n\"\n            f\"**å®Ÿè¡Œãƒ—ãƒ©ãƒ³:**\\n{planning_response}\\n\\n\"\n            f\"ã“ã®å†…å®¹ã§é€²ã‚ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ (ã¯ã„/ä¿®æ­£è¦æ±‚)\"\n        )\n        \n        session.state = ConversationState.AWAITING_APPROVAL\n        session.context['pending_task'] = task_analysis\n        session.context['planning_response'] = planning_response\n    \n    def _analyze_task(self, text: str) -> Dict[str, Any]:\n        \"\"\"ã‚¿ã‚¹ã‚¯åˆ†æ\"\"\"\n        # ç°¡æ˜“å®Ÿè£… - å®Ÿéš›ã¯Claude APIã§åˆ†æ\n        return {\n            'original_request': text,\n            'summary': f\"è¦æ±‚: {text[:100]}...\",\n            'estimated_complexity': 'medium',\n            'estimated_time': '30-60åˆ†',\n            'required_skills': ['Python', 'ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆ'],\n            'deliverables': ['å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«', 'ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰', 'ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ']\n        }\n    \n    def _generate_planning_response(self, task_analysis: Dict) -> str:\n        \"\"\"ãƒ—ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°å¿œç­”ç”Ÿæˆ\"\"\"\n        return f\"\"\"1. **è¦ä»¶æ•´ç†**: {task_analysis['summary']}\n2. **æŠ€è¡“æ¤œè¨**: {', '.join(task_analysis['required_skills'])}\n3. **å®Ÿè£…**: ã‚³ãƒ¼ãƒ‰ä½œæˆã¨ãƒ†ã‚¹ãƒˆ\n4. **æ¤œè¨¼**: å‹•ä½œç¢ºèª\n5. **ç´å“**: {', '.join(task_analysis['deliverables'])}\n\n**è¦‹ç©æ™‚é–“**: {task_analysis['estimated_time']}\n**è¤‡é›‘åº¦**: {task_analysis['estimated_complexity']}\"\"\"\n    \n    def _handle_status_check(self, session: PMSession):\n        \"\"\"ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèªå‡¦ç†\"\"\"\n        if session.current_task_id:\n            # ã‚¿ã‚¹ã‚¯ã®é€²æ—ã‚’ç¢ºèª\n            progress = self._get_task_progress(session.current_task_id)\n            \n            self._send_slack_message(\n                session.channel_id,\n                f\"ğŸ“Š **ç¾åœ¨ã®ã‚¿ã‚¹ã‚¯é€²æ—**\\n\\n\"\n                f\"**ã‚¿ã‚¹ã‚¯ID**: {session.current_task_id}\\n\"\n                f\"**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: {progress['status']}\\n\"\n                f\"**é€²æ—ç‡**: {progress['progress']}%\\n\"\n                f\"**çµŒéæ™‚é–“**: {progress['elapsed_time']}\\n\"\n                f\"**äºˆæƒ³æ®‹ã‚Šæ™‚é–“**: {progress['estimated_remaining']}\\n\\n\"\n                f\"**è©³ç´°**: {progress['details']}\"\n            )\n        else:\n            self._send_slack_message(\n                session.channel_id,\n                \"ç¾åœ¨å®Ÿè¡Œä¸­ã®ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚\\næ–°ã—ã„ã‚¿ã‚¹ã‚¯ã‚’ãŠç”³ã—ä»˜ã‘ãã ã•ã„ï¼\"\n            )\n    \n    def _handle_approval(self, session: PMSession, text: str):\n        \"\"\"æ‰¿èªå‡¦ç†\"\"\"\n        if session.state != ConversationState.AWAITING_APPROVAL:\n            return\n        \n        pending_task = session.context.get('pending_task')\n        if not pending_task:\n            return\n        \n        # ã‚¿ã‚¹ã‚¯å®Ÿè¡Œé–‹å§‹\n        task_id = self._create_and_execute_task(pending_task, session)\n        \n        session.current_task_id = task_id\n        session.state = ConversationState.EXECUTING\n        \n        self._send_slack_message(\n            session.channel_id,\n            f\"âœ… **æ‰¿èªã„ãŸã ãã¾ã—ãŸï¼**\\n\\n\"\n            f\"**ã‚¿ã‚¹ã‚¯ID**: {task_id}\\n\"\n            f\"ã‚¿ã‚¹ã‚¯ã‚’é–‹å§‹ã—ã¾ã™ã€‚é€²æ—ã¯å®šæœŸçš„ã«ãŠçŸ¥ã‚‰ã›ã—ã¾ã™ã€‚\\n\\n\"\n            f\"é€²æ—ç¢ºèªã¯ã€Œé€²æ—ã¯ï¼Ÿã€ã¨ãŠå£°ãŒã‘ãã ã•ã„ã€‚\"\n        )\n        \n        # ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ\n        if self.on_task_created:\n            try:\n                self.on_task_created(task_id, pending_task, session)\n            except Exception as e:\n                self.logger.error(f\"Task creation callback error: {e}\")\n    \n    def _handle_modification(self, session: PMSession, text: str):\n        \"\"\"ä¿®æ­£è¦æ±‚å‡¦ç†\"\"\"\n        self._send_slack_message(\n            session.channel_id,\n            f\"ğŸ“ **ä¿®æ­£è¦æ±‚ã‚’æ‰¿ã‚Šã¾ã—ãŸ**\\n\\n\"\n            f\"ä¿®æ­£å†…å®¹: {text}\\n\\n\"\n            f\"ãƒ—ãƒ©ãƒ³ã‚’èª¿æ•´ã„ãŸã—ã¾ã™ã€‚å°‘ã€…ãŠå¾…ã¡ãã ã•ã„...\"\n        )\n        \n        # çŠ¶æ…‹ã‚’ãƒ—ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ã«æˆ»ã™\n        session.state = ConversationState.PLANNING\n        \n        # ä¿®æ­£ã•ã‚ŒãŸãƒ—ãƒ©ãƒ³ã‚’ç”Ÿæˆï¼ˆç°¡æ˜“å®Ÿè£…ï¼‰\n        time.sleep(2)  # å®Ÿéš›ã¯ Claude API ã§å†ãƒ—ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°\n        \n        self._send_slack_message(\n            session.channel_id,\n            f\"ğŸ“‹ **ä¿®æ­£ãƒ—ãƒ©ãƒ³**\\n\\n\"\n            f\"ã”æŒ‡æ‘˜ã‚’åæ˜ ã—ãŸãƒ—ãƒ©ãƒ³ã‚’ä½œæˆã—ã¾ã—ãŸã€‚\\n\"\n            f\"ä¿®æ­£å†…å®¹: {text}ã‚’è€ƒæ…®ã—ã¦èª¿æ•´\\n\\n\"\n            f\"ã“ã®å†…å®¹ã§é€²ã‚ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\"\n        )\n        \n        session.state = ConversationState.AWAITING_APPROVAL\n    \n    def _handle_cancel(self, session: PMSession):\n        \"\"\"ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†\"\"\"\n        if session.current_task_id:\n            # å®Ÿè¡Œä¸­ã‚¿ã‚¹ã‚¯ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«\n            self._cancel_task(session.current_task_id)\n            \n            self._send_slack_message(\n                session.channel_id,\n                f\"âš ï¸ **ã‚¿ã‚¹ã‚¯ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ**\\n\\n\"\n                f\"ã‚¿ã‚¹ã‚¯ID: {session.current_task_id}\\n\"\n                f\"å®Ÿè¡Œã‚’åœæ­¢ã„ãŸã—ã¾ã™ã€‚\"\n            )\n        else:\n            self._send_slack_message(\n                session.channel_id,\n                \"ç¾åœ¨å®Ÿè¡Œä¸­ã®ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚\\n\"\n                \"ä½•ã‹ä»–ã«ãŠæ‰‹ä¼ã„ã§ãã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ\"\n            )\n        \n        # ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒªã‚»ãƒƒãƒˆ\n        session.state = ConversationState.IDLE\n        session.current_task_id = None\n        session.context.clear()\n    \n    def _handle_help(self, session: PMSession):\n        \"\"\"ãƒ˜ãƒ«ãƒ—å‡¦ç†\"\"\"\n        help_message = \"\"\"ğŸ¤– **AI Company PM ã®ä½¿ã„æ–¹**\n\n**åŸºæœ¬æ©Ÿèƒ½:**\nâ€¢ ã‚¿ã‚¹ã‚¯è¦æ±‚: \"â—‹â—‹ã‚’ä½œã£ã¦\" \"â—‹â—‹ã‚’å®Ÿè£…ã—ã¦\"\nâ€¢ é€²æ—ç¢ºèª: \"é€²æ—ã¯ï¼Ÿ\" \"çŠ¶æ³ã‚’æ•™ãˆã¦\"\nâ€¢ ä¿®æ­£è¦æ±‚: \"â—‹â—‹ã‚’å¤‰æ›´ã—ã¦\" \"ã‚„ã‚Šç›´ã—\"\nâ€¢ ã‚­ãƒ£ãƒ³ã‚»ãƒ«: \"ã‚­ãƒ£ãƒ³ã‚»ãƒ«\" \"ä¸­æ­¢\"\n\n**ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼:**\n1. ã‚¿ã‚¹ã‚¯è¦æ±‚ â†’ åˆ†æãƒ»ãƒ—ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°\n2. æ‰¿èªç¢ºèª â†’ å®Ÿè¡Œé–‹å§‹\n3. å®šæœŸé€²æ—å ±å‘Š\n4. å®Œäº†å ±å‘Š\n\n**ã‚³ãƒãƒ³ãƒ‰ä¾‹:**\nâ€¢ \"ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½œã£ã¦\"\nâ€¢ \"é€²æ—ã¯ã©ã†ï¼Ÿ\"\nâ€¢ \"ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹éƒ¨åˆ†ã‚’å¤‰æ›´ã—ã¦\"\nâ€¢ \"ä½œæ¥­ã‚’ä¸­æ­¢ã—ã¦\"\n\nä½•ã‹ã”è³ªå•ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ\"\"\"\n        \n        self._send_slack_message(session.channel_id, help_message)\n    \n    def _handle_chat(self, session: PMSession, text: str):\n        \"\"\"ä¸€èˆ¬çš„ãªä¼šè©±å‡¦ç†\"\"\"\n        # ç°¡æ˜“å¿œç­”\n        responses = [\n            \"æ‰¿çŸ¥ã„ãŸã—ã¾ã—ãŸã€‚ä»–ã«ã”è¦æœ›ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ\",\n            \"ãªã‚‹ã»ã©ã€ç†è§£ã„ãŸã—ã¾ã™ã€‚\",\n            \"ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚ä»–ã«ãŠæ‰‹ä¼ã„ã§ãã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ\"\n        ]\n        \n        import random\n        response = random.choice(responses)\n        \n        self._send_slack_message(session.channel_id, response)\n    \n    def _send_slack_message(self, channel_id: str, text: str):\n        \"\"\"Slackãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡\"\"\"\n        try:\n            # å¿œç­”é…å»¶\n            time.sleep(self.config['slack']['response_delay'])\n            \n            response = self.web_client.chat_postMessage(\n                channel=channel_id,\n                text=text,\n                mrkdwn=True\n            )\n            \n            self.logger.debug(f\"Slacké€ä¿¡æˆåŠŸ: {channel_id}\")\n            \n        except Exception as e:\n            self.logger.error(f\"Slacké€ä¿¡å¤±æ•—: {e}\")\n    \n    def _send_error_message(self, channel_id: str, error_msg: str):\n        \"\"\"ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡\"\"\"\n        try:\n            self.web_client.chat_postMessage(\n                channel=channel_id,\n                text=f\"âŒ {error_msg}\",\n                mrkdwn=True\n            )\n        except Exception as e:\n            self.logger.error(f\"ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡å¤±æ•—: {e}\")\n    \n    def _create_and_execute_task(self, task_analysis: Dict, session: PMSession) -> str:\n        \"\"\"ã‚¿ã‚¹ã‚¯ä½œæˆãƒ»å®Ÿè¡Œ\"\"\"\n        task_id = f\"pm_{int(time.time())}\"\n        \n        # å®Ÿéš›ã®ã‚¿ã‚¹ã‚¯å®Ÿè¡Œãƒ­ã‚¸ãƒƒã‚¯ï¼ˆç°¡æ˜“å®Ÿè£…ï¼‰\n        # å®Ÿéš›ã¯æ—¢å­˜ã®ã‚¿ã‚¹ã‚¯ã‚·ã‚¹ãƒ†ãƒ ã¨é€£æº\n        \n        return task_id\n    \n    def _get_task_progress(self, task_id: str) -> Dict[str, Any]:\n        \"\"\"ã‚¿ã‚¹ã‚¯é€²æ—å–å¾—\"\"\"\n        # ç°¡æ˜“å®Ÿè£…\n        return {\n            'status': 'å®Ÿè¡Œä¸­',\n            'progress': 65,\n            'elapsed_time': '25åˆ†',\n            'estimated_remaining': '15åˆ†',\n            'details': 'ã‚³ã‚¢æ©Ÿèƒ½ã®å®Ÿè£…å®Œäº†ã€ãƒ†ã‚¹ãƒˆä½œæˆä¸­'\n        }\n    \n    def _cancel_task(self, task_id: str):\n        \"\"\"ã‚¿ã‚¹ã‚¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«\"\"\"\n        # å®Ÿéš›ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†\n        pass\n    \n    def _cleanup_worker(self):\n        \"\"\"ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãƒ¯ãƒ¼ã‚«ãƒ¼\"\"\"\n        while self.running:\n            try:\n                current_time = datetime.now()\n                expired_sessions = []\n                \n                for user_id, session in self.active_sessions.items():\n                    if current_time - session.last_activity > self.session_timeout:\n                        expired_sessions.append(user_id)\n                \n                for user_id in expired_sessions:\n                    self.logger.info(f\"ã‚»ãƒƒã‚·ãƒ§ãƒ³æœŸé™åˆ‡ã‚Œã§ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—: {user_id}\")\n                    del self.active_sessions[user_id]\n                \n                time.sleep(300)  # 5åˆ†é–“éš”ã§ãƒã‚§ãƒƒã‚¯\n                \n            except Exception as e:\n                self.logger.error(f\"ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼: {e}\")\n                time.sleep(60)\n    \n    def send_progress_report(self, task_id: str, progress_data: Dict[str, Any]):\n        \"\"\"é€²æ—å ±å‘Šé€ä¿¡\"\"\"\n        # ã‚¿ã‚¹ã‚¯IDã‹ã‚‰å¯¾å¿œã™ã‚‹ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’æ¤œç´¢\n        target_session = None\n        for session in self.active_sessions.values():\n            if session.current_task_id == task_id:\n                target_session = session\n                break\n        \n        if not target_session:\n            return\n        \n        progress_message = f\"\"\"ğŸ“Š **é€²æ—å ±å‘Š**\n\n**ã‚¿ã‚¹ã‚¯ID**: {task_id}\n**é€²æ—ç‡**: {progress_data.get('progress', 0)}%\n**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: {progress_data.get('status', 'å®Ÿè¡Œä¸­')}\n**å®Œäº†é …ç›®**: {', '.join(progress_data.get('completed_items', []))}\n**æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—**: {progress_data.get('next_step', 'ç¶™ç¶šä¸­')}\n\nå¼•ãç¶šãä½œæ¥­ã‚’é€²ã‚ã¾ã™ã€‚\"\"\"\n        \n        self._send_slack_message(target_session.channel_id, progress_message)\n    \n    def send_completion_report(self, task_id: str, completion_data: Dict[str, Any]):\n        \"\"\"å®Œäº†å ±å‘Šé€ä¿¡\"\"\"\n        target_session = None\n        for session in self.active_sessions.values():\n            if session.current_task_id == task_id:\n                target_session = session\n                break\n        \n        if not target_session:\n            return\n        \n        completion_message = f\"\"\"âœ… **ã‚¿ã‚¹ã‚¯å®Œäº†å ±å‘Š**\n\n**ã‚¿ã‚¹ã‚¯ID**: {task_id}\n**å®Ÿè¡Œæ™‚é–“**: {completion_data.get('execution_time', 'ä¸æ˜')}\n**æˆæœç‰©**: {', '.join(completion_data.get('deliverables', []))}\n**å®Ÿè¡Œçµæœ**: {completion_data.get('result_summary', 'æ­£å¸¸å®Œäº†')}\n\n**ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§**:\n{chr(10).join(f'â€¢ {file}' for file in completion_data.get('created_files', []))}\n\nã‚¿ã‚¹ã‚¯ãŒå®Œäº†ã„ãŸã—ã¾ã—ãŸï¼\nä»–ã«ã”è¦æœ›ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ\"\"\"\n        \n        self._send_slack_message(target_session.channel_id, completion_message)\n        \n        # ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ\n        target_session.state = ConversationState.IDLE\n        target_session.current_task_id = None\n    \n    def get_active_sessions(self) -> Dict[str, Dict]:\n        \"\"\"ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§å–å¾—\"\"\"\n        return {\n            user_id: {\n                'session_id': session.session_id,\n                'state': session.state.value,\n                'current_task': session.current_task_id,\n                'last_activity': session.last_activity.isoformat(),\n                'messages_count': len(session.conversation_history)\n            }\n            for user_id, session in self.active_sessions.items()\n        }
