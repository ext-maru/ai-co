<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elder Tree Monitoring Dashboard - Grand Elder maru</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #0a0e1a;
            color: #e0e0e0;
            overflow-x: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1a237e 0%, #311b92 100%);
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }

        .header h1 {
            font-size: 28px;
            font-weight: 300;
            letter-spacing: 2px;
        }

        .header .subtitle {
            font-size: 14px;
            opacity: 0.8;
            margin-top: 5px;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 20px;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .widget {
            background: #1a1f2e;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            border: 1px solid #2a3142;
            transition: transform 0.2s;
        }

        .widget:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.4);
        }

        .widget-title {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 15px;
            color: #8c9eff;
        }

        /* Elder Tree Hierarchy */
        .hierarchy-tree {
            grid-column: span 12;
            min-height: 300px;
        }

        .tree-node {
            display: flex;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            transition: all 0.3s;
        }

        .tree-node.grand-elder {
            background: linear-gradient(135deg, #4a148c 0%, #6a1b9a 100%);
            font-size: 20px;
            font-weight: bold;
            justify-content: center;
        }

        .tree-node.elder-council {
            background: #1565c0;
            margin-left: 40px;
        }

        .tree-node.four-sages {
            background: #00838f;
            margin-left: 80px;
        }

        .tree-node.workers {
            background: #2e7d32;
            margin-left: 120px;
        }

        .node-status {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
            animation: pulse 2s infinite;
        }

        .status-active { background: #4caf50; }
        .status-warning { background: #ff9800; }
        .status-critical { background: #f44336; }
        .status-unknown { background: #9e9e9e; }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Worker Pool Grid */
        .worker-pool {
            grid-column: span 6;
        }

        .worker-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 5px;
        }

        .worker-cell {
            aspect-ratio: 1;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .worker-cell:hover {
            transform: scale(1.1);
            z-index: 10;
        }

        .worker-active { background: #4caf50; }
        .worker-idle { background: #2196f3; }
        .worker-failed { background: #f44336; }

        /* Four Sages Status */
        .four-sages-widget {
            grid-column: span 6;
        }

        .sage-card {
            background: #252a3a;
            padding: 15px;
            margin: 10px 0;
            border-radius: 6px;
            border-left: 4px solid #536dfe;
        }

        .sage-name {
            font-weight: bold;
            color: #8c9eff;
        }

        .sage-role {
            font-size: 12px;
            opacity: 0.7;
            margin-top: 2px;
        }

        .sage-metrics {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }

        .metric {
            flex: 1;
        }

        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #4caf50;
        }

        .metric-label {
            font-size: 11px;
            opacity: 0.7;
            text-transform: uppercase;
        }

        /* System Metrics */
        .system-metrics {
            grid-column: span 4;
        }

        .metric-bar {
            height: 20px;
            background: #252a3a;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .metric-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50 0%, #8bc34a 100%);
            transition: width 0.5s ease;
        }

        /* Alerts */
        .alerts-widget {
            grid-column: span 4;
        }

        .alert-item {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            font-size: 13px;
            display: flex;
            align-items: center;
        }

        .alert-critical {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid #f44336;
        }

        .alert-warning {
            background: rgba(255, 152, 0, 0.2);
            border: 1px solid #ff9800;
        }

        .alert-info {
            background: rgba(33, 150, 243, 0.2);
            border: 1px solid #2196f3;
        }

        .alert-icon {
            margin-right: 10px;
            font-size: 16px;
        }

        /* Realtime Indicator */
        .realtime-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4caf50;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .realtime-dot {
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            margin-right: 8px;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .dashboard {
                grid-template-columns: repeat(6, 1fr);
            }

            .hierarchy-tree,
            .worker-pool,
            .four-sages-widget {
                grid-column: span 6;
            }

            .system-metrics,
            .alerts-widget {
                grid-column: span 3;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Elder Tree Monitoring Dashboard</h1>
        <div class="subtitle">Grand Elder maru統治下の階層システム監視</div>
    </div>

    <div class="realtime-indicator">
        <div class="realtime-dot"></div>
        <span>LIVE - 5秒更新</span>
    </div>

    <div class="dashboard">
        <!-- Elder Tree階層表示 -->
        <div class="widget hierarchy-tree">
            <div class="widget-title">Elder Tree階層構造</div>
            <div id="hierarchyTree">
                <div class="tree-node grand-elder">
                    <div class="node-status status-active"></div>
                    Grand Elder maru
                </div>
                <div class="tree-node elder-council">
                    <div class="node-status status-active"></div>
                    Elder Council (8 members)
                </div>
                <div class="tree-node four-sages">
                    <div class="node-status status-active"></div>
                    Four Sages
                </div>
                <div class="tree-node workers">
                    <div class="node-status status-active"></div>
                    Worker Pool (32 workers)
                </div>
            </div>
        </div>

        <!-- ワーカープール状態 -->
        <div class="widget worker-pool">
            <div class="widget-title">ワーカープール状態 (32 Workers)</div>
            <div class="worker-grid" id="workerGrid">
                <!-- Workers will be dynamically generated -->
            </div>
            <div style="margin-top: 15px;">
                <span style="color: #4caf50;">● Active: <span id="activeWorkers">0</span></span>
                <span style="color: #2196f3; margin-left: 20px;">● Idle: <span id="idleWorkers">0</span></span>
                <span style="color: #f44336; margin-left: 20px;">● Failed: <span id="failedWorkers">0</span></span>
            </div>
        </div>

        <!-- Four Sages状態 -->
        <div class="widget four-sages-widget">
            <div class="widget-title">Four Sages活動状況</div>
            <div id="fourSagesStatus">
                <div class="sage-card">
                    <div class="sage-name">Incident Sage</div>
                    <div class="sage-role">異常検知・対処</div>
                    <div class="sage-metrics">
                        <div class="metric">
                            <div class="metric-value" id="incidentCount">0</div>
                            <div class="metric-label">Active</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value" id="incidentResolved">0</div>
                            <div class="metric-label">Resolved</div>
                        </div>
                    </div>
                </div>

                <div class="sage-card">
                    <div class="sage-name">Knowledge Sage</div>
                    <div class="sage-role">知識蓄積・学習</div>
                    <div class="sage-metrics">
                        <div class="metric">
                            <div class="metric-value" id="knowledgeEntries">0</div>
                            <div class="metric-label">Entries</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value" id="learningRate">0</div>
                            <div class="metric-label">Learn/h</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- システムリソース -->
        <div class="widget system-metrics">
            <div class="widget-title">システムリソース</div>
            <div>
                <div>CPU使用率</div>
                <div class="metric-bar">
                    <div class="metric-fill" id="cpuBar" style="width: 0%"></div>
                </div>
                <div style="text-align: right; font-size: 12px;"><span id="cpuValue">0</span>%</div>
            </div>
            <div style="margin-top: 15px;">
                <div>メモリ使用率</div>
                <div class="metric-bar">
                    <div class="metric-fill" id="memoryBar" style="width: 0%"></div>
                </div>
                <div style="text-align: right; font-size: 12px;"><span id="memoryValue">0</span>%</div>
            </div>
            <div style="margin-top: 15px;">
                <div>ディスク使用率</div>
                <div class="metric-bar">
                    <div class="metric-fill" id="diskBar" style="width: 0%"></div>
                </div>
                <div style="text-align: right; font-size: 12px;"><span id="diskValue">0</span>%</div>
            </div>
        </div>

        <!-- アラートサマリー -->
        <div class="widget alerts-widget">
            <div class="widget-title">アクティブアラート</div>
            <div id="alertsList">
                <div class="alert-item alert-info">
                    <span class="alert-icon">ℹ️</span>
                    <span>システム正常稼働中</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // モニタリングデータの更新
        async function updateDashboard() {
            try {
                const response = await fetch('/monitoring/dashboards/current_status.json');
                const data = await response.json();

                // ワーカーグリッドの更新
                updateWorkerGrid(data.workers);

                // Four Sagesの更新
                updateFourSages(data.four_sages);

                // システムメトリクスの更新
                updateSystemMetrics(data.system_metrics);

                // アラートの更新
                updateAlerts(data.alerts);

            } catch (error) {
                console.error('Dashboard update failed:', error);
            }
        }

        function updateWorkerGrid(workersData) {
            const grid = document.getElementById('workerGrid');
            grid.innerHTML = '';

            let activeCount = 0;
            let idleCount = 0;
            let failedCount = 0;

            // 32ワーカーを表示
            for (let i = 0; i < 32; i++) {
                const worker = workersData.details?.[i] || { status: 'unknown' };
                const cell = document.createElement('div');
                cell.className = `worker-cell worker-${worker.status}`;
                cell.textContent = `W${i + 1}`;
                cell.title = `Worker ${i + 1}: ${worker.status}`;

                if (worker.status === 'active') activeCount++;
                else if (worker.status === 'idle') idleCount++;
                else if (worker.status === 'failed') failedCount++;

                grid.appendChild(cell);
            }

            document.getElementById('activeWorkers').textContent = activeCount;
            document.getElementById('idleWorkers').textContent = idleCount;
            document.getElementById('failedWorkers').textContent = failedCount;
        }

        function updateFourSages(sagesData) {
            if (!sagesData || sagesData.length === 0) return;

            // Incident Sageの更新
            const incidentSage = sagesData.find(s => s.name === 'Incident Sage');
            if (incidentSage) {
                document.getElementById('incidentCount').textContent =
                    incidentSage.metrics.active_incidents || 0;
                document.getElementById('incidentResolved').textContent =
                    incidentSage.metrics.resolved_today || 0;
            }

            // Knowledge Sageの更新
            const knowledgeSage = sagesData.find(s => s.name === 'Knowledge Sage');
            if (knowledgeSage) {
                document.getElementById('knowledgeEntries').textContent =
                    (knowledgeSage.metrics.knowledge_entries || 0).toLocaleString();
                document.getElementById('learningRate').textContent =
                    Math.round(knowledgeSage.metrics.learning_rate || 0);
            }
        }

        function updateSystemMetrics(metrics) {
            if (!metrics || !metrics.resource_usage) return;

            const cpu = Math.round(metrics.resource_usage.cpu || 0);
            const memory = Math.round(metrics.resource_usage.memory || 0);
            const disk = Math.round(metrics.resource_usage.disk || 0);

            document.getElementById('cpuBar').style.width = cpu + '%';
            document.getElementById('cpuValue').textContent = cpu;

            document.getElementById('memoryBar').style.width = memory + '%';
            document.getElementById('memoryValue').textContent = memory;

            document.getElementById('diskBar').style.width = disk + '%';
            document.getElementById('diskValue').textContent = disk;
        }

        function updateAlerts(alerts) {
            const alertsList = document.getElementById('alertsList');

            if (!alerts || alerts.length === 0) {
                alertsList.innerHTML = `
                    <div class="alert-item alert-info">
                        <span class="alert-icon">✓</span>
                        <span>システム正常稼働中</span>
                    </div>
                `;
                return;
            }

            alertsList.innerHTML = alerts.map(alert => `
                <div class="alert-item alert-${alert.level}">
                    <span class="alert-icon">${getAlertIcon(alert.level)}</span>
                    <span>${alert.message}</span>
                </div>
            `).join('');
        }

        function getAlertIcon(level) {
            switch(level) {
                case 'critical': return '🔴';
                case 'warning': return '🟠';
                case 'info': return 'ℹ️';
                default: return '●';
            }
        }

        // 初期化
        updateDashboard();

        // 5秒ごとに更新
        setInterval(updateDashboard, 5000);
    </script>
</body>
</html>
