name: ğŸ” PRå“è³ªãƒã‚§ãƒƒã‚¯

on:
  pull_request:
    types: [opened, synchronize]
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  # PRè‡ªå‹•ãƒ©ãƒ™ãƒªãƒ³ã‚°
  auto-labeling:
    name: ğŸ·ï¸ Auto Labeling
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ·ï¸ Apply Labels
        uses: actions/labeler@v4
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          configuration-path: .github/labeler.yml

  # 4è³¢è€…ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦è«‹
  four-sages-review:
    name: ğŸ§™â€â™‚ï¸ Four Sages Review Request
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: ğŸ“ Request Review
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const files = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number
            });
            
            let reviewMessage = '## ğŸ›ï¸ ã‚¨ãƒ«ãƒ€ãƒ¼ã‚ºã‚®ãƒ«ãƒ‰ PRãƒ¬ãƒ“ãƒ¥ãƒ¼è¦è«‹\n\n';
            let requiredSages = new Set();
            
            // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—ã«åŸºã¥ã„ã¦è³¢è€…ã‚’é¸å®š
            for (const file of files.data) {
              if (file.filename.includes('knowledge') || file.filename.includes('.md')) {
                requiredSages.add('ğŸ“š Knowledge Sage');
              }
              if (file.filename.includes('task') || file.filename.includes('workflow')) {
                requiredSages.add('ğŸ“‹ Task Sage');
              }
              if (file.filename.includes('test') || file.filename.includes('.spec.')) {
                requiredSages.add('ğŸš¨ Incident Sage');
              }
              if (file.filename.includes('search') || file.filename.includes('rag')) {
                requiredSages.add('ğŸ” RAG Sage');
              }
            }
            
            if (requiredSages.size === 0) {
              requiredSages = new Set(['ğŸ“š Knowledge Sage', 'ğŸ“‹ Task Sage', 'ğŸš¨ Incident Sage', 'ğŸ” RAG Sage']);
            }
            
            reviewMessage += '### ãƒ¬ãƒ“ãƒ¥ãƒ¼æ‹…å½“è³¢è€…\n';
            for (const sage of requiredSages) {
              reviewMessage += `- ${sage}\n`;
            }
            
            reviewMessage += '\n### ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ\n';
            reviewMessage += '- [ ] ã‚³ãƒ¼ãƒ‰å“è³ªåŸºæº–ã‚’æº€ãŸã—ã¦ã„ã‚‹\n';
            reviewMessage += '- [ ] ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸90%ä»¥ä¸Š\n';
            reviewMessage += '- [ ] ã‚¨ãƒ«ãƒ€ãƒ¼ã‚ºã‚®ãƒ«ãƒ‰å‘½åè¦å‰‡éµå®ˆ\n';
            reviewMessage += '- [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°æ¸ˆã¿\n';
            reviewMessage += '- [ ] E2Eãƒ†ã‚¹ãƒˆè¿½åŠ ï¼ˆå¿…è¦ãªå ´åˆï¼‰\n';
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: reviewMessage
            });

  # ã‚³ãƒãƒ³ãƒ‰ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
  command-handler:
    name: ğŸ¤– Command Handler
    runs-on: ubuntu-latest
    if: github.event_name == 'issue_comment' && contains(github.event.comment.body, '/elder')
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Process Command
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment;
            const command = comment.body.trim();
            
            // /elder test - ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
            if (command === '/elder test') {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: 'ğŸ§ª ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™...'
              });
              
              // ãƒ†ã‚¹ãƒˆå®Ÿè¡Œãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ãƒˆãƒªã‚¬ãƒ¼
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'quality-gate.yml',
                ref: 'main'
              });
            }
            
            // /elder approve - è³¢è€…æ‰¿èª
            else if (command.startsWith('/elder approve')) {
              const sage = command.split(' ')[2];
              let approvalMessage = '';
              
              switch(sage) {
                case 'knowledge':
                  approvalMessage = 'ğŸ“š Knowledge Sage ãŒæ‰¿èªã—ã¾ã—ãŸ';
                  break;
                case 'task':
                  approvalMessage = 'ğŸ“‹ Task Sage ãŒæ‰¿èªã—ã¾ã—ãŸ';
                  break;
                case 'incident':
                  approvalMessage = 'ğŸš¨ Incident Sage ãŒæ‰¿èªã—ã¾ã—ãŸ';
                  break;
                case 'rag':
                  approvalMessage = 'ğŸ” RAG Sage ãŒæ‰¿èªã—ã¾ã—ãŸ';
                  break;
                default:
                  approvalMessage = 'âŒ ç„¡åŠ¹ãªè³¢è€…åã§ã™';
              }
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: approvalMessage
              });
            }
            
            // /elder council - è©•è­°ä¼šæ‹›é›†
            else if (command === '/elder council') {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: 'ğŸ›ï¸ ã‚¨ãƒ«ãƒ€ãƒ¼è©•è­°ä¼šã‚’æ‹›é›†ã—ã¾ã™...\n\nå…¨è³¢è€…ã®æ‰¿èªãŒå¿…è¦ã§ã™ã€‚'
              });
            }

  # PR ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯
  pr-size-check:
    name: ğŸ“ PR Size Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: ğŸ“Š Check PR Size
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const { additions, deletions } = pr;
            const totalChanges = additions + deletions;
            
            let sizeLabel = '';
            let sizeEmoji = '';
            
            if (totalChanges < 10) {
              sizeLabel = 'size/XS';
              sizeEmoji = 'ğŸŸ¢';
            } else if (totalChanges < 50) {
              sizeLabel = 'size/S';
              sizeEmoji = 'ğŸŸ¢';
            } else if (totalChanges < 200) {
              sizeLabel = 'size/M';
              sizeEmoji = 'ğŸŸ¡';
            } else if (totalChanges < 500) {
              sizeLabel = 'size/L';
              sizeEmoji = 'ğŸŸ ';
            } else {
              sizeLabel = 'size/XL';
              sizeEmoji = 'ğŸ”´';
            }
            
            // ãƒ©ãƒ™ãƒ«è¿½åŠ 
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: [sizeLabel]
            });
            
            // ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ 
            if (totalChanges > 500) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: `${sizeEmoji} **PR ã‚µã‚¤ã‚ºè­¦å‘Š**\n\nã“ã®PRã¯ ${totalChanges} è¡Œã®å¤‰æ›´ã‚’å«ã‚“ã§ã„ã¾ã™ã€‚\nã‚¨ãƒ«ãƒ€ãƒ¼ã‚ºã‚®ãƒ«ãƒ‰ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã§ã¯ã€PRã¯500è¡Œä»¥ä¸‹ã«ä¿ã¤ã“ã¨ã‚’æ¨å¥¨ã—ã¦ã„ã¾ã™ã€‚\n\nå¯èƒ½ã§ã‚ã‚Œã°ã€è¤‡æ•°ã®å°ã•ãªPRã«åˆ†å‰²ã™ã‚‹ã“ã¨ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚`
              });
            }

# ğŸ§™â€â™‚ï¸ Four Sagesè©•ä¾¡
# 
# âœ… Knowledge Sage: PRè‡ªå‹•åˆ†æãƒ»ãƒ©ãƒ™ãƒªãƒ³ã‚°
# âœ… Task Sage: åŠ¹ç‡çš„ãªãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ—ãƒ­ã‚»ã‚¹
# âœ… Incident Sage: ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ãƒ»å“è³ªè­¦å‘Š
# âœ… RAG Sage: ã‚³ãƒãƒ³ãƒ‰ãƒ™ãƒ¼ã‚¹æ“ä½œ
# 
# PRæ©Ÿèƒ½:
# - è‡ªå‹•ãƒ©ãƒ™ãƒªãƒ³ã‚°
# - 4è³¢è€…ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦è«‹
# - ã‚³ãƒãƒ³ãƒ‰ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
# - PRã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯
# - ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ