name: ğŸ›ï¸ ã‚¨ãƒ«ãƒ€ãƒ¼ã‚ºã‚®ãƒ«ãƒ‰å“è³ªã‚²ãƒ¼ãƒˆ

on:
  push:
    branches: [main, develop]
  pull_request:
    types: [opened, synchronize, reopened]

env:
  NODE_VERSION: '20.x'
  ELDERS_GUILD_ENV: 'ci'

jobs:
  # ğŸ§™â€â™‚ï¸ Knowledge Sage - é™çš„è§£æãƒ»ãƒªãƒ³ãƒˆ
  knowledge-sage-analysis:
    name: ğŸ“š Knowledge Sage Analysis
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Install Dependencies
        run: npm ci
        
      - name: ğŸ” ESLint Check
        run: npm run lint
        
      - name: ğŸ“˜ TypeScript Check
        run: npx tsc --noEmit
        
      - name: ğŸ“Š Bundle Size Check
        run: |
          npm run build
          npx bundlesize --config .bundlesizerc.json || true

  # ğŸ§™â€â™‚ï¸ Task Sage - ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆãƒ»ã‚«ãƒãƒ¬ãƒƒã‚¸
  task-sage-testing:
    name: ğŸ“‹ Task Sage Testing
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Install Dependencies
        run: npm ci
        
      - name: ğŸ§ª Unit Tests
        run: npm run test:ci
        
      - name: ğŸ“Š Coverage Report
        uses: codecov/codecov-action@v3
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: true
          
      - name: ğŸ“ˆ Coverage Check (90%+)
        run: |
          COVERAGE=$(npx jest --coverage --coverageReporters=json-summary | grep -o '"pct":[0-9.]*' | head -1 | grep -o '[0-9.]*')
          echo "Coverage: $COVERAGE%"
          if (( $(echo "$COVERAGE < 90" | bc -l) )); then
            echo "âŒ Coverage is below 90% threshold"
            exit 1
          fi
          echo "âœ… Coverage meets 90% threshold"

  # ğŸ§™â€â™‚ï¸ Incident Sage - E2Eãƒ†ã‚¹ãƒˆ
  incident-sage-e2e:
    name: ğŸš¨ Incident Sage E2E
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright:v1.40.0-jammy
    strategy:
      matrix:
        browser: [chromium, firefox, webkit]
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Install Dependencies
        run: npm ci
        
      - name: ğŸ­ Install Playwright
        run: npx playwright install --with-deps ${{ matrix.browser }}
        
      - name: ğŸš€ Start Dev Server
        run: |
          npm run dev &
          npx wait-on http://localhost:3000
          
      - name: ğŸ§ª E2E Tests - ${{ matrix.browser }}
        run: npx playwright test --project=${{ matrix.browser }}
        
      - name: ğŸ“Š Upload Test Results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: playwright-report-${{ matrix.browser }}
          path: e2e-reports/
          retention-days: 7

  # ğŸ§™â€â™‚ï¸ RAG Sage - Visual Regression Testing
  rag-sage-visual:
    name: ğŸ” RAG Sage Visual Testing
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Chromaticéœ€è¦
          
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Install Dependencies
        run: npm ci
        
      - name: ğŸ“š Build Storybook
        run: npm run build-storybook
        
      - name: ğŸ¨ Chromatic Visual Tests
        uses: chromaui/action@v1
        with:
          projectToken: ${{ secrets.CHROMATIC_PROJECT_TOKEN }}
          exitZeroOnChanges: true
          exitOnceUploaded: true
          onlyChanged: true

  # ğŸ›ï¸ Elder Council - å“è³ªè©•è­°ä¼š
  elder-council-verdict:
    name: ğŸ›ï¸ Elder Council Verdict
    needs: [knowledge-sage-analysis, task-sage-testing, incident-sage-e2e, rag-sage-visual]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ“Š Collect Sage Reports
        id: sage-reports
        run: |
          echo "## ğŸ›ï¸ ã‚¨ãƒ«ãƒ€ãƒ¼è©•è­°ä¼šå“è³ªå ±å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # å„è³¢è€…ã®çµæœåé›†
          if [[ "${{ needs.knowledge-sage-analysis.result }}" == "success" ]]; then
            echo "âœ… **Knowledge Sage**: é™çš„è§£æåˆæ ¼" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Knowledge Sage**: é™çš„è§£æä¸åˆæ ¼" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.task-sage-testing.result }}" == "success" ]]; then
            echo "âœ… **Task Sage**: ãƒ†ã‚¹ãƒˆãƒ»ã‚«ãƒãƒ¬ãƒƒã‚¸åˆæ ¼" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Task Sage**: ãƒ†ã‚¹ãƒˆãƒ»ã‚«ãƒãƒ¬ãƒƒã‚¸ä¸åˆæ ¼" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.incident-sage-e2e.result }}" == "success" ]]; then
            echo "âœ… **Incident Sage**: E2Eãƒ†ã‚¹ãƒˆåˆæ ¼" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Incident Sage**: E2Eãƒ†ã‚¹ãƒˆä¸åˆæ ¼" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.rag-sage-visual.result }}" == "success" ]]; then
            echo "âœ… **RAG Sage**: ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ãƒ†ã‚¹ãƒˆåˆæ ¼" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **RAG Sage**: ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ãƒ†ã‚¹ãƒˆä¸åˆæ ¼" >> $GITHUB_STEP_SUMMARY
          fi
          
      - name: ğŸ¯ Final Verdict
        run: |
          if [[ "${{ needs.knowledge-sage-analysis.result }}" == "success" ]] && \
             [[ "${{ needs.task-sage-testing.result }}" == "success" ]] && \
             [[ "${{ needs.incident-sage-e2e.result }}" == "success" ]] && \
             [[ "${{ needs.rag-sage-visual.result }}" == "success" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## ğŸ‰ å“è³ªã‚²ãƒ¼ãƒˆé€šéï¼" >> $GITHUB_STEP_SUMMARY
            echo "å…¨ã¦ã®è³¢è€…ãŒå“è³ªã‚’æ‰¿èªã—ã¾ã—ãŸã€‚ãƒ‡ãƒ—ãƒ­ã‚¤å¯èƒ½ã§ã™ã€‚" >> $GITHUB_STEP_SUMMARY
            exit 0
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## âŒ å“è³ªã‚²ãƒ¼ãƒˆä¸åˆæ ¼" >> $GITHUB_STEP_SUMMARY
            echo "1äººä»¥ä¸Šã®è³¢è€…ãŒå“è³ªå•é¡Œã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚ä¿®æ­£ãŒå¿…è¦ã§ã™ã€‚" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

  # ğŸš€ Auto Deploy (mainãƒ–ãƒ©ãƒ³ãƒã®ã¿)
  auto-deploy:
    name: ğŸš€ Auto Deploy
    needs: [elder-council-verdict]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ğŸš€ Deploy to Production
        run: |
          echo "ğŸ›ï¸ ã‚¨ãƒ«ãƒ€ãƒ¼ã‚ºã‚®ãƒ«ãƒ‰æ‰¿èªæ¸ˆã¿ - æœ¬ç•ªç’°å¢ƒã¸ãƒ‡ãƒ—ãƒ­ã‚¤é–‹å§‹"
          # ãƒ‡ãƒ—ãƒ­ã‚¤ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ
          # npm run deploy:production
          
      - name: ğŸ“¢ Notify Success
        run: |
          echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ï¼" >> $GITHUB_STEP_SUMMARY
          echo "ã‚¨ãƒ«ãƒ€ãƒ¼ã‚ºã‚®ãƒ«ãƒ‰å“è³ªåŸºæº–ã‚’æº€ãŸã—ãŸã‚³ãƒ¼ãƒ‰ãŒæœ¬ç•ªç’°å¢ƒã«å±•é–‹ã•ã‚Œã¾ã—ãŸã€‚" >> $GITHUB_STEP_SUMMARY

# ğŸ§™â€â™‚ï¸ Four Sagesè©•ä¾¡
# 
# âœ… Knowledge Sage: é™çš„è§£æãƒ»ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯å®Œå‚™
# âœ… Task Sage: 90%+ã‚«ãƒãƒ¬ãƒƒã‚¸å¿…é ˆãƒ»åŠ¹ç‡çš„ä¸¦åˆ—å®Ÿè¡Œ
# âœ… Incident Sage: ãƒãƒ«ãƒãƒ–ãƒ©ã‚¦ã‚¶E2Eå®Œå…¨å¯¾å¿œ
# âœ… RAG Sage: Visual Regressionè‡ªå‹•æ¤œå‡º
# 
# å“è³ªã‚²ãƒ¼ãƒˆç‰¹å¾´:
# - 4è³¢è€…ã«ã‚ˆã‚‹å¤šå±¤å“è³ªãƒã‚§ãƒƒã‚¯
# - ä¸¦åˆ—å®Ÿè¡Œã«ã‚ˆã‚‹é«˜é€ŸåŒ–
# - è©³ç´°ãªã‚µãƒãƒªãƒ¼ãƒ¬ãƒãƒ¼ãƒˆ
# - è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤é€£æº
# - ã‚¨ãƒ«ãƒ€ãƒ¼è©•è­°ä¼šæ‰¿èªãƒ—ãƒ­ã‚»ã‚¹