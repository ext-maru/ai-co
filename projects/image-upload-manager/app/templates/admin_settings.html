{% extends "base.html" %}

{% block title %}システム設定 - 画像アップロード管理システム{% endblock %}

{% block header %}⚙️ システム設定{% endblock %}

{% block content %}
<div class="nav-links">
    <a href="/admin">👈 管理者ページ</a>
</div>

<form method="POST" enctype="multipart/form-data">
    <!-- Google Drive設定 -->
    <div class="card">
        <h2>☁️ Google Drive設定</h2>
        
        <!-- 接続状態表示 -->
        <div style="background: {% if google_drive_status.connected %}#d4edda{% elif google_drive_status.enabled %}#f8d7da{% else %}#e2e3e5{% endif %}; 
                    padding: 15px; border-radius: 5px; margin-bottom: 20px;">
            <strong>接続状態:</strong>
            {% if google_drive_status.connected %}
                ✅ 接続済み ({{ google_drive_status.user }})
            {% elif google_drive_status.enabled %}
                ❌ 接続エラー
                {% if google_drive_status.error %}
                    <br><small>{{ google_drive_status.error }}</small>
                {% endif %}
            {% else %}
                ⚪ 無効
            {% endif %}
            
            {% if not google_drive_status.credentials_exists %}
                <br>⚠️ 認証ファイルが見つかりません
                <br><small>配置先: {{ google_drive_status.credentials_path }}</small>
            {% endif %}
        </div>
        
        <div class="form-group">
            <label>
                <input type="checkbox" name="google_drive_enabled" id="google_drive_enabled"
                       {% if settings.google_drive_enabled %}checked{% endif %}
                       onchange="toggleGoogleDriveSettings()">
                Google Drive連携を有効にする
            </label>
        </div>
        
        <div id="google_drive_settings" style="{% if not settings.google_drive_enabled %}display: none;{% endif %}">
            <div class="form-group">
                <label for="google_credentials_file">認証JSONファイル</label>
                <input type="file" id="google_credentials_file" name="google_credentials_file" 
                       accept=".json">
                <small style="display: block; margin-top: 5px; color: #666;">
                    Google Cloud Consoleからダウンロードした認証ファイルを選択してください
                    {% if google_drive_status.credentials_exists %}
                    <br><span style="color: #28a745;">✅ 認証ファイルは既に配置されています</span>
                    {% else %}
                    <br><span style="color: #dc3545;">❌ 認証ファイルが見つかりません</span>
                    {% endif %}
                </small>
            </div>
            
            <div class="form-group">
                <label for="google_drive_folder_id">Google DriveフォルダID *</label>
                <input type="text" id="google_drive_folder_id" name="google_drive_folder_id" 
                       value="{{ settings.google_drive_folder_id or '' }}"
                       placeholder="例: 1abcdefghijklmnopqrstuvwxyz">
                <small style="display: block; margin-top: 5px; color: #666;">
                    Google DriveのフォルダURLから取得できます<br>
                    例: https://drive.google.com/drive/folders/<strong>1abcdefghijklmnopqrstuvwxyz</strong>
                </small>
            </div>
            
            <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-top: 20px;">
                <h4>📋 設定手順</h4>
                <ol style="padding-left: 20px; margin-top: 10px;">
                    <li><a href="/admin/settings/google-drive-guide" target="_blank">Google Drive設定ガイド</a>を参照</li>
                    <li>Google Cloud ConsoleでサービスアカウントとAPIを設定</li>
                    <li>認証JSONファイルをダウンロード</li>
                    <li>上の「認証JSONファイル」でアップロード</li>
                    <li>Google DriveでフォルダIDを取得して入力</li>
                    <li>設定を保存して接続テスト</li>
                </ol>
            </div>
        </div>
    </div>

    <!-- アップロード設定 -->
    <div class="card">
        <h2>📁 アップロード設定</h2>
        
        <div class="form-group">
            <label for="max_file_size">最大ファイルサイズ (MB)</label>
            <input type="number" id="max_file_size" name="max_file_size" 
                   value="{{ settings.max_file_size or '16' }}"
                   min="1" max="100">
        </div>
        
        <div class="form-group">
            <label for="allowed_extensions">許可する拡張子</label>
            <input type="text" id="allowed_extensions" name="allowed_extensions" 
                   value="{{ settings.allowed_extensions or 'jpg,jpeg,png,gif' }}"
                   placeholder="例: jpg,jpeg,png,gif">
            <small style="display: block; margin-top: 5px; color: #666;">
                カンマ区切りで入力してください
            </small>
        </div>
    </div>

    <!-- 画像種類設定（将来の拡張用） -->
    <div class="card">
        <h2>📸 画像種類設定</h2>
        <p>現在の画像種類:</p>
        <ul style="padding-left: 20px;">
            <li>身分証明書 (identity_card)</li>
            <li>住民票 (residence_cert)</li>
            <li>収入証明書 (income_proof)</li>
            <li>契約書 (contract)</li>
            <li>銀行明細 (bank_statement)</li>
            <li>その他書類 (other_document)</li>
        </ul>
        <p style="margin-top: 15px; color: #666;">
            <small>※ 画像種類のカスタマイズは今後のアップデートで対応予定です</small>
        </p>
    </div>

    <!-- システム情報 -->
    <div class="card">
        <h2>ℹ️ システム情報</h2>
        <table style="margin-top: 0;">
            <tr>
                <td><strong>バージョン</strong></td>
                <td>1.0.0</td>
            </tr>
            <tr>
                <td><strong>データベース</strong></td>
                <td>SQLite</td>
            </tr>
            <tr>
                <td><strong>画像保存先</strong></td>
                <td>uploads/</td>
            </tr>
            <tr>
                <td><strong>実行環境</strong></td>
                <td>{% if 'DOCKER' in os.environ %}Docker{% else %}ローカル{% endif %}</td>
            </tr>
        </table>
    </div>

    <div style="text-align: center; margin-top: 30px;">
        <button type="submit" class="btn btn-success">
            💾 設定を保存
        </button>
        <a href="/admin" class="btn btn-secondary">
            キャンセル
        </a>
    </div>
</form>

<!-- Google Drive設定の詳細ガイド表示用モーダル -->
<div id="guideModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000;">
    <div style="background: white; margin: 50px auto; padding: 20px; max-width: 800px; max-height: 80vh; overflow-y: auto; border-radius: 8px;">
        <h2>📚 Google Drive設定ガイド</h2>
        <div id="guideContent">
            <!-- JavaScriptで動的に読み込み -->
        </div>
        <button onclick="closeGuideModal()" class="btn btn-secondary" style="margin-top: 20px;">
            閉じる
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function toggleGoogleDriveSettings() {
    const checkbox = document.getElementById('google_drive_enabled');
    const settings = document.getElementById('google_drive_settings');
    
    if (checkbox.checked) {
        settings.style.display = 'block';
    } else {
        settings.style.display = 'none';
    }
}

// フォーム送信前の検証
document.querySelector('form').addEventListener('submit', function(e) {
    const googleDriveEnabled = document.getElementById('google_drive_enabled').checked;
    const folderId = document.getElementById('google_drive_folder_id').value.trim();
    const credentialsFile = document.getElementById('google_credentials_file').files[0];
    
    if (googleDriveEnabled && !folderId) {
        e.preventDefault();
        showAlert('Google DriveフォルダIDを入力してください', 'error');
        return;
    }
    
    // 認証ファイルの検証
    if (credentialsFile) {
        if (!credentialsFile.name.endsWith('.json')) {
            e.preventDefault();
            showAlert('JSONファイルを選択してください', 'error');
            return;
        }
        
        if (credentialsFile.size > 1024 * 1024) { // 1MB制限
            e.preventDefault();
            showAlert('認証ファイルのサイズが大きすぎます（最大1MB）', 'error');
            return;
        }
    }
    
    showLoading();
});

// ファイル選択時のプレビュー
document.getElementById('google_credentials_file').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const json = JSON.parse(e.target.result);
                if (json.type === 'service_account' && json.client_email) {
                    showAlert('認証ファイルを確認しました', 'success');
                } else {
                    showAlert('無効な認証ファイルです', 'error');
                }
            } catch (error) {
                showAlert('JSONファイルの解析に失敗しました', 'error');
            }
        };
        reader.readAsText(file);
    }
});

// ガイドモーダル
function showGuideModal() {
    document.getElementById('guideModal').style.display = 'block';
    
    // ガイド内容を動的に読み込み（実装の例）
    fetch('/admin/settings/google-drive-guide-content')
        .then(response => response.text())
        .then(html => {
            document.getElementById('guideContent').innerHTML = html;
        })
        .catch(error => {
            document.getElementById('guideContent').innerHTML = 
                '<p>ガイドの読み込みに失敗しました。<br>' +
                '<a href="/config/google_drive_setup.md" target="_blank">マニュアルファイルを直接参照してください</a></p>';
        });
}

function closeGuideModal() {
    document.getElementById('guideModal').style.display = 'none';
}

// ESCキーでモーダルを閉じる
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeGuideModal();
    }
});

// 設定値の自動保存（変更時に一時保存）
let settingsChanged = false;

document.querySelectorAll('input').forEach(input => {
    input.addEventListener('change', function() {
        settingsChanged = true;
    });
});

// ページ離脱時の警告
window.addEventListener('beforeunload', function(e) {
    if (settingsChanged) {
        e.preventDefault();
        e.returnValue = '';
    }
});

// 保存ボタンクリック時に変更フラグをリセット
document.querySelector('button[type="submit"]').addEventListener('click', function() {
    settingsChanged = false;
});
</script>
{% endblock %}