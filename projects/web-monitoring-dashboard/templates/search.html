<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ” ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯æ¤œç´¢ - Magic Grimoire</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .search-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .result-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
            margin-bottom: 1rem;
        }

        .result-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
        }

        .btn-magic {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            border-radius: 25px;
            color: white;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-magic:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            color: white;
        }

        .sage-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            margin-right: 5px;
        }

        .sage-knowledge { background: #e3f2fd; color: #1976d2; }
        .sage-task { background: #f3e5f5; color: #7b1fa2; }
        .sage-crisis { background: #ffebee; color: #d32f2f; }
        .sage-search { background: #e8f5e8; color: #388e3c; }

        .power-level {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            text-align: center;
            line-height: 20px;
            font-size: 0.75rem;
            font-weight: bold;
            color: white;
        }

        .power-1-3 { background: #4caf50; }
        .power-4-6 { background: #ff9800; }
        .power-7-10 { background: #f44336; }

        .similarity-bar {
            height: 4px;
            border-radius: 2px;
            background: linear-gradient(90deg, #4caf50, #ffeb3b, #f44336);
            position: relative;
            overflow: hidden;
        }

        .similarity-indicator {
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            position: absolute;
            right: 0;
            transition: width 0.3s ease;
        }

        .filter-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .spell-snippet {
            background: rgba(255, 255, 255, 0.7);
            padding: 0.5rem;
            border-radius: 8px;
            font-size: 0.9rem;
            line-height: 1.4;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-transparent">
        <div class="container">
            <a class="navbar-brand" href="/">
                ğŸ”® Magic Grimoire
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">ğŸ  ãƒ›ãƒ¼ãƒ </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/library">ğŸ“š é­”æ³•æ›¸å›³æ›¸é¤¨</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/search">ğŸ” æ¤œç´¢</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/evolution">ğŸ”„ æ˜‡è¯ç®¡ç†</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin">ğŸ›ï¸ ç®¡ç†</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container py-5">
        <!-- Search Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="search-container p-4">
                    <h2 class="text-center mb-4">ğŸ” é­”æ³•æ›¸ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯æ¤œç´¢</h2>

                    <!-- Main Search -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="input-group input-group-lg">
                                <input type="text" id="searchQuery" class="form-control"
                                       placeholder="ä¾‹: TDDã®å®Ÿè£…æ–¹æ³•ã€PostgreSQLã®è¨­å®šã€Claude CLIã®ä½¿ã„æ–¹..."
                                       value="">
                                <button class="btn btn-magic px-4" type="button" onclick="performSearch()">
                                    <i class="bi bi-search"></i> æ¤œç´¢
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Filters -->
                    <div class="filter-section">
                        <div class="row g-3">
                            <div class="col-md-6 col-lg-3">
                                <label class="form-label text-white">é­”æ³•å­¦æ´¾</label>
                                <select class="form-select" id="magicSchool">
                                    <option value="">ã™ã¹ã¦</option>
                                    <option value="knowledge_sage">ğŸ“š ãƒŠãƒ¬ãƒƒã‚¸è³¢è€…</option>
                                    <option value="task_oracle">ğŸ“‹ ã‚¿ã‚¹ã‚¯è³¢è€…</option>
                                    <option value="crisis_sage">ğŸš¨ ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆè³¢è€…</option>
                                    <option value="search_mystic">ğŸ” RAGè³¢è€…</option>
                                </select>
                            </div>
                            <div class="col-md-6 col-lg-3">
                                <label class="form-label text-white">å‘ªæ–‡ç¨®åˆ¥</label>
                                <select class="form-select" id="spellType">
                                    <option value="">ã™ã¹ã¦</option>
                                    <option value="knowledge">ğŸ“– çŸ¥è­˜ç³»</option>
                                    <option value="procedure">âš™ï¸ æ‰‹é †ç³»</option>
                                    <option value="configuration">ğŸ”§ è¨­å®šç³»</option>
                                    <option value="template">ğŸ“ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</option>
                                    <option value="reference">ğŸ“‹ å‚ç…§ç³»</option>
                                </select>
                            </div>
                            <div class="col-md-6 col-lg-2">
                                <label class="form-label text-white">æœ€å°å¨åŠ›</label>
                                <select class="form-select" id="minPower">
                                    <option value="">æŒ‡å®šãªã—</option>
                                    <option value="1">1ä»¥ä¸Š</option>
                                    <option value="3">3ä»¥ä¸Š</option>
                                    <option value="5">5ä»¥ä¸Š</option>
                                    <option value="7">7ä»¥ä¸Š</option>
                                    <option value="9">9ä»¥ä¸Š</option>
                                </select>
                            </div>
                            <div class="col-md-6 col-lg-2">
                                <label class="form-label text-white">é¡ä¼¼åº¦é–¾å€¤</label>
                                <select class="form-select" id="threshold">
                                    <option value="0.5">50%ä»¥ä¸Š</option>
                                    <option value="0.7" selected>70%ä»¥ä¸Š</option>
                                    <option value="0.8">80%ä»¥ä¸Š</option>
                                    <option value="0.9">90%ä»¥ä¸Š</option>
                                </select>
                            </div>
                            <div class="col-md-12 col-lg-2">
                                <label class="form-label text-white">ãã®ä»–</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="eternalOnly">
                                    <label class="form-check-label text-white" for="eternalOnly">
                                        æ°¸ç¶šåŒ–å‘ªæ–‡ã®ã¿
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search Results -->
        <div class="row">
            <div class="col-12">
                <div id="searchResults">
                    <!-- åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
                    <div class="text-center text-white py-5">
                        <i class="bi bi-search display-4 mb-3 d-block"></i>
                        <h4>AI Company é­”æ³•æ›¸ã‚·ã‚¹ãƒ†ãƒ ã¸ã‚ˆã†ã“ã</h4>
                        <p class="lead">466å€‹ã®Markdownãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰é€²åŒ–ã—ãŸçŸ¥è­˜ã‚’æ¤œç´¢ã§ãã¾ã™</p>
                        <div class="mt-4">
                            <h6>æ¤œç´¢ä¾‹:</h6>
                            <div class="d-flex flex-wrap justify-content-center gap-2 mt-2">
                                <button class="btn btn-outline-light btn-sm" onclick="setSearchExample('TDD ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™º')">TDDé–‹ç™º</button>
                                <button class="btn btn-outline-light btn-sm" onclick="setSearchExample('PostgreSQL ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢')">PostgreSQLè¨­å®š</button>
                                <button class="btn btn-outline-light btn-sm" onclick="setSearchExample('Claude CLI ã‚³ãƒãƒ³ãƒ‰')">Claude CLI</button>
                                <button class="btn btn-outline-light btn-sm" onclick="setSearchExample('ã‚¨ãƒ©ãƒ¼ è§£æ±ºæ–¹æ³•')">ã‚¨ãƒ©ãƒ¼å¯¾å‡¦</button>
                                <button class="btn btn-outline-light btn-sm" onclick="setSearchExample('4è³¢è€…ã‚·ã‚¹ãƒ†ãƒ ')">4è³¢è€…ã‚·ã‚¹ãƒ†ãƒ </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Loading Indicator -->
                <div id="loadingIndicator" class="text-center py-5" style="display: none;">
                    <div class="spinner-border text-light" role="status">
                        <span class="visually-hidden">æ¤œç´¢ä¸­...</span>
                    </div>
                    <p class="text-white mt-3">é­”æ³•æ›¸ã‚’æ¤œç´¢ä¸­...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            setupSearchHandlers();
        });

        // æ¤œç´¢ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®è¨­å®š
        function setupSearchHandlers() {
            const searchInput = document.getElementById('searchQuery');
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });

            // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ã‚¯ã‚¨ãƒªã‚’å–å¾—
            const urlParams = new URLSearchParams(window.location.search);
            const query = urlParams.get('q');
            if (query) {
                searchInput.value = query;
                performSearch();
            }
        }

        // æ¤œç´¢ä¾‹ã®è¨­å®š
        function setSearchExample(query) {
            document.getElementById('searchQuery').value = query;
            performSearch();
        }

        // æ¤œç´¢å®Ÿè¡Œ
        async function performSearch() {
            const query = document.getElementById('searchQuery').value.trim();
            const magicSchool = document.getElementById('magicSchool').value;
            const spellType = document.getElementById('spellType').value;
            const minPower = document.getElementById('minPower').value;
            const threshold = document.getElementById('threshold').value;
            const eternalOnly = document.getElementById('eternalOnly').checked;

            if (!query) {
                showError('æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            showLoading();

            try {
                const searchParams = {
                    query: query,
                    limit: 20,
                    threshold: parseFloat(threshold),
                    eternal_only: eternalOnly
                };

                if (magicSchool) searchParams.schools = [magicSchool];
                if (spellType) searchParams.types = [spellType];
                if (minPower) searchParams.min_power = parseInt(minPower);

                const response = await fetch('/api/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(searchParams)
                });

                const data = await response.json();

                if (data.success) {
                    displayResults(data.results, query);
                } else {
                    showError(data.error || 'æ¤œç´¢ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                }
            } catch (error) {
                console.error('Search error:', error);
                showError('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            } finally {
                hideLoading();
            }
        }

        // æ¤œç´¢çµæœã®è¡¨ç¤º
        function displayResults(results, query) {
            const resultsContainer = document.getElementById('searchResults');

            if (results.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="text-center text-white py-5">
                        <i class="bi bi-search-x display-4 mb-3 d-block"></i>
                        <h4>æ¤œç´¢çµæœãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</h4>
                        <p class="lead">ã€Œ${query}ã€ã«é–¢ã™ã‚‹å‘ªæ–‡ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p>
                        <p>åˆ¥ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢ã—ã¦ã¿ã¦ãã ã•ã„</p>
                    </div>
                `;
                return;
            }

            let html = `
                <div class="search-container p-4 mb-4">
                    <h5>æ¤œç´¢çµæœ: ${results.length}ä»¶</h5>
                    <p class="text-muted">ã€Œ${query}ã€ã®æ¤œç´¢çµæœ</p>
                </div>
            `;

            results.forEach(result => {
                const powerClass = getPowerClass(result.power_level);
                const sageClass = getSageClass(result.magic_school);
                const similarityPercent = (result.similarity_score * 100).toFixed(1);

                html += `
                    <div class="result-card p-4">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div class="flex-grow-1">
                                <h5 class="mb-2">
                                    <a href="/spells/${result.spell_id}" class="text-decoration-none">
                                        ${result.spell_name}
                                    </a>
                                    ${result.is_eternal ? '<i class="bi bi-shield-lock text-warning" title="æ°¸ç¶šåŒ–å‘ªæ–‡"></i>' : ''}
                                </h5>
                                <div class="mb-2">
                                    <span class="sage-badge ${sageClass}">
                                        ${getSageIcon(result.magic_school)} ${getSageName(result.magic_school)}
                                    </span>
                                    <span class="power-level ${powerClass}" title="å¨åŠ›ãƒ¬ãƒ™ãƒ«: ${result.power_level}">
                                        ${result.power_level}
                                    </span>
                                    <small class="text-muted ms-2">è© å”± ${result.casting_frequency}å›</small>
                                </div>
                            </div>
                            <div class="text-end">
                                <div class="mb-1">
                                    <small class="text-muted">é¡ä¼¼åº¦</small>
                                    <strong class="ms-1">${similarityPercent}%</strong>
                                </div>
                                <div class="similarity-bar" style="width: 80px;">
                                    <div class="similarity-indicator" style="width: ${100 - result.similarity_score * 100}%"></div>
                                </div>
                            </div>
                        </div>

                        <div class="spell-snippet mb-3">
                            ${result.snippet}
                        </div>

                        <div class="d-flex justify-content-between align-items-center">
                            <div class="tags">
                                ${result.tags.slice(0, 5).map(tag =>
                                    `<span class="badge bg-secondary me-1">${tag}</span>`
                                ).join('')}
                                ${result.tags.length > 5 ? '<span class="text-muted">...</span>' : ''}
                            </div>
                            <div>
                                <a href="/spells/${result.spell_id}" class="btn btn-magic btn-sm">
                                    <i class="bi bi-eye"></i> è©³ç´°
                                </a>
                            </div>
                        </div>
                    </div>
                `;
            });

            resultsContainer.innerHTML = html;
        }

        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        function getPowerClass(powerLevel) {
            if (powerLevel <= 3) return 'power-1-3';
            if (powerLevel <= 6) return 'power-4-6';
            return 'power-7-10';
        }

        function getSageClass(magicSchool) {
            const mapping = {
                'knowledge_sage': 'sage-knowledge',
                'task_oracle': 'sage-task',
                'crisis_sage': 'sage-crisis',
                'search_mystic': 'sage-search'
            };
            return mapping[magicSchool] || 'sage-knowledge';
        }

        function getSageIcon(magicSchool) {
            const mapping = {
                'knowledge_sage': 'ğŸ“š',
                'task_oracle': 'ğŸ“‹',
                'crisis_sage': 'ğŸš¨',
                'search_mystic': 'ğŸ”'
            };
            return mapping[magicSchool] || 'ğŸ“š';
        }

        function getSageName(magicSchool) {
            const mapping = {
                'knowledge_sage': 'ãƒŠãƒ¬ãƒƒã‚¸è³¢è€…',
                'task_oracle': 'ã‚¿ã‚¹ã‚¯è³¢è€…',
                'crisis_sage': 'ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆè³¢è€…',
                'search_mystic': 'RAGè³¢è€…'
            };
            return mapping[magicSchool] || 'ãƒŠãƒ¬ãƒƒã‚¸è³¢è€…';
        }

        function showLoading() {
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('searchResults').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loadingIndicator').style.display = 'none';
            document.getElementById('searchResults').style.display = 'block';
        }

        function showError(message) {
            const resultsContainer = document.getElementById('searchResults');
            resultsContainer.innerHTML = `
                <div class="text-center text-white py-5">
                    <i class="bi bi-exclamation-triangle display-4 mb-3 d-block text-warning"></i>
                    <h4>ã‚¨ãƒ©ãƒ¼</h4>
                    <p class="lead">${message}</p>
                </div>
            `;
        }
    </script>
</body>
</html>
