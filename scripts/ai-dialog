#!/bin/bash
# 対話型タスク開始

if [ $# -lt 1 ]; then
    echo "使用方法: ai-dialog <初期プロンプト>"
    exit 1
fi

PROMPT="$*"
cd /root/ai_co
source venv/bin/activate

python3 -c "
import sys
sys.path.append('/root/ai_co')
from libs.conversation_manager import ConversationManager
from datetime import datetime
import pika
import json

# 会話開始
manager = ConversationManager()
task_id = f'dialog_{datetime.now().strftime(\"%Y%m%d_%H%M%S\")}'
conv_id = manager.start_conversation(task_id, '$PROMPT')

# 初期タスク送信
connection = pika.BlockingConnection(pika.ConnectionParameters('localhost'))
channel = connection.channel()

task_data = {
    'conversation_id': conv_id,
    'instruction': '$PROMPT',
    'context': {'initial': True}
}

channel.basic_publish(
    exchange='',
    routing_key='dialog_task_queue',
    body=json.dumps(task_data),
    properties=pika.BasicProperties(delivery_mode=2)
)

print(f'🚀 対話開始: {conv_id}')
print(f'応答は ai-reply {conv_id} <回答> で送信')
connection.close()
"
