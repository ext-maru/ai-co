#!/bin/bash
# å¯¾è©±å‹ã‚¿ã‚¹ã‚¯é–‹å§‹

if [ $# -lt 1 ]; then
    echo "ä½¿ç”¨æ–¹æ³•: ai-dialog <åˆæœŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ>"
    exit 1
fi

PROMPT="$*"
cd /root/ai_co
source venv/bin/activate

python3 -c "
import sys
sys.path.append('/root/ai_co')
from libs.conversation_manager import ConversationManager
from datetime import datetime
import pika
import json

# ä¼šè©±é–‹å§‹
manager = ConversationManager()
task_id = f'dialog_{datetime.now().strftime(\"%Y%m%d_%H%M%S\")}'
conv_id = manager.start_conversation(task_id, '$PROMPT')

# åˆæœŸã‚¿ã‚¹ã‚¯é€ä¿¡
connection = pika.BlockingConnection(pika.ConnectionParameters('localhost'))
channel = connection.channel()

task_data = {
    'conversation_id': conv_id,
    'instruction': '$PROMPT',
    'context': {'initial': True}
}

channel.basic_publish(
    exchange='',
    routing_key='dialog_task_queue',
    body=json.dumps(task_data),
    properties=pika.BasicProperties(delivery_mode=2)
)

print(f'ğŸš€ å¯¾è©±é–‹å§‹: {conv_id}')
print(f'å¿œç­”ã¯ ai-reply {conv_id} <å›ç­”> ã§é€ä¿¡')
connection.close()
"
