#!/usr/bin/env python3
"""
AI Elder Cast - ã‚¨ãƒ«ãƒ€ãƒ¼é­”æ³•è© å”±ã‚·ã‚¹ãƒ†ãƒ 
Elder Flowãƒ™ãƒ¼ã‚¹ã®é«˜åº¦ãªè‡ªå‹•åŒ–ã‚³ãƒãƒ³ãƒ‰
"""

import argparse
import asyncio
import json
import os
import sys
from datetime import datetime
from typing import Dict, Any

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ«ãƒ¼ãƒˆãƒ‘ã‚¹ã‚’è¿½åŠ 
project_root = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
sys.path.insert(0, project_root)

try:
    from libs.four_sages.knowledge.knowledge_sage import KnowledgeSage
    from libs.four_sages.task.task_sage import TaskSage
    from libs.four_sages.incident.incident_sage import IncidentSage
except ImportError as e:
    print(f"âŒ Elder Systems import error: {e}")
    print("ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§å®Ÿè¡Œã—ã¦ãã ã•ã„")
    exit(1)


class ElderCast:
    """ã‚¨ãƒ«ãƒ€ãƒ¼é­”æ³•è© å”±ã‚·ã‚¹ãƒ†ãƒ """
    
    def __init__(self):
        self.knowledge_sage = KnowledgeSage()
        self.task_sage = TaskSage()
        self.incident_sage = IncidentSage()
        
        # è© å”±ãƒ‘ã‚¿ãƒ¼ãƒ³
        self.spell_patterns = {
            "çŸ¥è­˜å¬å–š": "knowledge_summon",
            "ã‚¿ã‚¹ã‚¯ç·¨æˆ": "task_formation", 
            "å•é¡Œè§£æ±º": "problem_solving",
            "4è³¢è€…ä¼šè­°": "four_sages_council",
        }
    
    async def cast_spell(self, spell_name: str, target: str = "", power: str = "medium") -> Dict[str, Any]:
        """é­”æ³•è© å”±å®Ÿè¡Œ"""
        print(f"ğŸ”® è© å”±é–‹å§‹: {spell_name}")
        print(f"ğŸ¯ å¯¾è±¡: {target or 'æ±ç”¨'}")
        print(f"âš¡ é­”åŠ›: {power}")
        print()
        
        spell_type = self.spell_patterns.get(spell_name, "unknown")
        
        if spell_type == "knowledge_summon":
            return await self._cast_knowledge_summon(target)
        elif spell_type == "task_formation":
            return await self._cast_task_formation(target, power)
        elif spell_type == "problem_solving":
            return await self._cast_problem_solving(target, power)
        elif spell_type == "four_sages_council":
            return await self._cast_four_sages_council(target)
        else:
            return await self._cast_custom_spell(spell_name, target, power)
    
    async def _cast_knowledge_summon(self, query: str) -> Dict[str, Any]:
        """çŸ¥è­˜å¬å–šã®è¡“"""
        print("ğŸ“š Knowledge Sageå¬å–šä¸­...")
        result = await self.knowledge_sage.process_request({
            "type": "search",
            "query": query,
            "limit": 5
        })
        
        print("âœ¨ çŸ¥è­˜å¬å–šå®Œäº†:")
        if result.get("entries"):
            for i, entry in enumerate(result["entries"][:3], 1):
                print(f"  {i}. {entry.get('title', 'Untitled')}")
                print(f"     {entry.get('content', '')[:100]}...")
        else:
            print(f"  çµæœ: {result.get('status', 'Unknown')}")
        
        return result
    
    async def _cast_task_formation(self, task_desc: str, power: str) -> Dict[str, Any]:
        """ã‚¿ã‚¹ã‚¯ç·¨æˆã®è¡“"""
        print("ğŸ“‹ Task Sageå¬å–šä¸­...")
        result = await self.task_sage.process_request({
            "type": "create_plan", 
            "title": task_desc,
            "priority": power
        })
        
        print("âœ¨ ã‚¿ã‚¹ã‚¯ç·¨æˆå®Œäº†:")
        print(f"  çŠ¶æ…‹: {result.get('status', 'Unknown')}")
        if result.get('plan_id'):
            print(f"  è¨ˆç”»ID: {result['plan_id']}")
        
        return result
    
    async def _cast_problem_solving(self, problem: str, power: str) -> Dict[str, Any]:
        """å•é¡Œè§£æ±ºã®è¡“"""
        print("ğŸš¨ Incident Sageå¬å–šä¸­...")
        result = await self.incident_sage.process_request({
            "type": "analyze_problem",
            "problem": problem,
            "severity": power
        })
        
        print("âœ¨ å•é¡Œåˆ†æå®Œäº†:")
        print(f"  çŠ¶æ…‹: {result.get('status', 'Unknown')}")
        if result.get('analysis'):
            print(f"  åˆ†æçµæœ: {result['analysis'][:100]}...")
        
        return result
    
    async def _cast_four_sages_council(self, topic: str) -> Dict[str, Any]:
        """4è³¢è€…ä¼šè­°ã®è¡“"""
        print("ğŸ§™â€â™‚ï¸ 4è³¢è€…è©•è­°ä¼šæ‹›é›†ä¸­...")
        
        # å„è³¢è€…ã‹ã‚‰ã®æ„è¦‹åé›†
        sages = [
            ("ãƒŠãƒ¬ãƒƒã‚¸è³¢è€…", self.knowledge_sage),
            ("ã‚¿ã‚¹ã‚¯è³¢è€…", self.task_sage), 
            ("ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆè³¢è€…", self.incident_sage)
        ]
        
        council_result = {
            "topic": topic,
            "timestamp": datetime.now().isoformat(),
            "participants": [name for name, _ in sages],
            "opinions": []
        }
        
        for sage_name, sage in sages:
            try:
                result = await sage.process_request({
                    "type": "health_check"
                })
                status = result.get("status", "unknown")
                opinion = f"{sage_name}: {status} - {topic}ã«ã¤ã„ã¦å¯¾å¿œå¯èƒ½"
            except Exception as e:
                opinion = f"{sage_name}: å¿œç­”ãªã— ({str(e)[:30]})"
            
            council_result["opinions"].append(opinion)
        
        print("âœ¨ 4è³¢è€…è©•è­°ä¼šå®Œäº†:")
        for opinion in council_result["opinions"]:
            print(f"  {opinion}")
        
        return council_result
    
    async def _cast_custom_spell(self, spell_name: str, target: str, power: str) -> Dict[str, Any]:
        """ã‚«ã‚¹ã‚¿ãƒ é­”æ³•"""
        print(f"ğŸ”® ã‚«ã‚¹ã‚¿ãƒ é­”æ³•: {spell_name}")
        
        # 4è³¢è€…ä¼šè­°ã§ã‚«ã‚¹ã‚¿ãƒ é­”æ³•ã‚’æ¤œè¨
        result = await self._cast_four_sages_council(f"ã‚«ã‚¹ã‚¿ãƒ é­”æ³•: {spell_name} - {target}")
        
        print("âœ¨ ã‚«ã‚¹ã‚¿ãƒ é­”æ³•å®Œäº†")
        return {
            "spell_name": spell_name,
            "target": target,
            "power": power,
            "result": result,
            "status": "completed"
        }


async def main():
    parser = argparse.ArgumentParser(
        description="AI Elder Cast - ã‚¨ãƒ«ãƒ€ãƒ¼é­”æ³•è© å”±ã‚·ã‚¹ãƒ†ãƒ ",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
ğŸ”® åˆ©ç”¨å¯èƒ½ãªé­”æ³•:
  çŸ¥è­˜å¬å–š       - çŸ¥è­˜ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ã®æƒ…å ±å¬å–š
  ã‚¿ã‚¹ã‚¯ç·¨æˆ     - ã‚¿ã‚¹ã‚¯ã®è‡ªå‹•è¨ˆç”»ãƒ»å®Ÿè¡Œ
  å•é¡Œè§£æ±º       - å•é¡Œåˆ†æã¨è§£æ±ºç­–ææ¡ˆ
  4è³¢è€…ä¼šè­°      - 4è³¢è€…ã«ã‚ˆã‚‹åˆè­°åˆ¶åˆ¤æ–­

ğŸ“– ä½¿ç”¨ä¾‹:
  # çŸ¥è­˜å¬å–š
  ai-elder-cast çŸ¥è­˜å¬å–š "Dockerè¨­å®š" --power high
  
  # 4è³¢è€…ä¼šè­°
  ai-elder-cast 4è³¢è€…ä¼šè­° "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ–¹é‡æ¤œè¨"
  
  # å•é¡Œè§£æ±º
  ai-elder-cast å•é¡Œè§£æ±º "ã‚·ã‚¹ãƒ†ãƒ éšœå®³" --power critical
""")
    
    parser.add_argument("spell", help="è© å”±ã™ã‚‹é­”æ³•å")
    parser.add_argument("target", nargs="?", default="", help="é­”æ³•ã®å¯¾è±¡")
    parser.add_argument("--power", choices=["low", "medium", "high", "critical"], 
                       default="medium", help="é­”åŠ›ãƒ¬ãƒ™ãƒ«")
    parser.add_argument("--json", action="store_true", help="JSONå½¢å¼ã§çµæœå‡ºåŠ›")
    
    args = parser.parse_args()
    
    elder_cast = ElderCast()
    
    try:
        result = await elder_cast.cast_spell(args.spell, args.target, args.power)
        
        if args.json:
            print(json.dumps(result, indent=2, ensure_ascii=False))
        else:
            print(f"\nğŸ‰ é­”æ³•è© å”±çµæœ:")
            print(f"  çŠ¶æ…‹: {result.get('status', 'completed')}")
            if result.get('message'):
                print(f"  ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: {result['message']}")
    
    except Exception as e:
        print(f"âŒ é­”æ³•è© å”±å¤±æ•—: {str(e)}")
        if args.json:
            print(json.dumps({"status": "error", "error": str(e)}, indent=2))
        exit(1)


if __name__ == "__main__":
    asyncio.run(main())