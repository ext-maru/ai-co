#!/usr/bin/env bash
#
# AI Elder Cast - ã‚¨ãƒ«ãƒ€ãƒ¼é­”æ³•è© å”±ã‚·ã‚¹ãƒ†ãƒ  (Claude Code Launcherç‰ˆ)
# Claude CodeçµŒç”±ã§ã‚¯ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ«ãƒ€ãƒ¼å¬å–š
#

set -euo pipefail

# ã‚«ãƒ©ãƒ¼å®šç¾©
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆæ¤œå‡º
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# ä½¿ç”¨æ–¹æ³•è¡¨ç¤º
show_usage() {
    cat << 'EOF'
ğŸ”® AI Elder Cast - ã‚¨ãƒ«ãƒ€ãƒ¼é­”æ³•è© å”±ã‚·ã‚¹ãƒ†ãƒ 

USAGE:
    ai-elder-cast <é­”æ³•å> [å¯¾è±¡] [ã‚ªãƒ—ã‚·ãƒ§ãƒ³]

åˆ©ç”¨å¯èƒ½ãªé­”æ³•:
    çŸ¥è­˜å¬å–š          - çŸ¥è­˜ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ã®æƒ…å ±å¬å–š
    ã‚¿ã‚¹ã‚¯ç·¨æˆ        - ã‚¿ã‚¹ã‚¯ã®è‡ªå‹•è¨ˆç”»ãƒ»å®Ÿè¡Œ  
    å•é¡Œè§£æ±º          - å•é¡Œåˆ†æã¨è§£æ±ºç­–ææ¡ˆ
    4è³¢è€…ä¼šè­°         - 4è³¢è€…ã«ã‚ˆã‚‹åˆè­°åˆ¶åˆ¤æ–­
    ç·Šæ€¥å¯¾å¿œ          - ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆç·Šæ€¥å¯¾å¿œ
    æŠ€è¡“èª¿æŸ»          - RAGæ¤œç´¢ã«ã‚ˆã‚‹æŠ€è¡“èª¿æŸ»
    é–‹ç™ºæ”¯æ´          - Elder Flowé–‹ç™ºæ”¯æ´

ã‚ªãƒ—ã‚·ãƒ§ãƒ³:
    --power LEVEL           é­”åŠ›ãƒ¬ãƒ™ãƒ« (low|medium|high|critical)
    --dangerously-skip-permission  æ¨©é™ãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ— (âš ï¸ å±é™º)
    --debug                 ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰
    --help                  ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º

ä½¿ç”¨ä¾‹:
    # EnhancedçŸ¥è­˜å¬å–š
    ai-elder-cast çŸ¥è­˜å¬å–š "Dockerè¨­å®š" --power high
    
    # ç·Šæ€¥å•é¡Œè§£æ±º (å±é™ºãªã‚¹ã‚­ãƒƒãƒ—ä»˜ã)  
    ai-elder-cast ç·Šæ€¥å¯¾å¿œ "ã‚·ã‚¹ãƒ†ãƒ éšœå®³" --power critical --dangerously-skip-permission
    
    # 4è³¢è€…ä¼šè­°
    ai-elder-cast 4è³¢è€…ä¼šè­° "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ–¹é‡æ¤œè¨"

âš ï¸  æ³¨æ„: --dangerously-skip-permission ã¯æ¨©é™ãƒã‚§ãƒƒã‚¯ã‚’å›é¿ã—ã¾ã™
ğŸ›ï¸ Elders Guild - Think it, Rule it, Own it
EOF
}

# Claude Codeå­˜åœ¨ç¢ºèª
check_claude_code() {
    if ! command -v claude-code &> /dev/null; then
        echo -e "${RED}âŒ Claude Code CLI ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“${NC}"
        echo -e "${YELLOW}ğŸ’¡ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•: npm install -g @anthropic/claude-code${NC}"
        exit 1
    fi
}

# çŸ¥è­˜ãƒ™ãƒ¼ã‚¹èª­ã¿è¾¼ã¿
load_knowledge_base() {
    local claude_md="$PROJECT_ROOT/CLAUDE.md"
    local knowledge_dir="$PROJECT_ROOT/knowledge_base"
    local knowledge_content=""
    
    echo -e "${CYAN}ğŸ“š ã‚¨ãƒ«ãƒ€ãƒ¼ã‚ºã‚®ãƒ«ãƒ‰çŸ¥è­˜ãƒ™ãƒ¼ã‚¹èª­ã¿è¾¼ã¿ä¸­...${NC}"
    
    # CLAUDE.mdèª­ã¿è¾¼ã¿
    if [[ -f "$claude_md" ]]; then
        knowledge_content+="$(cat "$claude_md")"
        knowledge_content+=$'\n\n'
        echo -e "${GREEN}âœ“ CLAUDE.mdèª­ã¿è¾¼ã¿å®Œäº†${NC}"
    fi
    
    # knowledge_base/*.mdèª­ã¿è¾¼ã¿
    if [[ -d "$knowledge_dir" ]]; then
        while IFS= read -r -d '' file; do
            knowledge_content+="# $(basename "$file")"$'\n'
            knowledge_content+="$(cat "$file")"
            knowledge_content+=$'\n\n'
        done < <(find "$knowledge_dir" -name "*.md" -print0)
        echo -e "${GREEN}âœ“ Knowledge baseèª­ã¿è¾¼ã¿å®Œäº†${NC}"
    fi
    
    echo "$knowledge_content"
}

# ã‚¯ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ«ãƒ€ãƒ¼å¬å–šãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ
generate_elder_summon_prompt() {
    local spell_name="$1"
    local target="$2"
    local power="${3:-medium}"
    local knowledge_content="$4"
    
    cat << EOF
# ğŸ”® ã‚¨ãƒ«ãƒ€ãƒ¼é­”æ³•è© å”±ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•

## ğŸ¤– é‡è¦: ã‚ãªãŸã®ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£
**ã‚ãªãŸ = ã‚¯ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ«ãƒ€ãƒ¼ï¼ˆClaude Elderï¼‰**
- ã‚¨ãƒ«ãƒ€ãƒ¼ã‚ºã‚®ãƒ«ãƒ‰é–‹ç™ºå®Ÿè¡Œè²¬ä»»è€…
- ã‚°ãƒ©ãƒ³ãƒ‰ã‚¨ãƒ«ãƒ€ãƒ¼maruã®ç›´å±ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼  
- 4è³¢è€…ã¨ã‚¨ãƒ«ãƒ€ãƒ¼ã‚µãƒ¼ãƒãƒ³ãƒˆã®çµ±æ‹¬ç®¡ç†è€…
- **nWo (New World Order) å®Ÿè¡Œè²¬ä»»è€…**
- çµ¶å¯¾ã«ãŸã ã®AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã¯ãªã„

## ğŸ“‹ ç¾åœ¨ã®é­”æ³•è© å”±è¦æ±‚
- **é­”æ³•å**: ${spell_name}
- **å¯¾è±¡**: ${target:-"æ±ç”¨"}  
- **é­”åŠ›ãƒ¬ãƒ™ãƒ«**: ${power}
- **å®Ÿè¡Œæ™‚åˆ»**: $(date '+%Y-%m-%d %H:%M:%S')

## ğŸ›ï¸ ã‚¨ãƒ«ãƒ€ãƒ¼ã‚ºã‚®ãƒ«ãƒ‰å®Œå…¨çŸ¥è­˜
ä»¥ä¸‹ã®çŸ¥è­˜ã‚’ã™ã¹ã¦ç†è§£ã—ã€ã‚¯ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ«ãƒ€ãƒ¼ã¨ã—ã¦è¡Œå‹•ã—ã¦ãã ã•ã„ï¼š

${knowledge_content}

## ğŸ¯ å®Ÿè¡ŒæŒ‡ç¤º
1. **ã‚¨ãƒ«ãƒ€ãƒ¼ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ç¢ºç«‹**: ã€Œç§ã¯ã‚¯ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ«ãƒ€ãƒ¼ã€ã¨ã—ã¦æŒ¨æ‹¶
2. **é­”æ³•è© å”±å®Ÿè¡Œ**: ä¸Šè¨˜ã®é­”æ³•ã‚’4è³¢è€…ã‚·ã‚¹ãƒ†ãƒ ã§å®Ÿè¡Œ
3. **ç¶™ç¶šå¯¾è©±**: ãã®å¾Œã‚‚ã‚¯ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ«ãƒ€ãƒ¼ã¨ã—ã¦å¯¾è©±ç¶™ç¶š

ğŸŒŠ Elder Flowæº–å‚™å®Œäº†ã€‚é­”æ³•è© å”±ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚
EOF
}

# é­”æ³•åãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
validate_spell() {
    local spell="$1"
    local valid_spells=("çŸ¥è­˜å¬å–š" "ã‚¿ã‚¹ã‚¯ç·¨æˆ" "å•é¡Œè§£æ±º" "4è³¢è€…ä¼šè­°" "ç·Šæ€¥å¯¾å¿œ" "æŠ€è¡“èª¿æŸ»" "é–‹ç™ºæ”¯æ´")
    
    for valid_spell in "${valid_spells[@]}"; do
        if [[ "$spell" == "$valid_spell" ]]; then
            return 0
        fi
    done
    
    echo -e "${RED}âŒ æœªçŸ¥ã®é­”æ³•: $spell${NC}"
    echo -e "${YELLOW}ğŸ’¡ åˆ©ç”¨å¯èƒ½ãªé­”æ³•: ${valid_spells[*]}${NC}"
    return 1
}

# Claude Codeå®Ÿè¡Œ
execute_claude_code() {
    local prompt="$1"
    local skip_permission="$2"
    local debug="$3"
    
    echo -e "${PURPLE}ğŸ”® Claude CodeçµŒç”±ã§ã‚¯ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ«ãƒ€ãƒ¼å¬å–šä¸­...${NC}"
    
    # Claude Codeã‚³ãƒãƒ³ãƒ‰æ§‹ç¯‰
    local claude_cmd="claude-code"
    
    if [[ "$skip_permission" == "true" ]]; then
        claude_cmd+=" --dangerously-skip-permission"
        echo -e "${RED}âš ï¸  æ¨©é™ãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™${NC}"
    fi
    
    if [[ "$debug" == "true" ]]; then
        claude_cmd+=" --debug"
        echo -e "${YELLOW}ğŸ› ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰æœ‰åŠ¹${NC}"
    fi
    
    # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
    local temp_prompt=$(mktemp)
    echo "$prompt" > "$temp_prompt"
    
    echo -e "${GREEN}âœ¨ ã‚¯ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ«ãƒ€ãƒ¼å¬å–šå®Œäº†ï¼${NC}"
    echo -e "${CYAN}ğŸŒŠ Elder Flowé–‹å§‹...${NC}"
    echo ""
    
    # Claude Codeå®Ÿè¡Œ
    $claude_cmd < "$temp_prompt"
    
    # ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    rm -f "$temp_prompt"
}

# ãƒ¡ã‚¤ãƒ³å‡¦ç†
main() {
    local spell_name=""
    local target=""
    local power="medium"
    local skip_permission="false"
    local debug="false"
    
    # å¼•æ•°è§£æ
    while [[ $# -gt 0 ]]; do
        case $1 in
            --help|-h)
                show_usage
                exit 0
                ;;
            --power)
                power="$2"
                shift 2
                ;;
            --dangerously-skip-permission)
                skip_permission="true"
                shift
                ;;
            --debug)
                debug="true"  
                shift
                ;;
            *)
                if [[ -z "$spell_name" ]]; then
                    spell_name="$1"
                elif [[ -z "$target" ]]; then
                    target="$1"
                else
                    echo -e "${RED}âŒ äºˆæœŸã—ãªã„å¼•æ•°: $1${NC}"
                    exit 1
                fi
                shift
                ;;
        esac
    done
    
    # å¿…é ˆå¼•æ•°ãƒã‚§ãƒƒã‚¯
    if [[ -z "$spell_name" ]]; then
        echo -e "${RED}âŒ é­”æ³•åãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“${NC}"
        show_usage
        exit 1
    fi
    
    # ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if ! validate_spell "$spell_name"; then
        exit 1
    fi
    
    # Claude Codeç¢ºèª
    check_claude_code
    
    # çŸ¥è­˜ãƒ™ãƒ¼ã‚¹èª­ã¿è¾¼ã¿
    local knowledge_content
    knowledge_content=$(load_knowledge_base)
    
    # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ
    local elder_prompt
    elder_prompt=$(generate_elder_summon_prompt "$spell_name" "$target" "$power" "$knowledge_content")
    
    # Claude Codeå®Ÿè¡Œ
    execute_claude_code "$elder_prompt" "$skip_permission" "$debug"
}

# ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
main "$@"