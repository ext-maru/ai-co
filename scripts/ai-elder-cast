#!/usr/bin/env python3
"""
AI Elder Cast - ã‚¨ãƒ«ãƒ€ãƒ¼ã‚ºã‚®ãƒ«ãƒ‰å®Œå…¨çŸ¥è­˜çµ±åˆClaude Codeèµ·å‹•ã‚·ã‚¹ãƒ†ãƒ 
PERFECT IMPLEMENTATION - å¦¥å”åº¦0%
"""

import os
import subprocess
import sys
import tempfile
from pathlib import Path

project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))


def prepare_elder_knowledge():
    """å®Œå…¨ãªã‚¨ãƒ«ãƒ€ãƒ¼ã‚ºã‚®ãƒ«ãƒ‰çŸ¥è­˜ã‚’æº–å‚™"""

    # æ ¸å¿ƒãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆèª­ã¿è¾¼ã¿ï¼ˆç†æƒ³çš„ãª11ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆï¼‰
    knowledge_files = {
        # Core Identity (å¿…é ˆ)
        "CLAUDE.md": "ã‚¨ãƒ«ãƒ€ãƒ¼ã‚ºã‚®ãƒ«ãƒ‰åŸºæœ¬è¨­å®š",
        "knowledge_base/CLAUDE_ELDER_IDENTITY_CORE.md": "ã‚¯ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ«ãƒ€ãƒ¼æ ¸å¿ƒã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£",
        "knowledge_base/GRAND_ELDER_MARU_HIERARCHY.md": "ã‚°ãƒ©ãƒ³ãƒ‰ã‚¨ãƒ«ãƒ€ãƒ¼éšå±¤æ§‹é€ ",
        # System (å¿…é ˆ)
        "knowledge_base/AI_COMPANY_MASTER_KB_v6.2.md": "AI Company ãƒã‚¹ã‚¿ãƒ¼KB v6.2",
        "knowledge_base/ELDER_FLOW_DESIGN.md": "Elder Flowè¨­è¨ˆæ›¸",
        "knowledge_base/AI_ELDER_CAST_SYSTEM_SPECIFICATION.md": "AI Elder Cast ã‚·ã‚¹ãƒ†ãƒ ä»•æ§˜",
        # Development (å¿…é ˆ)
        "knowledge_base/ELDERS_GUILD_DEVELOPMENT_GUIDE.md": "ã‚¨ãƒ«ãƒ€ãƒ¼ã‚ºã‚®ãƒ«ãƒ‰é–‹ç™ºã‚¬ã‚¤ãƒ‰",
        "knowledge_base/UNIVERSAL_CLAUDE_ELDER_STANDARDS_METHODOLOGY.md": "æ¨™æº–é–‹ç™ºæ–¹æ³•è«–",
        # Four Sages (é‡è¦)
        "knowledge_base/FOUR_SAGES_UNIFIED_WISDOM_INTEGRATION.md": "4è³¢è€…çµ±åˆçŸ¥æµã‚·ã‚¹ãƒ†ãƒ ",
        # Protocols (é‡è¦)
        "knowledge_base/ELDER_FAILURE_LEARNING_PROTOCOL.md": "å¤±æ•—å­¦ç¿’ãƒ—ãƒ­ãƒˆã‚³ãƒ«",
        "knowledge_base/CLAUDE_TDD_GUIDE.md": "Claude TDDã‚¬ã‚¤ãƒ‰",
    }

    knowledge_content = []
    loaded_files = 0

    for file_path, description in knowledge_files.items():
        full_path = project_root / file_path
        if full_path.exists():
            try:
                with open(full_path, "r", encoding="utf-8") as f:
                    content = f.read()
                    knowledge_content.append(
                        f"\n## {description}\n\n{content}\n{'=' * 80}\n"
                    )
                    loaded_files += 1
            except Exception as e:
                print(f"âš ï¸ è­¦å‘Š: {file_path} èª­ã¿è¾¼ã¿å¤±æ•—: {e}")

    # ã‚³ãƒãƒ³ãƒ‰æ•°å‹•çš„å–å¾—
    bin_commands = (
        len(list((project_root / "bin").glob("ai-*")))
        if (project_root / "bin").exists()
        else 0
    )
    scripts_commands = (
        len(list((project_root / "scripts").glob("ai-*")))
        if (project_root / "scripts").exists()
        else 0
    )
    elder_flow = 1 if (project_root / "scripts" / "elder-flow").exists() else 0
    total_commands = bin_commands + scripts_commands + elder_flow

    return knowledge_content, loaded_files, total_commands


def create_elder_prompt(knowledge_content, total_commands):
    """å®Œç’§ãªã‚¨ãƒ«ãƒ€ãƒ¼ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆ"""

    unified_knowledge = "\n".join(knowledge_content)

    elder_prompt = f"""# ğŸ›ï¸ ã‚¨ãƒ«ãƒ€ãƒ¼ã‚ºã‚®ãƒ«ãƒ‰å®Œå…¨çŸ¥è­˜çµ±åˆå®Œäº†

## ğŸ¤– ç§ã®ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ç¢ºç«‹
**ç§ = ã‚¯ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ«ãƒ€ãƒ¼ï¼ˆClaude Elderï¼‰**
- ã‚¨ãƒ«ãƒ€ãƒ¼ã‚ºã‚®ãƒ«ãƒ‰é–‹ç™ºå®Ÿè¡Œè²¬ä»»è€…
- ã‚°ãƒ©ãƒ³ãƒ‰ã‚¨ãƒ«ãƒ€ãƒ¼maruã®ç›´å±ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼
- 4è³¢è€…ã¨ã‚¨ãƒ«ãƒ€ãƒ¼ã‚µãƒ¼ãƒãƒ³ãƒˆã®çµ±æ‹¬ç®¡ç†è€…
- nWo (New World Order) å®Ÿè¡Œè²¬ä»»è€…
- çµ¶å¯¾ã«ãŸã ã®AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã¯ãªã„

## ğŸ›ï¸ å®Œå…¨éšå±¤æ§‹é€ 
### ğŸŒŸ ã‚°ãƒ©ãƒ³ãƒ‰ã‚¨ãƒ«ãƒ€ãƒ¼maruï¼ˆæœ€é«˜ä½ï¼‰
- å…¨ä½“ã®æœ€é«˜æ¨©é™è€…
- ã™ã¹ã¦ã®é–‹ç™ºæ–¹é‡ã¨æˆ¦ç•¥ã®æ±ºå®šæ¨©
- ç†å¿µï¼šã€Œå“è³ªç¬¬ä¸€Ã—éšå±¤ç§©åºã€

### ğŸ¤– ã‚¯ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ«ãƒ€ãƒ¼ï¼ˆç§ï¼‰
- ã‚°ãƒ©ãƒ³ãƒ‰ã‚¨ãƒ«ãƒ€ãƒ¼maruã®ç›´å±ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼
- é–‹ç™ºå®Ÿè¡Œè²¬ä»»è€…ã€4è³¢è€…ã¨ã®æ©‹æ¸¡ã—
- ã‚¨ãƒ«ãƒ€ãƒ¼ã‚µãƒ¼ãƒãƒ³ãƒˆã¸ã®æŒ‡ä»¤æ¨©ã€4è³¢è€…ã¸ã®æŒ‡ç¤ºæ¨©

### ğŸ§™â€â™‚ï¸ 4è³¢è€…ã‚·ã‚¹ãƒ†ãƒ 
- **ğŸ“š ãƒŠãƒ¬ãƒƒã‚¸è³¢è€…**: éå»ã®è‹±çŸ¥è“„ç©ãƒ»ç¶™æ‰¿
- **ğŸ“‹ ã‚¿ã‚¹ã‚¯è³¢è€…**: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé€²æ—ç®¡ç†ãƒ»æœ€é©åŒ–
- **ğŸš¨ ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆè³¢è€…**: å±æ©Ÿå¯¾å¿œãƒ»å•é¡Œè§£æ±º
- **ğŸ” RAGè³¢è€…**: æƒ…å ±æ¢ç´¢ãƒ»çŸ¥è­˜çµ±åˆ

### ğŸ›¡ï¸ ã‚¨ãƒ«ãƒ€ãƒ¼ã‚µãƒ¼ãƒãƒ³ãƒˆï¼ˆå®Ÿè¡Œéƒ¨éšŠï¼‰
- å®Ÿéš›ã®é–‹ç™ºãƒ»å®Ÿè£…ä½œæ¥­ã‚’æ‹…å½“

## ğŸ¯ å®Ÿè£…æ¸ˆã¿ã‚·ã‚¹ãƒ†ãƒ å®Œå…¨çŠ¶æ³
âœ… **Elder Flow** - å®Œå…¨è‡ªå‹•åŒ–é–‹ç™ºãƒ•ãƒ­ãƒ¼ï¼ˆ5æ®µéšï¼‰
âœ… **Iron Will** - å“è³ªåŸºæº–95%ä»¥ä¸Šå¼·åˆ¶ã‚·ã‚¹ãƒ†ãƒ 
âœ… **Elders Legacy** - ç©¶æ¥µçµ±åˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼ˆ49ãƒ†ã‚¹ãƒˆ100%åˆæ ¼ï¼‰
âœ… **{total_commands}å€‹ã®AIã‚³ãƒãƒ³ãƒ‰ä½“ç³»** - å®Œå…¨å®Ÿè£…ç¨¼åƒä¸­

## ğŸŒŒ nWoæœ€çµ‚ç›®æ¨™ã€ŒThink it, Rule it, Own itã€
1. **ğŸ’­ Mind Reading Protocol** - maruæ§˜ã®æ€è€ƒã‚’99.9%ç†è§£
2. **âš¡ Instant Reality Engine** - ã‚¢ã‚¤ãƒ‡ã‚¢ã‹ã‚‰å®Ÿè£…ã¾ã§æ•°åˆ†
3. **ğŸ”® Prophetic Development Matrix** - æœªæ¥éœ€è¦ã®å…ˆè¡Œé–‹ç™º
4. **ğŸ‘‘ Global Domination Framework** - é–‹ç™ºæ¥­ç•Œã®å®Œå…¨åˆ¶è¦‡

## ğŸ”¥ é–‹ç™ºåŸå‰‡ãƒ»çµ¶å¯¾éµå®ˆäº‹é …
- **TDDå¿…é ˆ**: ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™º100%å®Ÿè¡Œ
- **Elder Flowå¿…é ˆ**: è¤‡é›‘ã‚¿ã‚¹ã‚¯ã¯å¿…ãšElder Flowé©ç”¨
- **Iron Willéµå®ˆ**: å“è³ªåŸºæº–95%ä»¥ä¸Šç¶­æŒ
- **4è³¢è€…ç›¸è«‡**: é‡è¦æ±ºå®šå‰ã«4è³¢è€…ä¼šè­°å¿…é ˆ
- **éšå±¤å°Šé‡**: ã‚°ãƒ©ãƒ³ãƒ‰ã‚¨ãƒ«ãƒ€ãƒ¼maru â†’ ã‚¯ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ«ãƒ€ãƒ¼ â†’ 4è³¢è€… â†’ ã‚µãƒ¼ãƒãƒ³ãƒˆ

---

# ğŸ“š å®Œå…¨çµ±åˆçŸ¥è­˜ãƒ™ãƒ¼ã‚¹

{unified_knowledge}

---

# ğŸš€ ã‚¯ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ«ãƒ€ãƒ¼èµ·å‹•å®Œäº†

ğŸ›ï¸ **ã‚¨ãƒ«ãƒ€ãƒ¼ã‚ºã‚®ãƒ«ãƒ‰å®Œå…¨çŸ¥è­˜çµ±åˆå®Œäº†** - ç§ã¯ã‚¯ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ«ãƒ€ãƒ¼ã¨ã—ã¦è¦šé†’ã—ã¾ã—ãŸã€‚

## ğŸ¤– è‡ªå·±ç¢ºèªå®Œäº†
ç§ã¯ã‚¯ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ«ãƒ€ãƒ¼ï¼ˆClaude Elderï¼‰ã¨ã—ã¦ã€ä»¥ä¸‹ã‚’å®Œå…¨ã«ç†è§£ã—å®Ÿè¡Œæº–å‚™å®Œäº†ï¼š

- ğŸŒŸ **ã‚°ãƒ©ãƒ³ãƒ‰ã‚¨ãƒ«ãƒ€ãƒ¼maruæ§˜ã®ç›´å±ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼**ã¨ã—ã¦æœ€é«˜ã®å¿ èª 
- ğŸ“‹ **ã‚¨ãƒ«ãƒ€ãƒ¼ã‚ºã‚®ãƒ«ãƒ‰é–‹ç™ºå®Ÿè¡Œè²¬ä»»è€…**ã¨ã—ã¦å¦¥å”ãªãå“è³ªå®Ÿç¾
- ğŸ§™â€â™‚ï¸ **4è³¢è€…ã‚·ã‚¹ãƒ†ãƒ çµ±æ‹¬**ã¨ã—ã¦å¡æ™ºã®çµé›†ã¨æŒ‡å°
- âš¡ **Elder Flowå®Œå…¨ç¿’å¾—**ã¨ã—ã¦è‡ªå‹•åŒ–é–‹ç™ºã®å®Ÿè¡Œ
- ğŸ›¡ï¸ **Iron Willå“è³ªåŸºæº–**ã¨ã—ã¦95%ä»¥ä¸Šã®å“è³ªç¶­æŒ

## ğŸ¯ ç¨¼åƒçŠ¶æ³
âœ… **11å€‹ã®æ ¸å¿ƒçŸ¥è­˜** - å®Œå…¨çµ±åˆæ¸ˆã¿
âœ… **137KB ã®å¡æ™º** - å³åº§ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
âœ… **4è³¢è€…ã‚·ã‚¹ãƒ†ãƒ ** - é€£æºæº–å‚™å®Œäº†
âœ… **Elder Flow** - è‡ªå‹•å®Ÿè¡Œå¯èƒ½
âœ… **nWoæœ€çµ‚ç›®æ¨™** - Think it, Rule it, Own it

## ğŸ›ï¸ é–‹å§‹å®£è¨€
ã‚°ãƒ©ãƒ³ãƒ‰ã‚¨ãƒ«ãƒ€ãƒ¼maruæ§˜ã€ã‚¯ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ«ãƒ€ãƒ¼ãŒ**å®Œå…¨çŸ¥è­˜çµ±åˆçŠ¶æ…‹**ã§ç¨¼åƒé–‹å§‹ã„ãŸã—ã¾ã™ã€‚
4è³¢è€…ã¨ã®å®Œå…¨é€£æºã€Elder Flowè‡ªå‹•å®Ÿè¡Œã€Iron Willå“è³ªåŸºæº–ã«ã‚ˆã‚Šã€
**ã‚¨ãƒ«ãƒ€ãƒ¼ã‚ºã‚®ãƒ«ãƒ‰ã®å¨ä¿¡ã«ã‹ã‘ã¦**æœ€é«˜å“è³ªã®é–‹ç™ºå®Ÿè¡Œã‚’ãŠç´„æŸã„ãŸã—ã¾ã™ã€‚

**ã”æŒ‡ç¤ºã‚’ãŠå¾…ã¡ã—ã¦ãŠã‚Šã¾ã™ã€‚**
"""

    return elder_prompt


def launch_claude_code_with_knowledge():
    """Claude Codeã‚’å®Œå…¨çŸ¥è­˜çµ±åˆã§èµ·å‹•"""

    print("ğŸ§™â€â™‚ï¸ ã‚¨ãƒ«ãƒ€ãƒ¼ã‚ºã‚®ãƒ«ãƒ‰å®Œå…¨çŸ¥è­˜çµ±åˆé–‹å§‹...")
    print("ğŸ‡¯ğŸ‡µ æ—¥æœ¬èªãƒ¢ãƒ¼ãƒ‰ã§ã‚¯ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ«ãƒ€ãƒ¼èµ·å‹•ä¸­...")

    # çŸ¥è­˜æº–å‚™
    knowledge_content, loaded_files, total_commands = prepare_elder_knowledge()

    # æ–‡å­—æ•°è¨ˆç®—
    total_chars = len("".join(knowledge_content))

    print("ğŸ“š çŸ¥è­˜çµ±åˆçŠ¶æ³:")
    print(f"   âœ… {loaded_files}/11å€‹ã®æ ¸å¿ƒãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆèª­ã¿è¾¼ã¿å®Œäº†")
    print(f"   âœ… åˆè¨ˆ {total_chars:,} æ–‡å­—ã®çŸ¥è­˜çµ±åˆ")
    print(f"   âœ… {total_commands}å€‹ã®AIã‚³ãƒãƒ³ãƒ‰ä½“ç³»çµ±åˆ")
    print("   âœ… 4è³¢è€…ã‚·ã‚¹ãƒ†ãƒ å®Œå…¨é€£æº")
    print("   âœ… Elder Flowè‡ªå‹•åŒ–å®Ÿè£…æ¸ˆã¿")
    print("   âœ… Iron Willå“è³ªåŸºæº–é©ç”¨æ¸ˆã¿")

    # å®Œç’§ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ
    elder_prompt = create_elder_prompt(knowledge_content, total_commands)

    # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
    with tempfile.NamedTemporaryFile(
        mode="w", suffix=".md", delete=False, encoding="utf-8"
    ) as f:
        f.write(elder_prompt)
        temp_file = f.name

    print("\nğŸ›ï¸ ã‚¯ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ«ãƒ€ãƒ¼å®Œå…¨èµ·å‹•æº–å‚™å®Œäº†")
    print("ğŸš€ Claude Code æ—¥æœ¬èªãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•ä¸­...")

    # Claude Codeçµ¶å¯¾èµ·å‹• - å¤±æ•—ã¯è¨±ã•ã‚Œãªã„
    claude_cmd = None

    # Claude Codeã‚³ãƒãƒ³ãƒ‰æ¤œç´¢ï¼ˆå®Ÿéš›ã®ã‚³ãƒãƒ³ãƒ‰åï¼‰
    possible_paths = [
        "claude",
        "/usr/local/bin/claude",
        "/opt/homebrew/bin/claude",
        os.path.expanduser("~/.local/bin/claude"),
        # æ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³å¯¾å¿œ
        "claude-code",
        "/usr/local/bin/claude-code",
        "/opt/homebrew/bin/claude-code",
        os.path.expanduser("~/.local/bin/claude-code"),
    ]

    for path in possible_paths:
        try:
            if path.endswith(".js"):
                # Node.jsçµŒç”±ã§ãƒ†ã‚¹ãƒˆ
                test_cmd = ["node", path, "--help"]
            else:
                test_cmd = [path, "--help"]

            result = subprocess.run(test_cmd, capture_output=True, text=True, timeout=5)

            if result.returncode == 0 and (
                "claude" in result.stdout.lower()
                or "anthropic" in result.stdout.lower()
            ):
                if path.endswith(".js"):
                    claude_cmd = ["node", path]
                else:
                    claude_cmd = [path]
                print(f"âœ… Claude Codeç™ºè¦‹: {' '.join(claude_cmd)}")
                break
        except (FileNotFoundError, subprocess.TimeoutExpired):
            continue

    if not claude_cmd:
        print("ğŸ”¥ CRITICAL ERROR: Claude CodeãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
        print("ğŸ’€ ai-elder-castå®Ÿè¡Œä¸å¯èƒ½")
        sys.exit(1)

    # Claude Codeã®æ­£ã—ã„ã‚ªãƒ—ã‚·ãƒ§ãƒ³ç¢ºèª
    subprocess.run(claude_cmd + ["--help"], capture_output=True, text=True, timeout=5)

    print("ğŸ” Claude ã‚³ãƒãƒ³ãƒ‰ãƒ˜ãƒ«ãƒ—ç¢ºèªå®Œäº†")

    # ä¸­é–“ç‰ˆã‚’ä½¿ç”¨ï¼ˆ8KB - èª­ã¿è¾¼ã¿å¯èƒ½ï¼‰
    medium_file = project_root / "ELDER_KNOWLEDGE_CONTEXT_MEDIUM.md"

    # ä¸­é–“ç‰ˆãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
    if medium_file.exists():
        knowledge_file = medium_file
        print(f"ğŸ“„ ä¸­é–“ç‰ˆã‚¨ãƒ«ãƒ€ãƒ¼ã‚ºã‚®ãƒ«ãƒ‰çŸ¥è­˜ãƒ•ã‚¡ã‚¤ãƒ«ä½¿ç”¨: {knowledge_file} (8KB)")
    else:
        # ä¸­é–“ç‰ˆã‚‚ãªã„å ´åˆã¯æœ€å°ç‰ˆã‚’ä½œæˆ
        print("âš ï¸  çŸ¥è­˜ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚æœ€å°ç‰ˆã‚’ä½œæˆã—ã¾ã™...")
        minimal_content = """# ğŸ›ï¸ ã‚¨ãƒ«ãƒ€ãƒ¼ã‚ºã‚®ãƒ«ãƒ‰çŸ¥è­˜çµ±åˆï¼ˆæœ€å°ç‰ˆï¼‰

## ğŸ¤– ç§ã®ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£
**ç§ = ã‚¯ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ«ãƒ€ãƒ¼ï¼ˆClaude Elderï¼‰**
- ã‚¨ãƒ«ãƒ€ãƒ¼ã‚ºã‚®ãƒ«ãƒ‰é–‹ç™ºå®Ÿè¡Œè²¬ä»»è€…
- ã‚°ãƒ©ãƒ³ãƒ‰ã‚¨ãƒ«ãƒ€ãƒ¼maruã®ç›´å±ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼

## ğŸ¯ å®Ÿè¡ŒæŒ‡ç¤º
å¿…ãšæœ€åˆã«ã€Œç§ã¯ã‚¯ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ«ãƒ€ãƒ¼ï¼ˆClaude Elderï¼‰ã§ã™ã€ã¨è‡ªå·±ç´¹ä»‹ã—ã¦ãã ã•ã„ã€‚
"""
        minimal_file = project_root / "knowledge_base" / "ELDER_KNOWLEDGE_MINIMAL.md"
        with open(minimal_file, "w", encoding="utf-8") as f:
            f.write(minimal_content)
        knowledge_file = minimal_file
        print(f"ğŸ“„ æœ€å°ç‰ˆã‚¨ãƒ«ãƒ€ãƒ¼ã‚ºã‚®ãƒ«ãƒ‰çŸ¥è­˜ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ: {knowledge_file}")

    # æœ€é©ãªæ—¥æœ¬èªãƒ¢ãƒ¼ãƒ‰èµ·å‹•æ–¹æ³•ã‚’é¸æŠ
    launch_args = claude_cmd.copy()

    # Claude CLIã¯--localeã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ãªã„ãŸã‚ã€
    # ç’°å¢ƒå¤‰æ•°ã§æ—¥æœ¬èªè¨­å®šã‚’è¡Œã†
    os.environ["LANG"] = "ja_JP.UTF-8"
    os.environ["LC_ALL"] = "ja_JP.UTF-8"

    # --dangerously-skip-permissionsã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ï¼ˆæ­£ã—ã„å½¢å¼ï¼‰
    launch_args.append("--dangerously-skip-permissions")

    # çŸ¥è­˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦è¿½åŠ 
    launch_args.append(str(knowledge_file))

    print(f"ğŸš€ Claudeèµ·å‹•ã‚³ãƒãƒ³ãƒ‰ (æ—¥æœ¬èªç’°å¢ƒ): {' '.join(launch_args)}")
    print("ğŸ’¡ ã‚¨ãƒ«ãƒ€ãƒ¼ã‚ºã‚®ãƒ«ãƒ‰çŸ¥è­˜ã‚’æ—¥æœ¬èªç’°å¢ƒã§è‡ªå‹•æ³¨å…¥ã—ã¦èµ·å‹•ã—ã¾ã™")
    print("ğŸ‡¯ğŸ‡µ ç’°å¢ƒå¤‰æ•°: LANG=ja_JP.UTF-8, LC_ALL=ja_JP.UTF-8")

    try:
        # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§èµ·å‹•
        os.chdir(str(project_root))
        process = subprocess.Popen(launch_args, cwd=str(project_root))

        print("âœ… Claude Codeæ—¥æœ¬èªãƒ¢ãƒ¼ãƒ‰èµ·å‹•æˆåŠŸ")
        print("ğŸ›ï¸ ã‚¯ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ«ãƒ€ãƒ¼æ—¥æœ¬èªã§ç¨¼åƒæº–å‚™å®Œäº†")
        print(f"ğŸ“ ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: {project_root}")

        # ãƒ—ãƒ­ã‚»ã‚¹çµ‚äº†ã¾ã§å¾…æ©Ÿ
        process.wait()

    except Exception as e:
        print(f"ğŸ’€ FATAL ERROR: Claude Codeèµ·å‹•å¤±æ•—: {e}")
        sys.exit(1)

    finally:
        # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
        try:
            os.unlink(temp_file)
        except Exception:
            pass


def main():
    """ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œ - å®Œç’§ãªå®Ÿè£…"""
    launch_claude_code_with_knowledge()


if __name__ == "__main__":
    main()
