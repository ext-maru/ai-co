#!/usr/bin/env python3
"""
AI Elder Cast Modular - ã‚»ã‚¯ã‚·ãƒ§ãƒ³åˆ¥èª­ã¿è¾¼ã¿ã‚·ã‚¹ãƒ†ãƒ 
å¿…è¦ãªçŸ¥è­˜ã®ã¿ã‚’å‹•çš„ã«èª­ã¿è¾¼ã‚€è»½é‡ç‰ˆ
"""

import argparse
import os
import subprocess
import sys
import tempfile
from pathlib import Path

project_root = Path(__file__).parent.parent

# çŸ¥è­˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³å®šç¾©
KNOWLEDGE_SECTIONS = {
    "core": {
        "name": "ã‚³ã‚¢ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£",
        "files": ["ELDER_KNOWLEDGE_CONTEXT_OPTIMIZED.md"],
        "description": "æœ€å°é™ã®å¿…é ˆçŸ¥è­˜ï¼ˆ4KBï¼‰",
    },
    "medium": {
        "name": "ä¸­é–“ç‰ˆ",
        "files": ["ELDER_KNOWLEDGE_CONTEXT_MEDIUM.md"],
        "description": "ãƒãƒ©ãƒ³ã‚¹ç‰ˆï¼ˆ8KBï¼‰",
    },
    "identity": {
        "name": "ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£è©³ç´°",
        "files": [
            "knowledge_base/elder_knowledge_sections/02_claude_elder_identity.md",
            "knowledge_base/elder_knowledge_sections/03_grand_elder_hierarchy.md",
        ],
        "description": "ã‚¯ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ«ãƒ€ãƒ¼ã®è©³ç´°å®šç¾©",
    },
    "flow": {
        "name": "Elder Flow",
        "files": ["knowledge_base/elder_knowledge_sections/05_elder_flow_design.md"],
        "description": "Elder Flowè¨­è¨ˆä»•æ§˜",
    },
    "sages": {
        "name": "4è³¢è€…ã‚·ã‚¹ãƒ†ãƒ ",
        "files": ["knowledge_base/elder_knowledge_sections/09_four_sages_wisdom.md"],
        "description": "4è³¢è€…çµ±åˆçŸ¥æµã‚·ã‚¹ãƒ†ãƒ ",
    },
    "tdd": {
        "name": "TDDã‚¬ã‚¤ãƒ‰",
        "files": ["knowledge_base/elder_knowledge_sections/11_claude_tdd_guide.md"],
        "description": "ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã‚¬ã‚¤ãƒ‰",
    },
    "dev": {
        "name": "é–‹ç™ºã‚¬ã‚¤ãƒ‰",
        "files": [
            "knowledge_base/elder_knowledge_sections/07_elders_guild_dev_guide.md"
        ],
        "description": "ã‚¨ãƒ«ãƒ€ãƒ¼ã‚ºã‚®ãƒ«ãƒ‰é–‹ç™ºã‚¬ã‚¤ãƒ‰ï¼ˆ26KBï¼‰",
    },
}


def print_colored(text, color="cyan"):
    """ã‚«ãƒ©ãƒ¼å‡ºåŠ›"""
    colors = {
        "cyan": "\033[0;36m",
        "green": "\033[0;32m",
        "yellow": "\033[1;33m",
        "purple": "\033[0;35m",
        "red": "\033[0;31m",
    }
    reset = "\033[0m"
    print(f"{colors.get(color, '')}{text}{reset}")


def list_sections():
    """åˆ©ç”¨å¯èƒ½ãªã‚»ã‚¯ã‚·ãƒ§ãƒ³ä¸€è¦§ã‚’è¡¨ç¤º"""
    print_colored("ğŸ“š åˆ©ç”¨å¯èƒ½ãªçŸ¥è­˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³:", "purple")
    print()
    for key, section in KNOWLEDGE_SECTIONS.items():
        print(f"  {key:<10} - {section['name']:<20} {section['description']}")
    print()


def load_sections(section_names):
    """æŒ‡å®šã•ã‚ŒãŸã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’èª­ã¿è¾¼ã¿"""
    content = []
    total_size = 0

    print_colored("ğŸ“– èª­ã¿è¾¼ã‚€ã‚»ã‚¯ã‚·ãƒ§ãƒ³:", "cyan")

    for section_name in section_names:
        if section_name not in KNOWLEDGE_SECTIONS:
            print_colored(f"âš ï¸  æœªçŸ¥ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³: {section_name}", "yellow")
            continue

        section = KNOWLEDGE_SECTIONS[section_name]
        print(f"  - {section['name']} ({section['description']})")

        for file_path in section["files"]:
            full_path = project_root / file_path
            if full_path.exists():
                with open(full_path, "r", encoding="utf-8") as f:
                    file_content = f.read()
                    content.append(f"\n\n# === {section['name']} ===\n")
                    content.append(file_content)
                    total_size += len(file_content)
            else:
                print_colored(f"    âš ï¸  ãƒ•ã‚¡ã‚¤ãƒ«æœªæ¤œå‡º: {file_path}", "yellow")

    print()
    print_colored(f"ğŸ“Š ç·ã‚µã‚¤ã‚º: {total_size / 1024:.1f}KB", "green")

    return "\n".join(content)


def main():
    parser = argparse.ArgumentParser(
        description="AI Elder Cast Modular - ã‚»ã‚¯ã‚·ãƒ§ãƒ³åˆ¥èª­ã¿è¾¼ã¿ã‚·ã‚¹ãƒ†ãƒ ",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
ä½¿ç”¨ä¾‹:
  ai-elder-cast-modular                    # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆcoreï¼‰
  ai-elder-cast-modular medium             # ä¸­é–“ç‰ˆ
  ai-elder-cast-modular core sages tdd     # è¤‡æ•°ã‚»ã‚¯ã‚·ãƒ§ãƒ³
  ai-elder-cast-modular --list             # ã‚»ã‚¯ã‚·ãƒ§ãƒ³ä¸€è¦§
        """,
    )

    parser.add_argument(
        "sections", nargs="*", default=["core"], help="èª­ã¿è¾¼ã‚€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: coreï¼‰"
    )

    parser.add_argument("--list", "-l", action="store_true", help="åˆ©ç”¨å¯èƒ½ãªã‚»ã‚¯ã‚·ãƒ§ãƒ³ä¸€è¦§ã‚’è¡¨ç¤º")

    args = parser.parse_args()

    # ã‚»ã‚¯ã‚·ãƒ§ãƒ³ä¸€è¦§è¡¨ç¤º
    if args.list:
        list_sections()
        return

    print_colored("ğŸ”® AI Elder Cast Modular èµ·å‹•", "purple")
    print()

    # ã‚»ã‚¯ã‚·ãƒ§ãƒ³èª­ã¿è¾¼ã¿
    knowledge_content = load_sections(args.sections)

    # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
    with tempfile.NamedTemporaryFile(
        mode="w", encoding="utf-8", suffix=".md", delete=False
    ) as tmp:
        tmp.write(knowledge_content)
        tmp_path = tmp.name

    # æ—¥æœ¬èªç’°å¢ƒè¨­å®š
    os.environ["LANG"] = "ja_JP.UTF-8"
    os.environ["LC_ALL"] = "ja_JP.UTF-8"

    # Claude Codeèµ·å‹•
    try:
        print_colored("ğŸ›ï¸ ã‚¯ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ«ãƒ€ãƒ¼å¬å–šä¸­...", "green")
        print()

        subprocess.run(["claude", "--dangerously-skip-permissions", tmp_path])

    finally:
        # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
        if os.path.exists(tmp_path):
            os.unlink(tmp_path)

    print()
    print_colored("ğŸ›ï¸ Elder Flow ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº†", "green")


if __name__ == "__main__":
    main()
