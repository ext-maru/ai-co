#!/usr/bin/env python3
"""
AI Elder Cast Simple - æœ€å°ç‰ˆçŸ¥è­˜æ³¨å…¥èµ·å‹•ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆã‚¿ã‚¹ã‚¯çµ±åˆç‰ˆï¼‰
ä¸­é–“ç‰ˆçŸ¥è­˜ï¼ˆ8KBï¼‰ã‚’ä½¿ç”¨ã—ã¦Claude Codeã‚’èµ·å‹•
"""

import asyncio
import os
import subprocess
import sys
from datetime import datetime
from pathlib import Path

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã‚’ãƒ‘ã‚¹ã«è¿½åŠ 
project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))

# è‰²ä»˜ãå‡ºåŠ›ç”¨ã®ANSIã‚³ãƒ¼ãƒ‰
COLORS = {
    "cyan": "\033[0;36m",
    "green": "\033[0;32m",
    "yellow": "\033[1;33m",
    "purple": "\033[0;35m",
    "reset": "\033[0m"
}


def print_colored(text, color="cyan"):
    """è‰²ä»˜ããƒ†ã‚­ã‚¹ãƒˆã‚’å‡ºåŠ›"""
    print(f"{COLORS.get(color, '')}{text}{COLORS['reset']}")


async def quick_task_sync():
    """ç°¡æ˜“ã‚¿ã‚¹ã‚¯åŒæœŸå‡¦ç†"""
    try:
        from libs.todo_tracker_integration import TodoTrackerIntegration
        
        # ã‚¿ã‚¹ã‚¯ãƒˆãƒ©ãƒƒã‚«ãƒ¼çµ±åˆã‚’åˆæœŸåŒ–
        user_id = os.environ.get("CLAUDE_ELDER_USER", "claude_elder")
        integration = TodoTrackerIntegration(auto_sync=False, user_id=user_id)
        await integration.initialize()
        
        # åŒæ–¹å‘åŒæœŸ
        await integration.sync_both_ways(personal_only=True)
        
        # çµ±è¨ˆæƒ…å ±ã‚’å–å¾—
        sync_status = await integration.get_sync_status()
        my_stats = sync_status.get("my_tasks_stats", {})
        
        active_count = my_stats.get("pending", 0) + my_stats.get("in_progress", 0)
        
        print_colored(f"âœ… ã‚¿ã‚¹ã‚¯åŒæœŸå®Œäº† (ã‚¢ã‚¯ãƒ†ã‚£ãƒ–: {active_count}ä»¶)", "green")
        
        # ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        if integration.tracker:
            await integration.tracker.close()
            
    except Exception as e:
        print_colored(f"âš ï¸ ã‚¿ã‚¹ã‚¯åŒæœŸã‚¹ã‚­ãƒƒãƒ—: {e}", "yellow")


def main():
    """ãƒ¡ã‚¤ãƒ³å‡¦ç†"""
    # ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°ã‚’ãƒã‚§ãƒƒã‚¯
    if len(sys.argv) > 1 and sys.argv[1] == "todo":
        # TodoåŒæœŸæ©Ÿèƒ½ä»˜ãã§èµ·å‹•
        print_colored("ğŸ”„ TodoåŒæœŸæ©Ÿèƒ½ä»˜ãã§èµ·å‹•ã—ã¾ã™...", "cyan")
        print()
        
        # ai-elder-cast-with-todo-syncã‚’å®Ÿè¡Œ
        todo_sync_script = project_root / "scripts" / "ai-elder-cast-with-todo-sync"
        if todo_sync_script.exists():
            try:
                subprocess.run([sys.executable, str(todo_sync_script)])
                return
            except KeyboardInterrupt:
                print()
                print_colored("âš¡ ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸­æ–­", "yellow")
                return
            except Exception as e:
                print_colored(f"âŒ ã‚¨ãƒ©ãƒ¼: {e}", "red")
                sys.exit(1)
        else:
            print_colored("âŒ TodoåŒæœŸã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“", "red")
            sys.exit(1)
    
    print_colored("ğŸ”® AI Elder Cast Simple (Task Integration) èµ·å‹•", "purple")
    print()
    
    # çŸ¥è­˜ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ï¼ˆä¸­é–“ç‰ˆï¼‰
    knowledge_file = project_root / "knowledge_base" / "ELDER_KNOWLEDGE_CONTEXT_MEDIUM.md"
    
    if not knowledge_file.exists():
        print_colored(f"âŒ çŸ¥è­˜ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: {knowledge_file}", "red")
        sys.exit(1)
    
    # æ—¥æœ¬èªç’°å¢ƒè¨­å®š
    os.environ["LANG"] = "ja_JP.UTF-8"
    os.environ["LC_ALL"] = "ja_JP.UTF-8"
    
    # ã‚¿ã‚¹ã‚¯åŒæœŸã‚’å®Ÿè¡Œï¼ˆã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ç¶™ç¶šï¼‰
    if os.environ.get("ELDER_CAST_SKIP_SYNC", "").lower() != "true":
        print_colored("ğŸ“‹ ã‚¿ã‚¹ã‚¯åŒæœŸä¸­...", "cyan")
        asyncio.run(quick_task_sync())
        print()
    
    # Claude Codeèµ·å‹•
    try:
        print_colored("ğŸ›ï¸ ã‚¯ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ«ãƒ€ãƒ¼å¬å–šä¸­...", "green")
        print()
        
        subprocess.run([
            "claude", 
            "--dangerously-skip-permissions", 
            str(knowledge_file)
        ])
        
    except KeyboardInterrupt:
        print()
        print_colored("âš¡ ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸­æ–­", "yellow")
    except Exception as e:
        print_colored(f"âŒ ã‚¨ãƒ©ãƒ¼: {e}", "red")
        sys.exit(1)
    
    print()
    print_colored("ğŸ›ï¸ Elder Cast ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº†", "green")


if __name__ == "__main__":
    main()