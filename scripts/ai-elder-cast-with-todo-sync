#!/usr/bin/env python3
"""
AI Elder Cast with Todo Synchronization
Claude Codeã®TodoRead/TodoWriteã¨PostgreSQLã‚¿ã‚¹ã‚¯ãƒˆãƒ©ãƒƒã‚«ãƒ¼ã‚’å®Œå…¨çµ±åˆ
"""

import asyncio
import json
import os
import subprocess
import sys
import tempfile
from datetime import datetime
from pathlib import Path
from typing import Dict, List, Optional, Tuple

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã‚’ãƒ‘ã‚¹ã«è¿½åŠ 
project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))

from libs.todo_tracker_integration import TodoTrackerIntegration
from libs.todo_hook_system import TodoHookSystem
from libs.postgres_claude_task_tracker import TaskStatus, TaskPriority

# ANSIã‚«ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰
COLORS = {
    "cyan": "\033[0;36m",
    "green": "\033[0;32m",
    "yellow": "\033[1;33m",
    "purple": "\033[0;35m",
    "red": "\033[0;31m",
    "blue": "\033[0;34m",
    "bold": "\033[1m",
    "reset": "\033[0m"
}


def print_colored(text, color="cyan"):
    """ã‚«ãƒ©ãƒ¼å‡ºåŠ›"""
    print(f"{COLORS.get(color, '')}{text}{COLORS['reset']}")


def print_task(task, indent="  "):
    """ã‚¿ã‚¹ã‚¯ã‚’æ•´å½¢ã—ã¦è¡¨ç¤º"""
    status_map = {
        TaskStatus.PENDING: "ğŸ“‹",
        TaskStatus.IN_PROGRESS: "ğŸ”„",
        TaskStatus.COMPLETED: "âœ…",
        TaskStatus.CANCELLED: "âŒ",
        TaskStatus.BLOCKED: "ğŸš«",
    }
    
    priority_map = {
        TaskPriority.CRITICAL: "ğŸ”´",
        TaskPriority.HIGH: "ğŸŸ ",
        TaskPriority.MEDIUM: "ğŸŸ¡",
        TaskPriority.LOW: "ğŸŸ¢",
    }
    
    status_emoji = status_map.get(task.status, "â“")
    priority_emoji = priority_map.get(task.priority, "âšª")
    
    print(f"{indent}{status_emoji} {priority_emoji} {task.title}")
    if task.description:
        desc = task.description[:60] + "..." if len(task.description) > 60 else task.description
        print(f"{indent}  â””â”€ {desc}")


async def check_and_inherit_tasks(integration: TodoTrackerIntegration) -> bool:
    """å‰å›ã®æœªå®Œäº†ã‚¿ã‚¹ã‚¯ã‚’ç¢ºèªã—ã¦å¼•ãç¶™ã"""
    try:
        # æœªå®Œäº†ã‚¿ã‚¹ã‚¯ã‚’å–å¾—
        pending_tasks = await integration.tracker.list_tasks(
            assigned_to=integration.user_id,
            status_filter=[TaskStatus.PENDING, TaskStatus.IN_PROGRESS],
            limit=20
        )
        
        if not pending_tasks:
            return False
        
        # ã‚¿ã‚¹ã‚¯ã‚’è¡¨ç¤º
        print_colored("\nğŸ“‹ å‰å›ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§æœªå®Œäº†ã®ã‚¿ã‚¹ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ:", "yellow")
        print_colored(f"   {len(pending_tasks)}ä»¶ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ã‚¹ã‚¯\n", "yellow")
        
        # é€²è¡Œä¸­ã®ã‚¿ã‚¹ã‚¯
        in_progress = [t for t in pending_tasks if t.status == TaskStatus.IN_PROGRESS]
        if in_progress:
            print_colored("ğŸ”„ é€²è¡Œä¸­ã®ã‚¿ã‚¹ã‚¯:", "cyan")
            for task in in_progress[:5]:
                print_task(task)
            if len(in_progress) > 5:
                print(f"  ... ä»– {len(in_progress) - 5}ä»¶")
            print()
        
        # æœªç€æ‰‹ã®ã‚¿ã‚¹ã‚¯
        pending = [t for t in pending_tasks if t.status == TaskStatus.PENDING]
        if pending:
            print_colored("ğŸ“‹ æœªç€æ‰‹ã®ã‚¿ã‚¹ã‚¯:", "cyan")
            for task in pending[:5]:
                print_task(task)
            if len(pending) > 5:
                print(f"  ... ä»– {len(pending) - 5}ä»¶")
            print()
        
        # å¼•ãç¶™ãç¢ºèª
        print_colored("ã“ã‚Œã‚‰ã®ã‚¿ã‚¹ã‚¯ã‚’å¼•ãç¶™ãã¾ã™ã‹ï¼Ÿ", "bold")
        print("  [Y] å¼•ãç¶™ã (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)")
        print("  [N] æ–°è¦ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§é–‹å§‹")
        print("  [S] é¸æŠã—ã¦å¼•ãç¶™ã")
        
        # ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›å¾…ã¡ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ10ç§’ï¼‰
        try:
            choice = await asyncio.wait_for(
                asyncio.get_event_loop().run_in_executor(None, input, "> "),
                timeout=10.0
            )
            choice = choice.strip().upper()
        except asyncio.TimeoutError:
            print_colored("\nâ±ï¸ ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ - è‡ªå‹•çš„ã«å¼•ãç¶™ãã¾ã™", "yellow")
            choice = "Y"
        
        if choice == "N":
            print_colored("\nâœ¨ æ–°è¦ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã—ã¾ã™", "green")
            return False
        
        elif choice == "S":
            # é¸æŠãƒ¢ãƒ¼ãƒ‰ï¼ˆæœªå®Ÿè£…ï¼‰
            print_colored("\nâš ï¸ é¸æŠãƒ¢ãƒ¼ãƒ‰ã¯æº–å‚™ä¸­ã§ã™ã€‚å…¨ã‚¿ã‚¹ã‚¯ã‚’å¼•ãç¶™ãã¾ã™", "yellow")
            choice = "Y"
        
        if choice != "N":
            # ã‚¿ã‚¹ã‚¯ã‚’å¼•ãç¶™ã
            print_colored("\nğŸ”„ ã‚¿ã‚¹ã‚¯ã‚’å¼•ãç¶™ã„ã§ã„ã¾ã™...", "cyan")
            
            # TodoListãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«å¤‰æ›
            todo_items = []
            for task in pending_tasks[:10]:  # æœ€å¤§10ä»¶
                todo_items.append({
                    "id": f"task-{task.id[:8]}",
                    "content": task.title,
                    "status": "in_progress" if task.status == TaskStatus.IN_PROGRESS else "pending",
                    "priority": task.priority.value.lower()
                })
            
            # åˆæœŸTodoListã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãè¾¼ã¿
            initial_todos_file = Path.home() / ".claude_initial_todos.json"
            with open(initial_todos_file, 'w', encoding='utf-8') as f:
                json.dump(todo_items, f, ensure_ascii=False, indent=2)
            
            print_colored(f"âœ… {len(todo_items)}ä»¶ã®ã‚¿ã‚¹ã‚¯ã‚’å¼•ãç¶™ãã¾ã—ãŸ", "green")
            return True
        
        return False
        
    except Exception as e:
        print_colored(f"âš ï¸ ã‚¿ã‚¹ã‚¯å¼•ãç¶™ãã‚¨ãƒ©ãƒ¼: {e}", "yellow")
        return False


async def start_todo_monitor(integration: TodoTrackerIntegration):
    """ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§Todoç›£è¦–ã‚’é–‹å§‹"""
    try:
        # TodoHookSystemã‚’åˆæœŸåŒ–
        hook_system = TodoHookSystem(integration_module=integration)
        
        # ç›£è¦–é–‹å§‹
        await hook_system.start_monitoring()
        
        print_colored("ğŸ” Todoç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ã‚’é–‹å§‹ã—ã¾ã—ãŸ", "green")
        print_colored("   TodoWrite/TodoReadã®å¤‰æ›´ã‚’è‡ªå‹•çš„ã«PostgreSQLã¨åŒæœŸã—ã¾ã™", "cyan")
        
        # ãƒ—ãƒ­ã‚»ã‚¹IDã‚’è¨˜éŒ²ï¼ˆå¾Œã§åœæ­¢ã™ã‚‹ãŸã‚ï¼‰
        pid_file = Path.home() / ".claude_todo_monitor.pid"
        with open(pid_file, 'w') as f:
            f.write(str(os.getpid()))
        
        return hook_system
        
    except Exception as e:
        print_colored(f"âš ï¸ Todoç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ã®èµ·å‹•ã«å¤±æ•—: {e}", "yellow")
        return None


def create_startup_knowledge(has_inherited_tasks: bool) -> str:
    """èµ·å‹•æ™‚ã®çŸ¥è­˜ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ä½œæˆ"""
    content = []
    
    # åŸºæœ¬çš„ãªçŸ¥è­˜ã‚’èª­ã¿è¾¼ã¿
    knowledge_file = project_root / "docs" / "technical" / "ELDER_KNOWLEDGE_CONTEXT_MEDIUM.md"
    if knowledge_file.exists():
        with open(knowledge_file, 'r', encoding='utf-8') as f:
            content.append(f.read())
    
    # TodoåŒæœŸã‚·ã‚¹ãƒ†ãƒ ã®èª¬æ˜ã‚’è¿½åŠ 
    content.append(f"""
# ğŸ“‹ TodoåŒæœŸã‚·ã‚¹ãƒ†ãƒ 

**ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹æ™‚åˆ»**: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
**TodoåŒæœŸ**: âœ… æœ‰åŠ¹ï¼ˆPostgreSQLã‚¿ã‚¹ã‚¯ãƒˆãƒ©ãƒƒã‚«ãƒ¼ã¨é€£æºï¼‰

## ğŸ”„ è‡ªå‹•åŒæœŸæ©Ÿèƒ½
- TodoWriteã§è¿½åŠ /æ›´æ–° â†’ è‡ªå‹•çš„ã«PostgreSQLã«ä¿å­˜
- ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†å¾Œã‚‚ã‚¿ã‚¹ã‚¯ã¯æ°¸ç¶šåŒ–
- æ¬¡å›èµ·å‹•æ™‚ã«å‰å›ã®ã‚¿ã‚¹ã‚¯ã‚’å¼•ãç¶™ãå¯èƒ½

## ğŸ“ ä½¿ç”¨æ–¹æ³•
é€šå¸¸é€šã‚ŠTodoRead/TodoWriteãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
ã™ã¹ã¦ã®å¤‰æ›´ã¯è‡ªå‹•çš„ã«ã‚¿ã‚¹ã‚¯ãƒˆãƒ©ãƒƒã‚«ãƒ¼ã¨åŒæœŸã•ã‚Œã¾ã™ã€‚

""")
    
    if has_inherited_tasks:
        content.append("""
## âœ… ã‚¿ã‚¹ã‚¯å¼•ãç¶™ãå®Œäº†
å‰å›ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰æœªå®Œäº†ã‚¿ã‚¹ã‚¯ã‚’å¼•ãç¶™ãã¾ã—ãŸã€‚
TodoReadãƒ„ãƒ¼ãƒ«ã§ç¢ºèªã§ãã¾ã™ã€‚
""")
    
    return "\n".join(content)


async def main():
    print_colored("ğŸ”® AI Elder Cast with Todo Sync èµ·å‹•", "purple")
    print_colored("ğŸ›ï¸ ã‚¨ãƒ«ãƒ€ãƒ¼ã‚ºã‚®ãƒ«ãƒ‰ Todoå®Œå…¨çµ±åˆã‚·ã‚¹ãƒ†ãƒ ", "bold")
    print()
    
    # ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—
    user_id = os.environ.get("CLAUDE_ELDER_USER", "claude_elder")
    
    # ã‚¿ã‚¹ã‚¯ãƒˆãƒ©ãƒƒã‚«ãƒ¼çµ±åˆã‚’åˆæœŸåŒ–
    print_colored("ğŸ“Š ã‚¿ã‚¹ã‚¯ãƒˆãƒ©ãƒƒã‚«ãƒ¼ã«æ¥ç¶šä¸­...", "cyan")
    
    try:
        integration = TodoTrackerIntegration(
            auto_sync=False,  # æ‰‹å‹•åˆ¶å¾¡
            user_id=user_id
        )
        await integration.initialize()
        print_colored("âœ… æ¥ç¶šæˆåŠŸ", "green")
        
        # å‰å›ã®æœªå®Œäº†ã‚¿ã‚¹ã‚¯ã‚’ç¢ºèª
        has_inherited = await check_and_inherit_tasks(integration)
        
        # Todoç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ã‚’èµ·å‹•
        print()
        hook_system = await start_todo_monitor(integration)
        
        # çŸ¥è­˜ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’æº–å‚™
        knowledge_content = create_startup_knowledge(has_inherited)
        
        # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
        with tempfile.NamedTemporaryFile(
            mode="w", encoding="utf-8", suffix=".md", delete=False
        ) as tmp:
            tmp.write(knowledge_content)
            tmp_path = tmp.name
        
        # æ—¥æœ¬èªç’°å¢ƒè¨­å®š
        os.environ["LANG"] = "ja_JP.UTF-8"
        os.environ["LC_ALL"] = "ja_JP.UTF-8"
        
        # åˆæœŸTodoãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Œã°ç’°å¢ƒå¤‰æ•°ã«è¨­å®š
        initial_todos_file = Path.home() / ".claude_initial_todos.json"
        if initial_todos_file.exists():
            os.environ["CLAUDE_INITIAL_TODOS"] = str(initial_todos_file)
        
        # Claude Codeèµ·å‹•
        try:
            print()
            print_colored("ğŸ›ï¸ ã‚¯ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ«ãƒ€ãƒ¼å¬å–šä¸­...", "green")
            print()
            
            subprocess.run(["claude", "--dangerously-skip-permissions", tmp_path])
            
        finally:
            # ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
            if os.path.exists(tmp_path):
                os.unlink(tmp_path)
            
            # åˆæœŸTodoãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
            if initial_todos_file.exists():
                initial_todos_file.unlink()
            
            # Todoç›£è¦–ã‚’åœæ­¢
            if hook_system:
                await hook_system.stop_monitoring()
            
            # çµ±åˆã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
            if integration.tracker:
                await integration.tracker.close()
        
    except Exception as e:
        print_colored(f"âŒ ã‚¨ãƒ©ãƒ¼: {e}", "red")
        sys.exit(1)
    
    print()
    print_colored("ğŸ›ï¸ Elder Cast ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº†", "green")
    
    # PIDãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
    pid_file = Path.home() / ".claude_todo_monitor.pid"
    if pid_file.exists():
        pid_file.unlink()


if __name__ == "__main__":
    asyncio.run(main())