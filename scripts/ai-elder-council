#!/usr/bin/env python3
"""
AI Company Elder Council System
ã‚¨ãƒ«ãƒ€ãƒ¼è©•è­°ä¼šçµ±åˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
"""

import sys
import os
import json
import argparse
from pathlib import Path
from datetime import datetime
import subprocess

# Add project root to path
PROJECT_ROOT = Path(__file__).resolve().parent.parent
sys.path.insert(0, str(PROJECT_ROOT))

try:
    from libs.elder_council_review_system import ElderCouncilReviewSystem, ReviewStatus
    from libs.sage_propagation_engine import SagePropagationEngine
    SYSTEM_AVAILABLE = True
except ImportError:
    SYSTEM_AVAILABLE = False

class ElderCouncilCommand:
    """ã‚¨ãƒ«ãƒ€ãƒ¼è©•è­°ä¼šã‚³ãƒãƒ³ãƒ‰ã‚·ã‚¹ãƒ†ãƒ """
    
    def __init__(self):
        self.project_root = PROJECT_ROOT
        self.council_dir = self.project_root / "council_sessions"
        self.council_dir.mkdir(exist_ok=True)
        
        if SYSTEM_AVAILABLE:
            self.review_system = ElderCouncilReviewSystem()
            self.propagation_engine = SagePropagationEngine()
    
    def show_status(self):
        """è©•è­°ä¼šã‚·ã‚¹ãƒ†ãƒ ã®çŠ¶æ…‹è¡¨ç¤º"""
        print("ğŸ›ï¸ AI Company Elder Council System")
        print("=" * 60)
        
        if not SYSTEM_AVAILABLE:
            print("âš ï¸ Elder Council review system is not available")
            print("ğŸ“‹ åŸºæœ¬æ©Ÿèƒ½ã®ã¿åˆ©ç”¨å¯èƒ½")
            return
        
        print(f"ğŸ“Š ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹: âœ… ç¨¼åƒä¸­")
        print(f"ğŸ“ è©•è­°ä¼šã‚»ãƒƒã‚·ãƒ§ãƒ³è¨˜éŒ²: {self.council_dir}")
        
        # æœ€è¿‘ã®è©•è­°ä¼šã‚»ãƒƒã‚·ãƒ§ãƒ³
        sessions = list(self.council_dir.glob("session_*.json"))
        if sessions:
            print(f"ğŸ“ æœ€è¿‘ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³: {len(sessions)}ä»¶")
            recent = sorted(sessions, key=lambda x: x.stat().st_mtime, reverse=True)[:3]
            for session in recent:
                with open(session, 'r', encoding='utf-8') as f:
                    data = json.load(f)
                    print(f"  â€¢ {data.get('title', 'Untitled')} ({session.name})")
        else:
            print("ğŸ“ è©•è­°ä¼šã‚»ãƒƒã‚·ãƒ§ãƒ³è¨˜éŒ²: ãªã—")
        
        print("\nğŸ§™â€â™‚ï¸ 4è³¢è€…ã‚·ã‚¹ãƒ†ãƒ :")
        sage_paths = {
            "ãƒŠãƒ¬ãƒƒã‚¸è³¢è€…": "/home/aicompany/ai_co/knowledge_base/council_reports",
            "ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆè³¢è€…": "/home/aicompany/ai_co/knowledge_base/incident_management",
            "ã‚¿ã‚¹ã‚¯è³¢è€…": "/home/aicompany/ai_co/task_council_integration.log",
            "RAGè³¢è€…": "/home/aicompany/ai_co/rag_index"
        }
        
        for sage_name, path in sage_paths.items():
            if os.path.exists(path):
                if os.path.isdir(path):
                    files = os.listdir(path)
                    print(f"  âœ… {sage_name}: {len(files)}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«")
                else:
                    print(f"  âœ… {sage_name}: ãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨")
            else:
                print(f"  âš ï¸ {sage_name}: ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æœªä½œæˆ")
    
    def submit_report(self, title, content, category="general", priority="medium"):
        """è©•è­°ä¼šã¸ã®å ±å‘Šæ›¸æå‡º"""
        if not SYSTEM_AVAILABLE:
            print("âš ï¸ Elder Council review system is not available")
            self.create_manual_session(title, content, category, priority)
            return
        
        print(f"ğŸ“‹ è©•è­°ä¼šã¸ã®å ±å‘Šæ›¸æå‡º")
        print(f"ã‚¿ã‚¤ãƒˆãƒ«: {title}")
        print(f"ã‚«ãƒ†ã‚´ãƒª: {category}")
        print(f"å„ªå…ˆåº¦: {priority}")
        print("-" * 50)
        
        report = {
            "title": title,
            "content": content,
            "category": category,
            "priority": priority
        }
        
        try:
            report_id, result = self.review_system.submit_report(report)
            
            print(f"âœ… å ±å‘Šæ›¸æå‡ºå®Œäº†")
            print(f"ğŸ“„ å ±å‘ŠID: {report_id}")
            print(f"ğŸ“Š ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: {result.status.value}")
            print(f"ğŸ¯ å“è³ªã‚¹ã‚³ã‚¢: {result.quality_score.overall:.2f}")
            
            if result.propagation_targets:
                print(f"ğŸ§™â€â™‚ï¸ åæ˜ å¯¾è±¡è³¢è€…: {[t.value for t in result.propagation_targets]}")
            
            if result.enhanced_report:
                print("âœ¨ è‡ªå‹•æ”¹å–„ãŒå®Ÿæ–½ã•ã‚Œã¾ã—ãŸ")
                
        except Exception as e:
            print(f"âŒ å ±å‘Šæ›¸æå‡ºã‚¨ãƒ©ãƒ¼: {e}")
            self.create_manual_session(title, content, category, priority)
    
    def create_manual_session(self, title, content, category, priority):
        """æ‰‹å‹•è©•è­°ä¼šã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ä½œæˆ"""
        session_id = f"session_{datetime.now().strftime('%Y%m%d_%H%M%S')}"
        session_file = self.council_dir / f"{session_id}.json"
        
        session_data = {
            "session_id": session_id,
            "title": title,
            "content": content,
            "category": category,
            "priority": priority,
            "created_at": datetime.now().isoformat(),
            "status": "manual_pending",
            "council_decision": "pending_review"
        }
        
        with open(session_file, 'w', encoding='utf-8') as f:
            json.dump(session_data, f, ensure_ascii=False, indent=2)
        
        print(f"ğŸ“ æ‰‹å‹•è©•è­°ä¼šã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ: {session_id}")
        print(f"ğŸ“ è¨˜éŒ²å ´æ‰€: {session_file}")
    
    def list_sessions(self):
        """è©•è­°ä¼šã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§è¡¨ç¤º"""
        print("ğŸ“‹ Elder Council Sessions")
        print("=" * 60)
        
        sessions = list(self.council_dir.glob("session_*.json"))
        if not sessions:
            print("ğŸ“ è©•è­°ä¼šã‚»ãƒƒã‚·ãƒ§ãƒ³è¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“")
            return
        
        sessions.sort(key=lambda x: x.stat().st_mtime, reverse=True)
        
        for session_file in sessions:
            try:
                with open(session_file, 'r', encoding='utf-8') as f:
                    data = json.load(f)
                
                print(f"\nğŸ“„ {data.get('session_id', 'Unknown')}")
                print(f"   ã‚¿ã‚¤ãƒˆãƒ«: {data.get('title', 'Untitled')}")
                print(f"   ã‚«ãƒ†ã‚´ãƒª: {data.get('category', 'general')}")
                print(f"   å„ªå…ˆåº¦: {data.get('priority', 'medium')}")
                print(f"   ä½œæˆæ—¥æ™‚: {data.get('created_at', 'Unknown')}")
                print(f"   ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: {data.get('status', 'unknown')}")
                
            except Exception as e:
                print(f"âŒ ã‚»ãƒƒã‚·ãƒ§ãƒ³èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: {session_file.name} - {e}")
    
    def emergency_session(self, title, description):
        """ç·Šæ€¥è©•è­°ä¼šã‚»ãƒƒã‚·ãƒ§ãƒ³"""
        print("ğŸš¨ ç·Šæ€¥è©•è­°ä¼šã‚»ãƒƒã‚·ãƒ§ãƒ³æ‹›é›†")
        print("=" * 60)
        
        emergency_content = f"""
# ç·Šæ€¥äº‹æ…‹ç™ºç”Ÿ

## æ¦‚è¦
{title}

## è©³ç´°
{description}

## ç·Šæ€¥å¯¾å¿œãŒå¿…è¦ãªç†ç”±
- å³åº§ã®å¯¾å¿œãŒå¿…è¦ãªçŠ¶æ³
- ã‚·ã‚¹ãƒ†ãƒ ã®å®‰å®šæ€§ã«å½±éŸ¿
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®å½±éŸ¿ã‚’æœ€å°åŒ–

## å¯¾å¿œæ–¹é‡
1. å³åº§ã®å•é¡ŒæŠŠæ¡
2. 4è³¢è€…ã«ã‚ˆã‚‹ç·Šæ€¥åˆ†æ
3. å¯¾å¿œç­–ã®ç­–å®šã¨å®Ÿè¡Œ
4. äº‹å¾Œæ¤œè¨¼ã¨æ”¹å–„

## ç·Šæ€¥è©•è­°ä¼šåˆ¤å®š
ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ç·Šæ€¥è©•è­°ä¼šã¨ã—ã¦æ‹›é›†ã•ã‚Œã¾ã—ãŸã€‚
"""
        
        self.submit_report(
            title=f"[ç·Šæ€¥] {title}",
            content=emergency_content,
            category="incident",
            priority="high"
        )
    
    def run_integration_test(self):
        """çµ±åˆãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ"""
        print("ğŸ§ª Elder Council Integration Test")
        print("=" * 60)
        
        test_script = self.project_root / "scripts" / "test_complete_elder_council_system.py"
        if test_script.exists():
            try:
                result = subprocess.run([sys.executable, str(test_script)], 
                                      capture_output=True, text=True, cwd=str(self.project_root))
                print(result.stdout)
                if result.stderr:
                    print("âš ï¸ Warnings/Errors:")
                    print(result.stderr)
            except Exception as e:
                print(f"âŒ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚¨ãƒ©ãƒ¼: {e}")
        else:
            print("âš ï¸ çµ±åˆãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
    
    def show_help(self):
        """ãƒ˜ãƒ«ãƒ—è¡¨ç¤º"""
        print("ğŸ›ï¸ AI Company Elder Council System")
        print("=" * 60)
        print("Usage: ai-elder-council [command] [options]")
        print()
        print("Commands:")
        print("  status                    è©•è­°ä¼šã‚·ã‚¹ãƒ†ãƒ ã®çŠ¶æ…‹è¡¨ç¤º")
        print("  submit <title> <content>  å ±å‘Šæ›¸ã‚’è©•è­°ä¼šã«æå‡º")
        print("  list                      è©•è­°ä¼šã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§")
        print("  emergency <title> <desc>  ç·Šæ€¥è©•è­°ä¼šã‚»ãƒƒã‚·ãƒ§ãƒ³æ‹›é›†")
        print("  test                      çµ±åˆãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ")
        print("  help                      ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º")
        print()
        print("Options:")
        print("  --category <category>     å ±å‘Šæ›¸ã®ã‚«ãƒ†ã‚´ãƒª (default: general)")
        print("  --priority <priority>     å„ªå…ˆåº¦ (low/medium/high, default: medium)")
        print()
        print("Examples:")
        print("  ai-elder-council status")
        print("  ai-elder-council submit \"æ–°æ©Ÿèƒ½å®Ÿè£…\" \"è©³ç´°èª¬æ˜...\"")
        print("  ai-elder-council emergency \"ã‚·ã‚¹ãƒ†ãƒ éšœå®³\" \"è©³ç´°...\"")
        print("  ai-elder-council test")

def main():
    """ãƒ¡ã‚¤ãƒ³é–¢æ•°"""
    parser = argparse.ArgumentParser(description='AI Company Elder Council System')
    parser.add_argument('command', nargs='?', default='help',
                       help='Command to execute')
    parser.add_argument('args', nargs='*', help='Command arguments')
    parser.add_argument('--category', default='general',
                       help='Report category (default: general)')
    parser.add_argument('--priority', default='medium',
                       choices=['low', 'medium', 'high'],
                       help='Priority level (default: medium)')
    
    args = parser.parse_args()
    
    council = ElderCouncilCommand()
    
    if args.command == 'status':
        council.show_status()
    elif args.command == 'submit':
        if len(args.args) >= 2:
            title = args.args[0]
            content = args.args[1]
            council.submit_report(title, content, args.category, args.priority)
        else:
            print("âŒ Usage: ai-elder-council submit <title> <content>")
    elif args.command == 'list':
        council.list_sessions()
    elif args.command == 'emergency':
        if len(args.args) >= 2:
            title = args.args[0]
            description = args.args[1]
            council.emergency_session(title, description)
        else:
            print("âŒ Usage: ai-elder-council emergency <title> <description>")
    elif args.command == 'test':
        council.run_integration_test()
    elif args.command == 'help' or args.command == '--help' or args.command == '-h':
        council.show_help()
    else:
        print(f"âŒ Unknown command: {args.command}")
        council.show_help()

if __name__ == "__main__":
    main()
