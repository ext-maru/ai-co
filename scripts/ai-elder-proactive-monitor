#!/bin/bash
#
# AI Elder Proactive Monitoring System
# ã‚¨ãƒ«ãƒ€ãƒ¼è©•è­°ä¼šå…ˆåˆ¶çš„ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ  - ç¶™ç¶šç›£è¦–ã‚µã‚¤ã‚¯ãƒ«
#
# Usage:
#   ./ai-elder-proactive-monitor        # 1å›å®Ÿè¡Œ
#   ./ai-elder-proactive-monitor daemon # ãƒ‡ãƒ¼ãƒ¢ãƒ³ãƒ¢ãƒ¼ãƒ‰
#

set -e

PROJECT_ROOT="/home/aicompany/ai_co"
COMMAND="$PROJECT_ROOT/commands/ai_elder_proactive.py"
LOG_FILE="$PROJECT_ROOT/logs/elder_proactive_monitor.log"

# Color codes
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info() {
    echo -e "${GREEN}[$(date -Iseconds)]${NC} $1" | tee -a "$LOG_FILE"
}

log_warning() {
    echo -e "${YELLOW}[$(date -Iseconds)]${NC} $1" | tee -a "$LOG_FILE"
}

log_error() {
    echo -e "${RED}[$(date -Iseconds)]${NC} $1" | tee -a "$LOG_FILE"
}

# Initialize monitoring
init_monitoring() {
    mkdir -p "$(dirname "$LOG_FILE")"
    log_info "ğŸ›ï¸ Elder Council Proactive Monitoring System - ç›£è¦–é–‹å§‹"
    log_info "ğŸ“Š Target: AI Company System Health & Performance"
}

# Execute monitoring cycle
execute_monitoring_cycle() {
    log_info "ğŸ”® å…ˆåˆ¶çš„ç›£è¦–ã‚µã‚¤ã‚¯ãƒ«å®Ÿè¡Œä¸­..."
    
    # Generate proactive insights
    log_info "ğŸ’¡ æ´å¯Ÿç”Ÿæˆé–‹å§‹"
    if python3 "$COMMAND" generate 2>&1 | tee -a "$LOG_FILE"; then
        log_info "âœ… æ´å¯Ÿç”Ÿæˆå®Œäº†"
    else
        log_error "âŒ æ´å¯Ÿç”Ÿæˆå¤±æ•—"
        return 1
    fi
    
    # Check system status
    log_info "ğŸ“Š ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³ç¢ºèª"
    if python3 "$COMMAND" status 2>&1 | tee -a "$LOG_FILE"; then
        log_info "âœ… çŠ¶æ³ç¢ºèªå®Œäº†"
    else
        log_warning "âš ï¸ çŠ¶æ³ç¢ºèªã§è­¦å‘Š"
    fi
    
    # Generate comprehensive report
    log_info "ğŸ“‹ åŒ…æ‹¬ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ"
    if python3 "$COMMAND" report --type comprehensive 2>&1 | tee -a "$LOG_FILE"; then
        log_info "âœ… ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº†"
    else
        log_warning "âš ï¸ ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã§è­¦å‘Š"
    fi
    
    log_info "ğŸŒŸ ç›£è¦–ã‚µã‚¤ã‚¯ãƒ«å®Œäº†"
}

# Daemon mode
run_daemon() {
    log_info "ğŸ¤– ãƒ‡ãƒ¼ãƒ¢ãƒ³ãƒ¢ãƒ¼ãƒ‰é–‹å§‹ - ç¶™ç¶šç›£è¦–"
    
    local cycle_count=0
    while true; do
        cycle_count=$((cycle_count + 1))
        log_info "ğŸ”„ ç›£è¦–ã‚µã‚¤ã‚¯ãƒ« #$cycle_count é–‹å§‹"
        
        if execute_monitoring_cycle; then
            log_info "âœ… ã‚µã‚¤ã‚¯ãƒ« #$cycle_count æˆåŠŸ"
        else
            log_error "âŒ ã‚µã‚¤ã‚¯ãƒ« #$cycle_count å¤±æ•—"
        fi
        
        # Wait 30 minutes between cycles
        log_info "â° æ¬¡ã®ç›£è¦–ã¾ã§30åˆ†å¾…æ©Ÿ..."
        sleep 1800
    done
}

# Single execution
run_single() {
    log_info "ğŸ¯ å˜ç™ºç›£è¦–å®Ÿè¡Œ"
    execute_monitoring_cycle
}

# Main execution
main() {
    init_monitoring
    
    case "${1:-single}" in
        "daemon")
            run_daemon
            ;;
        "single"|"")
            run_single
            ;;
        *)
            echo "Usage: $0 [daemon|single]"
            echo ""
            echo "Options:"
            echo "  daemon  - ç¶™ç¶šç›£è¦–ãƒ¢ãƒ¼ãƒ‰ï¼ˆ30åˆ†é–“éš”ï¼‰"
            echo "  single  - å˜ç™ºå®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰"
            exit 1
            ;;
    esac
}

# Handle interruption
trap 'log_info "ğŸ›‘ ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ åœæ­¢"; exit 0' INT TERM

# Execute main function
main "$@"