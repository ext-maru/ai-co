#!/bin/bash
# AI Elf Forest Command
# ã‚¨ãƒ«ãƒ•ã®æ£®ç®¡ç†ã‚³ãƒãƒ³ãƒ‰

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

cd "$PROJECT_ROOT"

show_help() {
    echo "Usage: ai-elf-forest [command]"
    echo ""
    echo "Commands:"
    echo "  start         ã‚¨ãƒ«ãƒ•ã®æ£®ã‚’èµ·å‹•"
    echo "  stop          ã‚¨ãƒ«ãƒ•ã®æ£®ã‚’åœæ­¢"
    echo "  status        ãƒ¯ãƒ¼ã‚«ãƒ¼çŠ¶æ…‹è¡¨ç¤º"
    echo "  dashboard     ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰è¡¨ç¤º"
    echo "  remind        ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼è¨­å®š"
    echo "  --help, -h    ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º"
    echo ""
    echo "Examples:"
    echo "  ai-elf-forest start"
    echo "  ai-elf-forest status"
    echo "  ai-elf-forest remind enhanced_task_worker \"ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚é–“ã§ã™\""
}

start_forest() {
    echo "ğŸŒ² ã‚¨ãƒ«ãƒ•ã®æ£®ã‚’èµ·å‹•ã—ã¦ã„ã¾ã™..."
    nohup python3 "$PROJECT_ROOT/start_elf_forest.py" > "$PROJECT_ROOT/logs/elf_forest.log" 2>&1 &
    ELF_PID=$!
    echo $ELF_PID > "$PROJECT_ROOT/logs/elf_forest.pid"
    echo "âœ… ã‚¨ãƒ«ãƒ•ã®æ£®ãŒèµ·å‹•ã—ã¾ã—ãŸ (PID: $ELF_PID)"
    echo "ğŸ“‹ ãƒ­ã‚°: $PROJECT_ROOT/logs/elf_forest.log"
}

stop_forest() {
    if [ -f "$PROJECT_ROOT/logs/elf_forest.pid" ]; then
        ELF_PID=$(cat "$PROJECT_ROOT/logs/elf_forest.pid")
        if kill -0 "$ELF_PID" 2>/dev/null; then
            echo "ğŸ›‘ ã‚¨ãƒ«ãƒ•ã®æ£®ã‚’åœæ­¢ã—ã¦ã„ã¾ã™ (PID: $ELF_PID)..."
            kill "$ELF_PID"
            rm -f "$PROJECT_ROOT/logs/elf_forest.pid"
            echo "âœ… ã‚¨ãƒ«ãƒ•ã®æ£®ãŒåœæ­¢ã—ã¾ã—ãŸ"
        else
            echo "âš ï¸ ã‚¨ãƒ«ãƒ•ã®æ£®ã¯æ—¢ã«åœæ­¢ã—ã¦ã„ã¾ã™"
            rm -f "$PROJECT_ROOT/logs/elf_forest.pid"
        fi
    else
        echo "âš ï¸ ã‚¨ãƒ«ãƒ•ã®æ£®ã®PIDãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
    fi
}

show_status() {
    echo "ğŸ“Š AI Company ãƒ¯ãƒ¼ã‚«ãƒ¼çŠ¶æ…‹:"
    echo "=============================="
    
    # ãƒ¯ãƒ¼ã‚«ãƒ¼ãƒ—ãƒ­ã‚»ã‚¹ã®ç¢ºèª
    WORKERS=("enhanced_task_worker" "intelligent_pm_worker" "async_result_worker" "simple_task_worker")
    
    for worker in "${WORKERS[@]}"; do
        PID=$(ps aux | grep "$worker" | grep -v grep | awk '{print $2}' | head -1)
        if [ -n "$PID" ]; then
            CPU=$(ps -p "$PID" -o %cpu= | tr -d ' ')
            MEM=$(ps -p "$PID" -o %mem= | tr -d ' ')
            echo "âœ… $worker (PID: $PID, CPU: ${CPU}%, MEM: ${MEM}%)"
        else
            echo "âŒ $worker (åœæ­¢ä¸­)"
        fi
    done
    
    # ã‚¨ãƒ«ãƒ•ã®æ£®ã®çŠ¶æ…‹
    if [ -f "$PROJECT_ROOT/logs/elf_forest.pid" ]; then
        ELF_PID=$(cat "$PROJECT_ROOT/logs/elf_forest.pid")
        if kill -0 "$ELF_PID" 2>/dev/null; then
            echo ""
            echo "ğŸŒ² ã‚¨ãƒ«ãƒ•ã®æ£®: ç¨¼åƒä¸­ (PID: $ELF_PID)"
        else
            echo ""
            echo "ğŸŒ² ã‚¨ãƒ«ãƒ•ã®æ£®: åœæ­¢ä¸­"
        fi
    else
        echo ""
        echo "ğŸŒ² ã‚¨ãƒ«ãƒ•ã®æ£®: åœæ­¢ä¸­"
    fi
}

show_dashboard() {
    echo "ğŸŒ² ã‚¨ãƒ«ãƒ•ã®æ£® - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰"
    echo "============================================="
    
    python3 -c "
import sys
sys.path.insert(0, '$PROJECT_ROOT')
from libs.elf_forest_worker_manager import ElfForestWorkerManager
import asyncio

async def show_status():
    manager = ElfForestWorkerManager()
    await manager.update_worker_statuses()
    manager.display_dashboard()

if hasattr(asyncio, 'run'):
    asyncio.run(show_status())
else:
    loop = asyncio.get_event_loop()
    loop.run_until_complete(show_status())
"
}

set_reminder() {
    if [ $# -lt 2 ]; then
        echo "Usage: ai-elf-forest remind <worker_name> <message>"
        echo "Example: ai-elf-forest remind enhanced_task_worker \"ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚é–“ã§ã™\""
        return 1
    fi
    
    WORKER_NAME="$1"
    MESSAGE="$2"
    TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
    
    # ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ãƒ­ã‚°ã«è¨˜éŒ²
    REMINDER_LOG="$PROJECT_ROOT/logs/${WORKER_NAME}_reminders.log"
    echo "[$TIMESTAMP] $MESSAGE" >> "$REMINDER_LOG"
    echo "ğŸ“ ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚’è¨­å®šã—ã¾ã—ãŸ:"
    echo "   ãƒ¯ãƒ¼ã‚«ãƒ¼: $WORKER_NAME"
    echo "   ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: $MESSAGE"
    echo "   è¨˜éŒ²å…ˆ: $REMINDER_LOG"
}

# ãƒ¡ã‚¤ãƒ³å‡¦ç†
case "$1" in
    start)
        start_forest
        ;;
    stop)
        stop_forest
        ;;
    status)
        show_status
        ;;
    dashboard)
        show_dashboard
        ;;
    remind)
        shift
        set_reminder "$@"
        ;;
    --help|-h|help)
        show_help
        ;;
    "")
        echo "ã‚¨ãƒ«ãƒ•ã®æ£®ç®¡ç†ã‚³ãƒãƒ³ãƒ‰"
        echo "ä½¿ç”¨æ–¹æ³•ã«ã¤ã„ã¦ã¯ 'ai-elf-forest --help' ã‚’å‚ç…§ã—ã¦ãã ã•ã„"
        ;;
    *)
        echo "ä¸æ˜ãªã‚³ãƒãƒ³ãƒ‰: $1"
        echo "ä½¿ç”¨æ–¹æ³•ã«ã¤ã„ã¦ã¯ 'ai-elf-forest --help' ã‚’å‚ç…§ã—ã¦ãã ã•ã„"
        exit 1
        ;;
esac