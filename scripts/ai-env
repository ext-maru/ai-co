#!/bin/bash
#
# AI Env - „Ç∑„É≥„Éó„É´Áí∞Â¢ÉÂ§âÊï∞ÁÆ°ÁêÜ
#

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"

COMMAND="$1"

if [[ -z "$COMMAND" ]]; then
    echo "Usage: ai-env <command>"
    echo ""
    echo "Commands:"
    echo "  check       Check environment configuration"
    echo "  setup       Setup .env file from template"
    echo "  verify      Verify required variables are set"
    echo "  show        Show current environment (masked)"
    echo ""
    exit 1
fi

cd "$PROJECT_DIR"

case "$COMMAND" in
    check)
        echo "üîç Environment Configuration Check"
        echo "=================================="
        
        # ‰ªÆÊÉ≥Áí∞Â¢É„ÉÅ„Çß„ÉÉ„ÇØ
        if [[ ! "$AI_VENV_ACTIVE" == "1" ]]; then
            if [[ -f "venv/bin/activate" ]]; then
                source venv/bin/activate
                export AI_VENV_ACTIVE=1
            fi
        fi
        
        python3 -c "
import sys
sys.path.append('$PROJECT_DIR')

try:
    from libs.env_config import verify_setup
    verify_setup()
except Exception as e:
    print(f'‚ùå Check failed: {e}')
    print('üí° Try: ai-setup')
"
        ;;
        
    setup)
        echo "üìã Setting up .env file"
        echo "======================="
        
        if [[ -f ".env" ]]; then
            echo "‚ö†Ô∏è  .env file already exists"
            echo "Do you want to overwrite it? (y/N)"
            read -r response
            if [[ ! "$response" =~ ^[Yy]$ ]]; then
                echo "Setup cancelled"
                exit 0
            fi
        fi
        
        if [[ -f ".env.template" ]]; then
            cp .env.template .env
            echo "‚úÖ .env file created from template"
            echo ""
            echo "üìù Please edit .env file and fill in your values:"
            echo "   - ANTHROPIC_API_KEY"
            echo "   - SLACK_BOT_TOKEN"
            echo "   - SLACK_APP_TOKEN"
            echo "   - SLACK_CHANNEL"
        else
            echo "‚ùå .env.template not found"
            exit 1
        fi
        ;;
        
    verify)
        echo "‚úÖ Verifying Required Environment Variables"
        echo "=========================================="
        
        # ÂøÖÈ†àÂ§âÊï∞„É™„Çπ„Éà
        REQUIRED_VARS=(
            "ANTHROPIC_API_KEY"
            "SLACK_BOT_TOKEN"
            "SLACK_CHANNEL"
            "PYTHONPATH"
        )
        
        # .env„Éï„Ç°„Ç§„É´Ë™≠„ÅøËæº„Åø
        if [[ -f ".env" ]]; then
            set -a
            source .env
            set +a
        fi
        
        all_good=true
        
        for var in "${REQUIRED_VARS[@]}"; do
            if [[ -n "${!var}" && "${!var}" != "your_"*"_here" ]]; then
                echo "‚úÖ $var: Set"
            else
                echo "‚ùå $var: Missing or placeholder"
                all_good=false
            fi
        done
        
        echo ""
        if [[ "$all_good" == "true" ]]; then
            echo "üéâ All required variables are set!"
        else
            echo "‚ö†Ô∏è  Some required variables are missing"
            echo "üí° Edit .env file to set missing values"
        fi
        ;;
        
    show)
        echo "üîê Current Environment Configuration"
        echo "==================================="
        
        # .env„Éï„Ç°„Ç§„É´Ë™≠„ÅøËæº„Åø
        if [[ -f ".env" ]]; then
            set -a
            source .env
            set +a
        fi
        
        # ÈáçË¶Å„Å™Â§âÊï∞„ÇíË°®Á§∫Ôºà„Éû„Çπ„ÇØ‰ªò„ÅçÔºâ
        SHOW_VARS=(
            "ANTHROPIC_API_KEY"
            "SLACK_BOT_TOKEN"
            "SLACK_APP_TOKEN"
            "SLACK_CHANNEL"
            "RABBITMQ_HOST"
            "PYTHONPATH"
            "AI_VENV_ACTIVE"
        )
        
        for var in "${SHOW_VARS[@]}"; do
            value="${!var}"
            if [[ -n "$value" ]]; then
                # „Çª„É≥„Ç∑„ÉÜ„Ç£„ÉñÊÉÖÂ†±„Çí„Éû„Çπ„ÇØ
                if [[ "$var" == *"TOKEN"* || "$var" == *"KEY"* ]]; then
                    if [[ ${#value} -gt 8 ]]; then
                        masked="${value:0:4}****${value: -4}"
                    else
                        masked="****"
                    fi
                    echo "üîë $var: $masked"
                else
                    echo "üìù $var: $value"
                fi
            else
                echo "‚ùå $var: Not set"
            fi
        done
        ;;
        
    *)
        echo "‚ùå Unknown command: $COMMAND"
        exit 1
        ;;
esac