#!/bin/bash
#
# AI Evolution Cron Manager - AIé€²åŒ–ã‚·ã‚¹ãƒ†ãƒ Cronç®¡ç†ãƒ„ãƒ¼ãƒ«
# Cronè¨­å®šã®ç®¡ç†ã€ç›£è¦–ã€ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç”¨ã®ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ãƒ„ãƒ¼ãƒ«
#
# ä½¿ç”¨æ–¹æ³•:
#   ai-evolution-cron setup     # Cronè¨­å®šã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
#   ai-evolution-cron status    # CronçŠ¶æ³ç¢ºèª
#   ai-evolution-cron logs      # ãƒ­ã‚°ç¢ºèª
#   ai-evolution-cron test      # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
#   ai-evolution-cron remove    # Cronè¨­å®šå‰Šé™¤
#

set -e

PROJECT_ROOT="/home/aicompany/ai_co"
LOG_DIR="$PROJECT_ROOT/logs/cron"
SCRIPT_NAME="ai-evolution-cron"

# è‰²ä»˜ããƒ­ã‚°å‡ºåŠ›
red='\033[0;31m'
green='\033[0;32m'
yellow='\033[1;33m'
blue='\033[0;34m'
purple='\033[0;35m'
cyan='\033[0;36m'
nc='\033[0m' # No Color

log_info() {
    echo -e "${green}[INFO]${nc} $1"
}

log_warning() {
    echo -e "${yellow}[WARNING]${nc} $1"
}

log_error() {
    echo -e "${red}[ERROR]${nc} $1"
}

log_debug() {
    echo -e "${blue}[DEBUG]${nc} $1"
}

show_help() {
    echo -e "${cyan}AI Evolution Cron Manager${nc}"
    echo ""
    echo "ä½¿ç”¨æ–¹æ³•:"
    echo "  $SCRIPT_NAME setup     # Cronè¨­å®šã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—"
    echo "  $SCRIPT_NAME status    # CronçŠ¶æ³ç¢ºèª"
    echo "  $SCRIPT_NAME logs      # ãƒ­ã‚°ç¢ºèª"
    echo "  $SCRIPT_NAME test      # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"
    echo "  $SCRIPT_NAME remove    # Cronè¨­å®šå‰Šé™¤"
    echo "  $SCRIPT_NAME monitor   # ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–"
    echo ""
    echo "ã‚ªãƒ—ã‚·ãƒ§ãƒ³:"
    echo "  --help, -h    ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º"
    echo "  --verbose     è©³ç´°å‡ºåŠ›"
}

setup_cron() {
    log_info "ğŸ”§ AIé€²åŒ–ã‚·ã‚¹ãƒ†ãƒ Cronè¨­å®šé–‹å§‹"
    
    if [ -f "$PROJECT_ROOT/scripts/setup_evolution_cron.sh" ]; then
        cd "$PROJECT_ROOT"
        bash scripts/setup_evolution_cron.sh
        log_info "âœ… Cronè¨­å®šå®Œäº†"
    else
        log_error "âŒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: scripts/setup_evolution_cron.sh"
        exit 1
    fi
}

show_status() {
    log_info "ğŸ“Š AIé€²åŒ–ã‚·ã‚¹ãƒ†ãƒ CronçŠ¶æ³ç¢ºèª"
    echo ""
    
    # Cronè¨­å®šç¢ºèª
    echo -e "${cyan}ğŸ”§ ç¾åœ¨ã®Cronè¨­å®š:${nc}"
    if crontab -l 2>/dev/null | grep -q "AI Company"; then
        crontab -l | grep -A 20 "AI Company" | head -25
        echo ""
        log_info "âœ… AIé€²åŒ–ã‚·ã‚¹ãƒ†ãƒ ã®Cronè¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"
    else
        log_warning "âš ï¸ AIé€²åŒ–ã‚·ã‚¹ãƒ†ãƒ ã®Cronè¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        echo "ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚³ãƒãƒ³ãƒ‰: $SCRIPT_NAME setup"
        echo ""
    fi
    
    # ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª
    echo -e "${cyan}ğŸ“ ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«çŠ¶æ³:${nc}"
    if [ -d "$LOG_DIR" ]; then
        ls -la "$LOG_DIR" | while read line; do
            echo "  $line"
        done
        echo ""
        
        # æœ€æ–°ãƒ­ã‚°ã‚¨ãƒ³ãƒˆãƒªç¢ºèª
        echo -e "${cyan}ğŸ“ˆ æœ€æ–°ã®å®Ÿè¡ŒçŠ¶æ³:${nc}"
        for log_file in daily_evolution weekly_strategy hourly_status; do
            if [ -f "$LOG_DIR/${log_file}.log" ]; then
                last_entry=$(tail -1 "$LOG_DIR/${log_file}.log" 2>/dev/null || echo "No entries")
                echo -e "  ${green}${log_file}:${nc} $last_entry"
            fi
        done
    else
        log_warning "âš ï¸ ãƒ­ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $LOG_DIR"
    fi
    
    # ã‚·ã‚¹ãƒ†ãƒ ãƒªã‚½ãƒ¼ã‚¹ç¢ºèª
    echo ""
    echo -e "${cyan}ğŸ’» ã‚·ã‚¹ãƒ†ãƒ ãƒªã‚½ãƒ¼ã‚¹:${nc}"
    echo "  ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨é‡: $(df -h "$PROJECT_ROOT" | tail -1 | awk '{print $5 " (" $4 " available)"}')"
    echo "  ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡: $(free -h | grep Mem | awk '{print $3 "/" $2}')"
    echo "  ç¾åœ¨æ™‚åˆ»: $(date)"
}

show_logs() {
    log_info "ğŸ“‹ AIé€²åŒ–ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°ç¢ºèª"
    
    if [ ! -d "$LOG_DIR" ]; then
        log_error "âŒ ãƒ­ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $LOG_DIR"
        return 1
    fi
    
    echo ""
    echo -e "${cyan}ğŸ“ åˆ©ç”¨å¯èƒ½ãªãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«:${nc}"
    ls -la "$LOG_DIR"/*.log 2>/dev/null | nl
    
    echo ""
    echo "ç¢ºèªã—ãŸã„ãƒ­ã‚°ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (Enter=å…¨ã¦):"
    read -r log_choice
    
    if [ -z "$log_choice" ]; then
        # å…¨ãƒ­ã‚°ã®æœ€æ–°ã‚¨ãƒ³ãƒˆãƒªã‚’è¡¨ç¤º
        for log_file in "$LOG_DIR"/*.log; do
            if [ -f "$log_file" ]; then
                filename=$(basename "$log_file")
                echo ""
                echo -e "${cyan}=== $filename (æœ€æ–°10è¡Œ) ===${nc}"
                tail -10 "$log_file"
            fi
        done
    else
        # æŒ‡å®šã•ã‚ŒãŸãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¡¨ç¤º
        log_files=("$LOG_DIR"/*.log)
        if [ "$log_choice" -gt 0 ] && [ "$log_choice" -le "${#log_files[@]}" ]; then
            selected_log="${log_files[$((log_choice-1))]}"
            echo ""
            echo -e "${cyan}=== $(basename "$selected_log") ===${nc}"
            echo "ãƒ•ã‚¡ã‚¤ãƒ«å…¨ä½“ã‚’è¦‹ã‚‹å ´åˆã¯ 'less'ã€æœ€æ–°100è¡Œã¯ 'tail'ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã¯ 'follow' ã‚’å…¥åŠ›:"
            read -r view_mode
            
            case "$view_mode" in
                "less")
                    less "$selected_log"
                    ;;
                "tail")
                    tail -100 "$selected_log"
                    ;;
                "follow")
                    tail -f "$selected_log"
                    ;;
                *)
                    tail -20 "$selected_log"
                    ;;
            esac
        else
            log_error "âŒ ç„¡åŠ¹ãªé¸æŠã§ã™"
        fi
    fi
}

test_evolution_system() {
    log_info "ğŸ§ª AIé€²åŒ–ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"
    
    cd "$PROJECT_ROOT"
    
    echo ""
    echo -e "${cyan}1. ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³ç¢ºèªãƒ†ã‚¹ãƒˆ${nc}"
    if python3 commands/ai_evolve_daily.py --status; then
        log_info "âœ… ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³ç¢ºèª: OK"
    else
        log_error "âŒ ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³ç¢ºèª: Failed"
    fi
    
    echo ""
    echo -e "${cyan}2. ä¿ç•™ç›¸è«‡ç¢ºèªãƒ†ã‚¹ãƒˆ${nc}"
    if python3 commands/ai_evolve_daily.py --pending; then
        log_info "âœ… ä¿ç•™ç›¸è«‡ç¢ºèª: OK"
    else
        log_error "âŒ ä¿ç•™ç›¸è«‡ç¢ºèª: Failed"
    fi
    
    echo ""
    echo -e "${cyan}3. é€²åŒ–å±¥æ­´ç¢ºèªãƒ†ã‚¹ãƒˆ${nc}"
    if python3 commands/ai_evolve_daily.py --history --limit 3; then
        log_info "âœ… é€²åŒ–å±¥æ­´ç¢ºèª: OK"
    else
        log_error "âŒ é€²åŒ–å±¥æ­´ç¢ºèª: Failed"
    fi
    
    echo ""
    echo -e "${cyan}4. ã‚°ãƒ©ãƒ³ãƒ‰ã‚¨ãƒ«ãƒ€ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆ${nc}"
    if python3 commands/ai_grand_elder.py --consultation-log --limit 3; then
        log_info "âœ… ã‚°ãƒ©ãƒ³ãƒ‰ã‚¨ãƒ«ãƒ€ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹: OK"
    else
        log_error "âŒ ã‚°ãƒ©ãƒ³ãƒ‰ã‚¨ãƒ«ãƒ€ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹: Failed"
    fi
    
    echo ""
    echo -e "${cyan}5. Cronè¨­å®šæ§‹æ–‡ãƒã‚§ãƒƒã‚¯${nc}"
    if crontab -l | grep "ai_evolve_daily" >/dev/null 2>&1; then
        log_info "âœ… Cronè¨­å®š: æ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
        echo "æ¬¡å›å®Ÿè¡Œäºˆå®šæ™‚åˆ»ã®è¨ˆç®—..."
        
        # æ¬¡ã®å®Ÿè¡Œæ™‚åˆ»ã‚’è¨ˆç®—ï¼ˆç°¡æ˜“ç‰ˆï¼‰
        current_hour=$(date +%H)
        if [ "$current_hour" -lt 2 ]; then
            echo "  æ—¥æ¬¡é€²åŒ–ã‚µã‚¤ã‚¯ãƒ«: ä»Šæ—¥ 2:00 AM"
        else
            echo "  æ—¥æ¬¡é€²åŒ–ã‚µã‚¤ã‚¯ãƒ«: æ˜æ—¥ 2:00 AM"
        fi
    else
        log_warning "âš ï¸ Cronè¨­å®š: AIé€²åŒ–ã‚·ã‚¹ãƒ†ãƒ ã®è¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
    fi
    
    log_info "ğŸ‰ ãƒ†ã‚¹ãƒˆå®Œäº†"
}

remove_cron() {
    log_warning "âš ï¸ AIé€²åŒ–ã‚·ã‚¹ãƒ†ãƒ Cronè¨­å®šå‰Šé™¤"
    echo ""
    echo "ã“ã®æ“ä½œã«ã‚ˆã‚Šã€ä»¥ä¸‹ã®è‡ªå‹•åŒ–ãŒåœæ­¢ã•ã‚Œã¾ã™:"
    echo "  - æ—¥æ¬¡è‡ªå·±é€²åŒ–ã‚µã‚¤ã‚¯ãƒ«"
    echo "  - é€±æ¬¡æˆ¦ç•¥ãƒ¬ãƒ“ãƒ¥ãƒ¼"
    echo "  - ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–ãƒ»ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯"
    echo "  - ãƒ­ã‚°ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³"
    echo ""
    echo -e "${red}æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ (yes/no):${nc}"
    read -r confirmation
    
    if [ "$confirmation" = "yes" ]; then
        # ç¾åœ¨ã®crontabã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
        crontab -l > "/tmp/crontab_backup_$(date +%Y%m%d_%H%M%S)" 2>/dev/null || true
        
        # AI Companyé–¢é€£ã®ã‚¨ãƒ³ãƒˆãƒªã‚’é™¤å»
        crontab -l 2>/dev/null | grep -v "AI Company\|ai_evolve_daily\|ai_grand_elder" | crontab -
        
        log_info "âœ… AIé€²åŒ–ã‚·ã‚¹ãƒ†ãƒ Cronè¨­å®šã‚’å‰Šé™¤ã—ã¾ã—ãŸ"
        log_info "ğŸ“‹ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—: /tmp/crontab_backup_*"
    else
        log_info "âŒ å‰Šé™¤ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ"
    fi
}

monitor_system() {
    log_info "ğŸ” AIé€²åŒ–ã‚·ã‚¹ãƒ†ãƒ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–é–‹å§‹"
    echo "Ctrl+C ã§ç›£è¦–ã‚’åœæ­¢ã—ã¾ã™"
    echo ""
    
    while true; do
        clear
        echo -e "${cyan}ğŸ¤– AI Company è‡ªå·±é€²åŒ–ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰${nc}"
        echo "æ›´æ–°æ™‚åˆ»: $(date)"
        echo "==========================================â€‹=================================="
        
        # ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³
        echo -e "${green}ğŸ“Š ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³:${nc}"
        if [ -f "$LOG_DIR/hourly_status.log" ]; then
            tail -1 "$LOG_DIR/hourly_status.log" 2>/dev/null || echo "  çŠ¶æ³ç¢ºèªä¸­..."
        else
            echo "  ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¾…æ©Ÿä¸­..."
        fi
        
        # æœ€æ–°ã®é€²åŒ–æ´»å‹•
        echo ""
        echo -e "${green}ğŸŒŸ æœ€æ–°ã®é€²åŒ–æ´»å‹•:${nc}"
        if [ -f "$LOG_DIR/daily_evolution.log" ]; then
            tail -3 "$LOG_DIR/daily_evolution.log" 2>/dev/null | sed 's/^/  /' || echo "  é€²åŒ–ãƒ­ã‚°ã‚’å¾…æ©Ÿä¸­..."
        else
            echo "  é€²åŒ–ãƒ­ã‚°ã‚’å¾…æ©Ÿä¸­..."
        fi
        
        # ä¿ç•™ä¸­ã®ç›¸è«‡
        echo ""
        echo -e "${green}ğŸ‘‘ ä¿ç•™ä¸­ã®ç›¸è«‡:${nc}"
        if [ -f "$LOG_DIR/pending_consultations.log" ]; then
            tail -2 "$LOG_DIR/pending_consultations.log" 2>/dev/null | sed 's/^/  /' || echo "  ç›¸è«‡ãƒ­ã‚°ã‚’å¾…æ©Ÿä¸­..."
        else
            echo "  ç›¸è«‡ãƒ­ã‚°ã‚’å¾…æ©Ÿä¸­..."
        fi
        
        # ã‚·ã‚¹ãƒ†ãƒ ãƒªã‚½ãƒ¼ã‚¹
        echo ""
        echo -e "${green}ğŸ’» ã‚·ã‚¹ãƒ†ãƒ ãƒªã‚½ãƒ¼ã‚¹:${nc}"
        echo "  CPU: $(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d'%' -f1)% ä½¿ç”¨ä¸­"
        echo "  ãƒ¡ãƒ¢ãƒª: $(free | grep Mem | awk '{printf "%.1f%%", $3/$2 * 100.0}') ä½¿ç”¨ä¸­"
        echo "  ãƒ‡ã‚£ã‚¹ã‚¯: $(df "$PROJECT_ROOT" | tail -1 | awk '{print $5}') ä½¿ç”¨ä¸­"
        
        # æ¬¡å›å®Ÿè¡Œäºˆå®š
        echo ""
        echo -e "${green}â° æ¬¡å›å®Ÿè¡Œäºˆå®š:${nc}"
        current_time=$(date +%H%M)
        if [ "$current_time" -lt "0200" ]; then
            echo "  æ—¥æ¬¡é€²åŒ–ã‚µã‚¤ã‚¯ãƒ«: ä»Šæ—¥ 2:00 AM"
        else
            echo "  æ—¥æ¬¡é€²åŒ–ã‚µã‚¤ã‚¯ãƒ«: æ˜æ—¥ 2:00 AM"
        fi
        
        sleep 10
    done
}

# ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œãƒ­ã‚¸ãƒƒã‚¯
case "${1:-}" in
    "setup")
        setup_cron
        ;;
    "status")
        show_status
        ;;
    "logs")
        show_logs
        ;;
    "test")
        test_evolution_system
        ;;
    "remove")
        remove_cron
        ;;
    "monitor")
        monitor_system
        ;;
    "--help"|"-h"|"help")
        show_help
        ;;
    "")
        log_error "âŒ ã‚³ãƒãƒ³ãƒ‰ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
        echo ""
        show_help
        exit 1
        ;;
    *)
        log_error "âŒ ä¸æ˜ãªã‚³ãƒãƒ³ãƒ‰: $1"
        echo ""
        show_help
        exit 1
        ;;
esac