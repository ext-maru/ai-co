#!/usr/bin/env python3
"""
AI Company Gitç®¡ç†ã‚³ãƒãƒ³ãƒ‰ï¼ˆãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹å¯¾å¿œç‰ˆï¼‰
"""

import sys
import argparse
from pathlib import Path
import json

PROJECT_ROOT = Path(__file__).parent.parent
sys.path.insert(0, str(PROJECT_ROOT))

from libs.github_flow_manager import GitHubFlowManager
from libs.commit_message_generator import CommitMessageGenerator
import logging

logging.basicConfig(level=logging.INFO, format='%(message)s')
logger = logging.getLogger(__name__)

def main():
    parser = argparse.ArgumentParser(description='AI Company Gitç®¡ç†ãƒ„ãƒ¼ãƒ«ï¼ˆãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹å¯¾å¿œï¼‰')
    
    subparsers = parser.add_subparsers(dest='command', help='ã‚³ãƒãƒ³ãƒ‰')
    
    # status
    subparsers.add_parser('status', help='GitçŠ¶æ…‹ã‚’è¡¨ç¤º')
    
    # commitï¼ˆæ”¹è‰¯ç‰ˆï¼‰
    commit_parser = subparsers.add_parser('commit', help='ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã«å¾“ã£ã¦ã‚³ãƒŸãƒƒãƒˆ')
    commit_parser.add_argument('-m', '--message', help='ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆçœç•¥æ™‚ã¯è‡ªå‹•ç”Ÿæˆï¼‰')
    commit_parser.add_argument('--simple', action='store_true', help='ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å½¢å¼ã‚’ä½¿ç”¨')
    commit_parser.add_argument('--preview', action='store_true', help='ç”Ÿæˆã•ã‚Œã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼')
    commit_parser.add_argument('--validate', action='store_true', help='ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¤œè¨¼ã®ã¿')
    
    # feature
    feature_parser = subparsers.add_parser('feature', help='æ©Ÿèƒ½ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆ')
    feature_parser.add_argument('name', help='ãƒ–ãƒ©ãƒ³ãƒå')
    
    # pr
    pr_parser = subparsers.add_parser('pr', help='ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆ')
    pr_parser.add_argument('branch', nargs='?', help='ãƒ–ãƒ©ãƒ³ãƒå')
    pr_parser.add_argument('--title', help='PRã‚¿ã‚¤ãƒˆãƒ«')
    pr_parser.add_argument('--body', help='PRèª¬æ˜')
    
    # release
    release_parser = subparsers.add_parser('release', help='ãƒªãƒªãƒ¼ã‚¹ã‚’ä½œæˆ')
    release_parser.add_argument('--version', help='ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·')
    
    # changelogï¼ˆæ–°æ©Ÿèƒ½ï¼‰
    changelog_parser = subparsers.add_parser('changelog', help='CHANGELOGã‚’ç”Ÿæˆ')
    changelog_parser.add_argument('--from', dest='from_tag', help='é–‹å§‹ã‚¿ã‚°')
    changelog_parser.add_argument('--to', default='HEAD', help='çµ‚äº†ã‚¿ã‚°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: HEADï¼‰')
    changelog_parser.add_argument('--output', help='å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«')
    
    # best-practicesï¼ˆæ–°æ©Ÿèƒ½ï¼‰
    bp_parser = subparsers.add_parser('best-practices', help='ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã‚’è¡¨ç¤º')
    
    # analyzeï¼ˆæ–°æ©Ÿèƒ½ï¼‰
    analyze_parser = subparsers.add_parser('analyze', help='ç¾åœ¨ã®å¤‰æ›´ã‚’åˆ†æ')
    
    args = parser.parse_args()
    
    manager = GitHubFlowManager()
    
    if args.command == 'status':
        status = manager.get_status()
        print(f"ğŸŒ¿ Current branch: {status.get('current_branch', 'unknown')}")
        print(f"ğŸ“ Has changes: {'Yes' if status.get('has_changes') else 'No'}")
        
        if status.get('recent_commits'):
            print("\nğŸ“œ Recent commits:")
            for commit in status['recent_commits'][:5]:
                print(f"  {commit}")
    
    elif args.command == 'commit':
        if args.preview:
            # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
            generator = CommitMessageGenerator()
            message = generator.generate_commit_message()
            print("Generated commit message:")
            print("-" * 72)
            print(message)
            print("-" * 72)
            
            if args.validate:
                valid, errors = generator.validate_message(message)
                if valid:
                    print("âœ… Message is valid according to best practices")
                else:
                    print("âŒ Message has issues:")
                    for error in errors:
                        print(f"  - {error}")
        else:
            # å®Ÿéš›ã«ã‚³ãƒŸãƒƒãƒˆ
            use_best_practices = not args.simple
            if manager.commit_changes(message=args.message, use_best_practices=use_best_practices):
                print("âœ… Committed successfully with best practices")
            else:
                print("âŒ Commit failed")
    
    elif args.command == 'feature':
        branch = manager.create_feature_branch(args.name)
        print(f"âœ… Created feature branch: {branch}")
    
    elif args.command == 'pr':
        if args.branch:
            title = args.title or f"feat: {args.branch}"
            body = args.body or f"Auto-generated PR for {args.branch}"
            if manager.create_pull_request(args.branch, title, body):
                print(f"âœ… Created PR for {args.branch}")
            else:
                print("âŒ PR creation failed")
        else:
            print("âŒ Please specify branch for PR")
    
    elif args.command == 'release':
        if manager.create_release(args.version):
            print(f"âœ… Created release: {args.version or 'auto-generated'}")
        else:
            print("âŒ Release failed")
    
    elif args.command == 'changelog':
        changelog = manager.generate_changelog(args.from_tag, args.to)
        
        if args.output:
            output_path = PROJECT_ROOT / args.output
            output_path.write_text(changelog)
            print(f"âœ… Changelog written to {args.output}")
        else:
            print(changelog)
    
    elif args.command == 'best-practices':
        print("""
# ğŸ“š Git Commit Message Best Practices

## Conventional Commitså½¢å¼
```
<type>(<scope>): <subject>

<body>

<footer>
```

## ã‚¿ã‚¤ãƒ—
- feat: æ–°æ©Ÿèƒ½
- fix: ãƒã‚°ä¿®æ­£
- docs: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ã¿ã®å¤‰æ›´
- style: ã‚³ãƒ¼ãƒ‰ã®æ„å‘³ã«å½±éŸ¿ã—ãªã„å¤‰æ›´ï¼ˆç©ºç™½ã€ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆç­‰ï¼‰
- refactor: ãƒã‚°ä¿®æ­£ã‚„æ©Ÿèƒ½è¿½åŠ ã‚’å«ã¾ãªã„ã‚³ãƒ¼ãƒ‰å¤‰æ›´
- perf: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„
- test: ãƒ†ã‚¹ãƒˆã®è¿½åŠ ã‚„ä¿®æ­£
- build: ãƒ“ãƒ«ãƒ‰ã‚·ã‚¹ãƒ†ãƒ ã‚„å¤–éƒ¨ä¾å­˜é–¢ä¿‚ã®å¤‰æ›´
- ci: CIè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å¤‰æ›´
- chore: ãã®ä»–ã®å¤‰æ›´

## ãƒ«ãƒ¼ãƒ«
1. ä»¶åã¯50æ–‡å­—ä»¥å†…
2. ä»¶åã¯å‘½ä»¤å½¢ã§æ›¸ãï¼ˆä¾‹: "Fix bug" not "Fixed bug"ï¼‰
3. ä»¶åã®æœ€å¾Œã«ãƒ”ãƒªã‚ªãƒ‰ã‚’ä»˜ã‘ãªã„
4. æœ¬æ–‡ã¯72æ–‡å­—ã§æ”¹è¡Œ
5. æœ¬æ–‡ã§ã¯ã€Œä½•ã‚’ã€ã€Œãªãœã€å¤‰æ›´ã—ãŸã‹ã‚’èª¬æ˜
6. Breaking changesã¯æ˜ç¤ºçš„ã«è¨˜è¼‰

## ä¾‹
```
feat(workers): add email notification worker

Implement EmailWorker to handle asynchronous email notifications.
This allows the system to send emails without blocking main processes.

- Add SMTP configuration support
- Implement retry mechanism for failed sends
- Add template support for common email types

Closes #123
```
        """)
    
    elif args.command == 'analyze':
        generator = CommitMessageGenerator()
        changes = generator.analyze_changes()
        
        print("ğŸ“Š Change Analysis:")
        print(f"Files changed: {len(changes['files'])}")
        
        if changes['files']:
            print("\nModified files:")
            for file in changes['files'][:10]:
                print(f"  - {file}")
            
            if len(changes['files']) > 10:
                print(f"  ... and {len(changes['files']) - 10} more")
        
        if changes['stats']:
            print(f"\n{changes['stats']}")
        
        # æ¨å¥¨ã•ã‚Œã‚‹ã‚³ãƒŸãƒƒãƒˆã‚¿ã‚¤ãƒ—ã‚’è¡¨ç¤º
        if changes['files']:
            commit_type = generator.detect_commit_type(changes['files'], changes['content'])
            scope = generator.extract_scope(changes['files'])
            print(f"\nSuggested commit type: {commit_type}")
            if scope:
                print(f"Suggested scope: {scope}")
    
    else:
        parser.print_help()

if __name__ == "__main__":
    main()
