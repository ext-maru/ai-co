#!/usr/bin/env python3
"""
AI Company MCP (Model Context Protocol) ç®¡ç†ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
MCPã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•ãƒ»åœæ­¢ãƒ»çŠ¶æ…‹ç¢ºèªã‚’è¡Œã„ã¾ã™
"""

import json
import os
import signal
import subprocess
import sys
import time
from pathlib import Path
from typing import Dict, List, Optional

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã‚’è¿½åŠ 
PROJECT_ROOT = Path(__file__).parent.parent
sys.path.insert(0, str(PROJECT_ROOT))


class MCPManager:
    """MCP ã‚µãƒ¼ãƒãƒ¼ç®¡ç†ã‚¯ãƒ©ã‚¹"""

    def __init__(self):
        self.project_root = PROJECT_ROOT
        self.config_path = self.project_root / "config" / "mcp_config.json"
        self.pid_dir = self.project_root / "tmp" / "mcp_pids"
        self.pid_dir.mkdir(parents=True, exist_ok=True)

        # MCPã‚µãƒ¼ãƒãƒ¼è¨­å®š
        self.servers = {
            "filesystem": {
                "script": "libs/mcp_servers/filesystem_server.py",
                "description": "ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ æ“ä½œã‚µãƒ¼ãƒãƒ¼",
                "port": 3001,
            },
            "executor": {
                "script": "libs/mcp_servers/executor_server.py",
                "description": "ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œã‚µãƒ¼ãƒãƒ¼",
                "port": 3002,
            },
        }

    def start_server(self, server_name: str) -> bool:
        """MCPã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•"""
        if server_name not in self.servers:
            print(f"âŒ ä¸æ˜ãªã‚µãƒ¼ãƒãƒ¼: {server_name}")
            return False

        server = self.servers[server_name]
        script_path = self.project_root / server["script"]

        if not script_path.exists():
            print(f"âŒ ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: {script_path}")
            return False

        # æ—¢ã«èµ·å‹•ä¸­ã‹ãƒã‚§ãƒƒã‚¯
        if self.is_server_running(server_name):
            print(f"âš ï¸ {server_name} ã‚µãƒ¼ãƒãƒ¼ã¯æ—¢ã«èµ·å‹•ä¸­ã§ã™")
            return True

        try:
            # ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•
            print(f"ğŸš€ {server_name} ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ä¸­...")
            process = subprocess.Popen(
                ["python3", str(script_path)],
                stdout=subprocess.PIPE,
                stderr=subprocess.PIPE,
                cwd=str(self.project_root),
            )

            # PIDã‚’ä¿å­˜
            pid_file = self.pid_dir / f"{server_name}.pid"
            pid_file.write_text(str(process.pid))

            # å°‘ã—å¾…ã£ã¦èµ·å‹•ç¢ºèª
            time.sleep(2)
            if process.poll() is None:
                print(f"âœ… {server_name} ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¾ã—ãŸ (PID: {process.pid})")
                return True
            else:
                print(f"âŒ {server_name} ã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ")
                return False

        except Exception as e:
            print(f"âŒ {server_name} ã‚µãƒ¼ãƒãƒ¼èµ·å‹•ã‚¨ãƒ©ãƒ¼: {str(e)}")
            return False

    def stop_server(self, server_name: str) -> bool:
        """MCPã‚µãƒ¼ãƒãƒ¼ã‚’åœæ­¢"""
        if server_name not in self.servers:
            print(f"âŒ ä¸æ˜ãªã‚µãƒ¼ãƒãƒ¼: {server_name}")
            return False

        pid_file = self.pid_dir / f"{server_name}.pid"

        if not pid_file.exists():
            print(f"âš ï¸ {server_name} ã‚µãƒ¼ãƒãƒ¼ã¯èµ·å‹•ã—ã¦ã„ã¾ã›ã‚“")
            return True

        try:
            pid = int(pid_file.read_text())

            # ãƒ—ãƒ­ã‚»ã‚¹ã‚’åœæ­¢
            os.kill(pid, signal.SIGTERM)
            time.sleep(1)

            # å¼·åˆ¶åœæ­¢ãŒå¿…è¦ãªå ´åˆ
            try:
                os.kill(pid, 0)  # ãƒ—ãƒ­ã‚»ã‚¹å­˜åœ¨ç¢ºèª
                os.kill(pid, signal.SIGKILL)
                time.sleep(1)
            except ProcessLookupError:
                pass  # ãƒ—ãƒ­ã‚»ã‚¹ã¯æ—¢ã«çµ‚äº†

            # PIDãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
            pid_file.unlink()

            print(f"âœ… {server_name} ã‚µãƒ¼ãƒãƒ¼ã‚’åœæ­¢ã—ã¾ã—ãŸ")
            return True

        except Exception as e:
            print(f"âŒ {server_name} ã‚µãƒ¼ãƒãƒ¼åœæ­¢ã‚¨ãƒ©ãƒ¼: {str(e)}")
            # PIDãƒ•ã‚¡ã‚¤ãƒ«ãŒå£Šã‚Œã¦ã„ã‚‹å ´åˆã¯å‰Šé™¤
            if pid_file.exists():
                pid_file.unlink()
            return False

    def is_server_running(self, server_name: str) -> bool:
        """ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ä¸­ã‹ãƒã‚§ãƒƒã‚¯"""
        pid_file = self.pid_dir / f"{server_name}.pid"

        if not pid_file.exists():
            return False

        try:
            pid = int(pid_file.read_text())
            os.kill(pid, 0)  # ãƒ—ãƒ­ã‚»ã‚¹å­˜åœ¨ç¢ºèª
            return True
        except (ProcessLookupError, ValueError):
            # ãƒ—ãƒ­ã‚»ã‚¹ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯PIDãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
            if pid_file.exists():
                pid_file.unlink()
            return False

    def get_server_status(self) -> Dict[str, Dict]:
        """å…¨ã‚µãƒ¼ãƒãƒ¼ã®çŠ¶æ…‹å–å¾—"""
        status = {}

        for server_name, server_config in self.servers.items():
            is_running = self.is_server_running(server_name)
            pid = None

            if is_running:
                pid_file = self.pid_dir / f"{server_name}.pid"
                try:
                    pid = int(pid_file.read_text())
                except:
                    pid = None

            status[server_name] = {
                "running": is_running,
                "pid": pid,
                "description": server_config["description"],
                "port": server_config.get("port"),
                "script": server_config["script"],
            }

        return status

    def start_all(self) -> bool:
        """å…¨ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•"""
        print("ğŸš€ å…¨MCPã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ä¸­...")
        success = True

        for server_name in self.servers:
            if not self.start_server(server_name):
                success = False

        return success

    def stop_all(self) -> bool:
        """å…¨ã‚µãƒ¼ãƒãƒ¼ã‚’åœæ­¢"""
        print("ğŸ›‘ å…¨MCPã‚µãƒ¼ãƒãƒ¼ã‚’åœæ­¢ä¸­...")
        success = True

        for server_name in self.servers:
            if not self.stop_server(server_name):
                success = False

        return success

    def restart_all(self) -> bool:
        """å…¨ã‚µãƒ¼ãƒãƒ¼ã‚’å†èµ·å‹•"""
        print("ğŸ”„ å…¨MCPã‚µãƒ¼ãƒãƒ¼ã‚’å†èµ·å‹•ä¸­...")
        self.stop_all()
        time.sleep(2)
        return self.start_all()


def main():
    """ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œé–¢æ•°"""
    if len(sys.argv) < 2:
        print("ä½¿ç”¨æ–¹æ³•:")
        print("  ai-mcp start [server_name]  - ã‚µãƒ¼ãƒãƒ¼èµ·å‹•")
        print("  ai-mcp stop [server_name]   - ã‚µãƒ¼ãƒãƒ¼åœæ­¢")
        print("  ai-mcp restart [server_name] - ã‚µãƒ¼ãƒãƒ¼å†èµ·å‹•")
        print("  ai-mcp status               - çŠ¶æ…‹ç¢ºèª")
        print("  ai-mcp list                 - ã‚µãƒ¼ãƒãƒ¼ä¸€è¦§")
        print("")
        print("åˆ©ç”¨å¯èƒ½ãªã‚µãƒ¼ãƒãƒ¼: filesystem, executor")
        sys.exit(1)

    manager = MCPManager()
    command = sys.argv[1]

    if command == "start":
        if len(sys.argv) > 2:
            # ç‰¹å®šã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•
            server_name = sys.argv[2]
            success = manager.start_server(server_name)
        else:
            # å…¨ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•
            success = manager.start_all()

        sys.exit(0 if success else 1)

    elif command == "stop":
        if len(sys.argv) > 2:
            # ç‰¹å®šã‚µãƒ¼ãƒãƒ¼ã‚’åœæ­¢
            server_name = sys.argv[2]
            success = manager.stop_server(server_name)
        else:
            # å…¨ã‚µãƒ¼ãƒãƒ¼ã‚’åœæ­¢
            success = manager.stop_all()

        sys.exit(0 if success else 1)

    elif command == "restart":
        if len(sys.argv) > 2:
            # ç‰¹å®šã‚µãƒ¼ãƒãƒ¼ã‚’å†èµ·å‹•
            server_name = sys.argv[2]
            manager.stop_server(server_name)
            time.sleep(1)
            success = manager.start_server(server_name)
        else:
            # å…¨ã‚µãƒ¼ãƒãƒ¼ã‚’å†èµ·å‹•
            success = manager.restart_all()

        sys.exit(0 if success else 1)

    elif command == "status":
        # çŠ¶æ…‹ç¢ºèª
        print("ğŸ“Š MCP ã‚µãƒ¼ãƒãƒ¼çŠ¶æ…‹")
        print("=" * 50)

        status = manager.get_server_status()

        for server_name, info in status.items():
            status_icon = "ğŸŸ¢ èµ·å‹•ä¸­" if info["running"] else "ğŸ”´ åœæ­¢ä¸­"
            pid_info = f" (PID: {info['pid']})" if info["pid"] else ""
            port_info = f" Port: {info['port']}" if info.get("port") else ""

            print(f"{status_icon} {server_name}{pid_info}")
            print(f"  èª¬æ˜: {info['description']}")
            print(f"  ã‚¹ã‚¯ãƒªãƒ—ãƒˆ: {info['script']}{port_info}")
            print()

        # å…¨ä½“çŠ¶æ³
        running_count = sum(1 for info in status.values() if info["running"])
        total_count = len(status)

        if running_count == total_count:
            print(f"âœ… å…¨ã‚µãƒ¼ãƒãƒ¼ãŒç¨¼åƒä¸­ ({running_count}/{total_count})")
        elif running_count > 0:
            print(f"âš ï¸ ä¸€éƒ¨ã‚µãƒ¼ãƒãƒ¼ãŒç¨¼åƒä¸­ ({running_count}/{total_count})")
        else:
            print(f"âŒ å…¨ã‚µãƒ¼ãƒãƒ¼ãŒåœæ­¢ä¸­ ({running_count}/{total_count})")

    elif command == "list":
        # ã‚µãƒ¼ãƒãƒ¼ä¸€è¦§
        print("ğŸ“‹ åˆ©ç”¨å¯èƒ½ãªMCPã‚µãƒ¼ãƒãƒ¼")
        print("=" * 40)

        for server_name, server_config in manager.servers.items():
            print(f"â€¢ {server_name}")
            print(f"  {server_config['description']}")
            print(f"  ã‚¹ã‚¯ãƒªãƒ—ãƒˆ: {server_config['script']}")
            print()

    else:
        print(f"âŒ ä¸æ˜ãªã‚³ãƒãƒ³ãƒ‰: {command}")
        sys.exit(1)


if __name__ == "__main__":
    main()
