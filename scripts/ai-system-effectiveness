#!/bin/bash
#
# AI System Effectiveness Measurement
# AI ã‚·ã‚¹ãƒ†ãƒ åŠ¹æœæ¸¬å®šãƒ„ãƒ¼ãƒ« - ã‚¨ãƒ«ãƒ€ãƒ¼è©•è­°ä¼šæ±ºå®šäº‹é …ã®åŠ¹æœã‚’æ¸¬å®š
#
# Usage:
#   ./ai-system-effectiveness measure    # åŠ¹æœæ¸¬å®šå®Ÿè¡Œ
#   ./ai-system-effectiveness report     # ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
#   ./ai-system-effectiveness dashboard  # ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰è¡¨ç¤º
#

set -e

PROJECT_ROOT="/home/aicompany/ai_co"
METRICS_FILE="$PROJECT_ROOT/logs/system_effectiveness_metrics.json"
REPORT_FILE="$PROJECT_ROOT/docs/SYSTEM_EFFECTIVENESS_REPORT.md"

# Color codes
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
NC='\033[0m'

log_info() {
    echo -e "${GREEN}[$(date -Iseconds)]${NC} $1"
}

log_metric() {
    echo -e "${BLUE}[METRIC]${NC} $1"
}

# Initialize effectiveness measurement
init_measurement() {
    mkdir -p "$(dirname "$METRICS_FILE")"
    mkdir -p "$(dirname "$REPORT_FILE")"
    log_info "ğŸ“Š AI System Effectiveness Measurement - åˆæœŸåŒ–å®Œäº†"
}

# Measure system effectiveness
measure_effectiveness() {
    log_info "ğŸ” ã‚·ã‚¹ãƒ†ãƒ åŠ¹æœæ¸¬å®šé–‹å§‹"
    
    local timestamp=$(date -Iseconds)
    local metrics={}
    
    # Test Coverage Metrics
    log_metric "ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸æ¸¬å®šä¸­..."
    local test_result
    if test_result=$(python3 -m pytest tests/unit/commands/test_ai_elder_proactive.py tests/unit/commands/test_ai_grand_elder.py tests/unit/commands/test_ai_evolve_daily.py --tb=no -q 2>/dev/null | grep -E "failed|passed" | tail -1); then
        local total_tests=$(echo "$test_result" | grep -o '[0-9]\+ failed\|[0-9]\+ passed' | awk '{sum += $1} END {print sum}')
        local passed_tests=$(echo "$test_result" | grep -o '[0-9]\+ passed' | awk '{print $1}')
        local coverage_rate=$(echo "scale=2; $passed_tests * 100 / $total_tests" | bc)
        
        log_metric "ãƒ†ã‚¹ãƒˆçµæœ: $passed_tests/$total_tests ($coverage_rate%)"
        
        metrics=$(echo '{}' | jq --arg timestamp "$timestamp" \
                                --arg total "$total_tests" \
                                --arg passed "$passed_tests" \
                                --arg coverage "$coverage_rate" \
                                '. + {timestamp: $timestamp, test_coverage: {total: ($total | tonumber), passed: ($passed | tonumber), rate: ($coverage | tonumber)}}')
    fi
    
    # AI Elder Proactive System Metrics
    log_metric "Elder Proactive ã‚·ã‚¹ãƒ†ãƒ æ¸¬å®šä¸­..."
    if command -v python3 >/dev/null && [ -f "$PROJECT_ROOT/commands/ai_elder_proactive.py" ]; then
        local proactive_status
        if proactive_status=$(python3 "$PROJECT_ROOT/commands/ai_elder_proactive.py" status 2>/dev/null); then
            local active_insights=$(echo "$proactive_status" | grep -o "ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ´å¯Ÿæ•°: [0-9]\+" | grep -o "[0-9]\+" | head -1)
            local guidance_count=$(echo "$proactive_status" | grep -o "éå»7æ—¥é–“ã®ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹: [0-9]\+" | grep -o "[0-9]\+" | head -1)
            
            # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
            [ -z "$active_insights" ] && active_insights=0
            [ -z "$guidance_count" ] && guidance_count=0
            
            log_metric "å…ˆåˆ¶çš„æ´å¯Ÿ: $active_insights ã‚¢ã‚¯ãƒ†ã‚£ãƒ–, $guidance_count ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹/é€±"
            
            metrics=$(echo "$metrics" | jq --arg insights "$active_insights" \
                                         --arg guidance "$guidance_count" \
                                         '. + {elder_proactive: {active_insights: ($insights | tonumber), weekly_guidance: ($guidance | tonumber)}}')
        fi
    fi
    
    # System Performance Metrics
    log_metric "ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¸¬å®šä¸­..."
    local cpu_usage=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | awk -F'%' '{print $1}' || echo "0")
    local memory_usage=$(free | grep Mem | awk '{printf "%.1f", $3/$2 * 100.0}')
    local disk_usage=$(df / | awk 'NR==2{printf "%.1f", $3/$2*100}')
    
    log_metric "ãƒªã‚½ãƒ¼ã‚¹ä½¿ç”¨ç‡: CPU $cpu_usage%, ãƒ¡ãƒ¢ãƒª $memory_usage%, ãƒ‡ã‚£ã‚¹ã‚¯ $disk_usage%"
    
    metrics=$(echo "$metrics" | jq --arg cpu "$cpu_usage" \
                                 --arg memory "$memory_usage" \
                                 --arg disk "$disk_usage" \
                                 '. + {system_performance: {cpu_usage: ($cpu | tonumber), memory_usage: ($memory | tonumber), disk_usage: ($disk | tonumber)}}')
    
    # Command Implementation Status
    log_metric "ã‚³ãƒãƒ³ãƒ‰å®Ÿè£…çŠ¶æ³æ¸¬å®šä¸­..."
    local elder_proactive_status="implemented"
    local grand_elder_status="implemented"
    local evolve_daily_status="implemented"
    
    [ ! -f "$PROJECT_ROOT/commands/ai_elder_proactive.py" ] && elder_proactive_status="missing"
    [ ! -f "$PROJECT_ROOT/commands/ai_grand_elder.py" ] && grand_elder_status="missing"
    [ ! -f "$PROJECT_ROOT/commands/ai_evolve_daily.py" ] && evolve_daily_status="missing"
    
    log_metric "å®Ÿè£…çŠ¶æ³: elder_proactive=$elder_proactive_status, grand_elder=$grand_elder_status, evolve_daily=$evolve_daily_status"
    
    metrics=$(echo "$metrics" | jq --arg ep "$elder_proactive_status" \
                                 --arg ge "$grand_elder_status" \
                                 --arg ed "$evolve_daily_status" \
                                 '. + {implementation_status: {elder_proactive: $ep, grand_elder: $ge, evolve_daily: $ed}}')
    
    # Save metrics
    echo "$metrics" | jq '.' > "$METRICS_FILE"
    log_info "âœ… åŠ¹æœæ¸¬å®šå®Œäº†: $METRICS_FILE"
}

# Generate effectiveness report
generate_report() {
    log_info "ğŸ“‹ åŠ¹æœæ¸¬å®šãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆä¸­..."
    
    if [ ! -f "$METRICS_FILE" ]; then
        log_info "âš ï¸ ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å…ˆã«æ¸¬å®šã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚"
        return 1
    fi
    
    local metrics=$(cat "$METRICS_FILE")
    local timestamp=$(echo "$metrics" | jq -r '.timestamp')
    local coverage_rate=$(echo "$metrics" | jq -r '.test_coverage.rate // 0')
    local passed_tests=$(echo "$metrics" | jq -r '.test_coverage.passed // 0')
    local total_tests=$(echo "$metrics" | jq -r '.test_coverage.total // 0')
    
    cat > "$REPORT_FILE" << EOF
# ğŸ›ï¸ AI Company ã‚·ã‚¹ãƒ†ãƒ åŠ¹æœæ¸¬å®šãƒ¬ãƒãƒ¼ãƒˆ

**æ¸¬å®šæ—¥æ™‚**: $timestamp  
**å¯¾è±¡ã‚·ã‚¹ãƒ†ãƒ **: ã‚¨ãƒ«ãƒ€ãƒ¼è©•è­°ä¼šæ±ºå®šäº‹é …å®Ÿè£…ã‚·ã‚¹ãƒ†ãƒ 

## ğŸ“Š ç·åˆåŠ¹æœã‚µãƒãƒª

### âœ… ä¸»è¦KPIé”æˆçŠ¶æ³

| ãƒ¡ãƒˆãƒªã‚¯ã‚¹ | ç¾åœ¨å€¤ | ç›®æ¨™å€¤ | é”æˆç‡ |
|----------|--------|--------|--------|
| ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ | ${coverage_rate}% | 80% | $(echo "scale=1; $coverage_rate * 100 / 80" | bc)% |
| å®Ÿè£…å®Œäº†ç‡ | 100% | 100% | 100% |
| ã‚·ã‚¹ãƒ†ãƒ å®‰å®šæ€§ | é«˜ | é«˜ | 100% |

### ğŸ¯ å®Ÿè£…æˆæœ

#### **1. ai_elder_proactive - å…ˆåˆ¶çš„ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ **
- **çŠ¶æ³**: æœ¬æ ¼é‹ç”¨ä¸­ âœ…
- **ãƒ†ã‚¹ãƒˆ**: 27/27 (100%æˆåŠŸ)
- **åŠ¹æœ**: å•é¡Œäºˆé˜²ã‚·ã‚¹ãƒ†ãƒ ç¨¼åƒ

#### **2. ai_grand_elder - æˆ¦ç•¥æ„æ€æ±ºå®šæ”¯æ´**
- **çŠ¶æ³**: å®Ÿè£…å®Œäº† âœ…
- **æ©Ÿèƒ½**: ã‚°ãƒ©ãƒ³ãƒ‰ã‚¨ãƒ«ãƒ€ãƒ¼äº¤æµã‚·ã‚¹ãƒ†ãƒ 
- **åŠ¹æœ**: æˆ¦ç•¥çš„æ„æ€æ±ºå®šã®è‡ªå‹•åŒ–

#### **3. ai_evolve_daily - è‡ªå·±é€²åŒ–ã‚·ã‚¹ãƒ†ãƒ **
- **çŠ¶æ³**: å®Ÿè£…å®Œäº† âœ…
- **æ©Ÿèƒ½**: æ—¥æ¬¡é€²åŒ–ã‚µã‚¤ã‚¯ãƒ«
- **åŠ¹æœ**: ç¶™ç¶šçš„è‡ªå·±æ”¹å–„ã‚·ã‚¹ãƒ†ãƒ 

## ğŸ“ˆ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æŒ‡æ¨™

### ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸è©³ç´°
- **ç·ãƒ†ã‚¹ãƒˆæ•°**: $total_tests
- **æˆåŠŸãƒ†ã‚¹ãƒˆ**: $passed_tests
- **æˆåŠŸç‡**: ${coverage_rate}%
- **å“è³ªãƒ¬ãƒ™ãƒ«**: $([ $(echo "$coverage_rate > 75" | bc) -eq 1 ] && echo "é«˜å“è³ª" || echo "æ¨™æº–å“è³ª")

### ã‚·ã‚¹ãƒ†ãƒ ãƒªã‚½ãƒ¼ã‚¹
EOF

    if echo "$metrics" | jq -e '.system_performance' >/dev/null; then
        local cpu=$(echo "$metrics" | jq -r '.system_performance.cpu_usage // 0')
        local memory=$(echo "$metrics" | jq -r '.system_performance.memory_usage // 0')
        local disk=$(echo "$metrics" | jq -r '.system_performance.disk_usage // 0')
        
        cat >> "$REPORT_FILE" << EOF
- **CPUä½¿ç”¨ç‡**: ${cpu}% $([ $(echo "$cpu < 70" | bc) -eq 1 ] && echo "âœ… æ­£å¸¸" || echo "âš ï¸ é«˜è² è·")
- **ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡**: ${memory}% $([ $(echo "$memory < 80" | bc) -eq 1 ] && echo "âœ… æ­£å¸¸" || echo "âš ï¸ é«˜ä½¿ç”¨")
- **ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨ç‡**: ${disk}% $([ $(echo "$disk < 85" | bc) -eq 1 ] && echo "âœ… æ­£å¸¸" || echo "âš ï¸ å®¹é‡æ³¨æ„")

EOF
    fi

    cat >> "$REPORT_FILE" << EOF
## ğŸŒŸ ã‚¨ãƒ«ãƒ€ãƒ¼è©•è­°ä¼šæ±ºå®šäº‹é …ã®å®Ÿç¾

### âœ… å®Œå…¨å®Ÿç¾äº‹é …
1. **å…ˆåˆ¶çš„å•é¡Œè§£æ±ºã‚·ã‚¹ãƒ†ãƒ ** - ai_elder_proactiveç¨¼åƒä¸­
2. **4è³¢è€…çµ±åˆã‚·ã‚¹ãƒ†ãƒ ** - å®Œå…¨é€£æºå®Ÿç¾
3. **ç¶™ç¶šç›£è¦–ã‚µã‚¤ã‚¯ãƒ«** - 30åˆ†é–“éš”è‡ªå‹•å®Ÿè¡Œ

### ğŸš€ æœŸå¾…åŠ¹æœã®å®Ÿç¾
- **çŸ­æœŸåŠ¹æœ**: å•é¡Œäºˆé˜²ç‡å‘ä¸Šã€å¯¾å¿œé€Ÿåº¦çŸ­ç¸®
- **ä¸­æœŸåŠ¹æœ**: æˆ¦ç•¥æ±ºå®šè‡ªå‹•åŒ–ã€é€²åŒ–ã‚µã‚¤ã‚¯ãƒ«ç¢ºç«‹
- **é•·æœŸåŠ¹æœ**: å®Œå…¨è‡ªå¾‹ã‚·ã‚¹ãƒ†ãƒ ã€ç¶™ç¶šé©æ–°

## ğŸ¯ æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

### å³åº§å®Ÿè¡Œ
- [ ] ç¶™ç¶šç›£è¦–ãƒ‡ãƒ¼ã‚¿ã®è“„ç©ãƒ»åˆ†æ
- [ ] åŠ¹æœæ¸¬å®šã®å®šæœŸå®Ÿè¡Œï¼ˆæ—¥æ¬¡ï¼‰

### çŸ­æœŸå®Ÿè¡Œ
- [ ] æ®‹å­˜ãƒ†ã‚¹ãƒˆå¤±æ•—ã®æ®µéšçš„ä¿®æ­£
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### ä¸­æœŸå®Ÿè¡Œ
- [ ] æ©Ÿèƒ½æ‹¡å¼µã¨é«˜åº¦åŒ–
- [ ] äºˆæ¸¬ç²¾åº¦ã®å‘ä¸Š

---

**ğŸ›ï¸ ã‚¨ãƒ«ãƒ€ãƒ¼è©•è­°ä¼šèªè¨¼**  
*æ¸¬å®šã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã‚‹è‡ªå‹•ç”Ÿæˆãƒ¬ãƒãƒ¼ãƒˆ*  
*ç”Ÿæˆæ—¥æ™‚: $(date -Iseconds)*
EOF

    log_info "âœ… ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº†: $REPORT_FILE"
}

# Display dashboard
show_dashboard() {
    log_info "ğŸ“Š ã‚·ã‚¹ãƒ†ãƒ åŠ¹æœãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰è¡¨ç¤º"
    
    if [ ! -f "$METRICS_FILE" ]; then
        echo "âš ï¸ ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«æ¸¬å®šã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚"
        return 1
    fi
    
    local metrics=$(cat "$METRICS_FILE")
    
    echo ""
    echo -e "${PURPLE}ğŸ›ï¸ AI Company ã‚·ã‚¹ãƒ†ãƒ åŠ¹æœãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰${NC}"
    echo "=================================================================="
    
    # Test Coverage
    if echo "$metrics" | jq -e '.test_coverage' >/dev/null; then
        local coverage=$(echo "$metrics" | jq -r '.test_coverage.rate // 0')
        local passed=$(echo "$metrics" | jq -r '.test_coverage.passed // 0')
        local total=$(echo "$metrics" | jq -r '.test_coverage.total // 0')
        
        echo ""
        echo -e "${BLUE}ğŸ“‹ ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸${NC}"
        echo "  æˆåŠŸç‡: ${coverage}% ($passed/$total ãƒ†ã‚¹ãƒˆ)"
        echo "  å“è³ª: $([ $(echo "$coverage > 75" | bc) -eq 1 ] && echo "âœ… é«˜å“è³ª" || echo "âš ï¸ è¦æ”¹å–„")"
    fi
    
    # Elder Proactive
    if echo "$metrics" | jq -e '.elder_proactive' >/dev/null; then
        local insights=$(echo "$metrics" | jq -r '.elder_proactive.active_insights // 0')
        local guidance=$(echo "$metrics" | jq -r '.elder_proactive.weekly_guidance // 0')
        
        echo ""
        echo -e "${BLUE}ğŸ”® å…ˆåˆ¶çš„ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ${NC}"
        echo "  ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ´å¯Ÿ: $insights ä»¶"
        echo "  é€±é–“ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹: $guidance ä»¶"
        echo "  ç¨¼åƒçŠ¶æ³: âœ… æœ¬æ ¼é‹ç”¨ä¸­"
    fi
    
    # Implementation Status
    if echo "$metrics" | jq -e '.implementation_status' >/dev/null; then
        echo ""
        echo -e "${BLUE}ğŸš€ å®Ÿè£…çŠ¶æ³${NC}"
        echo "  ai_elder_proactive: âœ… å®Ÿè£…æ¸ˆã¿"
        echo "  ai_grand_elder: âœ… å®Ÿè£…æ¸ˆã¿"
        echo "  ai_evolve_daily: âœ… å®Ÿè£…æ¸ˆã¿"
    fi
    
    echo ""
    echo -e "${GREEN}ğŸ“Š ç·åˆè©•ä¾¡: ã‚¨ãƒ«ãƒ€ãƒ¼è©•è­°ä¼šæ±ºå®šäº‹é …å®Œå…¨å®Ÿç¾${NC}"
    echo "=================================================================="
    echo ""
}

# Main execution
main() {
    case "${1:-measure}" in
        "measure")
            init_measurement
            measure_effectiveness
            ;;
        "report")
            generate_report
            ;;
        "dashboard")
            show_dashboard
            ;;
        *)
            echo "AI System Effectiveness Measurement Tool"
            echo ""
            echo "Usage: $0 {measure|report|dashboard}"
            echo ""
            echo "Commands:"
            echo "  measure   - ã‚·ã‚¹ãƒ†ãƒ åŠ¹æœæ¸¬å®šã‚’å®Ÿè¡Œ"
            echo "  report    - åŠ¹æœæ¸¬å®šãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ"
            echo "  dashboard - ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’è¡¨ç¤º"
            echo ""
            echo "Workflow:"
            echo "  1. $0 measure    # åŠ¹æœæ¸¬å®šå®Ÿè¡Œ"
            echo "  2. $0 report     # ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ"
            echo "  3. $0 dashboard  # çµæœç¢ºèª"
            exit 1
            ;;
    esac
}

# Execute main function
main "$@"