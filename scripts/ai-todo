#!/usr/bin/env python3
"""
ai-todo ã‚³ãƒãƒ³ãƒ‰
AIè‡ªå¾‹å‹ToDoãƒªã‚¹ãƒˆç®¡ç†CLI
"""

import argparse
import json
import os
import sys
from pathlib import Path

PROJECT_ROOT = Path(__file__).parent.parent
sys.path.insert(0, str(PROJECT_ROOT))

# ä»®æƒ³ç’°å¢ƒã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ãƒˆï¼ˆç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢ï¼‰
os.chdir(str(PROJECT_ROOT))
venv_python = PROJECT_ROOT / "venv" / "bin" / "python3"
if venv_python.exists() and not os.environ.get("AI_VENV_ACTIVE"):
    import subprocess

    env = os.environ.copy()
    env["AI_VENV_ACTIVE"] = "1"  # ç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢ãƒ•ãƒ©ã‚°
    result = subprocess.run(
        [str(venv_python), __file__] + sys.argv[1:],
        cwd=str(PROJECT_ROOT),
        env=env,
        timeout=30,
    )
    sys.exit(result.returncode)

from libs.ai_command_helper import AICommandHelper
from libs.ai_growth_todo_manager import AIGrowthTodoManager
from libs.process_monitor import ProcessMonitor


def main():
    parser = argparse.ArgumentParser(description="AIè‡ªå¾‹å‹ToDoãƒªã‚¹ãƒˆç®¡ç†")
    subparsers = parser.add_subparsers(dest="command", help="å®Ÿè¡Œã™ã‚‹ã‚³ãƒãƒ³ãƒ‰")

    # create ã‚³ãƒãƒ³ãƒ‰
    create_parser = subparsers.add_parser("create", help="æ–°ã—ã„ToDoãƒªã‚¹ãƒˆã‚’ä½œæˆ")
    create_parser.add_argument("name", help="ToDoãƒªã‚¹ãƒˆå")
    create_parser.add_argument("--tasks-file", help="ã‚¿ã‚¹ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆJSONå½¢å¼ï¼‰")

    # add ã‚³ãƒãƒ³ãƒ‰
    add_parser = subparsers.add_parser("add", help="ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ")
    add_parser.add_argument("todo_name", help="ToDoãƒªã‚¹ãƒˆå")
    add_parser.add_argument("description", help="ã‚¿ã‚¹ã‚¯ã®èª¬æ˜")
    add_parser.add_argument(
        "type", choices=["bash", "python", "ai-send", "command"], help="ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—"
    )
    add_parser.add_argument("content", help="å®Ÿè¡Œå†…å®¹")
    add_parser.add_argument(
        "--priority", choices=["low", "normal", "high"], default="normal"
    )

    # run ã‚³ãƒãƒ³ãƒ‰
    run_parser = subparsers.add_parser("run", help="ToDoãƒªã‚¹ãƒˆã‚’å®Ÿè¡Œ")
    run_parser.add_argument("name", help="å®Ÿè¡Œã™ã‚‹ToDoãƒªã‚¹ãƒˆå")
    run_parser.add_argument(
        "--async-mode", action="store_true", help="éåŒæœŸå®Ÿè¡Œï¼ˆAI Command Executorä½¿ç”¨ï¼‰"
    )

    # status ã‚³ãƒãƒ³ãƒ‰
    status_parser = subparsers.add_parser("status", help="ToDoãƒªã‚¹ãƒˆã®çŠ¶æ…‹ç¢ºèª")
    status_parser.add_argument("name", nargs="?", help="ToDoãƒªã‚¹ãƒˆåï¼ˆçœç•¥æ™‚ã¯å…¨ã¦ï¼‰")

    # learn ã‚³ãƒãƒ³ãƒ‰
    learn_parser = subparsers.add_parser("learn", help="å­¦ç¿’å†…å®¹ã‚’è¡¨ç¤º")
    learn_parser.add_argument("--days", type=int, default=7, help="éå»næ—¥é–“ã®å­¦ç¿’å†…å®¹")

    # daily ã‚³ãƒãƒ³ãƒ‰
    daily_parser = subparsers.add_parser("daily", help="æ—¥æ¬¡è‡ªå·±æ”¹å–„ToDoã‚’ä½œæˆãƒ»å®Ÿè¡Œ")

    # list ã‚³ãƒãƒ³ãƒ‰ï¼ˆstatusã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹ï¼‰
    list_parser = subparsers.add_parser("list", help="ToDoãƒªã‚¹ãƒˆä¸€è¦§ï¼ˆstatusã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹ï¼‰")

    args = parser.parse_args()

    # ãƒ—ãƒ­ã‚»ã‚¹ç›£è¦–ã«ã‚ˆã‚‹å®‰å…¨æ€§ãƒã‚§ãƒƒã‚¯
    monitor = ProcessMonitor(max_processes=8, max_memory_mb=800)
    health = monitor.check_system_health()
    if not health["healthy"]:
        print(f"âš ï¸ ã‚·ã‚¹ãƒ†ãƒ ç•°å¸¸æ¤œå‡º: {health['issues']}")
        print("å®‰å…¨ã®ãŸã‚å®Ÿè¡Œã‚’åœæ­¢ã—ã¾ã™ã€‚")
        sys.exit(1)

    # ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼åˆæœŸåŒ–
    manager = AIGrowthTodoManager()
    helper = AICommandHelper()

    if args.command == "create":
        if args.tasks_file:
            with open(args.tasks_file, "r") as f:
                tasks = json.load(f)
        else:
            # ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ã«ã‚¿ã‚¹ã‚¯ã‚’å…¥åŠ›
            tasks = []
            print("ã‚¿ã‚¹ã‚¯ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆç©ºè¡Œã§çµ‚äº†ï¼‰:")
            while True:
                desc = input("èª¬æ˜: ").strip()
                if not desc:
                    break
                task_type = input("ã‚¿ã‚¤ãƒ— (bash/python/ai-send): ").strip()
                content = input("å†…å®¹: ").strip()
                tasks.append(
                    {"description": desc, "type": task_type, "content": content}
                )

        todo = manager.create_todo_list(args.name, tasks)
        print(f"âœ… ToDoãƒªã‚¹ãƒˆ '{args.name}' ã‚’ä½œæˆã—ã¾ã—ãŸï¼ˆ{len(tasks)}ã‚¿ã‚¹ã‚¯ï¼‰")

    elif args.command == "run":
        if args.async_mode:
            # AI Command ExecutorçµŒç”±ã§éåŒæœŸå®Ÿè¡Œ
            script = f"""
from libs.ai_growth_todo_manager import AIGrowthTodoManager
manager = AIGrowthTodoManager()
manager.process_todo_with_learning("{args.name}")
"""
            helper.create_python_command(script, f"run_todo_{args.name}")
            print(f"âœ… ToDoãƒªã‚¹ãƒˆ '{args.name}' ã‚’éåŒæœŸå®Ÿè¡Œã‚­ãƒ¥ãƒ¼ã«è¿½åŠ ã—ã¾ã—ãŸ")
            print("â³ 6ç§’å¾Œã«è‡ªå‹•å®Ÿè¡Œã•ã‚Œã¾ã™...")
        else:
            # åŒæœŸå®Ÿè¡Œ
            print(f"ğŸš€ ToDoãƒªã‚¹ãƒˆ '{args.name}' ã‚’å®Ÿè¡Œä¸­...")
            result = manager.process_todo_with_learning(args.name)
            print("âœ… å®Ÿè¡Œå®Œäº†")

    elif args.command == "status":
        todo_dir = PROJECT_ROOT / "ai_todo"
        if args.name:
            # ç‰¹å®šã®ToDoãƒªã‚¹ãƒˆã®çŠ¶æ…‹
            result_files = list(todo_dir.glob(f"{args.name}_result_*.json"))
            if result_files:
                latest = max(result_files, key=lambda x: x.stat().st_mtime)
                with open(latest, "r") as f:
                    result = json.load(f)
                print(f"ToDoãƒªã‚¹ãƒˆ: {result['todo_name']}")
                print(f"å®Ÿè¡Œæ—¥æ™‚: {result['execution_date']}")
                print(
                    f"æˆåŠŸç‡: {result['success_rate']*100:.1f}% ({result['successful']}/{result['total_tasks']})"
                )
                print(f"å®Ÿè¡Œæ™‚é–“: {result['total_duration']:.2f}ç§’")
            else:
                print(f"ToDoãƒªã‚¹ãƒˆ '{args.name}' ã®å®Ÿè¡ŒçµæœãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
        else:
            # å…¨ToDoãƒªã‚¹ãƒˆã®ä¸€è¦§
            todo_files = list(todo_dir.glob("*_[0-9]*.json"))
            todo_names = set()
            for f in todo_files:
                if "_result_" not in f.name:
                    name = f.name.split("_")[0]
                    todo_names.add(name)

            print("ğŸ“‹ ToDoãƒªã‚¹ãƒˆä¸€è¦§:")
            for name in sorted(todo_names):
                print(f"  - {name}")

    elif args.command == "learn":
        insights = manager.get_learning_insights(args.days)
        print(f"ğŸ§  éå»{args.days}æ—¥é–“ã®å­¦ç¿’å†…å®¹:")
        print(f"ç·å­¦ç¿’æ•°: {insights['total_learnings']}")

        if insights["error_patterns"]:
            print("\nã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³:")
            for error, count in insights["error_patterns"].items():
                print(f"  - {error}: {count}å›")

        if insights["performance_tips"]:
            print("\nãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–:")
            for tip in insights["performance_tips"][:5]:
                print(f"  - {tip}")

        if insights["auto_fixes"]:
            print("\nè‡ªå‹•ä¿®æ­£:")
            for fix in insights["auto_fixes"][:5]:
                print(f"  - {fix}")

    elif args.command == "daily":
        print("ğŸ“… æ—¥æ¬¡è‡ªå·±æ”¹å–„ToDoã‚’ä½œæˆä¸­...")
        todo = manager.create_daily_todo()
        print(f"âœ… ä½œæˆå®Œäº†: {len(todo['tasks'])}ã‚¿ã‚¹ã‚¯")

        # è‡ªå‹•å®Ÿè¡Œ
        script = """
from libs.ai_growth_todo_manager import AIGrowthTodoManager
manager = AIGrowthTodoManager()
manager.process_todo_with_learning("daily_self_improvement")
"""
        helper.create_python_command(script, "daily_todo_execution")
        print("â³ 6ç§’å¾Œã«è‡ªå‹•å®Ÿè¡Œã•ã‚Œã¾ã™...")

    elif args.command == "list":
        # listã‚³ãƒãƒ³ãƒ‰ã¯statusã¨åŒã˜å‡¦ç†ï¼ˆå¼•æ•°ãªã—ï¼‰
        todo_dir = PROJECT_ROOT / "ai_todo"
        todo_files = list(todo_dir.glob("*_[0-9]*.json"))
        todo_names = set()
        for f in todo_files:
            if "_result_" not in f.name:
                name = f.name.split("_")[0]
                todo_names.add(name)

        print("ğŸ“‹ ToDoãƒªã‚¹ãƒˆä¸€è¦§:")
        for name in sorted(todo_names):
            print(f"  - {name}")

    else:
        parser.print_help()


if __name__ == "__main__":
    main()
