#!/usr/bin/env python3
"""
AI Company Workspace Manager CLI
Manages secure project workspaces with Docker isolation
"""

import sys
import argparse
import json
from pathlib import Path

# Add project root to path
PROJECT_ROOT = Path(__file__).parent.parent
sys.path.insert(0, str(PROJECT_ROOT))

from libs.auto_project_manager import AutoProjectManager
from libs.shared_enums import SecurityLevel
from libs.ai_project_placement_manager import AIProjectPlacementManager, PlacementStrategy

def main():
    parser = argparse.ArgumentParser(
        description='AI Company Workspace Manager',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
ä½¿ç”¨ä¾‹:
  # æ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
  ai-workspace create "My Web App" --type web --description "FastAPI web application"
  
  # è¦ä»¶ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
  ai-workspace create-from-file requirements.json --name "Generated Project"
  
  # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§è¡¨ç¤º
  ai-workspace list
  
  # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè©³ç´°æƒ…å ±
  ai-workspace status "my_web_app"
  
  # Dockerç’°å¢ƒèµ·å‹•
  ai-workspace start "my_web_app"
  
  # Dockerç’°å¢ƒåœæ­¢
  ai-workspace stop "my_web_app"

ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ™ãƒ«:
  - sandbox: å®Œå…¨éš”é›¢ï¼ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¯ã‚»ã‚¹ãªã—ï¼‰
  - restricted: åˆ¶é™ä»˜ãã‚¢ã‚¯ã‚»ã‚¹ï¼ˆé™å®šçš„ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ï¼‰
  - development: æ¨™æº–é–‹ç™ºç’°å¢ƒ
  - trusted: ä¿¡é ¼æ¸ˆã¿ï¼ˆæ‰‹å‹•æ‰¿èªå¿…è¦ï¼‰
        """
    )
    
    subparsers = parser.add_subparsers(dest='command', help='Commands')
    
    # create ã‚³ãƒãƒ³ãƒ‰
    create_parser = subparsers.add_parser('create', help='æ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ')
    create_parser.add_argument('name', help='ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå')
    create_parser.add_argument('--description', help='ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®èª¬æ˜')
    create_parser.add_argument('--dependencies', nargs='*', help='ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸')
    create_parser.add_argument('--features', nargs='*', help='æ©Ÿèƒ½ãƒªã‚¹ãƒˆ')
    create_parser.add_argument('--security-level', 
                             choices=['sandbox', 'restricted', 'development', 'trusted'],
                             help='ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ™ãƒ«ï¼ˆè‡ªå‹•æ¤œå‡ºã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ï¼‰')
    create_parser.add_argument('--strategy',
                             choices=['security_first', 'balanced', 'dev_focused', 'performance'],
                             default='balanced',
                             help='é…ç½®æˆ¦ç•¥ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: balancedï¼‰')
    create_parser.add_argument('--development-phase',
                             choices=['prototype', 'development', 'testing', 'production'],
                             default='development',
                             help='é–‹ç™ºãƒ•ã‚§ãƒ¼ã‚º')
    create_parser.add_argument('--team-access-level',
                             choices=['junior', 'senior', 'architect', 'admin'], 
                             default='senior',
                             help='ãƒãƒ¼ãƒ ã‚¢ã‚¯ã‚»ã‚¹ãƒ¬ãƒ™ãƒ«')
    create_parser.add_argument('--intelligent', action='store_true',
                             help='ã‚¤ãƒ³ãƒ†ãƒªã‚¸ã‚§ãƒ³ãƒˆé…ç½®ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ç”¨')
    
    # create-from-file ã‚³ãƒãƒ³ãƒ‰
    file_parser = subparsers.add_parser('create-from-file', 
                                       help='è¦ä»¶ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ')
    file_parser.add_argument('requirements_file', help='è¦ä»¶JSONãƒ•ã‚¡ã‚¤ãƒ«')
    file_parser.add_argument('--name', help='ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåï¼ˆæŒ‡å®šã—ãªã„å ´åˆã¯è¦ä»¶ã‹ã‚‰æ¨å®šï¼‰')
    file_parser.add_argument('--security-level',
                           choices=['sandbox', 'restricted', 'development', 'trusted'],
                           help='ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ™ãƒ«ï¼ˆè‡ªå‹•æ¤œå‡ºã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ï¼‰')
    
    # list ã‚³ãƒãƒ³ãƒ‰
    list_parser = subparsers.add_parser('list', help='ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§è¡¨ç¤º')
    list_parser.add_argument('--security-level', 
                           choices=['sandbox', 'restricted', 'development', 'trusted'],
                           help='ç‰¹å®šã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ™ãƒ«ã®ã¿è¡¨ç¤º')
    
    # status ã‚³ãƒãƒ³ãƒ‰
    status_parser = subparsers.add_parser('status', help='ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè©³ç´°æƒ…å ±')
    status_parser.add_argument('name', help='ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå')
    
    # start ã‚³ãƒãƒ³ãƒ‰
    start_parser = subparsers.add_parser('start', help='Dockerç’°å¢ƒèµ·å‹•')
    start_parser.add_argument('name', help='ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå')
    
    # stop ã‚³ãƒãƒ³ãƒ‰
    stop_parser = subparsers.add_parser('stop', help='Dockerç’°å¢ƒåœæ­¢')
    stop_parser.add_argument('name', help='ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå')
    
    # analyze ã‚³ãƒãƒ³ãƒ‰
    analyze_parser = subparsers.add_parser('analyze', help='ãƒªã‚¹ã‚¯åˆ†æï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆå‰ï¼‰')
    analyze_parser.add_argument('requirements_file', help='è¦ä»¶JSONãƒ•ã‚¡ã‚¤ãƒ«')
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    manager = AutoProjectManager()
    placement_manager = AIProjectPlacementManager()
    
    try:
        if args.command == 'create':
            requirements = {
                'description': args.description or f'{args.name} project',
                'dependencies': args.dependencies or [],
                'features': args.features or [],
                'development_phase': args.development_phase,
                'team_access_level': args.team_access_level
            }
            
            if args.intelligent:
                # Use intelligent placement system
                strategy_mapping = {
                    'security_first': PlacementStrategy.SECURITY_FIRST,
                    'balanced': PlacementStrategy.BALANCED,
                    'dev_focused': PlacementStrategy.DEVELOPMENT_FOCUSED,
                    'performance': PlacementStrategy.PERFORMANCE_OPTIMIZED
                }
                strategy = strategy_mapping.get(args.strategy, PlacementStrategy.BALANCED)
                
                project_path, placement_info = placement_manager.create_project_with_intelligent_placement(
                    args.name, requirements, strategy
                )
                
                recommendation = placement_info["placement_recommendation"]
                risk = placement_info["risk_assessment"]
                
                print(f"âœ… ã‚¤ãƒ³ãƒ†ãƒªã‚¸ã‚§ãƒ³ãƒˆé…ç½®ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆå®Œäº†:")
                print(f"   ğŸ“ ãƒ‘ã‚¹: {project_path}")
                print(f"   ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ™ãƒ«: {recommendation.security_level.value}")
                print(f"   ğŸ“Š ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«: {risk.level}")
                print(f"   ğŸ¯ é…ç½®ä¿¡é ¼åº¦: {recommendation.confidence_score:.2f}")
                print(f"   â±ï¸  ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ™‚é–“: {recommendation.estimated_setup_time}åˆ†")
                print(f"   ğŸ” åˆ†é›¢ã‚¿ã‚¤ãƒ—: {recommendation.isolation_type}")
                
                print(f"\nğŸ“‹ é…ç½®ç†ç”±:")
                for justification in recommendation.justification:
                    print(f"   âœ“ {justification}")
                
                if recommendation.warnings:
                    print(f"\nâš ï¸  æ³¨æ„äº‹é …:")
                    for warning in recommendation.warnings:
                        print(f"   {warning}")
                
                print(f"\nğŸš€ é–‹ç™ºã‚’é–‹å§‹ã™ã‚‹ã«ã¯:")
                print(f"   ai-workspace start {project_path.name}")
            else:
                # Use traditional placement system
                security_override = None
                if args.security_level:
                    security_override = SecurityLevel(args.security_level)
                
                project_path, risk = manager.create_project(args.name, requirements, security_override)
                
                print(f"âœ… ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆå®Œäº†:")
                print(f"   ğŸ“ ãƒ‘ã‚¹: {project_path}")
                print(f"   ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ™ãƒ«: {risk.recommended_security.value}")
                print(f"   ğŸ“Š ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«: {risk.level}")
                if risk.factors:
                    print(f"   âš ï¸  ãƒªã‚¹ã‚¯è¦å› : {', '.join(risk.factors)}")
                
                print(f"\nğŸš€ é–‹ç™ºã‚’é–‹å§‹ã™ã‚‹ã«ã¯:")
                print(f"   ai-workspace start {project_path.name}")
            
        elif args.command == 'create-from-file':
            with open(args.requirements_file, 'r', encoding='utf-8') as f:
                requirements = json.load(f)
            
            project_name = args.name or requirements.get('name', 'generated_project')
            
            security_override = None
            if args.security_level:
                security_override = SecurityLevel(args.security_level)
            
            project_path, risk = manager.create_project(project_name, requirements, security_override)
            
            print(f"âœ… ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆå®Œäº†:")
            print(f"   ğŸ“ ãƒ‘ã‚¹: {project_path}")
            print(f"   ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ™ãƒ«: {risk.recommended_security.value}")
            print(f"   ğŸ“Š ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«: {risk.level}")
            
        elif args.command == 'list':
            projects_by_level = manager.list_projects()
            
            total_projects = 0
            for level, projects in projects_by_level.items():
                if args.security_level and level != args.security_level:
                    continue
                
                if projects:
                    print(f"\nğŸ”’ {level.upper()} ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ™ãƒ«:")
                    print("=" * 50)
                    for project in projects:
                        print(f"ğŸ“ {project['name']}")
                        print(f"   ãƒ‘ã‚¹: {project['path']}")
                        print(f"   ä½œæˆæ—¥: {project['created'][:10]}")
                        print()
                        total_projects += 1
            
            if total_projects == 0:
                print("ğŸ“­ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
            else:
                print(f"åˆè¨ˆ: {total_projects} ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ")
        
        elif args.command == 'status':
            status = manager.get_project_status(args.name)
            if status:
                print(f"ğŸ“ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: {status['name']}")
                print(f"ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ™ãƒ«: {status['security_level']}")
                print(f"ğŸ“ ãƒ‘ã‚¹: {status['path']}")
                print(f"ğŸ“… ä½œæˆæ—¥: {status['created'][:10]}")
                print(f"ğŸ³ Dockerå®Ÿè¡Œä¸­: {'âœ… Yes' if status['docker_running'] else 'âŒ No'}")
                print(f"ğŸ”— GitHubçµ±åˆ: {'âœ… Yes' if status['github_integration'] else 'âŒ No'}")
            else:
                print(f"âŒ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ '{args.name}' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
                return
        
        elif args.command == 'start':
            status = manager.get_project_status(args.name)
            if not status:
                print(f"âŒ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ '{args.name}' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
                return
            
            project_path = Path(status['path'])
            start_script = project_path / ".docker" / "start.sh"
            
            if start_script.exists():
                import subprocess
                print(f"ğŸš€ Dockerç’°å¢ƒã‚’èµ·å‹•ä¸­...")
                result = subprocess.run([str(start_script)], cwd=str(project_path), 
                                      capture_output=True, text=True)
                
                if result.returncode == 0:
                    print("âœ… Dockerç’°å¢ƒãŒæ­£å¸¸ã«èµ·å‹•ã—ã¾ã—ãŸ")
                    print(f"ğŸ”— ã‚¢ã‚¯ã‚»ã‚¹: docker exec -it {args.name}_{status['security_level']} bash")
                else:
                    print(f"âŒ èµ·å‹•ã‚¨ãƒ©ãƒ¼: {result.stderr}")
            else:
                print("âŒ Dockerè¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
        
        elif args.command == 'stop':
            status = manager.get_project_status(args.name)
            if not status:
                print(f"âŒ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ '{args.name}' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
                return
            
            project_path = Path(status['path'])
            stop_script = project_path / ".docker" / "stop.sh"
            
            if stop_script.exists():
                import subprocess
                print(f"ğŸ›‘ Dockerç’°å¢ƒã‚’åœæ­¢ä¸­...")
                result = subprocess.run([str(stop_script)], cwd=str(project_path),
                                      capture_output=True, text=True)
                
                if result.returncode == 0:
                    print("âœ… Dockerç’°å¢ƒãŒæ­£å¸¸ã«åœæ­¢ã—ã¾ã—ãŸ")
                else:
                    print(f"âŒ åœæ­¢ã‚¨ãƒ©ãƒ¼: {result.stderr}")
            else:
                print("âŒ Dockerè¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
        
        elif args.command == 'analyze':
            with open(args.requirements_file, 'r', encoding='utf-8') as f:
                requirements = json.load(f)
            
            project_content = json.dumps(requirements, default=str)
            risk = manager.analyze_project_risk(project_content, requirements)
            
            print(f"ğŸ” ãƒªã‚¹ã‚¯åˆ†æçµæœ:")
            print(f"   ğŸ“Š ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«: {risk.level}")
            print(f"   ğŸ”’ æ¨å¥¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ™ãƒ«: {risk.recommended_security.value}")
            print(f"   ğŸ—ï¸  éš”é›¢ãŒå¿…è¦: {'Yes' if risk.isolation_required else 'No'}")
            print(f"   âœ‹ æ‰‹å‹•æ‰¿èªãŒå¿…è¦: {'Yes' if risk.manual_approval else 'No'}")
            
            if risk.factors:
                print(f"   âš ï¸  æ¤œå‡ºã•ã‚ŒãŸãƒªã‚¹ã‚¯è¦å› :")
                for factor in risk.factors:
                    print(f"     - {factor}")
    
    except Exception as e:
        print(f"âŒ ã‚¨ãƒ©ãƒ¼: {e}")
        sys.exit(1)

if __name__ == "__main__":
    main()