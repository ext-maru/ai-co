#!/usr/bin/env python3
"""
Claude Todo Hook Helper
Claude Codeã®TodoRead/TodoWriteæ“ä½œã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã—ã¦ãƒ†ã‚¹ãƒˆ
"""

import asyncio
import json
import sys
from datetime import datetime
from pathlib import Path

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã‚’ãƒ‘ã‚¹ã«è¿½åŠ 
project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))

from libs.todo_tracker_integration import TodoTrackerIntegration


async def simulate_todo_write(todos):
    """TodoWriteæ“ä½œã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ"""
    hook_file = Path.home() / ".claude_todo_hook"
    
    # TodoListãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ãƒƒã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãè¾¼ã¿
    with open(hook_file, 'w', encoding='utf-8') as f:
        json.dump(todos, f, ensure_ascii=False, indent=2)
    
    print(f"âœ… TodoWrite simulated: {len(todos)} items written to hook file")
    print(f"   File: {hook_file}")


async def simulate_todo_read():
    """TodoReadæ“ä½œã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ"""
    current_file = Path.home() / ".claude_todo_current.json"
    
    if current_file.exists():
        with open(current_file, 'r', encoding='utf-8') as f:
            todos = json.load(f)
        
        print(f"ğŸ“‹ TodoRead result: {len(todos)} items")
        for todo in todos:
            status_emoji = {
                "pending": "ğŸ“‹",
                "in_progress": "ğŸ”„",
                "completed": "âœ…"
            }.get(todo.get("status", "pending"), "â“")
            
            priority_emoji = {
                "high": "ğŸ”´",
                "medium": "ğŸŸ¡",
                "low": "ğŸŸ¢"
            }.get(todo.get("priority", "medium"), "âšª")
            
            print(f"  {status_emoji} {priority_emoji} {todo.get('content', 'No content')}")
    else:
        print("ğŸ“‹ TodoRead result: No todos found")


async def test_integration():
    """çµ±åˆãƒ†ã‚¹ãƒˆ"""
    print("ğŸ§ª Claude Todo Hook Integration Test")
    print("=" * 50)
    
    # 1. åˆæœŸçŠ¶æ…‹ã‚’ç¢ºèª
    print("\n1ï¸âƒ£ Initial TodoRead:")
    await simulate_todo_read()
    
    # 2. æ–°ã—ã„Todoã‚’è¿½åŠ 
    print("\n2ï¸âƒ£ Simulating TodoWrite with new items:")
    test_todos = [
        {
            "id": "test-1",
            "content": "OAuth2.0èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã®å®Ÿè£…",
            "status": "in_progress",
            "priority": "high"
        },
        {
            "id": "test-2",
            "content": "ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã®è¿½åŠ ",
            "status": "pending",
            "priority": "medium"
        },
        {
            "id": "test-3",
            "content": "ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ›´æ–°",
            "status": "pending",
            "priority": "low"
        }
    ]
    await simulate_todo_write(test_todos)
    
    # 3. Todoç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ãŒå‡¦ç†ã™ã‚‹ã®ã‚’å¾…ã¤
    print("\n3ï¸âƒ£ Waiting for monitor to process (5 seconds)...")
    await asyncio.sleep(5)
    
    # 4. PostgreSQLã‹ã‚‰åŒæœŸã•ã‚ŒãŸçµæœã‚’ç¢ºèª
    print("\n4ï¸âƒ£ Checking synchronized result:")
    await simulate_todo_read()
    
    # 5. ã‚¿ã‚¹ã‚¯ãƒˆãƒ©ãƒƒã‚«ãƒ¼ã®çŠ¶æ…‹ã‚’ç¢ºèª
    print("\n5ï¸âƒ£ Checking task tracker status:")
    try:
        integration = TodoTrackerIntegration(
            auto_sync=False,
            user_id="claude_elder"
        )
        await integration.initialize()
        
        sync_status = await integration.get_sync_status()
        my_stats = sync_status.get("my_tasks_stats", {})
        
        print(f"   PostgreSQL Tasks:")
        print(f"   - Total: {my_stats.get('total', 0)}")
        print(f"   - Pending: {my_stats.get('pending', 0)}")
        print(f"   - In Progress: {my_stats.get('in_progress', 0)}")
        print(f"   - Completed: {my_stats.get('completed', 0)}")
        
        await integration.tracker.close()
        
    except Exception as e:
        print(f"   âŒ Error: {e}")
    
    print("\nâœ… Test completed!")


async def get_system_status():
    """ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ã‚’å–å¾—"""
    print("ğŸ” Claude Todo ãƒ•ãƒƒã‚¯ ã‚·ã‚¹ãƒ†ãƒ  çŠ¶æ…‹ç¢ºèª")
    print("=" * 50)
    
    status = {
        "timestamp": datetime.now().isoformat(),
        "hook_files": {},
        "integration_status": {},
        "monitor_status": {}
    }
    
    # 1. ãƒ•ãƒƒã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã®çŠ¶æ…‹ç¢ºèª
    print("\n1ï¸âƒ£ ãƒ•ãƒƒã‚¯ãƒ•ã‚¡ã‚¤ãƒ«çŠ¶æ…‹:")
    hook_file = Path.home() / ".claude_todo_hook"
    current_file = Path.home() / ".claude_todo_current.json"
    monitor_pid = Path.home() / ".claude_todo_monitor.pid"
    
    files_to_check = {
        "ãƒ•ãƒƒã‚¯ãƒ•ã‚¡ã‚¤ãƒ«": hook_file,
        "ç¾åœ¨ã®Todoãƒ•ã‚¡ã‚¤ãƒ«": current_file,
        "ç›£è¦–ãƒ—ãƒ­ã‚»ã‚¹PID": monitor_pid
    }
    
    for name, file_path in files_to_check.items():
        if file_path.exists():
            stat = file_path.stat()
            size = stat.st_size
            modified = datetime.fromtimestamp(stat.st_mtime).isoformat()
            status["hook_files"][name] = {
                "exists": True,
                "path": str(file_path),
                "size": size,
                "modified": modified
            }
            print(f"  âœ… {name}: {size}ãƒã‚¤ãƒˆ (æ›´æ–°: {modified})")
        else:
            status["hook_files"][name] = {
                "exists": False,
                "path": str(file_path)
            }
            print(f"  âŒ {name}: è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
    
    # 2. çµ±åˆã‚·ã‚¹ãƒ†ãƒ ã®çŠ¶æ…‹ç¢ºèª
    print("\n2ï¸âƒ£ çµ±åˆã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹:")
    try:
        integration = TodoTrackerIntegration(
            auto_sync=False,
            user_id="claude_elder"
        )
        await integration.initialize()
        
        sync_status = await integration.get_sync_status()
        status["integration_status"] = sync_status
        
        print(f"  âœ… PostgreSQLæ¥ç¶š: æ­£å¸¸")
        print(f"  ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼: {sync_status.get('user_id')} ã•ã‚“")
        print(f"  ğŸ“‹ ç®¡ç†ä¸­Todo: {sync_status.get('todo_count', 0)}å€‹")
        print(f"  ğŸ”„ è‡ªå‹•åŒæœŸ: {'ğŸŸ¢ æœ‰åŠ¹' if sync_status.get('auto_sync_enabled') else 'ğŸ”´ ç„¡åŠ¹'}")
        print(f"  ğŸ“Š å€‹äººã‚¿ã‚¹ã‚¯æ•°: {sync_status.get('my_tasks_stats', {}).get('total', 0)}å€‹")
        
        if hasattr(integration.tracker, 'close'):
            await integration.tracker.close()
            
    except Exception as e:
        status["integration_status"] = {"error": str(e)}
        print(f"  âŒ Integration Error: {e}")
    
    # 3. ãƒ¢ãƒ‹ã‚¿ãƒ¼ãƒ—ãƒ­ã‚»ã‚¹ã®çŠ¶æ…‹
    print("\n3ï¸âƒ£ Monitor Process Status:")
    if monitor_pid.exists():
        try:
            with open(monitor_pid, 'r') as f:
                pid = int(f.read().strip())
            
            # ãƒ—ãƒ­ã‚»ã‚¹ã®ç”Ÿå­˜ç¢ºèª
            import psutil
            if psutil.pid_exists(pid):
                process = psutil.Process(pid)
                status["monitor_status"] = {
                    "running": True,
                    "pid": pid,
                    "name": process.name(),
                    "cpu_percent": process.cpu_percent(),
                    "memory_percent": process.memory_percent()
                }
                print(f"  âœ… Monitor Running: PID {pid}")
                print(f"  ğŸ’¾ Memory: {process.memory_percent():.1f}%")
                print(f"  âš¡ CPU: {process.cpu_percent()}%")
            else:
                status["monitor_status"] = {"running": False, "stale_pid": pid}
                print(f"  âŒ Monitor Not Running (stale PID: {pid})")
                
        except Exception as e:
            status["monitor_status"] = {"error": str(e)}
            print(f"  âŒ Monitor Check Error: {e}")
    else:
        status["monitor_status"] = {"running": False}
        print(f"  âŒ Monitor PID file not found")
    
    # 4. æœ€è¿‘ã®Todoæ´»å‹•
    print("\n4ï¸âƒ£ Recent Todo Activity:")
    if current_file.exists():
        with open(current_file, 'r', encoding='utf-8') as f:
            todos = json.load(f)
        
        print(f"  ğŸ“‹ Active Todos: {len(todos)}")
        for i, todo in enumerate(todos[:3], 1):
            status_emoji = {"pending": "ğŸ“‹", "in_progress": "ğŸ”„", "completed": "âœ…"}.get(todo.get("status"), "â“")
            priority_emoji = {"high": "ğŸ”´", "medium": "ğŸŸ¡", "low": "ğŸŸ¢"}.get(todo.get("priority"), "âšª")
            print(f"    {i}. {status_emoji} {priority_emoji} {todo.get('content', 'No content')[:50]}...")
    else:
        print(f"  ğŸ“­ No active todos found")
    
    print(f"\nâœ… Status check completed!")
    return status


def main():
    """ãƒ¡ã‚¤ãƒ³å‡¦ç†"""
    if len(sys.argv) < 2:
        print("Usage: claude-todo-hook <command>")
        print("Commands:")
        print("  test     - Run integration test")
        print("  write    - Simulate TodoWrite (provide JSON via stdin)")
        print("  read     - Simulate TodoRead")
        print("  status   - Show system status")
        sys.exit(1)
    
    command = sys.argv[1]
    
    if command == "test":
        asyncio.run(test_integration())
    
    elif command == "write":
        # æ¨™æº–å…¥åŠ›ã‹ã‚‰JSONã‚’èª­ã‚€
        try:
            todos = json.load(sys.stdin)
            asyncio.run(simulate_todo_write(todos))
        except json.JSONDecodeError as e:
            print(f"âŒ Invalid JSON: {e}")
            sys.exit(1)
    
    elif command == "read":
        asyncio.run(simulate_todo_read())
    
    elif command == "status":
        asyncio.run(get_system_status())
    
    else:
        print(f"âŒ Unknown command: {command}")
        sys.exit(1)


if __name__ == "__main__":
    main()