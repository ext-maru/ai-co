<<<<<<< HEAD
#!/usr/bin/env python3
"""
EITMS Command Line Interface
統合タスク管理システムの簡易CLIツール
"""

import os
import sys
import json
import argparse
import requests
from datetime import datetime
from tabulate import tabulate

# API設定
API_BASE_URL = os.getenv('EITMS_API_URL', 'http://localhost:8006')
API_KEY = os.getenv('EITMS_API_KEY', '')

def get_headers():
    """APIヘッダーを取得"""
    return {
        'X-EITMS-API-Key': API_KEY,
        'Content-Type': 'application/json'
    }

def format_datetime(dt_str):
    """日時文字列をフォーマット"""
    if not dt_str:
        return '-'
    try:
        dt = datetime.fromisoformat(dt_str.replace('Z', '+00:00'))
        return dt.strftime('%Y-%m-%d %H:%M')
    except:
        return dt_str

def list_tasks(args):
    """タスク一覧を表示"""
    params = {}
    if args.status:
        params['status'] = args.status
    if args.assignee:
        params['assignee'] = args.assignee
    if args.priority:
        params['priority'] = args.priority
    
    try:
        response = requests.get(
            f"{API_BASE_URL}/api/tasks",
            headers=get_headers(),
            params=params
        )
        response.raise_for_status()
        
        tasks = response.json()
        
        if not tasks:
            print("No tasks found.")
            return
        
        # テーブル形式で表示
        table_data = []
        for task in tasks:
            table_data.append([
                task.get('id', '')[:8],
                task.get('title', '')[:50],
                task.get('status', ''),
                task.get('priority', ''),
                task.get('assignee', '-'),
                format_datetime(task.get('created_at'))
            ])
        
        print(tabulate(
            table_data,
            headers=['ID', 'Title', 'Status', 'Priority', 'Assignee', 'Created'],
            tablefmt='grid'
        ))
        
    except requests.exceptions.RequestException as e:
        print(f"Error: {e}")
        sys.exit(1)

def create_task(args):
    """新規タスクを作成"""
    task_data = {
        'title': args.title,
        'description': args.description or '',
        'priority': args.priority,
        'assignee': args.assignee
    }
    
    if args.labels:
        task_data['labels'] = args.labels.split(',')
    
    try:
        response = requests.post(
            f"{API_BASE_URL}/api/tasks",
            headers=get_headers(),
            json=task_data
        )
        response.raise_for_status()
        
        task = response.json()
        print(f"Task created successfully!")
        print(f"ID: {task['id']}")
        print(f"Title: {task['title']}")
        
    except requests.exceptions.RequestException as e:
        print(f"Error: {e}")
        if hasattr(e, 'response') and e.response is not None:
            print(f"Response: {e.response.text}")
        sys.exit(1)

def update_task(args):
    """タスクを更新"""
    update_data = {}
    
    if args.status:
        update_data['status'] = args.status
    if args.priority:
        update_data['priority'] = args.priority
    if args.assignee:
        update_data['assignee'] = args.assignee
    if args.title:
        update_data['title'] = args.title
    
    if not update_data:
        print("No updates specified.")
        return
    
    try:
        response = requests.put(
            f"{API_BASE_URL}/api/tasks/{args.task_id}",
            headers=get_headers(),
            json=update_data
        )
        response.raise_for_status()
        
        print("Task updated successfully!")
        
    except requests.exceptions.RequestException as e:
        print(f"Error: {e}")
        sys.exit(1)

def search_tasks(args):
    """タスクを検索"""
    try:
        response = requests.get(
            f"{API_BASE_URL}/api/search",
            headers=get_headers(),
            params={'q': args.query}
        )
        response.raise_for_status()
        
        results = response.json()
        
        if not results:
            print("No tasks found.")
            return
        
        print(f"Found {len(results)} task(s):\n")
        
        for task in results:
            print(f"ID: {task['id'][:8]}")
            print(f"Title: {task['title']}")
            print(f"Status: {task['status']} | Priority: {task['priority']}")
            print(f"Score: {task.get('score', 0):.2f}")
            print("-" * 50)
        
    except requests.exceptions.RequestException as e:
        print(f"Error: {e}")
        sys.exit(1)

def optimize_tasks(args):
    """タスクを最適化"""
    endpoint = f"/api/optimize/{args.type}"
    
    try:
        response = requests.post(
            f"{API_BASE_URL}{endpoint}",
            headers=get_headers()
        )
        response.raise_for_status()
        
        result = response.json()
        print(f"Optimization complete: {args.type}")
        
        if 'suggestions' in result:
            print("\nSuggestions:")
            for suggestion in result['suggestions']:
                print(f"- {suggestion}")
        
    except requests.exceptions.RequestException as e:
        print(f"Error: {e}")
        sys.exit(1)

def system_status(args):
    """システムステータスを表示"""
    services = [
        ('GitHub Connector', 8001),
        ('Task Tracker', 8002),
        ('Todo Bridge', 8003),
        ('Real-time Sync', 8004),
        ('Query Processor', 8006),
        ('AI Optimization', 8007)
    ]
    
    print("=== EITMS System Status ===\n")
    
    all_healthy = True
    for service_name, port in services:
        try:
            response = requests.get(
                f"http://localhost:{port}/health",
                timeout=2
            )
            if response.status_code == 200:
                print(f"✓ {service_name}: Running")
            else:
                print(f"✗ {service_name}: Unhealthy")
                all_healthy = False
        except:
            print(f"✗ {service_name}: Not responding")
            all_healthy = False
    
    print(f"\nOverall Status: {'HEALTHY' if all_healthy else 'DEGRADED'}")

def main():
    """メイン関数"""
    parser = argparse.ArgumentParser(
        description='EITMS Command Line Interface',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  eitms list --status open --priority high
  eitms create "New feature" --description "Add login functionality" --priority high
  eitms update abc12345 --status in_progress --assignee john
  eitms search "authentication bug"
  eitms optimize priorities
  eitms status
        """
    )
    
    subparsers = parser.add_subparsers(dest='command', help='Commands')
    
    # list command
    list_parser = subparsers.add_parser('list', help='List tasks')
    list_parser.add_argument('--status', help='Filter by status')
    list_parser.add_argument('--assignee', help='Filter by assignee')
    list_parser.add_argument('--priority', help='Filter by priority')
    list_parser.set_defaults(func=list_tasks)
    
    # create command
    create_parser = subparsers.add_parser('create', help='Create a new task')
    create_parser.add_argument('title', help='Task title')
    create_parser.add_argument('--description', '-d', help='Task description')
    create_parser.add_argument('--priority', '-p', default='medium',
                             choices=['low', 'medium', 'high', 'critical'])
    create_parser.add_argument('--assignee', '-a', help='Assignee')
    create_parser.add_argument('--labels', '-l', help='Comma-separated labels')
    create_parser.set_defaults(func=create_task)
    
    # update command
    update_parser = subparsers.add_parser('update', help='Update a task')
    update_parser.add_argument('task_id', help='Task ID')
    update_parser.add_argument('--status', '-s', help='New status')
    update_parser.add_argument('--priority', '-p', help='New priority')
    update_parser.add_argument('--assignee', '-a', help='New assignee')
    update_parser.add_argument('--title', '-t', help='New title')
    update_parser.set_defaults(func=update_task)
    
    # search command
    search_parser = subparsers.add_parser('search', help='Search tasks')
    search_parser.add_argument('query', help='Search query')
    search_parser.set_defaults(func=search_tasks)
    
    # optimize command
    optimize_parser = subparsers.add_parser('optimize', help='Optimize tasks')
    optimize_parser.add_argument('type', choices=['priorities', 'assignments'],
                               help='Optimization type')
    optimize_parser.set_defaults(func=optimize_tasks)
    
    # status command
    status_parser = subparsers.add_parser('status', help='Show system status')
    status_parser.set_defaults(func=system_status)
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        sys.exit(1)
    
    # 実行
    args.func(args)

if __name__ == "__main__":
    main()
=======
#!/bin/bash
# EITMS Command Line Interface
# エルダーズギルド統合タスク管理システム コマンドラインツール

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Paths
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"
DATA_DIR="$PROJECT_ROOT/data"
LOG_DIR="$PROJECT_ROOT/logs"

# Functions
log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

show_help() {
    echo "EITMS - Elders Guild Integrated Task Management System"
    echo
    echo "Usage: eitms <command> [options]"
    echo
    echo "Commands:"
    echo "  start                 Start EITMS services"
    echo "  stop                  Stop EITMS services"  
    echo "  status                Show system status"
    echo "  restart               Restart EITMS services"
    echo
    echo "Task Management:"
    echo "  list [--status STATUS]    List tasks (open, in_progress, completed, all)"
    echo "  create <title> [options]  Create new task"
    echo "  update <id> [options]     Update existing task"
    echo "  delete <id>              Delete task"
    echo "  show <id>                Show task details"
    echo "  search <query>           Search tasks"
    echo
    echo "AI Operations:"
    echo "  analyze <id>             Analyze task with AI"
    echo "  recommend <id>           Get AI recommendations"
    echo "  optimize [priorities]    Run AI optimization"
    echo
    echo "System Operations:"
    echo "  sync                     Force synchronization"
    echo "  check                    Run health check"
    echo "  logs [service]          Show logs"
    echo "  stats                   Show statistics"
    echo
    echo "Options for create/update:"
    echo "  --type TYPE             Task type (todo, project_task, issue, planning)"
    echo "  --priority PRIORITY     Priority (low, medium, high, critical)"
    echo "  --status STATUS         Status (created, in_progress, completed, blocked)"
    echo "  --description DESC      Task description"
    echo "  --estimate HOURS        Estimated hours"
    echo
    echo "Examples:"
    echo "  eitms create \"Implement authentication\" --type issue --priority high"
    echo "  eitms list --status open"
    echo "  eitms analyze task-123"
    echo "  eitms optimize priorities"
}

execute_sql() {
    local query="$1"
    sqlite3 "$DATA_DIR/eitms.db" "$query"
}

generate_task_id() {
    echo "task-$(date +%s)-$(shuf -i 1000-9999 -n 1)"
}

list_tasks() {
    local status_filter="$1"
    local db_path="$DATA_DIR/eitms.db"
    
    if [ ! -f "$db_path" ]; then
        log_error "Database not found. Please start EITMS first."
        return 1
    fi
    
    local query="SELECT id, title, task_type, status, priority, created_at FROM unified_tasks"
    
    if [ -n "$status_filter" ] && [ "$status_filter" != "all" ]; then
        query="$query WHERE status = '$status_filter'"
    fi
    
    query="$query ORDER BY created_at DESC LIMIT 20"
    
    echo -e "${BLUE}Task List${NC}"
    echo "----------------------------------------"
    printf "%-20s %-30s %-12s %-12s %-8s\n" "ID" "TITLE" "TYPE" "STATUS" "PRIORITY"
    echo "----------------------------------------"
    
    execute_sql "$query" | while IFS='|' read -r id title type status priority created_at; do
        # Truncate long titles
        if [ ${#title} -gt 28 ]; then
            title="${title:0:25}..."
        fi
        
        printf "%-20s %-30s %-12s %-12s %-8s\n" "$id" "$title" "$type" "$status" "$priority"
    done
}

create_task() {
    local title="$1"
    shift
    
    if [ -z "$title" ]; then
        log_error "Task title is required"
        return 1
    fi
    
    # Parse options
    local task_type="todo"
    local priority="medium"
    local status="created"
    local description=""
    local estimate=""
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --type)
                task_type="$2"
                shift 2
                ;;
            --priority)
                priority="$2"
                shift 2
                ;;
            --status)
                status="$2"
                shift 2
                ;;
            --description)
                description="$2"
                shift 2
                ;;
            --estimate)
                estimate="$2"
                shift 2
                ;;
            *)
                log_warning "Unknown option: $1"
                shift
                ;;
        esac
    done
    
    local task_id=$(generate_task_id)
    local now=$(date -Iseconds)
    
    local query="INSERT INTO unified_tasks (id, title, description, task_type, status, priority, created_at, updated_at"
    local values="VALUES ('$task_id', '$title', '$description', '$task_type', '$status', '$priority', '$now', '$now'"
    
    if [ -n "$estimate" ]; then
        query="$query, time_estimated"
        values="$values, $estimate"
    fi
    
    query="$query) $values)"
    
    if execute_sql "$query"; then
        log_info "Task created successfully: $task_id"
        echo "  Title: $title"
        echo "  Type: $task_type"
        echo "  Priority: $priority"
        echo "  Status: $status"
        [ -n "$description" ] && echo "  Description: $description"
        [ -n "$estimate" ] && echo "  Estimated Hours: $estimate"
    else
        log_error "Failed to create task"
        return 1
    fi
}

show_task() {
    local task_id="$1"
    
    if [ -z "$task_id" ]; then
        log_error "Task ID is required"
        return 1
    fi
    
    local query="SELECT * FROM unified_tasks WHERE id = '$task_id'"
    local result=$(execute_sql "$query")
    
    if [ -z "$result" ]; then
        log_error "Task not found: $task_id"
        return 1
    fi
    
    echo -e "${BLUE}Task Details: $task_id${NC}"
    echo "----------------------------------------"
    
    echo "$result" | while IFS='|' read -r id title description task_type status priority created_at updated_at started_at completed_at time_estimated time_spent assigned_to dependencies sub_tasks github_issue_number context; do
        echo "ID: $id"
        echo "Title: $title"
        [ -n "$description" ] && echo "Description: $description"
        echo "Type: $task_type"
        echo "Status: $status"
        echo "Priority: $priority"
        echo "Created: $created_at"
        echo "Updated: $updated_at"
        [ -n "$started_at" ] && echo "Started: $started_at"
        [ -n "$completed_at" ] && echo "Completed: $completed_at"
        [ -n "$time_estimated" ] && echo "Estimated Hours: $time_estimated"
        [ -n "$time_spent" ] && echo "Time Spent: $time_spent"
        [ -n "$assigned_to" ] && echo "Assigned To: $assigned_to"
        [ -n "$dependencies" ] && echo "Dependencies: $dependencies"
        [ -n "$sub_tasks" ] && echo "Sub Tasks: $sub_tasks"
        [ -n "$github_issue_number" ] && echo "GitHub Issue: #$github_issue_number"
        [ -n "$context" ] && echo "Context: $context"
    done
}

search_tasks() {
    local query="$1"
    
    if [ -z "$query" ]; then
        log_error "Search query is required"
        return 1
    fi
    
    local sql_query="SELECT id, title, task_type, status, priority FROM unified_tasks WHERE title LIKE '%$query%' OR description LIKE '%$query%' ORDER BY created_at DESC LIMIT 20"
    
    echo -e "${BLUE}Search Results for: $query${NC}"
    echo "----------------------------------------"
    printf "%-20s %-30s %-12s %-12s %-8s\n" "ID" "TITLE" "TYPE" "STATUS" "PRIORITY"
    echo "----------------------------------------"
    
    execute_sql "$sql_query" | while IFS='|' read -r id title type status priority; do
        # Truncate long titles
        if [ ${#title} -gt 28 ]; then
            title="${title:0:25}..."
        fi
        
        printf "%-20s %-30s %-12s %-12s %-8s\n" "$id" "$title" "$type" "$status" "$priority"
    done
}

show_stats() {
    echo -e "${BLUE}EITMS Statistics${NC}"
    echo "----------------------------------------"
    
    # Task counts by status
    echo "Tasks by Status:"
    execute_sql "SELECT status, COUNT(*) FROM unified_tasks GROUP BY status" | while IFS='|' read -r status count; do
        echo "  $status: $count"
    done
    echo
    
    # Task counts by type
    echo "Tasks by Type:"
    execute_sql "SELECT task_type, COUNT(*) FROM unified_tasks GROUP BY task_type" | while IFS='|' read -r type count; do
        echo "  $type: $count"
    done
    echo
    
    # Task counts by priority
    echo "Tasks by Priority:"
    execute_sql "SELECT priority, COUNT(*) FROM unified_tasks GROUP BY priority" | while IFS='|' read -r priority count; do
        echo "  $priority: $count"
    done
    echo
    
    # Total count
    local total=$(execute_sql "SELECT COUNT(*) FROM unified_tasks")
    echo "Total Tasks: $total"
    
    # Database size
    if [ -f "$DATA_DIR/eitms.db" ]; then
        local db_size=$(du -h "$DATA_DIR/eitms.db" | cut -f1)
        echo "Database Size: $db_size"
    fi
}

show_logs() {
    local service="$1"
    
    if [ -n "$service" ]; then
        local log_file="$LOG_DIR/${service}.log"
        if [ -f "$log_file" ]; then
            tail -50 "$log_file"
        else
            log_error "Log file not found: $log_file"
        fi
    else
        echo "Available log files:"
        ls -la "$LOG_DIR"/*.log 2>/dev/null || log_warning "No log files found"
    fi
}

# Main command handler
main() {
    if [ $# -eq 0 ]; then
        show_help
        exit 0
    fi
    
    case $1 in
        start)
            "$SCRIPT_DIR/eitms_start.sh"
            ;;
        stop)
            "$SCRIPT_DIR/eitms_stop.sh" 2>/dev/null || log_warning "Stop script not implemented yet"
            ;;
        status)
            "$SCRIPT_DIR/eitms_status.sh"
            ;;
        restart)
            "$SCRIPT_DIR/eitms_stop.sh" 2>/dev/null || true
            sleep 2
            "$SCRIPT_DIR/eitms_start.sh"
            ;;
        list)
            list_tasks "$2"
            ;;
        create)
            shift
            create_task "$@"
            ;;
        show)
            show_task "$2"
            ;;
        search)
            search_tasks "$2"
            ;;
        analyze)
            log_info "AI analysis for task: $2"
            log_warning "AI analysis feature requires running AI service"
            ;;
        recommend)
            log_info "AI recommendations for task: $2"  
            log_warning "AI recommendation feature requires running AI service"
            ;;
        optimize)
            log_info "Running AI optimization..."
            log_warning "AI optimization feature requires running AI service"
            ;;
        sync)
            log_info "Forcing synchronization..."
            log_warning "Sync feature requires running sync services"
            ;;
        check)
            "$SCRIPT_DIR/eitms_status.sh" --verbose
            ;;
        logs)
            show_logs "$2"
            ;;
        stats)
            show_stats
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            log_error "Unknown command: $1"
            echo "Use 'eitms help' for available commands"
            exit 1
            ;;
    esac
}

# Run main function
main "$@"
>>>>>>> origin/main
