#!/usr/bin/env python3
"""
Elder Flow CLI - ã‚¨ãƒ«ãƒ€ãƒ¼ãƒ•ãƒ­ãƒ¼ ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
Created: 2025-07-12
Author: Claude Elder
Version: 1.0.0
"""

import asyncio
import sys
import argparse
import json
from pathlib import Path

# Add project root to path
sys.path.insert(0, str(Path(__file__).parent.parent))

from libs.elder_flow_integration import (
    execute_elder_flow,
    get_elder_flow_status,
    get_elder_flow_statistics,
    ElderFlowWorkflow
)

def print_elder_banner():
    """Elder Flow ãƒãƒŠãƒ¼è¡¨ç¤º"""
    print("ğŸŒŠ Elder Flow - Claude Elder Automation System")
    print("ğŸ›ï¸ ã‚¨ãƒ«ãƒ€ãƒ¼ã‚ºã‚®ãƒ«ãƒ‰å®Œå…¨è‡ªå‹•åŒ–é–‹ç™ºãƒ•ãƒ­ãƒ¼")
    print("=" * 50)

async def cmd_execute(args):
    """Elder Flowå®Ÿè¡Œ"""
    print_elder_banner()

    description = args.description
    priority = args.priority
    auto_commit = not args.no_commit
    commit_message = args.commit_message

    print(f"ğŸ“‹ Task: {description}")
    print(f"âš¡ Priority: {priority}")
    print(f"ğŸ“¤ Auto-commit: {'Yes' if auto_commit else 'No'}")
    print()

    try:
        print("ğŸš€ Starting Elder Flow execution...")
        task_id = await execute_elder_flow(description, priority, auto_commit, commit_message)

        print(f"âœ… Elder Flow completed successfully!")
        print(f"ğŸ†” Task ID: {task_id}")

        # çµæœè¡¨ç¤º
        status = get_elder_flow_status(task_id)
        if status:
            print(f"â±ï¸  Duration: {status['total_duration']:.2f}s")
            print(f"ğŸ“Š Status: {status['status']}")

            if status.get('quality_result'):
                quality = status['quality_result']
                print(f"ğŸ” Quality: {quality['overall_status']} (Score: {quality['overall_score']:.2f}/10)")

            if status.get('git_result') and status['git_result']['commit_success']:
                print(f"ğŸ“¤ Git: {status['git_result']['commit_hash'][:8]}")

    except Exception as e:
        print(f"âŒ Elder Flow failed: {str(e)}")
        return 1

    return 0

async def cmd_status(args):
    """Elder FlowçŠ¶æ…‹ç¢ºèª"""
    print_elder_banner()

    if args.task_id:
        # ç‰¹å®šã‚¿ã‚¹ã‚¯ã®çŠ¶æ…‹
        status = get_elder_flow_status(args.task_id)
        if not status:
            print(f"âŒ Task not found: {args.task_id}")
            return 1

        print(f"ğŸ†” Task ID: {args.task_id}")
        print(f"ğŸ“‹ Description: {status['description']}")
        print(f"ğŸ“Š Status: {status['status']}")
        print(f"âš¡ Priority: {status['priority']}")
        print(f"â±ï¸  Duration: {status['total_duration']:.2f}s")

        if status.get('orchestration_result'):
            print(f"ğŸ›ï¸ Orchestration: {status['orchestration_result']['status']}")

        if status.get('execution_result'):
            print(f"ğŸ¤– Execution: {status['execution_result']['total_tasks']} tasks")

        if status.get('quality_result'):
            quality = status['quality_result']
            print(f"ğŸ” Quality: {quality['overall_status']} (Score: {quality['overall_score']:.2f}/10)")

        if status.get('report_result'):
            print(f"ğŸ“Š Reports: {status['report_result']['reports_saved']}")

        if status.get('git_result'):
            git = status['git_result']
            print(f"ğŸ“¤ Git: {'âœ…' if git['commit_success'] else 'âŒ'}")

        if args.verbose and status.get('error_message'):
            print(f"âš ï¸  Error: {status['error_message']}")

    else:
        # å…¨ä½“çµ±è¨ˆ
        stats = get_elder_flow_statistics()
        print(f"ğŸ“Š Elder Flow Statistics")
        print(f"ğŸ“ˆ Total Tasks: {stats['total_tasks']}")
        print(f"âœ… Completed: {stats['completed_tasks']}")
        print(f"âŒ Failed: {stats['failed_tasks']}")
        print(f"â³ Active: {stats['active_tasks']}")
        print(f"ğŸ¯ Success Rate: {stats['success_rate']:.1f}%")
        print(f"â±ï¸  Average Duration: {stats['average_duration']:.2f}s")

    return 0

async def cmd_workflow(args):
    """Elder Flow ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼"""
    print_elder_banner()

    if args.action == "create":
        workflow = ElderFlowWorkflow()

        # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®šç¾©ï¼ˆä¾‹ï¼‰
        steps = [
            {"type": "elder_flow", "description": args.description or "Step 1", "priority": "high"},
            {"type": "elder_flow", "description": "Add comprehensive tests", "priority": "medium"},
            {"type": "elder_flow", "description": "Update documentation", "priority": "low"}
        ]

        workflow_id = workflow.create_workflow(args.name, steps)
        print(f"âœ… Workflow created: {workflow_id}")

        if args.execute:
            print("ğŸš€ Executing workflow...")
            result = await workflow.execute_workflow(workflow_id)
            print(f"âœ… Workflow completed: {result['total_steps']} steps")

    return 0

def cmd_help(args):
    """Elder Flow ãƒ˜ãƒ«ãƒ—"""
    print_elder_banner()
    print("ğŸ”§ Elder Flow Commands:")
    print()
    print("  execute <description>    - Elder Flowå®Ÿè¡Œ")
    print("    --priority <level>     - å„ªå…ˆåº¦ (low/medium/high)")
    print("    --no-commit            - è‡ªå‹•ã‚³ãƒŸãƒƒãƒˆç„¡åŠ¹")
    print("    --commit-message <msg> - ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸")
    print()
    print("  status [task_id]         - çŠ¶æ…‹ç¢ºèª")
    print("    --verbose              - è©³ç´°è¡¨ç¤º")
    print()
    print("  workflow create <name>   - ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ä½œæˆ")
    print("    --execute              - ä½œæˆå¾Œã™ãå®Ÿè¡Œ")
    print("    --description <desc>   - ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼èª¬æ˜")
    print()
    print("  help                     - ã“ã®ãƒ˜ãƒ«ãƒ—")
    print()
    print("ğŸŒŠ Examples:")
    print("  elder-flow execute 'OAuth2.0èªè¨¼ã‚·ã‚¹ãƒ†ãƒ å®Ÿè£…' --priority high")
    print("  elder-flow status")
    print("  elder-flow workflow create oauth_system --execute")
    print()

def main():
    """ãƒ¡ã‚¤ãƒ³é–¢æ•°"""
    parser = argparse.ArgumentParser(
        description="Elder Flow - Claude Elder Automation System",
        formatter_class=argparse.RawDescriptionHelpFormatter
    )

    subparsers = parser.add_subparsers(dest='command', help='Available commands')

    # execute ã‚³ãƒãƒ³ãƒ‰
    parser_execute = subparsers.add_parser('execute', help='Execute Elder Flow')
    parser_execute.add_argument('description', help='Task description')
    parser_execute.add_argument('--priority', choices=['low', 'medium', 'high'], default='medium', help='Task priority')
    parser_execute.add_argument('--no-commit', action='store_true', help='Disable auto-commit')
    parser_execute.add_argument('--commit-message', help='Custom commit message')
    parser_execute.set_defaults(func=cmd_execute)

    # status ã‚³ãƒãƒ³ãƒ‰
    parser_status = subparsers.add_parser('status', help='Check Elder Flow status')
    parser_status.add_argument('task_id', nargs='?', help='Specific task ID')
    parser_status.add_argument('--verbose', '-v', action='store_true', help='Verbose output')
    parser_status.set_defaults(func=cmd_status)

    # workflow ã‚³ãƒãƒ³ãƒ‰
    parser_workflow = subparsers.add_parser('workflow', help='Elder Flow workflow management')
    parser_workflow.add_argument('action', choices=['create'], help='Workflow action')
    parser_workflow.add_argument('name', help='Workflow name')
    parser_workflow.add_argument('--execute', action='store_true', help='Execute immediately')
    parser_workflow.add_argument('--description', help='Workflow description')
    parser_workflow.set_defaults(func=cmd_workflow)

    # help ã‚³ãƒãƒ³ãƒ‰
    parser_help = subparsers.add_parser('help', help='Show help')
    parser_help.set_defaults(func=cmd_help)

    args = parser.parse_args()

    if not args.command:
        cmd_help(args)
        return 0

    if args.command == 'help':
        cmd_help(args)
        return 0

    # éåŒæœŸã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ
    if asyncio.iscoroutinefunction(args.func):
        return asyncio.run(args.func(args))
    else:
        return args.func(args)

if __name__ == '__main__':
    sys.exit(main())
