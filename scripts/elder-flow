#!/usr/bin/env python3
"""
Elder Flow CLI - ã‚¨ãƒ«ãƒ€ãƒ¼ãƒ•ãƒ­ãƒ¼ ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
Created: 2025-07-12
Author: Claude Elder
Version: 1.0.0
"""

import argparse
import asyncio
import json
import sys
from pathlib import Path

# Add project root to path
sys.path.insert(0, str(Path(__file__).parent.parent))

from libs.elder_flow_integration import (
    ElderFlowWorkflow,
    execute_elder_flow,
    get_elder_flow_statistics,
    get_elder_flow_status,
)

# Retry wrapper import
from libs.elder_flow_retry_wrapper import execute_elder_flow_with_retry

# Elder Soul Integration imports
from libs.elder_flow_soul_integration import (
    ElderFlowSoulMode,
    execute_soul_enhanced_elder_flow,
    get_soul_enhanced_flow_status,
)
from libs.elder_system.flow.elder_flow_engine import ElderFlowEngine


def print_elder_banner():
    """Elder Flow ãƒãƒŠãƒ¼è¡¨ç¤º"""
    print("ğŸŒŠ Elder Flow - Claude Elder Automation System")
    print("ğŸ›ï¸ ã‚¨ãƒ«ãƒ€ãƒ¼ã‚ºã‚®ãƒ«ãƒ‰å®Œå…¨è‡ªå‹•åŒ–é–‹ç™ºãƒ•ãƒ­ãƒ¼")
    print("=" * 50)


async def cmd_execute(args):
    """Elder Flowå®Ÿè¡Œ"""
    print_elder_banner()

    description = args.description
    priority = args.priority
    auto_commit = not args.no_commit
    commit_message = args.commit_message
    soul_mode = getattr(args, "soul_mode", None)
    retry_on_lock = getattr(args, "retry", False)
    max_retries = getattr(args, "max_retries", 3)
    retry_interval = getattr(args, "retry_interval", 5)

    print(f"ğŸ“‹ Task: {description}")
    print(f"âš¡ Priority: {priority}")
    print(f"ğŸ“¤ Auto-commit: {'Yes' if auto_commit else 'No'}")

    if soul_mode:
        print(f"ğŸŒŸ Soul Mode: {soul_mode}")
        print("ğŸ§™â€â™‚ï¸ Using Elder Soul integration")
    else:
        print("ğŸ‘‘ Using default Claude Elder Soul integration")
    print()

    try:
        if soul_mode:
            # Elder Soulçµ±åˆå®Ÿè¡Œ
            print("ğŸŒŠ Starting Soul Enhanced Elder Flow...")
            task_id = await execute_soul_enhanced_elder_flow(
                description, priority, auto_commit, commit_message, soul_mode
            )

            print(f"âœ… Soul Enhanced Elder Flow completed!")
            print(f"ğŸ†” Task ID: {task_id}")

            # Soulçµ±åˆçµæœè¡¨ç¤º
            status = await get_soul_enhanced_flow_status(task_id)
            if status:
                print(f"â±ï¸  Duration: {status['total_duration']:.2f}s")
                print(f"ğŸ“Š Status: {status['soul_mode']}")

                summary = status.get("soul_results_summary", {})
                completion_rate = summary.get("completion_rate", 0)
                print(
                    f"ğŸŒŸ Soul Completion: {completion_rate:.1%} ({summary.get('phases_completed', 0)}/5 phases)"
                )

                if status.get("error_message"):
                    print(f"âš ï¸  Error: {status['error_message']}")
        else:
            # ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ä»˜ãElder Flowå®Ÿè¡Œ
            if retry_on_lock:
                print("ğŸ”„ Retry mode enabled")
                print(f"   Max retries: {max_retries}")
                print(f"   Retry interval: {retry_interval}s")
                print()

            print("ğŸš€ Starting Elder Flow execution...")

            # æ–°ã—ã„Elder Flow Engineã‚’ä½¿ç”¨
            result = await execute_elder_flow_with_retry(
                task_name=description,
                priority=priority,
                auto_retry=retry_on_lock,
                max_retries=max_retries,
                retry_interval=retry_interval,
            )

            if result.get("error") == "Task already running" and result.get(
                "retry_required"
            ):
                # ãƒªãƒˆãƒ©ã‚¤ãŒå¿…è¦ãªå ´åˆã®å‡¦ç†
                print(f"\nğŸ’¡ ãƒ’ãƒ³ãƒˆ: {result.get('retry_suggestion', '')}")
                return 1
            elif "error" in result:
                print(f"âŒ Elder Flow failed: {result['error']}")
                return 1
            else:
                print(f"âœ… Elder Flow completed successfully!")
                print(f"ğŸ†” Flow ID: {result.get('flow_id', 'N/A')}")

                if result.get("execution_time"):
                    print(f"â±ï¸  Completed at: {result['execution_time']}")

    except Exception as e:
        print(f"âŒ Elder Flow failed: {str(e)}")
        return 1

    return 0


async def cmd_status(args):
    """Elder FlowçŠ¶æ…‹ç¢ºèª"""
    print_elder_banner()

    if args.task_id:
        # ç‰¹å®šã‚¿ã‚¹ã‚¯ã®çŠ¶æ…‹
        status = get_elder_flow_status(args.task_id)
        if not status:
            print(f"âŒ Task not found: {args.task_id}")
            return 1

        print(f"ğŸ†” Task ID: {args.task_id}")
        print(f"ğŸ“‹ Description: {status['description']}")
        print(f"ğŸ“Š Status: {status['status']}")
        print(f"âš¡ Priority: {status['priority']}")
        print(f"â±ï¸  Duration: {status['total_duration']:.2f}s")

        if status.get("orchestration_result"):
            print(f"ğŸ›ï¸ Orchestration: {status['orchestration_result']['status']}")

        if status.get("execution_result"):
            print(f"ğŸ¤– Execution: {status['execution_result']['total_tasks']} tasks")

        if status.get("quality_result"):
            quality = status["quality_result"]
            print(
                f"ğŸ” Quality: {quality['overall_status']} (Score: {quality['overall_score']:.2f}/10)"
            )

        if status.get("report_result"):
            print(f"ğŸ“Š Reports: {status['report_result']['reports_saved']}")

        if status.get("git_result"):
            git = status["git_result"]
            print(f"ğŸ“¤ Git: {'âœ…' if git['commit_success'] else 'âŒ'}")

        if args.verbose and status.get("error_message"):
            print(f"âš ï¸  Error: {status['error_message']}")

    else:
        # å…¨ä½“çµ±è¨ˆ
        stats = get_elder_flow_statistics()
        print(f"ğŸ“Š Elder Flow Statistics")
        print(f"ğŸ“ˆ Total Tasks: {stats['total_tasks']}")
        print(f"âœ… Completed: {stats['completed_tasks']}")
        print(f"âŒ Failed: {stats['failed_tasks']}")
        print(f"â³ Active: {stats['active_tasks']}")
        print(f"ğŸ¯ Success Rate: {stats['success_rate']:.1f}%")
        print(f"â±ï¸  Average Duration: {stats['average_duration']:.2f}s")

    return 0


async def cmd_workflow(args):
    """Elder Flow ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼"""
    print_elder_banner()

    if args.action == "create":
        workflow = ElderFlowWorkflow()

        # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®šç¾©ï¼ˆä¾‹ï¼‰
        steps = [
            {
                "type": "elder_flow",
                "description": args.description or "Step 1",
                "priority": "high",
            },
            {
                "type": "elder_flow",
                "description": "Add comprehensive tests",
                "priority": "medium",
            },
            {
                "type": "elder_flow",
                "description": "Update documentation",
                "priority": "low",
            },
        ]

        workflow_id = workflow.create_workflow(args.name, steps)
        print(f"âœ… Workflow created: {workflow_id}")

        if args.execute:
            print("ğŸš€ Executing workflow...")
            result = await workflow.execute_workflow(workflow_id)
            print(f"âœ… Workflow completed: {result['total_steps']} steps")

    return 0


async def cmd_cleanup(args):
    """å¤ã„ãƒ­ãƒƒã‚¯ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—"""
    print_elder_banner()
    print("ğŸ§¹ Cleaning up stale locks...")

    engine = ElderFlowEngine()
    result = await engine.cleanup_stale_locks()

    if result.get("status") == "success":
        print(f"âœ… {result['cleaned_locks']} stale locks cleaned up")
    else:
        print(f"âŒ Cleanup failed: {result.get('error', 'Unknown error')}")
        return 1

    return 0


async def cmd_active(args):
    """ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ã‚¹ã‚¯ã®è¡¨ç¤º"""
    print_elder_banner()
    print("ğŸ“‹ Active Tasks")
    print()

    engine = ElderFlowEngine()
    result = await engine.get_active_tasks()

    if result.get("status") == "success":
        active_count = result.get("active_tasks_count", 0)

        if active_count == 0:
            print("âœ¨ No active tasks")
        else:
            print(f"ğŸ”¥ {active_count} active task(s):")
            print()

            for task in result.get("active_tasks", []):
                print(f"  ğŸ“Œ {task['task_id']}")
                print(f"     PID: {task['pid']}")
                print(f"     Started: {task['started_at']}")

                # ãƒªãƒˆãƒ©ã‚¤æ¨å¥¨ã‚³ãƒãƒ³ãƒ‰ã‚’è¡¨ç¤º
                print(f"     Retry: elder-flow execute --retry \"{task['task_id']}\"")
                print()
    else:
        print(f"âŒ Failed to get active tasks: {result.get('error', 'Unknown error')}")
        return 1

    return 0


async def cmd_souls(args):
    """Elder Soulç®¡ç†"""
    print_elder_banner()

    if args.action == "status":
        print("ğŸŒŸ Elder Soul System Status")
        print("=" * 30)

        try:
            from libs.elder_flow_soul_connector import get_elder_flow_soul_connector

            connector = await get_elder_flow_soul_connector()

            # ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚»ãƒƒã‚·ãƒ§ãƒ³è¡¨ç¤º
            sessions = await connector.list_active_soul_sessions()

            if sessions:
                print(f"ğŸ”¥ Active Soul Sessions: {len(sessions)}")
                for session in sessions:
                    print(
                        f"  ğŸŒŠ {session['session_id']}: {session['phase']} ({session['soul_count']} souls)"
                    )
            else:
                print("ğŸ’¤ No active soul sessions")

        except Exception as e:
            print(f"âŒ Failed to get soul status: {e}")

    elif args.action == "summon":
        phase = args.phase
        description = args.description or "Elder Flow test task"

        print(f"ğŸŒŸ Summoning souls for {phase}...")

        try:
            from libs.elder_flow_soul_connector import summon_souls_for_elder_flow

            result = await summon_souls_for_elder_flow(phase, description, "medium")

            print(
                f"âœ… Summoned {result['summoned_count']}/{result['total_souls']} souls"
            )
            print(f"ğŸ†” Session ID: {result['session_id']}")

            for soul_id, soul_info in result["souls"].items():
                status_icon = "âœ…" if soul_info.get("status") == "active" else "âŒ"
                print(
                    f"  {status_icon} {soul_id}: {soul_info.get('purpose', 'Unknown purpose')}"
                )

        except Exception as e:
            print(f"âŒ Failed to summon souls: {e}")

    elif args.action == "dismiss":
        session_id = args.session_id

        print(f"ğŸŒ… Dismissing soul session: {session_id}")

        try:
            from libs.elder_flow_soul_connector import dismiss_elder_flow_souls

            result = await dismiss_elder_flow_souls(session_id)

            print(f"âœ… Dismissed {result['dismissed_souls']} souls")

        except Exception as e:
            print(f"âŒ Failed to dismiss souls: {e}")

    return 0


def cmd_help(args):
    """Elder Flow ãƒ˜ãƒ«ãƒ—"""
    print_elder_banner()
    print("ğŸ”§ Elder Flow Commands:")
    print()
    print("  execute <description>    - Elder Flowå®Ÿè¡Œ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: Claude Elderé­‚çµ±åˆ)")
    print("    --priority <level>     - å„ªå…ˆåº¦ (low/medium/high)")
    print("    --soul-mode <mode>     - Soulçµ±åˆãƒ¢ãƒ¼ãƒ‰ (soul_enhanced/full_soul)")
    print("                           - æœªæŒ‡å®šæ™‚: Claude Elderé­‚ãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæœ‰åŠ¹")
    print("    --no-commit            - è‡ªå‹•ã‚³ãƒŸãƒƒãƒˆç„¡åŠ¹")
    print("    --commit-message <msg> - ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸")
    print("    --retry                - ãƒ­ãƒƒã‚¯æ™‚ã®è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤æœ‰åŠ¹")
    print("    --max-retries N        - æœ€å¤§ãƒªãƒˆãƒ©ã‚¤å›æ•° (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 3)")
    print("    --retry-interval N     - ãƒªãƒˆãƒ©ã‚¤é–“éš”(ç§’) (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 5)")
    print()
    print("  status [task_id]         - çŠ¶æ…‹ç¢ºèª")
    print("    --verbose              - è©³ç´°è¡¨ç¤º")
    print()
    print("  souls <action>           - Elder Soulç®¡ç†")
    print("    status                 - ã‚¢ã‚¯ãƒ†ã‚£ãƒ–é­‚ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¢ºèª")
    print("    summon <phase>         - æŒ‡å®šãƒ•ã‚§ãƒ¼ã‚ºã®é­‚å¬å–š")
    print("    dismiss <session_id>   - é­‚ã‚»ãƒƒã‚·ãƒ§ãƒ³è§£æ•£")
    print()
    print("  workflow create <name>   - ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ä½œæˆ")
    print("    --execute              - ä½œæˆå¾Œã™ãå®Ÿè¡Œ")
    print("    --description <desc>   - ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼èª¬æ˜")
    print()
    print("  cleanup                  - å¤ã„ãƒ­ãƒƒã‚¯ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—")
    print()
    print("  active                   - ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ã‚¹ã‚¯ã®è¡¨ç¤º")
    print()
    print("  help                     - ã“ã®ãƒ˜ãƒ«ãƒ—")
    print()
    print("ğŸ‘‘ Default Claude Elder Soul Examples:")
    print(
        "  elder-flow execute 'OAuth2.0èªè¨¼ã‚·ã‚¹ãƒ†ãƒ å®Ÿè£…' --priority high  # Claude Elderé­‚è‡ªå‹•çµ±åˆ"
    )
    print(
        "  elder-flow execute 'ãƒã‚°ä¿®æ­£' --retry --max-retries 5         # Claude Elderé­‚è‡ªå‹•çµ±åˆ"
    )
    print("  elder-flow status")
    print("  elder-flow active")
    print("  elder-flow cleanup")
    print("  elder-flow workflow create oauth_system --execute")
    print()
    print("ğŸŒŸ Advanced Soul Enhanced Examples:")
    print(
        "  elder-flow execute 'OAuth2.0å®Ÿè£…' --soul-mode soul_enhanced    # ã‚ˆã‚Šé«˜åº¦ãªSoulçµ±åˆ"
    )
    print(
        "  elder-flow execute 'ãƒã‚°ä¿®æ­£' --soul-mode full_soul --priority high  # å®Œå…¨Soulçµ±åˆ"
    )
    print("  elder-flow souls status")
    print("  elder-flow souls summon phase1_analysis")
    print()
    print("ğŸ“‹ Available Soul Phases:")
    print(
        "  phase1_analysis  - 4è³¢è€…ä¼šè­° (knowledge_sage, task_sage, rag_sage, incident_sage)"
    )
    print(
        "  phase2_execution - ã‚µãƒ¼ãƒãƒ³ãƒˆå®Ÿè¡Œ (code_servant, test_guardian, quality_inspector)"
    )
    print(
        "  phase3_quality   - å“è³ªã‚²ãƒ¼ãƒˆ (security_auditor, performance_monitor, documentation_keeper)"
    )
    print(
        "  phase4_reporting - è©•è­°ä¼šå ±å‘Š (council_secretary, report_generator, approval_manager)"
    )
    print("  phase5_git       - Gitè‡ªå‹•åŒ– (git_master, version_guardian, deploy_manager)")
    print()


def main():
    """ãƒ¡ã‚¤ãƒ³é–¢æ•°"""
    parser = argparse.ArgumentParser(
        description="Elder Flow - Claude Elder Automation System",
        formatter_class=argparse.RawDescriptionHelpFormatter,
    )

    subparsers = parser.add_subparsers(dest="command", help="Available commands")

    # execute ã‚³ãƒãƒ³ãƒ‰
    parser_execute = subparsers.add_parser("execute", help="Execute Elder Flow")
    parser_execute.add_argument("description", help="Task description")
    parser_execute.add_argument(
        "--priority",
        choices=["low", "medium", "high"],
        default="medium",
        help="Task priority",
    )
    parser_execute.add_argument(
        "--soul-mode",
        choices=["soul_enhanced", "full_soul"],
        help="Elder Soul integration mode",
    )
    parser_execute.add_argument(
        "--no-commit", action="store_true", help="Disable auto-commit"
    )
    parser_execute.add_argument("--commit-message", help="Custom commit message")
    parser_execute.add_argument(
        "--retry", action="store_true", help="Enable automatic retry on lock"
    )
    parser_execute.add_argument(
        "--max-retries", type=int, default=3, help="Maximum retry attempts (default: 3)"
    )
    parser_execute.add_argument(
        "--retry-interval",
        type=int,
        default=5,
        help="Retry interval in seconds (default: 5)",
    )
    parser_execute.set_defaults(func=cmd_execute)

    # status ã‚³ãƒãƒ³ãƒ‰
    parser_status = subparsers.add_parser("status", help="Check Elder Flow status")
    parser_status.add_argument("task_id", nargs="?", help="Specific task ID")
    parser_status.add_argument(
        "--verbose", "-v", action="store_true", help="Verbose output"
    )
    parser_status.set_defaults(func=cmd_status)

    # souls ã‚³ãƒãƒ³ãƒ‰
    parser_souls = subparsers.add_parser("souls", help="Elder Soul management")
    parser_souls.add_argument(
        "action", choices=["status", "summon", "dismiss"], help="Soul action"
    )
    parser_souls.add_argument("phase", nargs="?", help="Phase for summon action")
    parser_souls.add_argument(
        "session_id", nargs="?", help="Session ID for dismiss action"
    )
    parser_souls.add_argument("--description", help="Task description for summon")
    parser_souls.set_defaults(func=cmd_souls)

    # workflow ã‚³ãƒãƒ³ãƒ‰
    parser_workflow = subparsers.add_parser(
        "workflow", help="Elder Flow workflow management"
    )
    parser_workflow.add_argument("action", choices=["create"], help="Workflow action")
    parser_workflow.add_argument("name", help="Workflow name")
    parser_workflow.add_argument(
        "--execute", action="store_true", help="Execute immediately"
    )
    parser_workflow.add_argument("--description", help="Workflow description")
    parser_workflow.set_defaults(func=cmd_workflow)

    # cleanup ã‚³ãƒãƒ³ãƒ‰
    parser_cleanup = subparsers.add_parser("cleanup", help="Clean up stale locks")
    parser_cleanup.set_defaults(func=cmd_cleanup)

    # active ã‚³ãƒãƒ³ãƒ‰
    parser_active = subparsers.add_parser("active", help="Show active tasks")
    parser_active.set_defaults(func=cmd_active)

    # help ã‚³ãƒãƒ³ãƒ‰
    parser_help = subparsers.add_parser("help", help="Show help")
    parser_help.set_defaults(func=cmd_help)

    args = parser.parse_args()

    if not args.command:
        cmd_help(args)
        return 0

    if args.command == "help":
        cmd_help(args)
        return 0

    # éåŒæœŸã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ
    if asyncio.iscoroutinefunction(args.func):
        return asyncio.run(args.func(args))
    else:
        return args.func(args)


if __name__ == "__main__":
    sys.exit(main())
