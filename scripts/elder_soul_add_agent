#!/usr/bin/env python3
"""
ã‚¨ãƒ«ãƒ€ãƒ¼ã®é­‚ - æ–°ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆè¿½åŠ ãƒ„ãƒ¼ãƒ«
Elder Soul - New Agent Addition Tool
"""

import sys
import json
import argparse
from pathlib import Path
from typing import Dict, Any

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã‚’ãƒ‘ã‚¹ã«è¿½åŠ 
PROJECT_ROOT = Path(__file__).parent.parent
sys.path.insert(0, str(PROJECT_ROOT))

from libs.elder_registry import ElderRegistry, AgentType


class AgentAdditionWizard:
    """æ–°ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆè¿½åŠ ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰"""

    def __init__(self):
        self.registry = ElderRegistry()

    async def interactive_add_agent(self):
        """å¯¾è©±å¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆè¿½åŠ """
        print("ğŸŒ² Elder Soul - New Agent Addition Wizard")
        print("=" * 60)

        # åŸºæœ¬æƒ…å ±ã®åé›†
        agent_info = await self._collect_basic_info()

        # é«˜åº¦ãªè¨­å®š
        advanced_info = await self._collect_advanced_info()
        agent_info.update(advanced_info)

        # ç¢ºèª
        if await self._confirm_addition(agent_info):
            # ç™»éŒ²å®Ÿè¡Œ
            success = await self._register_agent(agent_info)

            if success:
                await self._show_success_message(agent_info)
            else:
                await self._show_failure_message(agent_info)
        else:
            print("âŒ Agent addition cancelled")

    async def batch_add_agents(self, config_file: str):
        """ãƒãƒƒãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆè¿½åŠ """
        print(f"ğŸ“¦ Batch adding agents from {config_file}")

        try:
            with open(config_file, 'r', encoding='utf-8') as f:
                config = json.load(f)

            agents = config.get('agents', [])

            for agent_info in agents:
                print(f"\nğŸ“‹ Processing: {agent_info.get('name', 'Unknown')}")

                success = await self._register_agent(agent_info)

                if success:
                    print(f"âœ… Successfully added: {agent_info['name']}")
                else:
                    print(f"âŒ Failed to add: {agent_info.get('name', 'Unknown')}")

            print(f"\nğŸ‰ Batch processing completed for {len(agents)} agents")

        except Exception as e:
            print(f"âŒ Batch addition failed: {e}")

    async def _collect_basic_info(self) -> Dict[str, Any]:
        """åŸºæœ¬æƒ…å ±åé›†"""
        print("\nğŸ“‹ Basic Information")
        print("-" * 30)

        # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå
        name = input("Agent Name: ").strip()
        if not name:
            raise ValueError("Agent name is required")

        # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆIDï¼ˆè‡ªå‹•ç”Ÿæˆã¾ãŸã¯æ‰‹å‹•ï¼‰
        suggested_id = name.lower().replace(" ", "_")
        agent_id = input(f"Agent ID [{suggested_id}]: ").strip() or suggested_id

        # èª¬æ˜
        description = input("Description: ").strip()
        if not description:
            description = f"Auto-generated agent: {name}"

        # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¿ã‚¤ãƒ—
        print("\nAvailable Agent Types:")
        for i, agent_type in enumerate(AgentType, 1):
            print(f"  {i}. {agent_type.value}")

        while True:
            try:
                type_choice = input("Select Agent Type (1-7): ").strip()
                if type_choice:
                    agent_type = list(AgentType)[int(type_choice) - 1]
                    break
                else:
                    agent_type = AgentType.SERVANT  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
                    break
            except (ValueError, IndexError):
                print("âŒ Invalid choice. Please try again.")

        return {
            "id": agent_id,
            "name": name,
            "description": description,
            "type": agent_type.value
        }

    async def _collect_advanced_info(self) -> Dict[str, Any]:
        """é«˜åº¦ãªè¨­å®šåé›†"""
        print("\nâš™ï¸ Advanced Configuration")
        print("-" * 30)

        # æ©Ÿèƒ½ãƒªã‚¹ãƒˆ
        print("Capabilities (comma-separated):")
        capabilities_input = input("Enter capabilities: ").strip()
        capabilities = [cap.strip() for cap in capabilities_input.split(",") if cap.strip()]

        if not capabilities:
            capabilities = ["basic_functionality"]

        # ä¾å­˜é–¢ä¿‚
        print("\nDependencies (comma-separated agent IDs):")
        dependencies_input = input("Enter dependencies: ").strip()
        dependencies = [dep.strip() for dep in dependencies_input.split(",") if dep.strip()]

        # ãƒãƒ¼ãƒˆï¼ˆè‡ªå‹•å‰²ã‚Šå½“ã¦ã¾ãŸã¯æ‰‹å‹•ï¼‰
        port_input = input("Port (leave empty for auto-assignment): ").strip()
        port = int(port_input) if port_input.isdigit() else None

        # è‡ªå‹•èµ·å‹•
        auto_start_input = input("Auto-start? [y/N]: ").strip().lower()
        auto_start = auto_start_input in ['y', 'yes']

        return {
            "capabilities": capabilities,
            "dependencies": dependencies,
            "port": port,
            "auto_start": auto_start
        }

    async def _confirm_addition(self, agent_info: Dict[str, Any]) -> bool:
        """è¿½åŠ ç¢ºèª"""
        print("\nğŸ“‹ Agent Configuration Summary")
        print("=" * 40)
        print(f"Name: {agent_info['name']}")
        print(f"ID: {agent_info['id']}")
        print(f"Type: {agent_info['type']}")
        print(f"Description: {agent_info['description']}")
        print(f"Capabilities: {', '.join(agent_info['capabilities'])}")
        print(f"Dependencies: {', '.join(agent_info['dependencies']) if agent_info['dependencies'] else 'None'}")
        print(f"Port: {agent_info['port'] if agent_info['port'] else 'Auto-assign'}")
        print(f"Auto-start: {'Yes' if agent_info['auto_start'] else 'No'}")
        print("=" * 40)

        confirm = input("\nâ“ Add this agent? [Y/n]: ").strip().lower()
        return confirm in ['', 'y', 'yes']

    async def _register_agent(self, agent_info: Dict[str, Any]) -> bool:
        """ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆç™»éŒ²"""
        try:
            await self.registry.initialize()

            agent = await self.registry.register_agent(
                agent_id=agent_info["id"],
                name=agent_info["name"],
                description=agent_info["description"],
                agent_type=AgentType(agent_info["type"]),
                capabilities=agent_info["capabilities"],
                dependencies=agent_info.get("dependencies", []),
                port=agent_info.get("port"),
                auto_start=agent_info.get("auto_start", True)
            )

            return True

        except Exception as e:
            print(f"âŒ Registration failed: {e}")
            return False

    async def _show_success_message(self, agent_info: Dict[str, Any]):
        """æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º"""
        print("\nğŸ‰ Agent Successfully Added!")
        print("=" * 40)
        print(f"âœ… {agent_info['name']} has been registered with Elder Soul")
        print("\nğŸš€ Next steps:")
        print(f"   1. Check status: elder-tree-soul status")
        print(f"   2. Start agent: elder-tree-soul start")
        print(f"   3. View logs: elder-tree-soul logs {agent_info['id']}")
        print(f"   4. Agent script: processes/{agent_info['id']}_process.py")
        print("\nğŸŒ² Welcome to the Elder Soul ecosystem!")

    async def _show_failure_message(self, agent_info: Dict[str, Any]):
        """å¤±æ•—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º"""
        print("\nâŒ Agent Addition Failed")
        print("=" * 40)
        print(f"Failed to register: {agent_info.get('name', 'Unknown')}")
        print("\nğŸ”§ Troubleshooting:")
        print("   1. Check if the agent ID is unique")
        print("   2. Verify all required fields are provided")
        print("   3. Ensure Elder Soul is properly installed")
        print("   4. Check logs: logs/elder_enforcement.log")

    def create_batch_template(self, output_file: str):
        """ãƒãƒƒãƒè¿½åŠ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆ"""
        template = {
            "description": "Elder Soul - Batch Agent Configuration",
            "version": "1.0",
            "agents": [
                {
                    "id": "example_servant",
                    "name": "Example Servant",
                    "description": "Example servant agent",
                    "type": "servant",
                    "capabilities": ["example_capability", "another_capability"],
                    "dependencies": [],
                    "port": null,
                    "auto_start": True
                },
                {
                    "id": "another_agent",
                    "name": "Another Agent",
                    "description": "Another example agent",
                    "type": "elf",
                    "capabilities": ["monitoring", "optimization"],
                    "dependencies": ["example_servant"],
                    "port": 8001,
                    "auto_start": False
                }
            ]
        }

        try:
            with open(output_file, 'w', encoding='utf-8') as f:
                json.dump(template, f, ensure_ascii=False, indent=2)

            print(f"âœ… Batch template created: {output_file}")
            print("ğŸ“ Edit this file and use: elder-tree-soul-add-agent --batch")

        except Exception as e:
            print(f"âŒ Failed to create template: {e}")


async def main():
    """ãƒ¡ã‚¤ãƒ³é–¢æ•°"""
    parser = argparse.ArgumentParser(
        description="Elder Soul - New Agent Addition Tool",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  %(prog)s                          # Interactive wizard
  %(prog)s --batch config.json      # Batch addition
  %(prog)s --create-template out.json  # Create template
        """
    )

    parser.add_argument(
        '--batch',
        metavar='CONFIG_FILE',
        help='Batch add agents from JSON configuration file'
    )

    parser.add_argument(
        '--create-template',
        metavar='OUTPUT_FILE',
        help='Create a batch configuration template'
    )

    parser.add_argument(
        '--interactive',
        action='store_true',
        help='Run interactive wizard (default)'
    )

    args = parser.parse_args()

    wizard = AgentAdditionWizard()

    try:
        if args.create_template:
            wizard.create_batch_template(args.create_template)
        elif args.batch:
            await wizard.batch_add_agents(args.batch)
        else:
            # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯å¯¾è©±å¼
            await wizard.interactive_add_agent()

    except KeyboardInterrupt:
        print("\nğŸ‘‹ Goodbye!")
    except Exception as e:
        print(f"\nâŒ Error: {e}")
        return 1

    return 0


if __name__ == "__main__":
    import asyncio
    sys.exit(asyncio.run(main()))
