#!/usr/bin/env python3
"""
ã‚¨ãƒ«ãƒ€ãƒ¼ãƒ„ãƒªãƒ¼ã®é­‚ - ãƒ¡ã‚¤ãƒ³ã‚³ãƒãƒ³ãƒ‰
Elder Tree Soul - Main Command Interface
"""

import sys
import subprocess
import argparse
import json
import time
from pathlib import Path
from typing import Dict, List, Optional

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã‚’ãƒ‘ã‚¹ã«è¿½åŠ 
PROJECT_ROOT = Path(__file__).parent.parent
sys.path.insert(0, str(PROJECT_ROOT))


class ElderTreeSoul:
    """ã‚¨ãƒ«ãƒ€ãƒ¼ãƒ„ãƒªãƒ¼ã®é­‚ - ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ç•Œé¢"""

    def __init__(self):
        self.project_root = PROJECT_ROOT
        self.scripts_dir = self.project_root / "scripts"
        self.logs_dir = self.project_root / "logs" / "elders"
        self.data_dir = self.project_root / "data"

        # ã‚¨ãƒ«ãƒ€ãƒ¼å®šç¾©
        self.elders = {
            "grand_elder": {
                "name": "Grand Elder maru",
                "description": "æœ€é«˜æŒ‡æ®å®˜ - å…¨ä½“æˆ¦ç•¥ã¨ç·Šæ€¥æ™‚æŒ‡æ®",
                "port": 5000,
                "script": "processes/grand_elder_process.py"
            },
            "claude_elder": {
                "name": "Claude Elder",
                "description": "é–‹ç™ºå®Ÿè¡Œè²¬ä»»è€… - 4è³¢è€…çµ±æ‹¬ç®¡ç†",
                "port": 5001,
                "script": "processes/claude_elder_process.py"
            },
            "knowledge_sage": {
                "name": "Knowledge Sage",
                "description": "çŸ¥è­˜è³¢è€… - çŸ¥è­˜ç®¡ç†ãƒ»å­¦ç¿’å°‚é–€",
                "port": 5002,
                "script": "processes/knowledge_sage_process.py"
            },
            "task_sage": {
                "name": "Task Sage",
                "description": "ã‚¿ã‚¹ã‚¯è³¢è€… - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†å°‚é–€",
                "port": 5003,
                "script": "processes/task_sage_process.py"
            },
            "rag_sage": {
                "name": "RAG Sage",
                "description": "RAGè³¢è€… - æƒ…å ±æ¤œç´¢ãƒ»ç†è§£å°‚é–€",
                "port": 5004,
                "script": "processes/rag_sage_process.py"
            },
            "incident_sage": {
                "name": "Incident Sage",
                "description": "ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆè³¢è€… - å±æ©Ÿå¯¾å¿œå°‚é–€",
                "port": 5005,
                "script": "processes/incident_sage_process.py"
            }
        }

    def show_banner(self):
        """ãƒãƒŠãƒ¼è¡¨ç¤º"""
        print("ğŸŒ²" + "=" * 60 + "ğŸŒ²")
        print("ğŸŒŸ         ã‚¨ãƒ«ãƒ€ãƒ¼ãƒ„ãƒªãƒ¼ã®é­‚ (Elder Tree Soul)         ğŸŒŸ")
        print("ğŸ›ï¸              A2Aåˆ†æ•£AIã‚·ã‚¹ãƒ†ãƒ                      ğŸ›ï¸")
        print("âš¡           1å½¹å‰² = 1ãƒ—ãƒ­ã‚»ã‚¹ = 1ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ          âš¡")
        print("ğŸŒ²" + "=" * 60 + "ğŸŒ²")
        print()

    def cmd_start(self, args):
        """ã‚¨ãƒ«ãƒ€ãƒ¼ãƒ„ãƒªãƒ¼èµ·å‹•"""
        print("ğŸš€ Starting Elder Tree Soul...")

        # ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯
        if not self._check_dependencies():
            return 1

        # èµ·å‹•ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
        launcher_script = self.scripts_dir / "start_elder_processes.py"

        if args.daemon:
            # ãƒ‡ãƒ¼ãƒ¢ãƒ³ãƒ¢ãƒ¼ãƒ‰
            cmd = [sys.executable, str(launcher_script), "start"]
        else:
            # ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãƒ¢ãƒ¼ãƒ‰
            cmd = [sys.executable, str(launcher_script)]

        try:
            if args.daemon:
                subprocess.run(cmd, check=True)
                print("âœ… Elder Tree Soul started in daemon mode")
                print("Use 'elder-tree-soul status' to check status")
            else:
                # ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãƒ¢ãƒ¼ãƒ‰ã¯ç›´æ¥å®Ÿè¡Œ
                subprocess.run(cmd)

        except subprocess.CalledProcessError as e:
            print(f"âŒ Failed to start Elder Tree Soul: {e}")
            return 1

        return 0

    def cmd_stop(self, args):
        """ã‚¨ãƒ«ãƒ€ãƒ¼ãƒ„ãƒªãƒ¼åœæ­¢"""
        print("ğŸ›‘ Stopping Elder Tree Soul...")

        # ãƒ—ãƒ­ã‚»ã‚¹æ¤œç´¢ã¨åœæ­¢
        try:
            # elder ãƒ—ãƒ­ã‚»ã‚¹ã‚’æ¤œç´¢
            result = subprocess.run(
                ["pgrep", "-f", "elder.*process"],
                capture_output=True,
                text=True
            )

            if result.returncode == 0:
                pids = result.stdout.strip().split('\n')
                print(f"Found {len(pids)} elder processes")

                for pid in pids:
                    if pid:
                        try:
                            subprocess.run(["kill", "-TERM", pid], check=True)
                            print(f"âœ… Stopped process {pid}")
                        except subprocess.CalledProcessError:
                            print(f"âš ï¸  Could not stop process {pid}")

                print("âœ… Elder Tree Soul stopped")
            else:
                print("â„¹ï¸  No elder processes found")

        except Exception as e:
            print(f"âŒ Error stopping processes: {e}")
            return 1

        return 0

    def cmd_status(self, args):
        """ã‚¨ãƒ«ãƒ€ãƒ¼ãƒ„ãƒªãƒ¼çŠ¶æ…‹ç¢ºèª"""
        print("ğŸ“Š Elder Tree Soul Status")
        print("-" * 40)

        # ãƒ—ãƒ­ã‚»ã‚¹çŠ¶æ…‹ç¢ºèª
        try:
            result = subprocess.run(
                ["pgrep", "-f", "elder.*process"],
                capture_output=True,
                text=True
            )

            if result.returncode == 0:
                pids = result.stdout.strip().split('\n')
                print(f"ğŸŸ¢ Running: {len(pids)} elder processes")

                # è©³ç´°æƒ…å ±
                if args.verbose:
                    for pid in pids:
                        if pid:
                            self._show_process_info(pid)
            else:
                print("ğŸ”´ Stopped: No elder processes running")

        except Exception as e:
            print(f"âŒ Error checking status: {e}")
            return 1

        # RedisçŠ¶æ…‹ç¢ºèª
        self._check_redis_status()

        # ãƒãƒ¼ãƒˆçŠ¶æ…‹ç¢ºèª
        if args.verbose:
            self._check_port_status()

        return 0

    def cmd_restart(self, args):
        """ã‚¨ãƒ«ãƒ€ãƒ¼å†èµ·å‹•"""
        if args.elder:
            print(f"ğŸ”„ Restarting {args.elder}...")
            # ç‰¹å®šã‚¨ãƒ«ãƒ€ãƒ¼ã®å†èµ·å‹•
            return self._restart_specific_elder(args.elder)
        else:
            print("ğŸ”„ Restarting Elder Tree Soul...")
            # å…¨ä½“å†èµ·å‹•
            self.cmd_stop(args)
            time.sleep(2)
            return self.cmd_start(args)

    def cmd_logs(self, args):
        """ãƒ­ã‚°ç¢ºèª"""
        if args.elder:
            log_file = self.logs_dir / f"{args.elder}.log"
            if log_file.exists():
                if args.follow:
                    subprocess.run(["tail", "-f", str(log_file)])
                else:
                    lines = args.lines if args.lines else 50
                    subprocess.run(["tail", f"-{lines}", str(log_file)])
            else:
                print(f"âŒ Log file not found: {log_file}")
                return 1
        else:
            # å…¨ãƒ­ã‚°ã®æ¦‚è¦è¡¨ç¤º
            print("ğŸ“‹ Elder Tree Soul Logs Overview")
            print("-" * 40)

            for elder_id in self.elders.keys():
                log_file = self.logs_dir / f"{elder_id}.log"
                if log_file.exists():
                    # æœ€æ–°è¡Œã‚’è¡¨ç¤º
                    result = subprocess.run(
                        ["tail", "-1", str(log_file)],
                        capture_output=True,
                        text=True
                    )
                    if result.returncode == 0:
                        print(f"{elder_id:15}: {result.stdout.strip()}")
                else:
                    print(f"{elder_id:15}: No log file")

        return 0

    def cmd_health(self, args):
        """ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯"""
        print("ğŸ¥ Elder Tree Soul Health Check")
        print("-" * 40)

        health_score = 0
        total_checks = 0

        # 1. ãƒ—ãƒ­ã‚»ã‚¹ç¢ºèª
        total_checks += 1
        if self._check_processes():
            print("âœ… Processes: All elders running")
            health_score += 1
        else:
            print("âŒ Processes: Some elders not running")

        # 2. Redisç¢ºèª
        total_checks += 1
        if self._check_redis():
            print("âœ… Redis: Running and accessible")
            health_score += 1
        else:
            print("âŒ Redis: Not running or inaccessible")

        # 3. ãƒãƒ¼ãƒˆç¢ºèª
        total_checks += 1
        if self._check_ports():
            print("âœ… Ports: All elder ports responding")
            health_score += 1
        else:
            print("âŒ Ports: Some ports not responding")

        # 4. ãƒ‡ãƒ¼ã‚¿ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç¢ºèª
        total_checks += 1
        if self._check_data_directories():
            print("âœ… Data: All directories accessible")
            health_score += 1
        else:
            print("âŒ Data: Some directories missing")

        # 5. ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª
        total_checks += 1
        if self._check_log_files():
            print("âœ… Logs: Recent activity detected")
            health_score += 1
        else:
            print("âŒ Logs: No recent activity")

        # ç·åˆè©•ä¾¡
        health_percentage = (health_score / total_checks) * 100
        print("-" * 40)
        print(f"ğŸ¥ Overall Health: {health_percentage:.1f}% ({health_score}/{total_checks})")

        if health_percentage >= 80:
            print("ğŸŸ¢ Status: Healthy")
        elif health_percentage >= 60:
            print("ğŸŸ¡ Status: Warning")
        else:
            print("ğŸ”´ Status: Critical")

        return 0 if health_percentage >= 60 else 1

    def cmd_config(self, args):
        """è¨­å®šè¡¨ç¤ºãƒ»å¤‰æ›´"""
        print("âš™ï¸  Elder Tree Soul Configuration")
        print("-" * 40)

        for elder_id, config in self.elders.items():
            print(f"{config['name']:20} (Port: {config['port']})")
            print(f"{'':20} {config['description']}")
            print()

        print("Configuration Files:")
        print(f"  Project Root: {self.project_root}")
        print(f"  Scripts Dir:  {self.scripts_dir}")
        print(f"  Logs Dir:     {self.logs_dir}")
        print(f"  Data Dir:     {self.data_dir}")

        return 0

    def _check_dependencies(self) -> bool:
        """ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯"""
        # Redisç¢ºèª
        if not self._check_redis():
            print("âŒ Redis is not running. Please start Redis first:")
            print("   redis-server")
            return False

        # Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆç¢ºèª
        for elder_id, config in self.elders.items():
            script_path = self.project_root / config['script']
            if not script_path.exists():
                print(f"âŒ Script not found: {script_path}")
                return False

        return True

    def _check_redis(self) -> bool:
        """Redisæ¥ç¶šç¢ºèª"""
        try:
            import redis
            r = redis.Redis(host='localhost', port=6379, socket_timeout=1)
            r.ping()
            return True
        except:
            return False

    def _check_redis_status(self):
        """RedisçŠ¶æ…‹è¡¨ç¤º"""
        if self._check_redis():
            print("ğŸŸ¢ Redis: Running")
        else:
            print("ğŸ”´ Redis: Not running")

    def _check_port_status(self):
        """ãƒãƒ¼ãƒˆçŠ¶æ…‹ç¢ºèª"""
        print("\nPort Status:")
        for elder_id, config in self.elders.items():
            port = config['port']
            if self._is_port_open(port):
                print(f"  {port}: ğŸŸ¢ {elder_id}")
            else:
                print(f"  {port}: ğŸ”´ {elder_id}")

    def _is_port_open(self, port: int) -> bool:
        """ãƒãƒ¼ãƒˆé–‹æ”¾ç¢ºèª"""
        import socket
        try:
            with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as sock:
                sock.settimeout(1)
                result = sock.connect_ex(('localhost', port))
                return result == 0
        except:
            return False

    def _show_process_info(self, pid: str):
        """ãƒ—ãƒ­ã‚»ã‚¹æƒ…å ±è¡¨ç¤º"""
        try:
            result = subprocess.run(
                ["ps", "-p", pid, "-o", "pid,ppid,cmd"],
                capture_output=True,
                text=True
            )
            if result.returncode == 0:
                lines = result.stdout.strip().split('\n')
                if len(lines) > 1:
                    print(f"  PID {pid}: {lines[1]}")
        except:
            pass

    def _restart_specific_elder(self, elder_id: str) -> int:
        """ç‰¹å®šã‚¨ãƒ«ãƒ€ãƒ¼ã®å†èµ·å‹•"""
        if elder_id not in self.elders:
            print(f"âŒ Unknown elder: {elder_id}")
            print(f"Available elders: {', '.join(self.elders.keys())}")
            return 1

        config = self.elders[elder_id]
        script_path = self.project_root / config['script']

        # æ—¢å­˜ãƒ—ãƒ­ã‚»ã‚¹åœæ­¢
        try:
            result = subprocess.run(
                ["pgrep", "-f", f"{elder_id}_process"],
                capture_output=True,
                text=True
            )

            if result.returncode == 0:
                pid = result.stdout.strip()
                subprocess.run(["kill", "-TERM", pid])
                time.sleep(1)
                print(f"âœ… Stopped {elder_id} (PID: {pid})")
        except:
            pass

        # æ–°ãƒ—ãƒ­ã‚»ã‚¹èµ·å‹•
        try:
            log_file = self.logs_dir / f"{elder_id}.log"
            with open(log_file, 'a') as log:
                process = subprocess.Popen(
                    [sys.executable, str(script_path)],
                    stdout=log,
                    stderr=subprocess.STDOUT,
                    cwd=str(self.project_root)
                )
            print(f"âœ… Started {elder_id} (PID: {process.pid})")
            return 0
        except Exception as e:
            print(f"âŒ Failed to start {elder_id}: {e}")
            return 1

    def _check_processes(self) -> bool:
        """ãƒ—ãƒ­ã‚»ã‚¹ç¢ºèª"""
        try:
            result = subprocess.run(
                ["pgrep", "-f", "elder.*process"],
                capture_output=True,
                text=True
            )
            return result.returncode == 0
        except:
            return False

    def _check_ports(self) -> bool:
        """ãƒãƒ¼ãƒˆç¢ºèª"""
        open_count = 0
        for config in self.elders.values():
            if self._is_port_open(config['port']):
                open_count += 1
        return open_count >= len(self.elders) * 0.8  # 80%ä»¥ä¸Š

    def _check_data_directories(self) -> bool:
        """ãƒ‡ãƒ¼ã‚¿ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç¢ºèª"""
        required_dirs = [
            self.data_dir,
            self.logs_dir,
            self.project_root / "knowledge_base"
        ]

        for dir_path in required_dirs:
            if not dir_path.exists():
                return False
        return True

    def _check_log_files(self) -> bool:
        """ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª"""
        recent_logs = 0
        cutoff_time = time.time() - 300  # 5åˆ†å‰

        for elder_id in self.elders.keys():
            log_file = self.logs_dir / f"{elder_id}.log"
            if log_file.exists():
                if log_file.stat().st_mtime > cutoff_time:
                    recent_logs += 1

        return recent_logs >= len(self.elders) * 0.5  # 50%ä»¥ä¸Š


def main():
    """ãƒ¡ã‚¤ãƒ³é–¢æ•°"""
    parser = argparse.ArgumentParser(
        description="ã‚¨ãƒ«ãƒ€ãƒ¼ãƒ„ãƒªãƒ¼ã®é­‚ - Elder Tree Soul Command Interface",
        formatter_class=argparse.RawDescriptionHelpFormatter
    )

    subparsers = parser.add_subparsers(dest='command', help='Available commands')

    # start ã‚³ãƒãƒ³ãƒ‰
    start_parser = subparsers.add_parser('start', help='Start Elder Tree Soul')
    start_parser.add_argument('-d', '--daemon', action='store_true',
                             help='Start in daemon mode')

    # stop ã‚³ãƒãƒ³ãƒ‰
    stop_parser = subparsers.add_parser('stop', help='Stop Elder Tree Soul')

    # status ã‚³ãƒãƒ³ãƒ‰
    status_parser = subparsers.add_parser('status', help='Show status')
    status_parser.add_argument('-v', '--verbose', action='store_true',
                              help='Show detailed information')

    # restart ã‚³ãƒãƒ³ãƒ‰
    restart_parser = subparsers.add_parser('restart', help='Restart elders')
    restart_parser.add_argument('elder', nargs='?',
                               help='Specific elder to restart')
    restart_parser.add_argument('-d', '--daemon', action='store_true',
                               help='Start in daemon mode')

    # logs ã‚³ãƒãƒ³ãƒ‰
    logs_parser = subparsers.add_parser('logs', help='Show logs')
    logs_parser.add_argument('elder', nargs='?',
                            help='Specific elder logs to show')
    logs_parser.add_argument('-f', '--follow', action='store_true',
                            help='Follow log output')
    logs_parser.add_argument('-n', '--lines', type=int,
                            help='Number of lines to show')

    # health ã‚³ãƒãƒ³ãƒ‰
    health_parser = subparsers.add_parser('health', help='Health check')

    # config ã‚³ãƒãƒ³ãƒ‰
    config_parser = subparsers.add_parser('config', help='Show configuration')

    args = parser.parse_args()

    soul = ElderTreeSoul()

    # ã‚³ãƒãƒ³ãƒ‰ãªã—ã®å ´åˆã¯ãƒãƒŠãƒ¼è¡¨ç¤º
    if not args.command:
        soul.show_banner()
        parser.print_help()
        return 0

    # ãƒãƒŠãƒ¼è¡¨ç¤ºï¼ˆãƒ˜ãƒ«ãƒ—ä»¥å¤–ï¼‰
    if args.command not in ['help']:
        soul.show_banner()

    # ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ
    if args.command == 'start':
        return soul.cmd_start(args)
    elif args.command == 'stop':
        return soul.cmd_stop(args)
    elif args.command == 'status':
        return soul.cmd_status(args)
    elif args.command == 'restart':
        return soul.cmd_restart(args)
    elif args.command == 'logs':
        return soul.cmd_logs(args)
    elif args.command == 'health':
        return soul.cmd_health(args)
    elif args.command == 'config':
        return soul.cmd_config(args)
    else:
        parser.print_help()
        return 1


if __name__ == "__main__":
    sys.exit(main())
