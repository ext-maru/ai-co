#!/bin/bash

# ã‚¨ãƒ«ãƒ€ãƒ¼ã‚ºã‚®ãƒ«ãƒ‰ Feature Branchä½œæˆãƒ˜ãƒ«ãƒ‘ãƒ¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
# Usage: git-feature <issue-number> [description]
# Example: git-feature 17 data-model

set -e

# è‰²å®šç¾©
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# ä½¿ç”¨æ–¹æ³•ã‚’è¡¨ç¤º
usage() {
    echo -e "${BLUE}ã‚¨ãƒ«ãƒ€ãƒ¼ã‚ºã‚®ãƒ«ãƒ‰ Feature Branchä½œæˆãƒ„ãƒ¼ãƒ«${NC}"
    echo ""
    echo "ä½¿ç”¨æ–¹æ³•:"
    echo "  git-feature <issue-number> [description]"
    echo ""
    echo "ä¾‹:"
    echo "  git-feature 17 data-model"
    echo "  git-feature 23 fix-api-error"
    echo ""
    echo "ã‚ªãƒ—ã‚·ãƒ§ãƒ³:"
    echo "  -h, --help    ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º"
    echo "  -t, --type    ãƒ–ãƒ©ãƒ³ãƒã‚¿ã‚¤ãƒ—ã‚’æŒ‡å®š (default: feature)"
    echo "                ä½¿ç”¨å¯èƒ½: feature, fix, docs, chore, test"
    exit 1
}

# ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
error() {
    echo -e "${RED}âŒ ã‚¨ãƒ©ãƒ¼: $1${NC}" >&2
    exit 1
}

# æˆåŠŸè¡¨ç¤º
success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

# æƒ…å ±è¡¨ç¤º
info() {
    echo -e "${BLUE}â„¹ï¸  $1${NC}"
}

# è­¦å‘Šè¡¨ç¤º
warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ–ãƒ©ãƒ³ãƒã‚¿ã‚¤ãƒ—
BRANCH_TYPE="feature"

# å¼•æ•°è§£æ
while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            usage
            ;;
        -t|--type)
            BRANCH_TYPE="$2"
            shift 2
            ;;
        *)
            if [[ -z "$ISSUE_NUMBER" ]]; then
                ISSUE_NUMBER="$1"
            elif [[ -z "$DESCRIPTION" ]]; then
                DESCRIPTION="$1"
            fi
            shift
            ;;
    esac
done

# Issueç•ªå·ã®ç¢ºèª
if [[ -z "$ISSUE_NUMBER" ]]; then
    error "Issueç•ªå·ã‚’æŒ‡å®šã—ã¦ãã ã•ã„"
fi

# Issueç•ªå·ãŒæ•°å­—ã‹ãƒã‚§ãƒƒã‚¯
if ! [[ "$ISSUE_NUMBER" =~ ^[0-9]+$ ]]; then
    error "Issueç•ªå·ã¯æ•°å­—ã§æŒ‡å®šã—ã¦ãã ã•ã„"
fi

# ãƒ–ãƒ©ãƒ³ãƒã‚¿ã‚¤ãƒ—ã®å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯
case $BRANCH_TYPE in
    feature|fix|docs|chore|test|refactor|perf)
        ;;
    *)
        error "ä¸æ­£ãªãƒ–ãƒ©ãƒ³ãƒã‚¿ã‚¤ãƒ—: $BRANCH_TYPE"
        ;;
esac

# Gitãƒªãƒã‚¸ãƒˆãƒªã‹ãƒã‚§ãƒƒã‚¯
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    error "Gitãƒªãƒã‚¸ãƒˆãƒªã§ã¯ã‚ã‚Šã¾ã›ã‚“"
fi

# ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒç¢ºèª
CURRENT_BRANCH=$(git branch --show-current)
info "ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒ: $CURRENT_BRANCH"

# mainãƒ–ãƒ©ãƒ³ãƒã«åˆ‡ã‚Šæ›¿ãˆ
if [[ "$CURRENT_BRANCH" != "main" ]]; then
    warning "mainãƒ–ãƒ©ãƒ³ãƒã«åˆ‡ã‚Šæ›¿ãˆã¾ã™..."
    
    # æœªã‚³ãƒŸãƒƒãƒˆã®å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    if ! git diff --quiet || ! git diff --staged --quiet; then
        warning "æœªã‚³ãƒŸãƒƒãƒˆã®å¤‰æ›´ãŒã‚ã‚Šã¾ã™"
        echo "1) stashã—ã¦ç¶šè¡Œ"
        echo "2) ä¸­æ­¢"
        read -p "é¸æŠã—ã¦ãã ã•ã„ (1/2): " choice
        
        case $choice in
            1)
                git stash push -m "auto-stash before creating feature branch"
                success "å¤‰æ›´ã‚’stashã—ã¾ã—ãŸ"
                ;;
            2)
                error "æ“ä½œã‚’ä¸­æ­¢ã—ã¾ã—ãŸ"
                ;;
            *)
                error "ç„¡åŠ¹ãªé¸æŠã§ã™"
                ;;
        esac
    fi
    
    git checkout main
fi

# mainãƒ–ãƒ©ãƒ³ãƒã‚’æœ€æ–°ã«æ›´æ–°
info "mainãƒ–ãƒ©ãƒ³ãƒã‚’æœ€æ–°ã«æ›´æ–°ã—ã¦ã„ã¾ã™..."
git pull origin main

# ãƒ–ãƒ©ãƒ³ãƒåã®ç”Ÿæˆ
if [[ -n "$DESCRIPTION" ]]; then
    BRANCH_NAME="${BRANCH_TYPE}/issue-${ISSUE_NUMBER}-${DESCRIPTION}"
else
    BRANCH_NAME="${BRANCH_TYPE}/issue-${ISSUE_NUMBER}"
fi

# ãƒ–ãƒ©ãƒ³ãƒåã®ç¢ºèª
echo ""
info "ä½œæˆã™ã‚‹ãƒ–ãƒ©ãƒ³ãƒ: $BRANCH_NAME"
read -p "ã“ã®ãƒ–ãƒ©ãƒ³ãƒåã§ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ (y/n): " confirm

if [[ "$confirm" != "y" && "$confirm" != "Y" ]]; then
    read -p "ãƒ–ãƒ©ãƒ³ãƒåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„: " CUSTOM_BRANCH_NAME
    if [[ -n "$CUSTOM_BRANCH_NAME" ]]; then
        BRANCH_NAME="$CUSTOM_BRANCH_NAME"
    else
        error "ãƒ–ãƒ©ãƒ³ãƒåãŒå…¥åŠ›ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
    fi
fi

# ãƒ–ãƒ©ãƒ³ãƒãŒæ—¢ã«å­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
if git show-ref --verify --quiet "refs/heads/$BRANCH_NAME"; then
    error "ãƒ–ãƒ©ãƒ³ãƒ '$BRANCH_NAME' ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™"
fi

# Feature Branchä½œæˆ
info "Feature Branchã‚’ä½œæˆã—ã¦ã„ã¾ã™..."
git checkout -b "$BRANCH_NAME"
success "Feature Branch '$BRANCH_NAME' ã‚’ä½œæˆã—ã¾ã—ãŸ"

# åˆå›ã‚³ãƒŸãƒƒãƒˆç”¨ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè¡¨ç¤º
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ¯ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:"
echo ""
echo "1. é–‹ç™ºã‚’é–‹å§‹ã—ã¦ãã ã•ã„"
echo "2. ã‚³ãƒŸãƒƒãƒˆæ™‚ã¯ä»¥ä¸‹ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’ä½¿ç”¨:"
echo ""
echo "   git commit -m \"${BRANCH_TYPE}: å¤‰æ›´å†…å®¹ã®èª¬æ˜ (#${ISSUE_NUMBER})\""
echo ""
echo "3. åˆå›ãƒ—ãƒƒã‚·ãƒ¥:"
echo ""
echo "   git push -u origin $BRANCH_NAME"
echo ""
echo "4. PRä½œæˆæ™‚ã¯æœ¬æ–‡ã«ä»¥ä¸‹ã‚’å«ã‚ã‚‹:"
echo ""
echo "   Closes #${ISSUE_NUMBER}"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# GitHub Issue URLã‚’è¡¨ç¤ºï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
if command -v gh &> /dev/null; then
    REPO=$(gh repo view --json nameWithOwner -q .nameWithOwner 2>/dev/null || echo "")
    if [[ -n "$REPO" ]]; then
        echo ""
        info "ğŸ“‹ Issue URL: https://github.com/$REPO/issues/$ISSUE_NUMBER"
    fi
fi

# VS CodeãŒèµ·å‹•ã—ã¦ã„ã‚‹å ´åˆã¯é€šçŸ¥
if command -v code &> /dev/null && [[ -n "$VSCODE_IPC_HOOK_CLI" ]]; then
    echo ""
    info "ğŸ’¡ VS Codeã§ãƒ–ãƒ©ãƒ³ãƒãŒåˆ‡ã‚Šæ›¿ã‚ã‚Šã¾ã—ãŸ"
fi