#!/bin/bash
# GitHub Issue Helper Script for Elder Guild
# Sub Issueç®¡ç†ã¨ã‚³ãƒ¡ãƒ³ãƒˆé–²è¦§ã®ä¾¿åˆ©ã‚³ãƒãƒ³ãƒ‰

set -e

# è‰²å®šç¾©
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# ãƒ˜ãƒ«ãƒ—è¡¨ç¤º
show_help() {
    echo -e "${CYAN}ğŸ›ï¸ GitHub Issue Helper for Elder Guild${NC}"
    echo ""
    echo "ä½¿ç”¨æ–¹æ³•:"
    echo -e "  ${GREEN}./github_issue_helper.sh <command> [options]${NC}"
    echo ""
    echo "ã‚³ãƒãƒ³ãƒ‰:"
    echo -e "  ${YELLOW}view <issue_number>${NC}        - Issueè©³ç´°è¡¨ç¤º"
    echo -e "  ${YELLOW}master <issue_number>${NC}      - Master Issueé€²æ—ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰"
    echo -e "  ${YELLOW}comments <issue_number>${NC}    - ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§è¡¨ç¤º"
    echo -e "  ${YELLOW}create-sub <master_id> <title>${NC} - Sub Issueä½œæˆ"
    echo -e "  ${YELLOW}close-sub <issue_number>${NC}   - Sub Issueå®Œäº†"
    echo -e "  ${YELLOW}update-master <master_id>${NC}  - Master Issueé€²æ—æ›´æ–°"
    echo -e "  ${YELLOW}sage-status${NC}                - 4è³¢è€…ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç¢ºèª"
    echo ""
    echo "ä¾‹:"
    echo -e "  ${GREEN}./github_issue_helper.sh view 7${NC}"
    echo -e "  ${GREEN}./github_issue_helper.sh master 7${NC}"
    echo -e "  ${GREEN}./github_issue_helper.sh create-sub 7 'ğŸ§™â€â™‚ï¸ ãƒ†ã‚¹ãƒˆæ©Ÿèƒ½å®Ÿè£…'${NC}"
}

# Issueè©³ç´°è¡¨ç¤º
view_issue() {
    local issue_number=$1
    echo -e "${CYAN}ğŸ” Issue #${issue_number} è©³ç´°è¡¨ç¤º${NC}"
    python3 scripts/github_issue_dashboard.py "$issue_number"
}

# Master Issueé€²æ—ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
master_dashboard() {
    local master_issue=$1
    echo -e "${PURPLE}ğŸ›ï¸ Master Issueé€²æ—ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰${NC}"
    python3 scripts/github_issue_dashboard.py master "$master_issue"
}

# ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§è¡¨ç¤º
view_comments() {
    local issue_number=$1
    echo -e "${BLUE}ğŸ’¬ Issue #${issue_number} ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§${NC}"
    gh issue view "$issue_number" --comments
}

# Sub Issueä½œæˆ
create_sub_issue() {
    local master_id=$1
    local title=$2

    echo -e "${GREEN}ğŸ“ Sub Issueä½œæˆä¸­...${NC}"

    # 4è³¢è€…ã‚·ã‚¹ãƒ†ãƒ ã®æ‹…å½“ã‚’åˆ¤å®š
    local sage_type=""
    local sage_emoji=""

    if [[ "$title" =~ "Knowledge"||"çŸ¥è­˜"||"ãƒŠãƒ¬ãƒƒã‚¸" ]]; then
        sage_type="knowledge-sage"
        sage_emoji="ğŸ“š"
    elif [[ "$title" =~ "Task"||"ã‚¿ã‚¹ã‚¯"||"é€²æ—" ]]; then
        sage_type="task-sage"
        sage_emoji="ğŸ“‹"
    elif [[ "$title" =~ "Incident"||"ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆ"||"ã‚¨ãƒ©ãƒ¼" ]]; then
        sage_type="incident-sage"
        sage_emoji="ğŸš¨"
    elif [[ "$title" =~ "RAG"||"æ¤œç´¢"||"æƒ…å ±" ]]; then
        sage_type="rag-sage"
        sage_emoji="ğŸ”"
    fi

    # Sub Issueä½œæˆ
    gh issue create \
        --title "$title" \
        --body "# $sage_emoji Sub Issue

## ğŸ¯ ç›®çš„
Master Issue #${master_id} ã®ã‚µãƒ–ã‚¿ã‚¹ã‚¯å®Ÿè£…

## ğŸ“‹ ã‚¿ã‚¹ã‚¯
- [ ] è¦ä»¶å®šç¾©
- [ ] è¨­è¨ˆ
- [ ] å®Ÿè£…
- [ ] ãƒ†ã‚¹ãƒˆ
- [ ] å®Œäº†ç¢ºèª

## ğŸ”— é–¢é€£
- Parent Issue: #${master_id}
- æ‹…å½“: $sage_emoji $sage_type

## ğŸ“Š æˆåŠŸæŒ‡æ¨™
- å“è³ªåŸºæº–: 95%ä»¥ä¸Š
- ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸: 90%ä»¥ä¸Š
- å®Œäº†æœŸé™: è¨­å®šå¾…ã¡

ğŸ¤– Auto-generated by Elder Guild Helper" \
        --label "$sage_type,sub-issue"
}

# Sub Issueå®Œäº†
close_sub_issue() {
    local issue_number=$1

    echo -e "${GREEN}âœ… Sub Issue #${issue_number} å®Œäº†å‡¦ç†ä¸­...${NC}"

    gh issue close "$issue_number" --comment "âœ… **Sub Issueå®Œäº†**

## ğŸ“Š æœ€çµ‚çµæœ
Sub Issueå®Œäº†ã«ã‚ˆã‚Šã€Master Issueã®é€²æ—ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸã€‚

## ğŸ”„ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
é–¢é€£ã™ã‚‹Sub Issueã®å®Ÿè¡Œã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚

ğŸ¤– Auto-closed by Elder Guild Helper"
}

# Master Issueé€²æ—æ›´æ–°
update_master_progress() {
    local master_id=$1

    echo -e "${YELLOW}ğŸ“Š Master Issue #${master_id} é€²æ—æ›´æ–°ä¸­...${NC}"

    # é–¢é€£Sub Issueã®çŠ¶æ…‹ã‚’å–å¾—
    local total_subs=$(gh issue list --label "sub-issue" --json number,state | jq length)
    local completed_subs=$(gh issue list --label "sub-issue" --state closed --json number | jq length)

    local progress=0
    if [ "$total_subs" -gt 0 ]; then
        progress=$((completed_subs * 100 / total_subs))
    fi

    # Master Issueã«é€²æ—ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ 
    gh issue comment "$master_id" --body "ğŸ“Š **è‡ªå‹•é€²æ—æ›´æ–°**

## ğŸ“ˆ ç¾åœ¨ã®é€²æ—
- ç·Sub Issueæ•°: $total_subs
- å®Œäº†Sub Issueæ•°: $completed_subs
- é€²æ—ç‡: $progress%

## ğŸ”„ æ›´æ–°æ—¥æ™‚
$(date '+%Y-%m-%d %H:%M:%S')

ğŸ¤– Auto-updated by Elder Guild Helper"
}

# 4è³¢è€…ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç¢ºèª
sage_status() {
    echo -e "${PURPLE}ğŸ§™â€â™‚ï¸ 4è³¢è€…ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç¢ºèª${NC}"

    echo -e "${BLUE}ğŸ“š Knowledge Sage:${NC}"
    gh issue list --label "knowledge-sage" --json number,title,state

    echo -e "${BLUE}ğŸ“‹ Task Sage:${NC}"
    gh issue list --label "task-sage" --json number,title,state

    echo -e "${BLUE}ğŸš¨ Incident Sage:${NC}"
    gh issue list --label "incident-sage" --json number,title,state

    echo -e "${BLUE}ğŸ” RAG Sage:${NC}"
    gh issue list --label "rag-sage" --json number,title,state
}

# ãƒ¡ã‚¤ãƒ³å‡¦ç†
main() {
    case "${1:-help}" in
        "view")
            view_issue "$2"
            ;;
        "master")
            master_dashboard "$2"
            ;;
        "comments")
            view_comments "$2"
            ;;
        "create-sub")
            create_sub_issue "$2" "$3"
            ;;
        "close-sub")
            close_sub_issue "$2"
            ;;
        "update-master")
            update_master_progress "$2"
            ;;
        "sage-status")
            sage_status
            ;;
        "help"|*)
            show_help
            ;;
    esac
}

main "$@"
