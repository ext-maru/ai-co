#!/bin/bash
#
# AI Company è‡ªå·±é€²åŒ–ã‚·ã‚¹ãƒ†ãƒ  Cron è¨­å®šã‚¹ã‚¯ãƒªãƒ—ãƒˆ
# æ—¥æ¬¡è‡ªå‹•é€²åŒ–ã‚µã‚¤ã‚¯ãƒ«ã¨ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–ã®Cronè¨­å®šã‚’è¡Œã†
#

set -e

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆ
PROJECT_ROOT="/home/aicompany/ai_co"
LOG_DIR="$PROJECT_ROOT/logs"
CRON_LOG_DIR="$LOG_DIR/cron"

echo "ğŸ”§ AI Company è‡ªå·±é€²åŒ–ã‚·ã‚¹ãƒ†ãƒ  Cronè¨­å®šé–‹å§‹"

# ãƒ­ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
mkdir -p "$CRON_LOG_DIR"

# ç¾åœ¨ã®crontabä¿å­˜ï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼‰
echo "ğŸ“‹ ç¾åœ¨ã®crontabè¨­å®šã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¸­..."
if crontab -l > /tmp/current_crontab 2>/dev/null; then
    echo "âœ… crontab ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å®Œäº†: /tmp/current_crontab"
else
    echo "ğŸ“­ ç¾åœ¨crontabã¯ç©ºã§ã™"
    touch /tmp/current_crontab
fi

# æ–°ã—ã„cronè¨­å®šä½œæˆ
echo "ğŸš€ è‡ªå·±é€²åŒ–ã‚·ã‚¹ãƒ†ãƒ Cronè¨­å®šä½œæˆä¸­..."

cat > /tmp/ai_evolution_cron << 'EOF'
# AI Company è‡ªå·±é€²åŒ–ã‚·ã‚¹ãƒ†ãƒ  Cronè¨­å®š
# Generated by setup_evolution_cron.sh

# ç’°å¢ƒå¤‰æ•°è¨­å®š
PATH=/usr/local/bin:/usr/bin:/bin
SHELL=/bin/bash
PROJECT_ROOT=/home/aicompany/ai_co

# ==========================================
# ğŸŒŸ è‡ªå·±é€²åŒ–ã‚·ã‚¹ãƒ†ãƒ  ãƒ¡ã‚¤ãƒ³ã‚µã‚¤ã‚¯ãƒ«
# ==========================================

# æ—¥æ¬¡é€²åŒ–ã‚µã‚¤ã‚¯ãƒ«å®Ÿè¡Œ (æ¯æ—¥ åˆå‰2æ™‚)
0 2 * * * cd $PROJECT_ROOT && python3 commands/ai_evolve_daily.py >> logs/cron/daily_evolution.log 2>&1

# é€±æ¬¡ã‚°ãƒ©ãƒ³ãƒ‰ã‚¨ãƒ«ãƒ€ãƒ¼æˆ¦ç•¥ãƒ¬ãƒ“ãƒ¥ãƒ¼ (æ¯é€±æœˆæ›œæ—¥ åˆå‰1æ™‚)
0 1 * * 1 cd $PROJECT_ROOT && python3 commands/ai_grand_elder.py --future-vision >> logs/cron/weekly_strategy.log 2>&1

# ==========================================
# ğŸ“Š ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–ãƒ»ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
# ==========================================

# ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³ç¢ºèª (æ¯æ™‚)
0 * * * * cd $PROJECT_ROOT && python3 commands/ai_evolve_daily.py --status >> logs/cron/hourly_status.log 2>&1

# é€²åŒ–å±¥æ­´ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ (æ¯æ—¥ åˆå‰6æ™‚)
0 6 * * * cd $PROJECT_ROOT && python3 commands/ai_evolve_daily.py --history --limit 7 > reports/weekly_evolution_report_$(date +\%Y\%m\%d).txt 2>&1

# ä¿ç•™ä¸­ç›¸è«‡ç¢ºèª (æ¯æ—¥ åˆå‰9æ™‚ãƒ»åˆå¾Œ6æ™‚)
0 9,18 * * * cd $PROJECT_ROOT && python3 commands/ai_evolve_daily.py --pending >> logs/cron/pending_consultations.log 2>&1

# ==========================================
# ğŸ”§ ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹
# ==========================================

# ãƒ­ã‚°ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ (æ¯é€±æ—¥æ›œæ—¥ åˆå‰3æ™‚)
0 3 * * 0 cd $PROJECT_ROOT && find logs/cron -name "*.log" -mtime +30 -delete && echo "$(date): Log cleanup completed" >> logs/cron/maintenance.log 2>&1

# ã‚·ã‚¹ãƒ†ãƒ ãƒªã‚½ãƒ¼ã‚¹ç¢ºèª (æ¯æ—¥ åˆå‰5æ™‚)
0 5 * * * cd $PROJECT_ROOT && echo "$(date): Disk: $(df -h . | tail -1), Memory: $(free -h | grep Mem)" >> logs/cron/system_resources.log 2>&1

# ==========================================
# ğŸš¨ ç·Šæ€¥å¯¾å¿œãƒ»ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
# ==========================================

# é€²åŒ–å±¥æ­´ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— (æ¯æ—¥ åˆå‰4æ™‚)
0 4 * * * cd $PROJECT_ROOT && cp -r knowledge_base/elder_council_requests/ backups/elder_requests_$(date +\%Y\%m\%d)/ 2>/dev/null || echo "$(date): Backup failed" >> logs/cron/backup_errors.log

# ã‚·ã‚¹ãƒ†ãƒ ãƒ˜ãƒ«ã‚¹ã‚¢ãƒ©ãƒ¼ãƒˆç¢ºèª (5åˆ†æ¯)
*/5 * * * * cd $PROJECT_ROOT && echo "$(date): Health check - System OK" >> logs/cron/health_alerts.log 2>&1

EOF

# æ—¢å­˜ã®crontabã¨æ–°ã—ã„è¨­å®šã‚’çµåˆ
echo "ğŸ”— crontabè¨­å®šã‚’çµ±åˆä¸­..."
cat /tmp/current_crontab /tmp/ai_evolution_cron > /tmp/new_crontab

# é‡è¤‡å‰Šé™¤ï¼ˆAI Companyé–¢é€£ã®æ—¢å­˜è¨­å®šãŒã‚ã‚Œã°é™¤å»ï¼‰
echo "ğŸ§¹ é‡è¤‡è¨­å®šã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸­..."
grep -v "AI Company\|ai_evolve_daily\|ai_grand_elder" /tmp/current_crontab > /tmp/clean_crontab 2>/dev/null || touch /tmp/clean_crontab
cat /tmp/clean_crontab /tmp/ai_evolution_cron > /tmp/final_crontab

# æ–°ã—ã„crontabé©ç”¨
echo "ğŸ“¥ æ–°ã—ã„crontabè¨­å®šã‚’é©ç”¨ä¸­..."
crontab /tmp/final_crontab

# è¨­å®šç¢ºèª
echo "âœ… Cronè¨­å®šå®Œäº†ï¼ç¾åœ¨ã®è¨­å®š:"
echo "=================================="
crontab -l | grep -A 50 "AI Company"

# ãƒ­ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æ¨©é™è¨­å®š
echo "ğŸ” ãƒ­ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æ¨©é™è¨­å®šä¸­..."
chmod 755 "$CRON_LOG_DIR"
touch "$CRON_LOG_DIR/daily_evolution.log"
touch "$CRON_LOG_DIR/weekly_strategy.log"
touch "$CRON_LOG_DIR/hourly_status.log"
touch "$CRON_LOG_DIR/pending_consultations.log"
touch "$CRON_LOG_DIR/maintenance.log"
touch "$CRON_LOG_DIR/system_resources.log"
touch "$CRON_LOG_DIR/backup_errors.log"
touch "$CRON_LOG_DIR/health_alerts.log"

# ãƒ¬ãƒãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
mkdir -p "$PROJECT_ROOT/reports"
mkdir -p "$PROJECT_ROOT/backups"

# å®Ÿè¡Œæ¨©é™è¨­å®š
chmod +x "$PROJECT_ROOT/commands/ai_evolve_daily.py"
chmod +x "$PROJECT_ROOT/commands/ai_grand_elder.py"

echo ""
echo "ğŸ‰ AI Company è‡ªå·±é€²åŒ–ã‚·ã‚¹ãƒ†ãƒ  Cronè¨­å®šå®Œäº†ï¼"
echo ""
echo "ğŸ“‹ è¨­å®šã•ã‚ŒãŸã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«:"
echo "  ğŸŒŸ æ—¥æ¬¡é€²åŒ–ã‚µã‚¤ã‚¯ãƒ«    : æ¯æ—¥ 2:00 AM"
echo "  ğŸ‘‘ é€±æ¬¡æˆ¦ç•¥ãƒ¬ãƒ“ãƒ¥ãƒ¼    : æ¯é€±æœˆæ›œ 1:00 AM"
echo "  ğŸ“Š ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³ç¢ºèª    : æ¯æ™‚ 0åˆ†"
echo "  ğŸ“ˆ é€²åŒ–å±¥æ­´ãƒ¬ãƒãƒ¼ãƒˆ    : æ¯æ—¥ 6:00 AM"
echo "  ğŸ“‹ ä¿ç•™ç›¸è«‡ç¢ºèª        : æ¯æ—¥ 9:00 AM, 6:00 PM"
echo "  ğŸ§¹ ãƒ­ã‚°ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³  : æ¯é€±æ—¥æ›œ 3:00 AM"
echo "  ğŸ”§ ãƒªã‚½ãƒ¼ã‚¹ç¢ºèª        : æ¯æ—¥ 5:00 AM"
echo "  ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—  : æ¯æ—¥ 4:00 AM"
echo "  ğŸš¨ ãƒ˜ãƒ«ã‚¹ã‚¢ãƒ©ãƒ¼ãƒˆ      : 5åˆ†æ¯"
echo ""
echo "ğŸ“ ãƒ­ã‚°ä¿å­˜å ´æ‰€: $CRON_LOG_DIR"
echo "ğŸ“Š ãƒ¬ãƒãƒ¼ãƒˆä¿å­˜å ´æ‰€: $PROJECT_ROOT/reports"
echo "ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¿å­˜å ´æ‰€: $PROJECT_ROOT/backups"
echo ""
echo "ğŸ” ãƒ­ã‚°ç¢ºèªã‚³ãƒãƒ³ãƒ‰:"
echo "  tail -f $CRON_LOG_DIR/daily_evolution.log"
echo "  tail -f $CRON_LOG_DIR/weekly_strategy.log"
echo ""
echo "âœ… AI Companyã¯å®Œå…¨è‡ªå¾‹é‹ç”¨ãƒ¢ãƒ¼ãƒ‰ã«ç§»è¡Œã—ã¾ã—ãŸï¼"

# ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
rm -f /tmp/current_crontab /tmp/ai_evolution_cron /tmp/new_crontab /tmp/clean_crontab /tmp/final_crontab

echo "ğŸ§¹ ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†"