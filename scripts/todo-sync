#!/usr/bin/env python3
"""
Todo Sync Command - æ‰‹å‹•ã§TodoListã¨PostgreSQLã‚’åŒæœŸ
"""

import asyncio
import sys
from pathlib import Path

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã‚’ãƒ‘ã‚¹ã«è¿½åŠ 
project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))

from libs.todo_tracker_integration import TodoTrackerIntegration


async def main():
    """æ‰‹å‹•åŒæœŸå®Ÿè¡Œ"""
    print("ğŸ”„ TodoåŒæœŸã‚’é–‹å§‹ã—ã¾ã™...")
    
    # ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—
    import os
    user_id = os.environ.get("CLAUDE_ELDER_USER", "claude_elder")
    
    try:
        # çµ±åˆã‚·ã‚¹ãƒ†ãƒ ã‚’åˆæœŸåŒ–ï¼ˆè‡ªå‹•åŒæœŸç„¡åŠ¹ï¼‰
        integration = TodoTrackerIntegration(
            auto_sync=False,
            user_id=user_id
        )
        await integration.initialize()
        
        # ç¾åœ¨ã®Todoãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
        current_todos = integration.get_current_todos()
        if current_todos:
            print(f"\nğŸ“‹ ç¾åœ¨ã®Todoãƒªã‚¹ãƒˆ ({len(current_todos)}ä»¶):")
            for todo in current_todos[:5]:
                status_emoji = {
                    "pending": "ğŸ“‹",
                    "in_progress": "ğŸ”„", 
                    "completed": "âœ…"
                }.get(todo.get("status", "pending"), "â“")
                print(f"   {status_emoji} {todo.get('content', 'No content')}")
            if len(current_todos) > 5:
                print(f"   ... ä»– {len(current_todos) - 5} ä»¶")
        
        # åŒæœŸç¢ºèª
        print("\nğŸ”„ PostgreSQLã¨åŒæœŸã—ã¾ã™ã‹ï¼Ÿ [Y/n]: ", end="", flush=True)
        choice = input().strip().lower()
        
        if choice != 'n':
            # åŒæ–¹å‘åŒæœŸã‚’å®Ÿè¡Œ
            print("\nâš¡ åŒæœŸä¸­...")
            await integration.sync_both_ways(personal_only=True)
            
            # åŒæœŸçµæœã‚’è¡¨ç¤º
            sync_status = await integration.get_sync_status()
            print("\nâœ… åŒæœŸå®Œäº†!")
            print(f"   ğŸ“Š Todoæ•°: {sync_status['todo_count']}")
            print(f"   ğŸ“‹ å¾…æ©Ÿä¸­: {sync_status['my_tasks_stats']['pending']}")
            print(f"   ğŸ”„ å®Ÿè¡Œä¸­: {sync_status['my_tasks_stats']['in_progress']}")
            print(f"   âœ… å®Œäº†: {sync_status['my_tasks_stats']['completed']}")
        else:
            print("\nâŒ åŒæœŸã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ")
        
        # ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        if integration.tracker:
            await integration.tracker.close()
            
    except Exception as e:
        print(f"\nâŒ ã‚¨ãƒ©ãƒ¼: {e}")
        sys.exit(1)


if __name__ == "__main__":
    asyncio.run(main())