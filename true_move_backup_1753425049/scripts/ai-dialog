#!/bin/bash
# å¯¾è©±å‹ã‚¿ã‚¹ã‚¯é–‹å§‹

# ãƒ˜ãƒ«ãƒ—è¡¨ç¤º
show_help() {
    cat << EOF
ai-dialog - AI Companyå¯¾è©±å‹ã‚¿ã‚¹ã‚¯é–‹å§‹ã‚³ãƒãƒ³ãƒ‰

ä½¿ç”¨æ–¹æ³•:
    ai-dialog <åˆæœŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ>
    ai-dialog --help | -h

èª¬æ˜:
    AIã¨ã®å¯¾è©±å‹ã‚¿ã‚¹ã‚¯ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã—ã¾ã™ã€‚
    æŒ‡å®šã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§ã‚¿ã‚¹ã‚¯ã‚’é–‹å§‹ã—ã€ä¼šè©±IDã‚’ç”Ÿæˆã—ã¾ã™ã€‚

å¼•æ•°:
    <åˆæœŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ>    ã‚¿ã‚¹ã‚¯ã®é–‹å§‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ

ã‚ªãƒ—ã‚·ãƒ§ãƒ³:
    --help, -h          ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º

ä¾‹:
    ai-dialog "PDFãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ ã‚’ä½œæˆã—ã¦ãã ã•ã„"
    ai-dialog "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æœ€é©åŒ–ã‚’ææ¡ˆã—ã¦ãã ã•ã„"

æ³¨æ„:
    å¿œç­”ã¯ ai-reply <conversation_id> <å›ç­”> ã§é€ä¿¡ã—ã¦ãã ã•ã„
EOF
}

# å¼•æ•°ãƒã‚§ãƒƒã‚¯
if [ $# -eq 0 ]; then
    echo "ä½¿ç”¨æ–¹æ³•: ai-dialog <åˆæœŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ>"
    echo "è©³ç´°: ai-dialog --help"
    exit 1
fi

# ãƒ˜ãƒ«ãƒ—ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯
if [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
    show_help
    exit 0
fi

PROMPT="$*"
cd /root/ai_co
source venv/bin/activate

python3 -c "
import sys
sys.path.append('/root/ai_co')
from libs.conversation_manager import ConversationManager
from datetime import datetime
import pika
import json

# ä¼šè©±é–‹å§‹
manager = ConversationManager()
task_id = f'dialog_{datetime.now().strftime(\"%Y%m%d_%H%M%S\")}'
conv_id = manager.start_conversation(task_id, '$PROMPT')

# åˆæœŸã‚¿ã‚¹ã‚¯é€ä¿¡
connection = pika.BlockingConnection(pika.ConnectionParameters('localhost'))
channel = connection.channel()

task_data = {
    'conversation_id': conv_id,
    'instruction': '$PROMPT',
    'context': {'initial': True}
}

channel.basic_publish(
    exchange='',
    routing_key='dialog_task_queue',
    body=json.dumps(task_data),
    properties=pika.BasicProperties(delivery_mode=2)
)

print(f'ğŸš€ å¯¾è©±é–‹å§‹: {conv_id}')
print(f'å¿œç­”ã¯ ai-reply {conv_id} <å›ç­”> ã§é€ä¿¡')
connection.close()
"
