#!/usr/bin/env python3
"""
AI Command System - çµ±ä¸€ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
ã‚¨ãƒ«ãƒ€ãƒ¼è©•è­°ä¼šæ‰¿èªæ¸ˆã¿æ–°ä½“ç³» (2025å¹´7æœˆ9æ—¥)
"""

import json
import os
import subprocess
import sys
from pathlib import Path
from typing import Dict, List, Optional


class AICommandSystem:
    """AIçµ±ä¸€ã‚³ãƒãƒ³ãƒ‰ã‚·ã‚¹ãƒ†ãƒ """

    def __init__(self):
        self.scripts_dir = Path("/home/aicompany/ai_co/scripts")
        self.version = "2.0.0"
        self.categories = {
            "core": {
                "name": "Core Commands",
                "description": "åŸºæœ¬ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒãƒ³ãƒ‰",
                "commands": {
                    "start": {"script": "ai-start", "desc": "ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•"},
                    "stop": {"script": "ai-stop", "desc": "ã‚·ã‚¹ãƒ†ãƒ åœæ­¢"},
                    "status": {"script": "ai-status", "desc": "ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç¢ºèª"},
                    "env": {"script": "ai-env", "desc": "ç’°å¢ƒè¨­å®š"},
                },
            },
            "elder": {
                "name": "Elder Management",
                "description": "ã‚¨ãƒ«ãƒ€ãƒ¼ç®¡ç†æ©Ÿèƒ½",
                "commands": {
                    "status": {"script": "ai-elder", "desc": "ã‚¨ãƒ«ãƒ€ãƒ¼çŠ¶æ…‹ç¢ºèª"},
                    "council": {"script": "ai-elder-council", "desc": "è©•è­°ä¼šç®¡ç†"},
                    "settings": {"script": "ai-elder-settings", "desc": "è¨­å®šè¡¨ç¤º"},
                    "tree": {"script": "ai-elder-tree", "desc": "ã‚¨ãƒ«ãƒ€ãƒ¼ãƒ„ãƒªãƒ¼è¡¨ç¤º"},
                    "compliance": {"script": "ai-elder-compliance", "desc": "ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹"},
                    "servant": {"script": "ai-servant", "desc": "ã‚µãƒ¼ãƒãƒ³ãƒˆç®¡ç†"},
                },
            },
            "worker": {
                "name": "Worker Management",
                "description": "ãƒ¯ãƒ¼ã‚«ãƒ¼ç®¡ç†",
                "commands": {
                    "status": {"script": "ai-worker-comm", "desc": "ãƒ¯ãƒ¼ã‚«ãƒ¼é€šä¿¡çŠ¶æ…‹"},
                    "recovery": {"script": "ai-worker-recovery", "desc": "ãƒ¯ãƒ¼ã‚«ãƒ¼å¾©æ—§"},
                    "dlq": {"script": "ai-dlq", "desc": "DLQç®¡ç†"},
                },
            },
            "dev": {
                "name": "Development Tools",
                "description": "é–‹ç™ºãƒ„ãƒ¼ãƒ«",
                "commands": {
                    "codegen": {"script": "ai-codegen", "desc": "ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ"},
                    "document": {"script": "ai-document", "desc": "ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç”Ÿæˆ"},
                    "git": {"script": "ai-git", "desc": "Gitçµ±åˆ"},
                    "tdd": {"script": "ai-tdd", "desc": "TDDé–‹ç™º"},
                },
            },
            "test": {
                "name": "Testing Tools",
                "description": "ãƒ†ã‚¹ãƒˆãƒ„ãƒ¼ãƒ«",
                "commands": {
                    "coverage": {"script": "ai-test-coverage", "desc": "ã‚«ãƒãƒ¬ãƒƒã‚¸åˆ†æ"},
                    "quality": {"script": "ai-test-quality", "desc": "å“è³ªåˆ†æ"},
                    "runner": {"script": "ai-test-runner", "desc": "ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"},
                    "magic": {"script": "ai-elf-test-magic", "desc": "ã‚¨ãƒ«ãƒ•ãƒ†ã‚¹ãƒˆé­”æ³•"},
                },
            },
            "ops": {
                "name": "Operations",
                "description": "é‹ç”¨ãƒ„ãƒ¼ãƒ«",
                "commands": {
                    "dashboard": {"script": "ai-dashboard", "desc": "ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰"},
                    "api-status": {"script": "ai-api-status", "desc": "APIçŠ¶æ…‹"},
                    "api-health": {"script": "ai-api-health", "desc": "APIãƒ˜ãƒ«ã‚¹"},
                    "api-reset": {"script": "ai-api-reset", "desc": "APIãƒªã‚»ãƒƒãƒˆ"},
                },
            },
            "monitor": {
                "name": "Monitoring",
                "description": "ç›£è¦–ãƒ»ãƒ­ã‚°",
                "commands": {
                    "logs": {"script": "ai-logs", "desc": "ãƒ­ã‚°è¡¨ç¤º"},
                    "proactive": {
                        "script": "ai-elder-proactive-monitor",
                        "desc": "äºˆé˜²çš„ç›£è¦–",
                    },
                },
            },
            "integrate": {
                "name": "Integrations",
                "description": "å¤–éƒ¨é€£æº",
                "commands": {
                    "slack": {"script": "ai-slack", "desc": "Slackçµ±åˆ"},
                    "mcp": {"script": "ai-mcp", "desc": "MCPçµ±åˆ"},
                    "send": {"script": "ai-send", "desc": "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡"},
                },
            },
        }

        # ç‰¹æ®Šã‚³ãƒãƒ³ãƒ‰ï¼ˆã‚¨ã‚¤ãƒªã‚¢ã‚¹ï¼‰
        self.aliases = {
            "help": self.show_help,
            "h": self.show_help,
            "?": self.show_help,
            "version": self.show_version,
            "v": self.show_version,
            "find": self.find_command,
            "search": self.find_command,
        }

    def show_help(self, args: List[str] = None):
        """ãƒ˜ãƒ«ãƒ—è¡¨ç¤º"""
        if args and len(args) > 0:
            # Category specific help
            category = args[0]
            if category in self.categories:
                self.show_category_help(category)
            else:
                print(f"âŒ Unknown category: {category}")
                print(f"Available categories: {', '.join(self.categories.keys())}")
        else:
            # General help
            print(
                f"""
ğŸ›ï¸ AI Command System v{self.version}
ã‚¨ãƒ«ãƒ€ãƒ¼è©•è­°ä¼šæ‰¿èªæ¸ˆã¿çµ±ä¸€ã‚³ãƒãƒ³ãƒ‰ä½“ç³»

Usage: ai <command> [options]
       ai <category> <command> [options]

Special Commands:
  help, h, ?      Show this help
  version, v      Show version
  find <query>    Find commands by keyword
  search <query>  Same as find

Categories:
"""
            )
            for cat_id, cat_info in self.categories.items():
                print(f"  {cat_id:<12} {cat_info['description']}")

            print(
                """
Examples:
  ai status               # ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç¢ºèª
  ai elder status         # ã‚¨ãƒ«ãƒ€ãƒ¼çŠ¶æ…‹ç¢ºèª
  ai help elder           # ã‚¨ãƒ«ãƒ€ãƒ¼é–¢é€£ã‚³ãƒãƒ³ãƒ‰ã®ãƒ˜ãƒ«ãƒ—
  ai find "test"          # "test"ã‚’å«ã‚€ã‚³ãƒãƒ³ãƒ‰ã‚’æ¤œç´¢

For detailed help on a category:
  ai help <category>
"""
            )

    def show_category_help(self, category: str):
        """ã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ¥ãƒ˜ãƒ«ãƒ—"""
        cat_info = self.categories[category]
        print(f"\nğŸ“ {cat_info['name']}")
        print(f"{cat_info['description']}\n")
        print("Commands:")

        for cmd_name, cmd_info in cat_info["commands"].items():
            if category == "core":
                usage = f"ai {cmd_name}"
            else:
                usage = f"ai {category} {cmd_name}"
            print(f"  {usage:<30} {cmd_info['desc']}")
        print()

    def show_version(self, args: List[str] = None):
        """ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¡¨ç¤º"""
        print(f"AI Command System v{self.version}")
        print("Elder Council Approved - 2025-07-09")

    def find_command(self, args: List[str]):
        """ã‚³ãƒãƒ³ãƒ‰æ¤œç´¢"""
        if not args:
            print("Usage: ai find <query>")
            return

        query = " ".join(args).lower()
        results = []

        # Search in all categories
        for cat_id, cat_info in self.categories.items():
            # Check category name/description
            if (
                query in cat_info["name"].lower()
                or query in cat_info["description"].lower()
            ):
                results.append(f"Category: {cat_id} - {cat_info['description']}")

            # Check commands
            for cmd_name, cmd_info in cat_info["commands"].items():
                if query in cmd_name.lower() or query in cmd_info["desc"].lower():
                    if cat_id == "core":
                        usage = f"ai {cmd_name}"
                    else:
                        usage = f"ai {cat_id} {cmd_name}"
                    results.append(f"{usage:<30} {cmd_info['desc']}")

        if results:
            print(f"\nğŸ” Found {len(results)} matches for '{query}':\n")
            for result in results:
                print(f"  {result}")
            print()
        else:
            print(f"âŒ No commands found matching '{query}'")

    def execute_legacy_command(self, script_name: str, args: List[str]):
        """ãƒ¬ã‚¬ã‚·ãƒ¼ã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè¡Œ"""
        script_path = self.scripts_dir / script_name

        if not script_path.exists():
            print(f"âŒ Command not found: {script_name}")
            return 1

        # Execute the legacy command
        cmd = [str(script_path)] + args
        try:
            return subprocess.call(cmd)
        except Exception as e:
            print(f"âŒ Error executing command: {e}")
            return 1

    def run(self, args: List[str]):
        """ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ"""
        if not args:
            self.show_help()
            return 0

        # Check for special commands
        if args[0] in self.aliases:
            self.aliases[args[0]](args[1:])
            return 0

        # Check for core commands
        if args[0] in self.categories["core"]["commands"]:
            cmd_info = self.categories["core"]["commands"][args[0]]
            return self.execute_legacy_command(cmd_info["script"], args[1:])

        # Check for category commands
        if args[0] in self.categories:
            if len(args) < 2:
                self.show_category_help(args[0])
                return 0

            category = args[0]
            command = args[1]

            if command in self.categories[category]["commands"]:
                cmd_info = self.categories[category]["commands"][command]
                return self.execute_legacy_command(cmd_info["script"], args[2:])
            else:
                print(f"âŒ Unknown command in {category}: {command}")
                self.show_category_help(category)
                return 1

        # Legacy fallback - try direct execution
        legacy_name = f"ai-{args[0]}"
        legacy_path = self.scripts_dir / legacy_name
        if legacy_path.exists():
            print(f"âš ï¸ Legacy command detected. Please use new syntax.")
            print(f"  Old: ai-{args[0]}")
            # Try to suggest new syntax
            for cat_id, cat_info in self.categories.items():
                for cmd_name, cmd_info in cat_info["commands"].items():
                    if cmd_info["script"] == legacy_name:
                        if cat_id == "core":
                            print(f"  New: ai {cmd_name}")
                        else:
                            print(f"  New: ai {cat_id} {cmd_name}")
                        break
            print()
            return self.execute_legacy_command(legacy_name, args[1:])

        # Unknown command
        print(f"âŒ Unknown command: {args[0]}")
        print("Try 'ai help' for available commands")
        return 1


def main():
    """ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œ"""
    system = AICommandSystem()
    sys.exit(system.run(sys.argv[1:]))


if __name__ == "__main__":
    main()
