#!/usr/bin/env python3
"""
Knowledge Management Scheduler
ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹ã®çµ±åˆã¨é€²åŒ–è¿½è·¡ã‚’å®šæœŸå®Ÿè¡Œã™ã‚‹ã‚·ã‚¹ãƒ†ãƒ 
"""

import sys
from pathlib import Path

# ä»®æƒ³ç’°å¢ƒã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ‘ã‚¹ã‚’è¿½åŠ 
venv_site_packages = '/home/aicompany/ai_co/venv/lib/python3.12/site-packages'
if venv_site_packages not in sys.path:
    sys.path.insert(0, venv_site_packages)

import schedule
import time
from datetime import datetime, timedelta
import threading

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã‚’Pythonãƒ‘ã‚¹ã«è¿½åŠ 
PROJECT_ROOT = Path(__file__).parent.parent
sys.path.insert(0, str(PROJECT_ROOT))

from core import BaseWorker, get_config, EMOJI
from libs.knowledge_consolidator import KnowledgeConsolidator
from libs.knowledge_evolution_tracker import KnowledgeEvolutionTracker
from libs.slack_notifier import SlackNotifier
import logging

class KnowledgeManagementScheduler(BaseWorker):
    """ãƒŠãƒ¬ãƒƒã‚¸ç®¡ç†ã®å®šæœŸå®Ÿè¡Œã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼"""
    
    def __init__(self):
        super().__init__(worker_type='knowledge_scheduler')
        self.config = get_config()
        self.consolidator = KnowledgeConsolidator()
        self.evolution_tracker = KnowledgeEvolutionTracker()
        self.setup_schedule()
        
    def setup_schedule(self):
        """ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®è¨­å®š"""
        # æ¯æ—¥åˆå‰3æ™‚ã«çµ±åˆå®Ÿè¡Œ
        schedule.every().day.at("03:00").do(self.run_consolidation)
        
        # 6æ™‚é–“ã”ã¨ã«é€²åŒ–è¿½è·¡
        schedule.every(6).hours.do(self.track_evolution)
        
        # æ¯é€±æœˆæ›œæ—¥ã«å®Œå…¨ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
        schedule.every().monday.at("09:00").do(self.generate_weekly_report)
        
        # æ¯æœˆ1æ—¥ã«æœˆæ¬¡ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
        schedule.every().day.at("00:00").do(self.check_monthly_archive)
        
        self.logger.info(f"{EMOJI['info']} Schedule configured:")
        self.logger.info("- Daily consolidation at 03:00")
        self.logger.info("- Evolution tracking every 6 hours")
        self.logger.info("- Weekly report on Mondays at 09:00")
        self.logger.info("- Monthly archive check at 00:00")
        
    def run_consolidation(self):
        """ãƒŠãƒ¬ãƒƒã‚¸çµ±åˆã®å®Ÿè¡Œ"""
        try:
            self.logger.info(f"{EMOJI['rocket']} Running scheduled knowledge consolidation...")
            self.consolidator.run_consolidation()
            self._notify_completion("Knowledge consolidation completed", "consolidation")
        except Exception as e:
            self.handle_error(e, "run_consolidation")
            
    def track_evolution(self):
        """é€²åŒ–è¿½è·¡ã®å®Ÿè¡Œ"""
        try:
            self.logger.info(f"{EMOJI['monitor']} Running scheduled evolution tracking...")
            self.evolution_tracker.track_evolution(interval_hours=6)
            self._notify_completion("Evolution tracking completed", "evolution")
        except Exception as e:
            self.handle_error(e, "track_evolution")
            
    def generate_weekly_report(self):
        """é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆã®ç”Ÿæˆ"""
        try:
            self.logger.info(f"{EMOJI['file']} Generating weekly report...")
            
            # çµ±åˆå®Ÿè¡Œ
            doc_path = self.consolidator.generate_documentation()
            
            # é€²åŒ–å¯è¦–åŒ–
            viz_path = self.evolution_tracker.visualize_evolution()
            
            # é€±æ¬¡ã‚µãƒãƒªãƒ¼ç”Ÿæˆ
            summary = self._generate_weekly_summary()
            
            self._notify_weekly_report(doc_path, viz_path, summary)
            
        except Exception as e:
            self.handle_error(e, "generate_weekly_report")
            
    def check_monthly_archive(self):
        """æœˆæ¬¡ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã®ãƒã‚§ãƒƒã‚¯"""
        if datetime.now().day == 1:
            self.create_monthly_archive()
            
    def create_monthly_archive(self):
        """æœˆæ¬¡ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã®ä½œæˆ"""
        try:
            self.logger.info(f"{EMOJI['info']} Creating monthly archive...")
            
            archive_dir = Path("/home/aicompany/ai_co/knowledge_base/archives")
            archive_dir.mkdir(exist_ok=True)
            
            # å…ˆæœˆã®å¹´æœˆã‚’å–å¾—
            last_month = datetime.now().replace(day=1) - timedelta(days=1)
            archive_name = f"knowledge_archive_{last_month.strftime('%Y%m')}"
            
            # ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ä½œæˆã‚³ãƒãƒ³ãƒ‰
            import subprocess
            subprocess.run([
                "tar", "-czf",
                f"{archive_dir}/{archive_name}.tar.gz",
                "-C", "/home/aicompany/ai_co/knowledge_base",
                "CONSOLIDATED_KNOWLEDGE",
                "evolution_tracking"
            ])
            
            self._notify_completion(f"Monthly archive created: {archive_name}", "archive")
            
        except Exception as e:
            self.handle_error(e, "create_monthly_archive")
            
    def _generate_weekly_summary(self) -> str:
        """é€±æ¬¡ã‚µãƒãƒªãƒ¼ã®ç”Ÿæˆ"""
        summary = []
        
        # æœ€è¿‘ã®å¤‰æ›´çµ±è¨ˆ
        evolution_db = Path("/home/aicompany/ai_co/knowledge_base/evolution_tracking")
        comparisons = sorted(evolution_db.glob("comparison_*.json"), reverse=True)[:7]
        
        added_total = 0
        modified_total = 0
        
        for comp_file in comparisons:
            try:
                import json
                with open(comp_file, 'r') as f:
                    comp = json.load(f)
                    added_total += len(comp.get('added_files', []))
                    modified_total += len(comp.get('modified_files', []))
            except:
                pass
                
        summary.append(f"Files added this week: {added_total}")
        summary.append(f"Files modified this week: {modified_total}")
        
        return "\n".join(summary)
        
    def _notify_completion(self, message: str, task_type: str):
        """å®Œäº†é€šçŸ¥"""
        try:
            notifier = SlackNotifier()
            notifier.send_message(f"{EMOJI['success']} {message}")
        except:
            self.logger.warning("Failed to send Slack notification")
            
    def _notify_weekly_report(self, doc_path: Path, viz_path: Path, summary: str):
        """é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆé€šçŸ¥"""
        try:
            notifier = SlackNotifier()
            message = f"""
    def cleanup(self):
        """TODO: cleanupãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè£…ã—ã¦ãã ã•ã„"""
        pass

    def stop(self):
        """TODO: stopãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè£…ã—ã¦ãã ã•ã„"""
        pass

    def initialize(self) -> None:
        """ãƒ¯ãƒ¼ã‚«ãƒ¼ã®åˆæœŸåŒ–å‡¦ç†"""
        # TODO: åˆæœŸåŒ–ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…ã—ã¦ãã ã•ã„
        logger.info(f"{self.__class__.__name__} initialized")
        pass

    def handle_error(self):
        """TODO: handle_errorãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè£…ã—ã¦ãã ã•ã„"""
        pass

    def get_status(self):
        """TODO: get_statusãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè£…ã—ã¦ãã ã•ã„"""
        pass

    def validate_config(self):
        """TODO: validate_configãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè£…ã—ã¦ãã ã•ã„"""
        pass

{EMOJI['info']} Weekly Knowledge Report

ğŸ“Š Summary:
{summary}

ğŸ“„ Full Documentation: {doc_path.name}
ğŸ“ˆ Evolution Visualization: {viz_path.name}

View online: http://localhost:8080/{viz_path.name}
"""
            notifier.send_message(message)
        except:
            self.logger.warning("Failed to send weekly report notification")
            
    def process_message(self, ch, method, properties, body):
        """ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç†ï¼ˆä½¿ç”¨ã—ãªã„ï¼‰"""
        pass
        
    def run(self):
        """ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ã®å®Ÿè¡Œ"""
        self.logger.info(f"{EMOJI['robot']} Knowledge Management Scheduler started")
        
        # èµ·å‹•æ™‚ã«ä¸€åº¦å®Ÿè¡Œ
        self.track_evolution()
        
        # ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œãƒ«ãƒ¼ãƒ—
        while True:
            try:
                schedule.run_pending()
                time.sleep(60)  # 1åˆ†ã”ã¨ã«ãƒã‚§ãƒƒã‚¯
            except KeyboardInterrupt:
                self.logger.info(f"{EMOJI['stop']} Scheduler stopped by user")
                break
            except Exception as e:
                self.logger.error(f"Scheduler error: {e}")
                time.sleep(60)


class KnowledgeManagementService:
    """ãƒŠãƒ¬ãƒƒã‚¸ç®¡ç†ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å®Ÿè¡Œç”¨ï¼‰"""
    
    def __init__(self):
        self.scheduler = KnowledgeManagementScheduler()
        self.running = False
        self.thread = None
        
    def start(self):
        """ã‚µãƒ¼ãƒ“ã‚¹é–‹å§‹"""
        if not self.running:
            self.running = True
            self.thread = threading.Thread(target=self._run_scheduler)
            self.thread.daemon = True
            self.thread.start()
            print(f"{EMOJI['rocket']} Knowledge Management Service started")
            
    def stop(self):
        """ã‚µãƒ¼ãƒ“ã‚¹åœæ­¢"""
        self.running = False
        if self.thread:
            self.thread.join(timeout=5)
        print(f"{EMOJI['stop']} Knowledge Management Service stopped")
        
    def _run_scheduler(self):
        """ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼å®Ÿè¡Œ"""
        while self.running:
            try:
                schedule.run_pending()
                time.sleep(60)
            except Exception as e:
                print(f"Service error: {e}")
                time.sleep(60)


if __name__ == "__main__":
    # ç›´æ¥å®Ÿè¡Œæ™‚ã¯ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ã‚’èµ·å‹•
    scheduler = KnowledgeManagementScheduler()
    scheduler.run()
